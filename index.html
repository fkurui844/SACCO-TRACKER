<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FELISHA SACCO ‚Äî Trip Logger</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f5f7f5; --card: #ffffff; --border: #dde8dd;
  --accent: #1a7a3c; --accent-light: #e8f5ed; --accent2: #f0a500;
  --red: #e53935; --red-light: #fdecea; --text: #1a2e1a; --muted: #6a8a6a;
  --font-display: 'Bebas Neue', sans-serif;
  --font-mono: 'Space Mono', monospace;
  --font-body: 'DM Sans', sans-serif;
  --shadow: 0 2px 16px rgba(26,122,60,0.10);
  --shadow-lg: 0 8px 32px rgba(26,122,60,0.15);
}
body { background: var(--bg); color: var(--text); font-family: var(--font-body); min-height: 100vh; max-width: 480px; margin: 0 auto; }

/* HEADER */
header { background: var(--accent); padding: 16px 20px 12px; position: sticky; top: 0; z-index: 100; }
.header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
.logo { font-family: var(--font-display); font-size: 1.7rem; letter-spacing: 3px; color: #fff; }
.logo span { color: var(--accent2); }
.header-sub { font-family: var(--font-mono); font-size: 0.55rem; color: rgba(255,255,255,0.6); letter-spacing: 2px; }
.driver-badge { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; font-family: var(--font-mono); font-size: 0.58rem; color: #fff; letter-spacing: 1px; cursor: pointer; transition: background 0.2s; }
.driver-badge:hover { background: rgba(255,255,255,0.25); }

/* BOTTOM NAV */
.bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #fff; border-top: 2px solid var(--border); display: grid; grid-template-columns: 1fr 1fr 1fr; z-index: 100; }
.nav-btn { padding: 12px 8px; text-align: center; cursor: pointer; border: none; background: transparent; transition: background 0.15s; }
.nav-btn.active { background: var(--accent-light); }
.nav-btn .nav-icon { font-size: 1.3rem; display: block; margin-bottom: 2px; }
.nav-btn .nav-label { font-family: var(--font-mono); font-size: 0.52rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
.nav-btn.active .nav-label { color: var(--accent); }

main { padding: 16px 16px 80px; }

/* CARDS */
.card { background: var(--card); border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); animation: fadeUp 0.3s ease; }
.card-title { font-family: var(--font-display); font-size: 1.3rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 6px; }
.card-sub { font-family: var(--font-mono); font-size: 0.58rem; color: var(--muted); letter-spacing: 1px; margin-bottom: 16px; }

/* FIELDS */
.field { margin-bottom: 12px; }
.field label { display: block; font-family: var(--font-mono); font-size: 0.56rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 5px; }
.field select, .field input { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px 12px; font-family: var(--font-body); font-size: 0.88rem; outline: none; transition: border-color 0.2s; appearance: none; }
.field select:focus, .field input:focus { border-color: var(--accent); }

/* STATION GRID */
.station-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
.station-btn { background: var(--bg); border: 2px solid var(--border); padding: 12px 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-family: var(--font-body); font-size: 0.78rem; color: var(--text); font-weight: 500; }
.station-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.station-btn.selected { border-color: var(--accent); background: var(--accent); color: #fff; }
.station-btn.disabled { opacity: 0.25; cursor: not-allowed; pointer-events: none; }
.station-btn .dist { display: block; font-family: var(--font-mono); font-size: 0.5rem; opacity: 0.7; margin-top: 2px; }

/* GPS BAR */
.gps-bar { display: flex; align-items: center; gap: 8px; padding: 9px 12px; background: var(--accent-light); border: 1px solid var(--border); margin-bottom: 14px; font-family: var(--font-mono); font-size: 0.58rem; color: var(--accent); letter-spacing: 1px; }
.gps-bar.error { background: var(--red-light); border-color: var(--red); color: var(--red); }

/* ROUTE DISPLAY */
.route-display { display: flex; align-items: center; gap: 10px; padding: 14px; background: var(--accent-light); border: 1px solid var(--border); margin-bottom: 14px; }
.route-station { flex: 1; text-align: center; }
.route-station .name { font-family: var(--font-mono); font-size: 0.72rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
.route-station .role { font-family: var(--font-mono); font-size: 0.5rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 3px; }
.route-arrow { font-size: 1.3rem; color: var(--accent); }

/* TIMER */
.timer-display { text-align: center; padding: 14px; background: var(--text); color: #fff; margin-bottom: 14px; }
.timer-label { font-family: var(--font-mono); font-size: 0.52rem; letter-spacing: 2px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 4px; }
.timer-value { font-family: var(--font-display); font-size: 2.6rem; letter-spacing: 3px; color: #22c55e; }

/* AMOUNT */
.amount-wrap { position: relative; margin-bottom: 14px; }
.amount-prefix { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-family: var(--font-mono); font-size: 0.78rem; color: var(--muted); font-weight: 700; }
.amount-input { width: 100%; background: var(--bg); border: 2px solid var(--border); color: var(--text); padding: 13px 13px 13px 52px; font-family: var(--font-mono); font-size: 1.1rem; font-weight: 700; outline: none; transition: border-color 0.2s; letter-spacing: 1px; }
.amount-input:focus { border-color: var(--accent); }

/* LOCKED */
.locked-section { padding: 18px; background: #f8f8f8; border: 2px dashed var(--border); text-align: center; margin-bottom: 14px; }
.locked-icon { font-size: 1.8rem; margin-bottom: 6px; opacity: 0.3; }
.locked-text { font-family: var(--font-mono); font-size: 0.6rem; color: var(--muted); letter-spacing: 1px; line-height: 1.8; text-transform: uppercase; }

/* BUTTONS */
.btn-block { width: 100%; padding: 14px; font-family: var(--font-display); font-size: 1.1rem; letter-spacing: 3px; cursor: pointer; border: none; transition: all 0.2s; margin-bottom: 8px; }
.btn-start { background: var(--accent); color: #fff; }
.btn-start:hover { background: #156632; }
.btn-start:disabled { background: var(--muted); cursor: not-allowed; }
.btn-arrive { background: var(--accent2); color: #fff; }
.btn-arrive:hover { background: #d4920a; }
.btn-end { background: var(--red); color: #fff; }
.btn-end:hover { background: #c0392b; }
.btn-end:disabled { background: var(--muted); cursor: not-allowed; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: var(--font-mono); font-size: 0.65rem; letter-spacing: 1px; padding: 10px; width: 100%; cursor: pointer; margin-bottom: 8px; }
.btn-outline:hover { border-color: var(--red); color: var(--red); }
.btn-sm { padding: 8px 16px; font-family: var(--font-mono); font-size: 0.62rem; letter-spacing: 1px; cursor: pointer; border: none; transition: all 0.2s; }
.btn-green { background: var(--accent); color: #fff; }
.btn-yellow { background: var(--accent2); color: #fff; }
.btn-red { background: var(--red); color: #fff; }

/* SUCCESS */
.success-card { background: var(--accent); color: #fff; padding: 24px 20px; text-align: center; margin-bottom: 16px; box-shadow: var(--shadow-lg); animation: fadeUp 0.4s ease; }
.success-icon { font-size: 2.5rem; margin-bottom: 10px; }
.success-title { font-family: var(--font-display); font-size: 1.8rem; letter-spacing: 3px; margin-bottom: 6px; }
.success-sub { font-family: var(--font-mono); font-size: 0.6rem; opacity: 0.8; letter-spacing: 1px; line-height: 1.8; }
.success-details { background: rgba(255,255,255,0.15); padding: 12px; margin: 14px 0; }
.detail-row { display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 0.62rem; margin-bottom: 5px; }
.detail-row:last-child { margin-bottom: 0; }

/* HISTORY */
.history-section { margin-top: 6px; }
.section-title { font-family: var(--font-mono); font-size: 0.58rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
.history-item { background: var(--card); border: 1px solid var(--border); padding: 12px 14px; margin-bottom: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
.history-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.history-route { font-family: var(--font-mono); font-size: 0.72rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
.history-amount { font-family: var(--font-mono); font-size: 0.68rem; color: #22c55e; font-weight: 700; }
.history-bottom { display: flex; justify-content: space-between; font-size: 0.66rem; color: var(--muted); }
.history-time { font-family: var(--font-mono); font-size: 0.56rem; }

/* REPORTS TAB */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-box { background: var(--card); border: 1px solid var(--border); padding: 16px; box-shadow: var(--shadow); }
.stat-box .lbl { font-family: var(--font-mono); font-size: 0.52rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.stat-box .val { font-family: var(--font-display); font-size: 1.8rem; color: var(--text); line-height: 1; }
.stat-box .val.green { color: var(--accent); }
.stat-box .val.yellow { color: var(--accent2); }

.report-filters { display: flex; gap: 6px; margin-bottom: 14px; flex-wrap: wrap; }
.filter-chip { background: var(--bg); border: 1px solid var(--border); padding: 5px 12px; font-family: var(--font-mono); font-size: 0.55rem; letter-spacing: 1px; cursor: pointer; color: var(--muted); transition: all 0.15s; text-transform: uppercase; }
.filter-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

.report-table { background: var(--card); border: 1px solid var(--border); overflow: hidden; margin-bottom: 14px; }
.table-header { display: grid; grid-template-columns: 1fr 1fr 60px 80px; padding: 8px 12px; background: var(--accent); font-family: var(--font-mono); font-size: 0.5rem; color: #fff; letter-spacing: 1px; text-transform: uppercase; gap: 6px; }
.table-row { display: grid; grid-template-columns: 1fr 1fr 60px 80px; padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 0.72rem; gap: 6px; align-items: center; transition: background 0.1s; }
.table-row:hover { background: var(--accent-light); }
.table-row:last-child { border-bottom: none; }
.table-route { font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent); font-weight: 700; }
.table-driver { font-size: 0.68rem; color: var(--muted); }
.table-time { font-family: var(--font-mono); font-size: 0.55rem; color: var(--muted); }
.table-amount { font-family: var(--font-mono); font-size: 0.65rem; color: #22c55e; font-weight: 700; text-align: right; }

.export-row { display: flex; gap: 8px; margin-bottom: 14px; }
.export-row button { flex: 1; }

/* SETUP TAB */
.setup-section { margin-bottom: 20px; }
.setup-section .section-title { margin-bottom: 12px; }
.url-display { background: var(--bg); border: 1px solid var(--border); padding: 10px 12px; font-family: var(--font-mono); font-size: 0.58rem; color: var(--muted); word-break: break-all; line-height: 1.6; margin-bottom: 8px; }
.connected-badge { display: inline-flex; align-items: center; gap: 6px; background: var(--accent-light); border: 1px solid var(--accent); padding: 5px 12px; font-family: var(--font-mono); font-size: 0.58rem; color: var(--accent); letter-spacing: 1px; margin-bottom: 12px; }
.dot-green { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; }
.steps-list { counter-reset: steps; }
.step { counter-increment: steps; padding: 10px 12px 10px 36px; border-left: 2px solid var(--border); margin-bottom: 8px; position: relative; font-size: 0.78rem; color: var(--text); line-height: 1.6; }
.step::before { content: counter(steps); position: absolute; left: -14px; top: 8px; width: 26px; height: 26px; background: var(--accent); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 0.65rem; font-weight: 700; }
.step code { background: var(--accent-light); padding: 1px 5px; font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent); }
.input-row { display: flex; gap: 8px; align-items: end; }
.input-row .field { flex: 1; margin: 0; }
.input-row button { flex-shrink: 0; padding: 10px 16px; }

/* TOAST */
.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--text); color: #fff; padding: 10px 20px; font-family: var(--font-mono); font-size: 0.62rem; letter-spacing: 1px; z-index: 999; opacity: 0; transition: opacity 0.3s; max-width: 90vw; text-align: center; }
.toast.show { opacity: 1; }

/* SPINNER */
.spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; margin: 30px auto; }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }

.tab-page { display: none; }
.tab-page.active { display: block; }
.empty-msg { text-align: center; padding: 40px 20px; font-family: var(--font-mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 1px; line-height: 2; }
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="logo">FELISHA<span> SACCO</span></div>
    <div class="driver-badge" id="driverBadge" onclick="goSetup()">‚Äî TAP TO LOGIN ‚Äî</div>
  </div>
  <div class="header-sub">// TRIP LOGGER &amp; REPORTS</div>
</header>

<main>
  <div id="page-log" class="tab-page active"></div>
  <div id="page-reports" class="tab-page"></div>
  <div id="page-settings" class="tab-page"></div>
</main>

<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-log" onclick="switchPage('log')">
    <span class="nav-icon">üöå</span>
    <span class="nav-label">LOG TRIP</span>
  </button>
  <button class="nav-btn" id="nav-reports" onclick="switchPage('reports')">
    <span class="nav-icon">üìä</span>
    <span class="nav-label">REPORTS</span>
  </button>
  <button class="nav-btn" id="nav-settings" onclick="switchPage('settings')">
    <span class="nav-icon">‚öôÔ∏è</span>
    <span class="nav-label">SETTINGS</span>
  </button>
</nav>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî Edit stations, drivers, cars here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATIONS = [
  { name: 'NAIROBI CBD',  lat: -1.2833, lng: 36.8167 },
  { name: 'WESTLANDS',    lat: -1.2676, lng: 36.8112 },
  { name: 'KAREN',        lat: -1.3197, lng: 36.7073 },
  { name: 'NGONG',        lat: -1.3583, lng: 36.6583 },
  { name: 'RONGAI',       lat: -1.3944, lng: 36.7452 },
  { name: "LANG'ATA",     lat: -1.3204, lng: 36.7571 },
  { name: 'KIKUYU',       lat: -1.2463, lng: 36.6637 },
  { name: 'LIMURU',       lat: -1.1095, lng: 36.6431 },
];

const DRIVERS = ['FESTUS KIPKURUI','TOM WASIKE','FELIX OTIENO','MUTUA KIRUI','JANETH TIONY','GRACE WANGECHI'];
const CAR_PLATES = ['KBZ 300','KBY 400','KBU 500','KCA 200'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tripState = {
  phase: 'setup', driver: '', carPlate: '',
  fromStation: null, toStation: null, amount: '',
  tripStart: null, tripEnd: null,
  gpsLat: null, gpsLng: null, gpsStatus: 'unknown', nearestStation: null,
};

let appConfig = {
  appsScriptUrl: '',
  sheetCsvUrl: 'https://docs.google.com/spreadsheets/d/162XUZwBJcpIc9m_011hzaBdbJY_I7Bf772aeJt7oQIs/pub?gid=0&single=true&output=csv',
};

let localTrips = [];
let sheetTrips = [];
let reportFilter = 'all';
let timerInterval = null;
let currentPage = 'log';

// Load from localStorage
try { localTrips = JSON.parse(localStorage.getItem('felishaTrips') || '[]'); } catch(e){}
try { const c = JSON.parse(localStorage.getItem('felishaConfig') || '{}'); appConfig = {...appConfig, ...c}; } catch(e){}
try { const d = localStorage.getItem('felishaDriver'); if(d) { const p = JSON.parse(d); tripState.driver = p.driver; tripState.carPlate = p.carPlate; if(tripState.driver) tripState.phase = 'idle'; } } catch(e){}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(page) {
  currentPage = page;
  document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('nav-'+page).classList.add('active');
  if (page === 'log') renderLog();
  if (page === 'reports') renderReports();
  if (page === 'settings') renderSettings();
}

function goSetup() { tripState.phase = 'setup'; switchPage('log'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGPS() {
  tripState.gpsStatus = 'detecting';
  if (!navigator.geolocation) { tripState.gpsStatus = 'error'; renderLog(); return; }
  navigator.geolocation.getCurrentPosition(
    pos => {
      tripState.gpsLat = pos.coords.latitude;
      tripState.gpsLng = pos.coords.longitude;
      tripState.gpsStatus = 'ok';
      tripState.nearestStation = findNearest(tripState.gpsLat, tripState.gpsLng);
      renderLog();
    },
    () => { tripState.gpsStatus = 'error'; renderLog(); },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

function haversine(la1,lo1,la2,lo2) {
  const R=6371, dL=(la2-la1)*Math.PI/180, dO=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dO/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function findNearest(lat,lng) {
  let best=null, bd=Infinity;
  STATIONS.forEach(s => { const d=haversine(lat,lng,s.lat,s.lng); if(d<bd){bd=d;best={...s,dist:d};} });
  return best;
}

function distKm(s) {
  if(!tripState.gpsLat||!s) return null;
  return haversine(tripState.gpsLat,tripState.gpsLng,s.lat,s.lng);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const el = document.getElementById('timerVal');
    if (el && tripState.tripStart) {
      const secs = Math.floor((Date.now()-tripState.tripStart)/1000);
      el.textContent = `${String(Math.floor(secs/3600)).padStart(2,'0')}:${String(Math.floor((secs%3600)/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}`;
    }
  }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRIP ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveDriver() {
  const d = document.getElementById('selDriver')?.value;
  const p = document.getElementById('selPlate')?.value;
  if (!d||!p) { showToast('SELECT DRIVER AND CAR PLATE'); return; }
  tripState.driver = d; tripState.carPlate = p; tripState.phase = 'idle';
  localStorage.setItem('felishaDriver', JSON.stringify({driver:d, carPlate:p}));
  document.getElementById('driverBadge').textContent = d.split(' ')[0];
  getGPS(); renderLog();
}

function selectFrom(name) { tripState.fromStation = STATIONS.find(s=>s.name===name); renderLog(); }
function selectTo(name) { if(tripState.phase!=='arrived') return; tripState.toStation = STATIONS.find(s=>s.name===name); renderLog(); }

function startTrip() {
  if (!tripState.fromStation) { showToast('SELECT YOUR STARTING STATION'); return; }
  tripState.phase = 'active'; tripState.tripStart = Date.now(); tripState.toStation = null;
  renderLog(); startTimer(); showToast('TRIP STARTED ‚Äî SAFE JOURNEY! üöå');
}

function arriveAtStation() {
  tripState.phase = 'arrived'; tripState.tripEnd = Date.now();
  clearInterval(timerInterval); getGPS(); renderLog();
  showToast('ARRIVAL CONFIRMED ‚Äî SELECT DESTINATION');
}

function endTrip() {
  const amt = parseFloat(document.getElementById('amountInput')?.value||'0');
  if (!tripState.toStation) { showToast('SELECT YOUR DESTINATION STATION'); return; }
  if (!amt||amt<=0) { showToast('ENTER AMOUNT COLLECTED'); return; }
  if (tripState.toStation.name===tripState.fromStation.name) { showToast('TO STATION MUST BE DIFFERENT'); return; }

  const trip = {
    id: Date.now(),
    driver: tripState.driver, carPlate: tripState.carPlate,
    fromStation: tripState.fromStation.name, toStation: tripState.toStation.name,
    amount: amt,
    duration: Math.floor((tripState.tripEnd-tripState.tripStart)/60000),
    date: new Date().toLocaleDateString('en-GB'),
    time: new Date().toLocaleTimeString(),
    timestamp: new Date().toISOString(),
  };

  localTrips.unshift(trip);
  localStorage.setItem('felishaTrips', JSON.stringify(localTrips.slice(0,100)));
  tripState.amount = amt; tripState.phase = 'done';
  submitToSheets(trip);
  renderLog();
}

function newTrip() {
  const prevTo = tripState.toStation;
  tripState.phase = 'idle'; tripState.fromStation = prevTo;
  tripState.toStation = null; tripState.amount = '';
  tripState.tripStart = null; tripState.tripEnd = null;
  getGPS(); renderLog(); showToast('READY FOR NEXT TRIP');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS SUBMIT (Apps Script)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitToSheets(trip) {
  if (!appConfig.appsScriptUrl) {
    showToast('‚ö† NOT CONNECTED ‚Äî SAVED LOCALLY');
    return;
  }
  try {
    const params = new URLSearchParams({
      date: trip.date, time: trip.time,
      fromStation: trip.fromStation, toStation: trip.toStation,
      driver: trip.driver, carPlate: trip.carPlate,
      amount: trip.amount, duration: trip.duration,
    });
    await fetch(appConfig.appsScriptUrl+'?'+params.toString(), {method:'GET', mode:'no-cors'});
    showToast('‚úÖ SYNCED TO GOOGLE SHEETS');
  } catch(e) {
    showToast('‚ö† SAVED LOCALLY');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PULL REPORTS FROM SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSheetData() {
  const url = appConfig.sheetCsvUrl;
  if (!url) { showToast('NO SHEET URL CONFIGURED'); return; }
  document.getElementById('page-reports').innerHTML = '<div class="spinner"></div>';
  try {
    let text = null;
    try { const r = await fetch(url); if(r.ok) text = await r.text(); } catch(_){}
    if (!text) {
      const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
      const r2 = await fetch(proxy);
      text = (await r2.json()).contents;
    }
    sheetTrips = parseSheetCSV(text);
    showToast('‚úÖ '+sheetTrips.length+' RECORDS LOADED');
    renderReports();
  } catch(e) {
    showToast('‚ö† COULD NOT LOAD SHEET DATA');
    renderReports();
  }
}

function parseSheetCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/[^a-z]/g,''));
  return lines.slice(1).map(line => {
    const cols = line.split(',').map(c=>c.trim().replace(/^"|"$/g,''));
    const row = {};
    headers.forEach((h,i) => row[h] = cols[i]||'');
    return {
      date: row['date']||row['dateofduty']||row['timestamp']||'',
      time: row['time']||'',
      fromStation: row['fromstation']||row['from']||'',
      toStation: row['tostation']||row['to']||'',
      driver: row['drivername']||row['driversname']||row['driver']||'',
      carPlate: row['carplate']||row['plate']||row['car']||'',
      amount: parseFloat((row['amountcollectedinkes']||row['amount']||'0').replace(/[^0-9.]/g,''))||0,
      duration: parseInt(row['duration']||'0')||0,
    };
  }).filter(r=>r.driver||r.carPlate);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER TRIPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFilteredTrips(trips) {
  const now = new Date();
  const today = new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return trips.filter(t => {
    if (reportFilter==='all') return true;
    const d = parseDate(t.date);
    if (!d) return false;
    if (reportFilter==='today') return d>=today;
    if (reportFilter==='week') { const ws=new Date(today); ws.setDate(today.getDate()-today.getDay()); return d>=ws; }
    if (reportFilter==='month') return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
    return true;
  });
}

function parseDate(str) {
  if (!str) return null;
  let d = new Date(str); if (!isNaN(d)) return d;
  const m = str.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
  if (m) { const yr=m[3].length===2?'20'+m[3]:m[3]; return new Date(`${yr}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`); }
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const allData = [...sheetTrips, ...localTrips];
  const filtered = getFilteredTrips(allData);
  const total = filtered.reduce((s,t)=>s+(t.amount||0),0);

  const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210, M=18;
  let y=M;

  doc.setFillColor(26,122,60); doc.rect(0,0,W,38,'F');
  doc.setTextColor(255,255,255); doc.setFontSize(20); doc.setFont('helvetica','bold');
  doc.text('FELISHA SACCO', M, 16);
  doc.setFontSize(8); doc.setFont('helvetica','normal');
  doc.text('TRIP REPORT ‚Äî '+reportFilter.toUpperCase(), M, 24);
  doc.text('Generated: '+new Date().toLocaleString(), M, 31);
  doc.setTextColor(240,165,0); doc.text('Total Records: '+filtered.length+' | Total Revenue: KES '+total.toLocaleString(), W-M, 31, {align:'right'});

  y=46;
  const bw=(W-M*2-9)/4;
  const boxes=[
    {l:'TOTAL TRIPS', v:filtered.length.toString()},
    {l:'TOTAL REVENUE', v:'KES '+total.toLocaleString()},
    {l:'AVG/TRIP', v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():'‚Äî'},
    {l:'UNIQUE CARS', v:[...new Set(filtered.map(t=>t.carPlate))].length.toString()},
  ];
  boxes.forEach((b,i) => {
    const bx=M+i*(bw+3);
    doc.setFillColor(245,250,245); doc.rect(bx,y,bw,20,'F');
    doc.setFillColor(26,122,60); doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130); doc.setFontSize(6); doc.setFont('helvetica','normal');
    doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20); doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text(b.v,bx+3,y+17);
  });
  y+=28;

  doc.setFillColor(26,46,26); doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0); doc.setFontSize(6.5); doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5); doc.text('DATE',M+10,y+5); doc.text('ROUTE',M+36,y+5);
  doc.text('DRIVER',M+90,y+5); doc.text('CAR',M+130,y+5); doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;

  filtered.forEach(([t,i]) => {
    if (y>272) { doc.addPage(); y=M; }
    const bg=i%2===0?[250,253,250]:[244,248,244];
    doc.setFillColor(...bg); doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80); doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.text(String(i+1),M+2,y+5);
    doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60); doc.setFont('helvetica','bold');
    doc.text((t.fromStation||'').slice(0,12)+'‚Üí'+(t.toStation||'').slice(0,12),M+36,y+5);
    doc.setTextColor(60,60,60); doc.setFont('helvetica','normal');
    doc.text((t.driver||'').slice(0,18),M+90,y+5);
    doc.text((t.carPlate||''),M+130,y+5);
    doc.setTextColor(20,100,60); doc.setFont('helvetica','bold');
    doc.text((t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });

  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++) {
    doc.setPage(i); doc.setFontSize(6); doc.setTextColor(150,150,150); doc.setFont('helvetica','normal');
    doc.text('FELISHA SACCO ‚Äî CONFIDENTIAL',M,292);
    doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});
  }
  doc.save('felisha-sacco-report-'+reportFilter+'.pdf');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LOG PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLog() {
  const el = document.getElementById('page-log');
  if (currentPage!=='log') return;

  // Update driver badge
  if (tripState.driver) document.getElementById('driverBadge').textContent = tripState.driver.split(' ')[0]+' ¬∑ '+tripState.carPlate;
  else document.getElementById('driverBadge').textContent = '‚Äî TAP TO LOGIN ‚Äî';

  const gpsBar = tripState.gpsStatus==='detecting'
    ? `<div class="gps-bar"><span>üì°</span>DETECTING LOCATION...</div>`
    : tripState.gpsStatus==='ok'&&tripState.nearestStation
    ? `<div class="gps-bar"><span>üìç</span>NEAREST: ${tripState.nearestStation.name} (${tripState.nearestStation.dist.toFixed(1)} KM)</div>`
    : tripState.gpsStatus==='error'
    ? `<div class="gps-bar error"><span>‚ö†</span>GPS UNAVAILABLE ‚Äî SELECT MANUALLY <span onclick="getGPS()" style="cursor:pointer;text-decoration:underline;margin-left:8px">RETRY</span></div>`
    : `<div class="gps-bar"><span>üì°</span><span onclick="getGPS()" style="cursor:pointer;text-decoration:underline">TAP TO DETECT LOCATION</span></div>`;

  if (tripState.phase==='setup') {
    el.innerHTML = `
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="card-title">DRIVER LOGIN</div>
        <div class="field">
          <label>Select Driver</label>
          <select id="selDriver">
            <option value="">‚Äî Choose Driver ‚Äî</option>
            ${DRIVERS.map(d=>`<option value="${d}" ${d===tripState.driver?'selected':''}>${d}</option>`).join('')}
          </select>
        </div>
        <div class="field">
          <label>Car Plate</label>
          <select id="selPlate">
            <option value="">‚Äî Choose Car ‚Äî</option>
            ${CAR_PLATES.map(p=>`<option value="${p}" ${p===tripState.carPlate?'selected':''}>${p}</option>`).join('')}
          </select>
        </div>
        <button class="btn-block btn-start" onclick="saveDriver()">BEGIN SHIFT</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  if (tripState.phase==='idle') {
    el.innerHTML = `
      <div class="card">
        <div class="card-title">START TRIP</div>
        <div class="card-sub">// SELECT YOUR STARTING STATION</div>
        ${gpsBar}
        <div class="field"><label>FROM STATION</label></div>
        <div class="station-grid">
          ${STATIONS.map(s => {
            const d=distKm(s), isN=tripState.nearestStation?.name===s.name;
            return `<div class="station-btn ${tripState.fromStation?.name===s.name?'selected':''}" onclick="selectFrom('${s.name}')">
              ${s.name}${isN?' üìç':''}
              ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
            </div>`;
          }).join('')}
        </div>
        <button class="btn-block btn-start" onclick="startTrip()" ${!tripState.fromStation?'disabled':''}>üöå START TRIP</button>
        <button class="btn-outline" onclick="goSetup()">CHANGE DRIVER</button>
      </div>
      ${renderTodayHistory()}`;
    if (tripState.nearestStation&&!tripState.fromStation) setTimeout(()=>selectFrom(tripState.nearestStation.name),100);
    return;
  }

  if (tripState.phase==='active') {
    const secs=tripState.tripStart?Math.floor((Date.now()-tripState.tripStart)/1000):0;
    el.innerHTML = `
      <div class="card">
        <div class="card-title">TRIP IN PROGRESS</div>
        <div class="card-sub">// DRIVE TO DESTINATION THEN TAP ARRIVE</div>
        <div class="route-display">
          <div class="route-station"><div class="role">FROM</div><div class="name">${tripState.fromStation.name}</div></div>
          <div class="route-arrow">‚Üí</div>
          <div class="route-station"><div class="role">TO</div><div class="name" style="color:var(--muted)">DESTINATION</div></div>
        </div>
        <div class="timer-display">
          <div class="timer-label">TRIP DURATION</div>
          <div class="timer-value" id="timerVal">${String(Math.floor(secs/3600)).padStart(2,'0')}:${String(Math.floor((secs%3600)/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}</div>
        </div>
        <div class="locked-section">
          <div class="locked-icon">üîí</div>
          <div class="locked-text">DESTINATION LOCKED<br>ARRIVE AT STATION FIRST</div>
        </div>
        <button class="btn-block btn-arrive" onclick="arriveAtStation()">üìç I HAVE ARRIVED</button>
        <button class="btn-outline" onclick="if(confirm('Cancel this trip?')){tripState.phase='idle';clearInterval(timerInterval);renderLog();}">CANCEL TRIP</button>
      </div>`;
    startTimer(); return;
  }

  if (tripState.phase==='arrived') {
    el.innerHTML = `
      <div class="card">
        <div class="card-title">END TRIP</div>
        <div class="card-sub">// SELECT DESTINATION & ENTER AMOUNT</div>
        ${gpsBar}
        <div class="route-display">
          <div class="route-station"><div class="role">FROM</div><div class="name">${tripState.fromStation.name}</div></div>
          <div class="route-arrow">‚Üí</div>
          <div class="route-station"><div class="role">TO</div><div class="name">${tripState.toStation?tripState.toStation.name:'???'}</div></div>
        </div>
        <div class="field"><label>TO STATION (WHERE YOU ARRIVED)</label></div>
        <div class="station-grid">
          ${STATIONS.map(s => {
            const d=distKm(s), isN=tripState.nearestStation?.name===s.name, same=s.name===tripState.fromStation?.name;
            return `<div class="station-btn ${tripState.toStation?.name===s.name?'selected':''} ${same?'disabled':''}" onclick="selectTo('${s.name}')">
              ${s.name}${isN?' üìç':''}
              ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
            </div>`;
          }).join('')}
        </div>
        <div class="field"><label>AMOUNT COLLECTED IN KES</label></div>
        <div class="amount-wrap">
          <span class="amount-prefix">KES</span>
          <input type="number" class="amount-input" id="amountInput" placeholder="0" min="0" value="${tripState.amount||''}">
        </div>
        <button class="btn-block btn-end" onclick="endTrip()" ${!tripState.toStation?'disabled':''}>‚úÖ SUBMIT TRIP</button>
      </div>`;
    if (tripState.nearestStation&&!tripState.toStation&&tripState.nearestStation.name!==tripState.fromStation?.name) setTimeout(()=>selectTo(tripState.nearestStation.name),100);
    return;
  }

  if (tripState.phase==='done') {
    const last = localTrips[0];
    el.innerHTML = `
      <div class="success-card">
        <div class="success-icon">‚úÖ</div>
        <div class="success-title">TRIP LOGGED!</div>
        <div class="success-details">
          <div class="detail-row"><span>DRIVER</span><span>${last.driver}</span></div>
          <div class="detail-row"><span>CAR</span><span>${last.carPlate}</span></div>
          <div class="detail-row"><span>ROUTE</span><span>${last.fromStation} ‚Üí ${last.toStation}</span></div>
          <div class="detail-row"><span>DURATION</span><span>${last.duration} MIN</span></div>
          <div class="detail-row"><span>AMOUNT</span><span>KES ${Number(last.amount).toLocaleString()}</span></div>
          <div class="detail-row"><span>TIME</span><span>${last.time}</span></div>
        </div>
        <div class="success-sub">${appConfig.appsScriptUrl?'‚úÖ SYNCED TO GOOGLE SHEETS':'üíæ SAVED LOCALLY'}</div>
      </div>
      <button class="btn-block btn-start" onclick="newTrip()">üöå START NEXT TRIP</button>
      <button class="btn-outline" onclick="goSetup()">END SHIFT</button>
      ${renderTodayHistory()}`;
    return;
  }
}

function renderTodayHistory() {
  const today = new Date().toLocaleDateString('en-GB');
  const todayTrips = localTrips.filter(t=>t.date===today);
  if (!todayTrips.length) return '';
  const todayTotal = todayTrips.reduce((s,t)=>s+t.amount,0);
  return `
    <div class="history-section">
      <div class="section-title">TODAY'S TRIPS (${todayTrips.length}) ¬∑ KES ${todayTotal.toLocaleString()}</div>
      ${todayTrips.slice(0,8).map(t=>`
        <div class="history-item">
          <div class="history-top">
            <span class="history-route">${t.fromStation} ‚Üí ${t.toStation}</span>
            <span class="history-amount">KES ${Number(t.amount).toLocaleString()}</span>
          </div>
          <div class="history-bottom">
            <span>${t.driver} ¬∑ ${t.carPlate}</span>
            <span class="history-time">${t.time}</span>
          </div>
        </div>`).join('')}
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER REPORTS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports() {
  const el = document.getElementById('page-reports');
  const allData = [...sheetTrips, ...localTrips.filter(lt=>!sheetTrips.find(st=>st.time===lt.time&&st.driver===lt.driver))];
  const filtered = getFilteredTrips(allData);
  const total = filtered.reduce((s,t)=>s+(t.amount||0),0);
  const avg = filtered.length ? Math.round(total/filtered.length) : 0;
  const cars = [...new Set(filtered.map(t=>t.carPlate))];
  const today = new Date(); today.setHours(0,0,0,0);
  const todayTrips = allData.filter(t=>{const d=parseDate(t.date); return d&&d>=today;});

  el.innerHTML = `
    <div class="export-row">
      <button class="btn-sm btn-green" onclick="loadSheetData()">‚ü≥ SYNC FROM SHEET</button>
      <button class="btn-sm btn-yellow" onclick="exportPDF()">‚¨á EXPORT PDF</button>
    </div>

    <div class="stat-grid">
      <div class="stat-box"><div class="lbl">TOTAL TRIPS</div><div class="val green">${filtered.length}</div></div>
      <div class="stat-box"><div class="lbl">TOTAL REVENUE</div><div class="val green" style="font-size:1.3rem">KES ${total.toLocaleString()}</div></div>
      <div class="stat-box"><div class="lbl">AVG / TRIP</div><div class="val yellow" style="font-size:1.3rem">KES ${avg.toLocaleString()}</div></div>
      <div class="stat-box"><div class="lbl">TODAY'S TRIPS</div><div class="val">${todayTrips.length}</div></div>
    </div>

    <div class="report-filters">
      ${['all','today','week','month'].map(f=>`<div class="filter-chip ${reportFilter===f?'active':''}" onclick="reportFilter='${f}';renderReports()">${f==='all'?'ALL TIME':f.toUpperCase()}</div>`).join('')}
    </div>

    ${filtered.length===0?'<div class="empty-msg">NO DATA YET<br>TAP SYNC FROM SHEET OR LOG A TRIP</div>': `
    <div class="report-table">
      <div class="table-header">
        <span>ROUTE</span><span>DRIVER</span><span>TIME</span><span>AMOUNT</span>
      </div>
      ${filtered.slice(0,50).map(t=>`
        <div class="table-row">
          <div><div class="table-route">${(t.fromStation||'').slice(0,8)}‚Üí${(t.toStation||'').slice(0,8)}</div><div style="font-family:var(--font-mono);font-size:0.52rem;color:var(--muted)">${t.date||''}</div></div>
          <div><div class="table-driver">${(t.driver||'').split(' ')[0]}</div><div style="font-family:var(--font-mono);font-size:0.52rem;color:var(--muted)">${t.carPlate||''}</div></div>
          <div class="table-time">${(t.time||'').slice(0,5)}</div>
          <div class="table-amount">KES ${Number(t.amount||0).toLocaleString()}</div>
        </div>`).join('')}
    </div>`}

    ${cars.length?`
    <div class="section-title" style="margin-bottom:10px">REVENUE BY CAR</div>
    ${cars.map(car=>{
      const carTrips=filtered.filter(t=>t.carPlate===car);
      const carTotal=carTrips.reduce((s,t)=>s+t.amount,0);
      const pct=Math.round((carTotal/total)*100)||0;
      return `<div class="history-item" style="margin-bottom:8px">
        <div class="history-top"><span class="history-route">${car}</span><span class="history-amount">KES ${carTotal.toLocaleString()}</span></div>
        <div style="height:5px;background:var(--border);border-radius:3px;margin-top:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:var(--accent);border-radius:3px"></div></div>
        <div class="history-bottom" style="margin-top:4px"><span>${carTrips.length} trips</span><span>${pct}% of revenue</span></div>
      </div>`;
    }).join('')}`:''}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER SETTINGS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings() {
  const el = document.getElementById('page-settings');
  el.innerHTML = `
    <div class="card">
      <div class="card-title">SHEET CONNECTION</div>
      <div class="card-sub">// CONNECT TO YOUR GOOGLE SHEET</div>

      <div class="setup-section">
        <div class="section-title">STEP 1 ‚Äî APPS SCRIPT (SEND DATA)</div>
        <p style="font-size:0.78rem;color:var(--muted);margin-bottom:10px;line-height:1.6">Paste your Google Apps Script Web App URL to send trip data directly to your sheet.</p>
        ${appConfig.appsScriptUrl?`<div class="connected-badge"><div class="dot-green"></div>CONNECTED</div><div class="url-display">${appConfig.appsScriptUrl}</div>`:''}
        <div class="input-row">
          <div class="field"><label>Apps Script Web App URL</label><input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec" value="${appConfig.appsScriptUrl||''}"></div>
          <button class="btn-sm btn-green" onclick="saveScriptUrl()">SAVE</button>
        </div>
        <div class="steps-list" style="margin-top:12px">
          <div class="step">Open your Google Sheet ‚Üí <code>Extensions</code> ‚Üí <code>Apps Script</code></div>
          <div class="step">Delete existing code, paste the <strong>apps-script.js</strong> code provided</div>
          <div class="step">Click <code>Deploy</code> ‚Üí <code>New deployment</code> ‚Üí Select <code>Web app</code></div>
          <div class="step">Set <code>Execute as: Me</code> and <code>Who has access: Anyone</code> ‚Üí Deploy ‚Üí Authorize</div>
          <div class="step">Copy the Web App URL and paste it above</div>
        </div>
      </div>

      <div class="setup-section">
        <div class="section-title">STEP 2 ‚Äî CSV URL (PULL REPORTS)</div>
        <p style="font-size:0.78rem;color:var(--muted);margin-bottom:10px;line-height:1.6">This URL pulls data from your sheet into the Reports tab.</p>
        ${appConfig.sheetCsvUrl?`<div class="connected-badge"><div class="dot-green"></div>SHEET URL SET</div>`:''}
        <div class="input-row">
          <div class="field"><label>Google Sheet CSV URL</label><input type="text" id="csvUrl" value="${appConfig.sheetCsvUrl||''}" placeholder="https://docs.google.com/spreadsheets/.../pub?output=csv"></div>
          <button class="btn-sm btn-green" onclick="saveCsvUrl()">SAVE</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">SHEET DETAILS</div>
      <div class="card-sub">// YOUR FELISHA SACCO GOOGLE SHEET</div>
      <div class="url-display">https://docs.google.com/spreadsheets/d/162XUZwBJcpIc9m_011hzaBdbJY_I7Bf772aeJt7oQIs/edit</div>
      <p style="font-size:0.75rem;color:var(--muted);line-height:1.7">
        To publish as CSV: Open sheet ‚Üí <strong>File ‚Üí Share ‚Üí Publish to web</strong> ‚Üí Select your sheet ‚Üí Choose <strong>CSV</strong> ‚Üí Publish ‚Üí Copy URL ‚Üí Paste above.
      </p>
    </div>

    <div class="card">
      <div class="card-title">LOCAL DATA</div>
      <div class="card-sub">// ${localTrips.length} TRIPS STORED ON THIS DEVICE</div>
      <button class="btn-outline" onclick="if(confirm('Clear all local trip data?')){localStorage.removeItem('felishaTrips');localTrips=[];showToast('LOCAL DATA CLEARED');renderSettings();}">CLEAR LOCAL TRIP DATA</button>
    </div>`;
}

function saveScriptUrl() {
  const url = document.getElementById('scriptUrl')?.value.trim();
  appConfig.appsScriptUrl = url;
  localStorage.setItem('felishaConfig', JSON.stringify(appConfig));
  showToast(url?'‚úÖ APPS SCRIPT URL SAVED':'URL CLEARED');
  renderSettings();
}

function saveCsvUrl() {
  const url = document.getElementById('csvUrl')?.value.trim();
  appConfig.sheetCsvUrl = url;
  localStorage.setItem('felishaConfig', JSON.stringify(appConfig));
  showToast(url?'‚úÖ CSV URL SAVED':'URL CLEARED');
  renderSettings();
}

// Fix exportPDF to use indexed data correctly
const _origExportPDF = exportPDF;
window.exportPDF = function() {
  const { jsPDF } = window.jspdf;
  const allData = [...sheetTrips, ...localTrips];
  const filtered = getFilteredTrips(allData);
  const total = filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210, M=18; let y=M;
  doc.setFillColor(26,122,60); doc.rect(0,0,W,38,'F');
  doc.setTextColor(255,255,255); doc.setFontSize(20); doc.setFont('helvetica','bold');
  doc.text('FELISHA SACCO', M, 16);
  doc.setFontSize(8); doc.setFont('helvetica','normal');
  doc.text('TRIP REPORT ‚Äî '+reportFilter.toUpperCase(), M, 24);
  doc.text('Generated: '+new Date().toLocaleString(), M, 31);
  y=46;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:filtered.length.toString()},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():'‚Äî'},{l:'UNIQUE CARS',v:[...new Set(filtered.map(t=>t.carPlate))].length.toString()}].forEach((b,i)=>{
    const bx=M+i*(bw+3);
    doc.setFillColor(245,250,245); doc.rect(bx,y,bw,20,'F');
    doc.setFillColor(26,122,60); doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130); doc.setFontSize(6); doc.setFont('helvetica','normal'); doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20); doc.setFontSize(10); doc.setFont('helvetica','bold'); doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26); doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0); doc.setFontSize(6.5); doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5); doc.text('DATE',M+10,y+5); doc.text('ROUTE',M+36,y+5); doc.text('DRIVER',M+90,y+5); doc.text('CAR',M+130,y+5); doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244])); doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80); doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.text(String(i+1),M+2,y+5); doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60); doc.setFont('helvetica','bold');
    doc.text((t.fromStation||'').slice(0,10)+'‚Üí'+(t.toStation||'').slice(0,10),M+36,y+5);
    doc.setTextColor(60,60,60); doc.setFont('helvetica','normal');
    doc.text((t.driver||'').slice(0,18),M+90,y+5); doc.text((t.carPlate||''),M+130,y+5);
    doc.setTextColor(20,100,60); doc.setFont('helvetica','bold');
    doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FELISHA SACCO ‚Äî CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  doc.save('felisha-sacco-report-'+reportFilter+'.pdf');
};

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
if (tripState.driver) document.getElementById('driverBadge').textContent = tripState.driver.split(' ')[0]+' ¬∑ '+tripState.carPlate;
renderLog();
if (tripState.phase==='idle') getGPS();
</script>
</body>
</html>
