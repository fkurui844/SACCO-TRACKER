<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FELISHA SACCO ‚Äî Trip Logger</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f7f5;--card:#fff;--border:#dde8dd;
  --accent:#1a7a3c;--alight:#e8f5ed;--accent2:#f0a500;
  --red:#e53935;--rlight:#fdecea;--text:#1a2e1a;--muted:#6a8a6a;
  --font-d:'Bebas Neue',sans-serif;--font-m:'Space Mono',monospace;--font-b:'DM Sans',sans-serif;
  --sh:0 2px 16px rgba(26,122,60,.10);--shlg:0 8px 32px rgba(26,122,60,.15);
}
body{background:var(--bg);color:var(--text);font-family:var(--font-b);min-height:100vh;max-width:480px;margin:0 auto}
header{background:var(--accent);padding:14px 18px 10px;position:sticky;top:0;z-index:100}
.hrow{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
.logo{font-family:var(--font-d);font-size:1.6rem;letter-spacing:3px;color:#fff}
.logo span{color:var(--accent2)}
.hsub{font-family:var(--font-m);font-size:.52rem;color:rgba(255,255,255,.6);letter-spacing:2px}
.dbadge{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);padding:4px 10px;font-family:var(--font-m);font-size:.55rem;color:#fff;letter-spacing:1px;cursor:pointer;transition:background .2s}
.dbadge:hover{background:rgba(255,255,255,.25)}
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:#fff;border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:100}
.nbtn{padding:10px 4px;text-align:center;cursor:pointer;border:none;background:transparent;transition:background .15s}
.nbtn.active{background:var(--alight)}
.nbtn .ni{font-size:1.2rem;display:block;margin-bottom:1px}
.nbtn .nl{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.nbtn.active .nl{color:var(--accent)}
main{padding:14px 14px 76px}
.page{display:none}.page.active{display:block}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);padding:18px;margin-bottom:14px;box-shadow:var(--sh);animation:fadeUp .3s ease}
.ctitle{font-family:var(--font-d);font-size:1.25rem;color:var(--accent);letter-spacing:2px;margin-bottom:5px}
.csub{font-family:var(--font-m);font-size:.55rem;color:var(--muted);letter-spacing:1px;margin-bottom:14px}

/* FIELD */
.field{margin-bottom:11px}
.field label{display:block;font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.field select,.field input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:var(--font-b);font-size:.88rem;outline:none;transition:border-color .2s;appearance:none}
.field select:focus,.field input:focus{border-color:var(--accent)}

/* STATION GRID */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px}
.sbtn{background:var(--bg);border:2px solid var(--border);padding:11px 8px;text-align:center;cursor:pointer;transition:all .2s;font-family:var(--font-b);font-size:.76rem;color:var(--text);font-weight:500}
.sbtn:hover{border-color:var(--accent);color:var(--accent);background:var(--alight)}
.sbtn.sel{border-color:var(--accent);background:var(--accent);color:#fff}
.sbtn.dis{opacity:.25;cursor:not-allowed;pointer-events:none}
.sbtn .dist{display:block;font-family:var(--font-m);font-size:.48rem;opacity:.7;margin-top:2px}

/* GPS */
.gbar{display:flex;align-items:center;gap:7px;padding:8px 11px;background:var(--alight);border:1px solid var(--border);margin-bottom:12px;font-family:var(--font-m);font-size:.55rem;color:var(--accent);letter-spacing:1px}
.gbar.err{background:var(--rlight);border-color:var(--red);color:var(--red)}

/* ROUTE */
.rdisp{display:flex;align-items:center;gap:10px;padding:12px;background:var(--alight);border:1px solid var(--border);margin-bottom:12px}
.rs{flex:1;text-align:center}
.rs .rn{font-family:var(--font-m);font-size:.7rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.rs .rl{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.rarr{font-size:1.3rem;color:var(--accent)}

/* TIMER */
.tdisp{text-align:center;padding:13px;background:var(--text);color:#fff;margin-bottom:12px}
.tl{font-family:var(--font-m);font-size:.5rem;letter-spacing:2px;color:rgba(255,255,255,.5);text-transform:uppercase;margin-bottom:4px}
.tv{font-family:var(--font-d);font-size:2.5rem;letter-spacing:3px;color:#22c55e}

/* AMOUNT */
.awrap{position:relative;margin-bottom:12px}
.apfx{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-family:var(--font-m);font-size:.75rem;color:var(--muted);font-weight:700}
.ainput{width:100%;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:12px 12px 12px 50px;font-family:var(--font-m);font-size:1.1rem;font-weight:700;outline:none;transition:border-color .2s;letter-spacing:1px}
.ainput:focus{border-color:var(--accent)}

/* LOCKED */
.lock{padding:16px;background:#f8f8f8;border:2px dashed var(--border);text-align:center;margin-bottom:12px}
.lico{font-size:1.6rem;margin-bottom:5px;opacity:.3}
.ltxt{font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:1.8;text-transform:uppercase}

/* BUTTONS */
.bb{width:100%;padding:13px;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;cursor:pointer;border:none;transition:all .2s;margin-bottom:7px}
.bstart{background:var(--accent);color:#fff}.bstart:hover{background:#156632}.bstart:disabled{background:var(--muted);cursor:not-allowed}
.barrive{background:var(--accent2);color:#fff}.barrive:hover{background:#d4920a}
.bend{background:var(--red);color:#fff}.bend:hover{background:#c0392b}.bend:disabled{background:var(--muted);cursor:not-allowed}
.bout{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.62rem;letter-spacing:1px;padding:9px;width:100%;cursor:pointer;margin-bottom:7px}
.bout:hover{border-color:var(--red);color:var(--red)}
.bsm{padding:7px 14px;font-family:var(--font-m);font-size:.58rem;letter-spacing:1px;cursor:pointer;border:none;transition:all .2s;border-radius:0}
.bg{background:var(--accent);color:#fff}.by{background:var(--accent2);color:#fff}.br{background:var(--red);color:#fff}
.bghost{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.58rem;padding:7px 14px;cursor:pointer}
.bghost:hover{border-color:var(--accent);color:var(--accent)}

/* SUCCESS */
.scard{background:var(--accent);color:#fff;padding:22px 18px;text-align:center;margin-bottom:14px;box-shadow:var(--shlg);animation:fadeUp .4s ease}
.sico{font-size:2.2rem;margin-bottom:8px}
.stitle{font-family:var(--font-d);font-size:1.7rem;letter-spacing:3px;margin-bottom:5px}
.ssub{font-family:var(--font-m);font-size:.58rem;opacity:.8;letter-spacing:1px;line-height:1.8}
.sdetails{background:rgba(255,255,255,.15);padding:11px;margin:12px 0}
.drow{display:flex;justify-content:space-between;font-family:var(--font-m);font-size:.6rem;margin-bottom:4px}
.drow:last-child{margin-bottom:0}

/* HISTORY */
.hsect{margin-top:6px}
.stitle2{font-family:var(--font-m);font-size:.55rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:9px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.hitem{background:var(--card);border:1px solid var(--border);padding:11px 13px;margin-bottom:7px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.hroute{font-family:var(--font-m);font-size:.68rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.hamt{font-family:var(--font-m);font-size:.65rem;color:#22c55e;font-weight:700}
.hbot{display:flex;justify-content:space-between;font-size:.64rem;color:var(--muted)}
.htime{font-family:var(--font-m);font-size:.52rem}

/* REPORTS */
.sgrid2{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px}
.sbox{background:var(--card);border:1px solid var(--border);padding:14px;box-shadow:var(--sh)}
.sbox .sl{font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:5px}
.sbox .sv{font-family:var(--font-d);font-size:1.7rem;color:var(--text);line-height:1}
.sv.green{color:var(--accent)}.sv.yellow{color:var(--accent2)}
.fchips{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap}
.fchip{background:var(--bg);border:1px solid var(--border);padding:4px 10px;font-family:var(--font-m);font-size:.52rem;letter-spacing:1px;cursor:pointer;color:var(--muted);transition:all .15s;text-transform:uppercase}
.fchip.active{background:var(--accent);border-color:var(--accent);color:#fff}
.rtable{background:var(--card);border:1px solid var(--border);overflow:hidden;margin-bottom:12px}
.rth{display:grid;grid-template-columns:1fr 1fr 55px 75px;padding:7px 11px;background:var(--accent);font-family:var(--font-m);font-size:.48rem;color:#fff;letter-spacing:1px;text-transform:uppercase;gap:5px}
.rtr{display:grid;grid-template-columns:1fr 1fr 55px 75px;padding:9px 11px;border-bottom:1px solid var(--border);font-size:.7rem;gap:5px;align-items:center;transition:background .1s}
.rtr:hover{background:var(--alight)}.rtr:last-child{border-bottom:none}
.trroute{font-family:var(--font-m);font-size:.57rem;color:var(--accent);font-weight:700}
.trdrv{font-size:.66rem;color:var(--muted)}
.trtm{font-family:var(--font-m);font-size:.52rem;color:var(--muted)}
.tramt{font-family:var(--font-m);font-size:.62rem;color:#22c55e;font-weight:700;text-align:right}
.exprow{display:flex;gap:7px;margin-bottom:12px}
.exprow button{flex:1}

/* ADMIN */
.apinbox{text-align:center;padding:40px 20px}
.apintitle{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:3px;margin-bottom:8px}
.apinsub{font-family:var(--font-m);font-size:.6rem;color:var(--muted);letter-spacing:1px;margin-bottom:20px}
.pininput{width:200px;text-align:center;font-family:var(--font-m);font-size:1.5rem;letter-spacing:8px;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:14px;outline:none;margin:0 auto 16px;display:block}
.pininput:focus{border-color:var(--accent)}
.alist{margin-bottom:6px}
.aitem{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--card);border:1px solid var(--border);margin-bottom:6px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.aitem-name{font-family:var(--font-m);font-size:.72rem;color:var(--text);font-weight:700;letter-spacing:1px}
.aitem-sub{font-size:.64rem;color:var(--muted);margin-top:2px}
.adel{background:none;border:none;cursor:pointer;font-size:1rem;color:var(--muted);padding:4px 8px;transition:color .2s}
.adel:hover{color:var(--red)}
.addrow{display:flex;gap:7px;align-items:end;margin-top:10px}
.addrow .field{flex:1;margin:0}
.addrow button{flex-shrink:0;padding:10px 14px}
.atabs{display:flex;gap:0;margin-bottom:14px;border-bottom:2px solid var(--border)}
.atab{font-family:var(--font-m);font-size:.58rem;letter-spacing:1px;padding:10px 16px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase}
.atab:hover{color:var(--text)}
.atab.active{color:var(--accent);border-bottom-color:var(--accent);margin-bottom:-2px}
.asect{display:none}.asect.active{display:block}
.atag{display:inline-flex;align-items:center;gap:5px;background:var(--alight);border:1px solid var(--accent);padding:4px 10px;font-family:var(--font-m);font-size:.6rem;color:var(--accent);letter-spacing:1px;margin:0 4px 4px 0}
.atag .xtag{cursor:pointer;opacity:.6;font-size:.8rem}.atag .xtag:hover{opacity:1;color:var(--red)}
.conn-badge{display:inline-flex;align-items:center;gap:5px;background:var(--alight);border:1px solid var(--accent);padding:4px 12px;font-family:var(--font-m);font-size:.55rem;color:var(--accent);letter-spacing:1px;margin-bottom:10px}
.dg{width:7px;height:7px;border-radius:50%;background:#22c55e}
.urlbox{background:var(--bg);border:1px solid var(--border);padding:9px 11px;font-family:var(--font-m);font-size:.55rem;color:var(--muted);word-break:break-all;line-height:1.6;margin-bottom:8px}
.steps{counter-reset:s}
.step{counter-increment:s;padding:9px 11px 9px 34px;border-left:2px solid var(--border);margin-bottom:7px;position:relative;font-size:.76rem;color:var(--text);line-height:1.6}
.step::before{content:counter(s);position:absolute;left:-13px;top:7px;width:24px;height:24px;background:var(--accent);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-m);font-size:.6rem;font-weight:700}
.step code{background:var(--alight);padding:1px 5px;font-family:var(--font-m);font-size:.68rem;color:var(--accent)}
.irow{display:flex;gap:7px;align-items:end}
.irow .field{flex:1;margin:0}
.irow button{flex-shrink:0;padding:10px 14px}

/* TOAST */
.toast{position:fixed;bottom:78px;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;padding:9px 18px;font-family:var(--font-m);font-size:.6rem;letter-spacing:1px;z-index:999;opacity:0;transition:opacity .3s;max-width:90vw;text-align:center}
.toast.show{opacity:1}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:30px auto}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.empty{text-align:center;padding:36px 18px;font-family:var(--font-m);font-size:.62rem;color:var(--muted);letter-spacing:1px;line-height:2}
.divline{height:1px;background:var(--border);margin:14px 0}
.pill{display:inline-block;background:var(--alight);color:var(--accent);font-family:var(--font-m);font-size:.5rem;padding:2px 7px;letter-spacing:1px;margin-left:6px;vertical-align:middle}
.pill.red{background:var(--rlight);color:var(--red)}
</style>
</head>
<body>

<header>
  <div class="hrow">
    <div class="logo">FELISHA<span> SACCO</span></div>
    <div class="dbadge" id="driverBadge" onclick="goSetup()">‚Äî TAP TO LOGIN ‚Äî</div>
  </div>
  <div class="hsub">// TRIP LOGGER &amp; REPORTS</div>
</header>

<main>
  <div id="page-log" class="page active"></div>
  <div id="page-reports" class="page"></div>
  <div id="page-admin" class="page"></div>

</main>

<nav class="bnav">
  <button class="nbtn active" id="nav-log" onclick="switchPage('log')">
    <span class="ni">üöå</span><span class="nl">LOG TRIP</span>
  </button>
  <button class="nbtn" id="nav-reports" onclick="switchPage('reports')">
    <span class="ni">üìä</span><span class="nl">REPORTS</span>
  </button>
  <button class="nbtn" id="nav-admin" onclick="switchPage('admin')">
    <span class="ni">üëë</span><span class="nl">ADMIN</span>
  </button>

</nav>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA (from your Google Form)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_DRIVERS = ['FESTUS KIPKURUI','TOM WASIKE','FELIX OTIENO','MUTUA KIRUI','JANETH TIONY','ABIGAEL CHEPKORIR','GRACE WANGECHI'];
const DEFAULT_CARS = ['KBZ 300','KBY 400','KBU 500','KCA 200','KDY 260W','KYA 520X','KAF 2601'];
const DEFAULT_STATIONS = [
  {name:'NAIROBI CBD',lat:-1.2833,lng:36.8167},
  {name:'WESTLANDS',lat:-1.2676,lng:36.8112},
  {name:'KAREN',lat:-1.3197,lng:36.7073},
  {name:'NGONG',lat:-1.3583,lng:36.6583},
  {name:'RONGAI',lat:-1.3944,lng:36.7452},
  {name:"LANG'ATA",lat:-1.3204,lng:36.7571},
  {name:'KIKUYU',lat:-1.2463,lng:36.6637},
  {name:'LIMURU',lat:-1.1095,lng:36.6431},
];
const ADMIN_PIN = '1234'; // Change this!

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE ‚Äî loaded from localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadCfg(key, def) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; }
}

let DRIVERS   = loadCfg('fs_drivers', DEFAULT_DRIVERS);
let CARS      = loadCfg('fs_cars', DEFAULT_CARS);
let STATIONS  = loadCfg('fs_stations', DEFAULT_STATIONS);
let localTrips = loadCfg('fs_trips', []);
let sheetTrips = [];
let appConfig  = loadCfg('fs_config', {appsScriptUrl:'', sheetCsvUrl:'https://docs.google.com/spreadsheets/d/162XUZwBJcpIc9m_011hzaBdbJY_I7Bf772aeJt7oQIs/pub?gid=0&single=true&output=csv'});

let tripState = {
  phase: 'setup', driver:'', carPlate:'',
  fromStation:null, toStation:null, amount:'',
  tripStart:null, tripEnd:null,
  gpsLat:null, gpsLng:null, gpsStatus:'unknown', nearestStation:null,
};
// Restore logged-in driver
const sd = loadCfg('fs_driver', null);
if (sd) { tripState.driver=sd.driver; tripState.carPlate=sd.carPlate; tripState.phase='idle'; }

let currentPage = 'log';
let reportFilter = 'all';
let adminTab = 'drivers';
let adminUnlocked = false;
let timerInterval = null;

function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(p) {
  currentPage = p;
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nbtn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  document.getElementById('nav-'+p).classList.add('active');
  if(p==='log') renderLog();
  if(p==='reports') renderReports();
  if(p==='admin') renderAdmin();

}
function goSetup() { tripState.phase='setup'; switchPage('log'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getGPS() {
  tripState.gpsStatus='detecting';
  if(!navigator.geolocation){tripState.gpsStatus='error';renderLog();return;}
  navigator.geolocation.getCurrentPosition(
    p=>{tripState.gpsLat=p.coords.latitude;tripState.gpsLng=p.coords.longitude;tripState.gpsStatus='ok';tripState.nearestStation=findNearest(tripState.gpsLat,tripState.gpsLng);renderLog();},
    ()=>{tripState.gpsStatus='error';renderLog();},
    {enableHighAccuracy:true,timeout:10000}
  );
}
function hav(a,b,c,d){const R=6371,dL=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}
function findNearest(lat,lng){let b=null,bd=Infinity;STATIONS.forEach(s=>{const d=hav(lat,lng,s.lat,s.lng);if(d<bd){bd=d;b={...s,dist:d};}});return b;}
function distKm(s){if(!tripState.gpsLat||!s)return null;return hav(tripState.gpsLat,tripState.gpsLng,s.lat,s.lng);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    const el=document.getElementById('timerVal');
    if(el&&tripState.tripStart){
      const s=Math.floor((Date.now()-tripState.tripStart)/1000);
      el.textContent=`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRIP ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveDriver(){
  const d=document.getElementById('selD')?.value, p=document.getElementById('selP')?.value;
  if(!d||!p){toast('SELECT DRIVER AND CAR PLATE');return;}
  tripState.driver=d;tripState.carPlate=p;tripState.phase='idle';
  save('fs_driver',{driver:d,carPlate:p});
  document.getElementById('driverBadge').textContent=d.split(' ')[0]+' ¬∑ '+p;
  getGPS();renderLog();
}
function selFrom(n){tripState.fromStation=STATIONS.find(s=>s.name===n);renderLog();}
function selTo(n){if(tripState.phase!=='arrived')return;tripState.toStation=STATIONS.find(s=>s.name===n);renderLog();}

function startTrip(){
  if(!tripState.fromStation){toast('SELECT YOUR STARTING STATION');return;}
  tripState.phase='active';tripState.tripStart=Date.now();tripState.toStation=null;
  renderLog();startTimer();toast('TRIP STARTED ‚Äî SAFE JOURNEY! üöå');
}
function arrive(){
  tripState.phase='arrived';tripState.tripEnd=Date.now();
  clearInterval(timerInterval);getGPS();renderLog();
  toast('ARRIVED ‚Äî SELECT DESTINATION & ENTER AMOUNT');
}
function endTrip(){
  const amt=parseFloat(document.getElementById('amtIn')?.value||'0');
  if(!tripState.toStation){toast('SELECT DESTINATION STATION');return;}
  if(!amt||amt<=0){toast('ENTER AMOUNT COLLECTED');return;}
  if(tripState.toStation.name===tripState.fromStation.name){toast('TO STATION MUST BE DIFFERENT');return;}
  const trip={
    id:Date.now(),driver:tripState.driver,carPlate:tripState.carPlate,
    fromStation:tripState.fromStation.name,toStation:tripState.toStation.name,
    amount:amt,duration:Math.floor((tripState.tripEnd-tripState.tripStart)/60000),
    date:new Date().toLocaleDateString('en-GB'),time:new Date().toLocaleTimeString(),
    timestamp:new Date().toISOString(),
  };
  localTrips.unshift(trip);save('fs_trips',localTrips.slice(0,200));
  tripState.amount=amt;tripState.phase='done';
  submitToSheets(trip);renderLog();
}
function newTrip(){
  const prev=tripState.toStation;
  tripState.phase='idle';tripState.fromStation=prev;tripState.toStation=null;
  tripState.amount='';tripState.tripStart=null;tripState.tripEnd=null;
  getGPS();renderLog();toast('READY FOR NEXT TRIP');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHEETS SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitToSheets(trip){
  if(!appConfig.appsScriptUrl){toast('‚ö† SAVED LOCALLY ‚Äî SET UP APPS SCRIPT IN SETTINGS');return;}
  try{
    const params=new URLSearchParams({date:trip.date,time:trip.time,fromStation:trip.fromStation,toStation:trip.toStation,driver:trip.driver,carPlate:trip.carPlate,amount:trip.amount,duration:trip.duration});
    await fetch(appConfig.appsScriptUrl+'?'+params.toString(),{method:'GET',mode:'no-cors'});
    toast('‚úÖ SYNCED TO GOOGLE SHEETS');
  }catch(e){toast('üíæ SAVED LOCALLY');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD SHEET DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSheetData(){
  if(!appConfig.sheetCsvUrl){toast('NO CSV URL IN SETTINGS');return;}
  document.getElementById('page-reports').innerHTML='<div class="spinner"></div>';
  try{
    let text=null;
    try{const r=await fetch(appConfig.sheetCsvUrl);if(r.ok)text=await r.text();}catch(_){}
    if(!text){const r2=await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(appConfig.sheetCsvUrl)}`);text=(await r2.json()).contents;}
    sheetTrips=parseCSV(text);
    toast('‚úÖ '+sheetTrips.length+' RECORDS LOADED');renderReports();
  }catch(e){toast('‚ö† COULD NOT LOAD DATA');renderReports();}
}

function parseCSV(text){
  const lines=text.trim().split('\n');
  const hdrs=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/[^a-z]/g,''));
  return lines.slice(1).map(line=>{
    const cols=line.split(',').map(c=>c.trim().replace(/^"|"$/g,''));
    const row={};hdrs.forEach((h,i)=>row[h]=cols[i]||'');
    return{
      date:row['date']||row['dateofduty']||row['timestamp']||'',
      time:row['time']||'',
      fromStation:row['fromstation']||row['from']||row['fromstation']||'',
      toStation:row['tostation']||row['to']||'',
      driver:row['drivername']||row['driversname']||row['driver']||'',
      carPlate:row['carplate']||row['carplate']||row['plate']||row['car']||'',
      amount:parseFloat((row['amountcollectedinkes']||row['amount']||'0').replace(/[^0-9.]/g,''))||0,
      duration:parseInt(row['duration']||'0')||0,
    };
  }).filter(r=>r.driver||r.carPlate);
}

function parseDate(str){
  if(!str)return null;let d=new Date(str);if(!isNaN(d))return d;
  const m=str.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
  if(m){const yr=m[3].length===2?'20'+m[3]:m[3];return new Date(`${yr}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`);}
  return null;
}

function filterTrips(trips){
  const now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return trips.filter(t=>{
    if(reportFilter==='all')return true;
    const d=parseDate(t.date);if(!d)return false;
    if(reportFilter==='today')return d>=today;
    if(reportFilter==='week'){const ws=new Date(today);ws.setDate(today.getDate()-today.getDay());return d>=ws;}
    if(reportFilter==='month')return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
    return true;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const all=[...sheetTrips,...localTrips];
  const filtered=filterTrips(all);
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=18;let y=M;
  doc.setFillColor(26,122,60);doc.rect(0,0,W,38,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('FELISHA SACCO',M,16);
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.text('TRIP REPORT ‚Äî '+reportFilter.toUpperCase(),M,24);doc.text('Generated: '+new Date().toLocaleString(),M,31);
  y=46;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:String(filtered.length)},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():'‚Äî'},{l:'UNIQUE CARS',v:String([...new Set(filtered.map(t=>t.carPlate))].length)}].forEach((b,i)=>{
    const bx=M+i*(bw+3);
    doc.setFillColor(245,250,245);doc.rect(bx,y,bw,20,'F');doc.setFillColor(26,122,60);doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(6);doc.setFont('helvetica','normal');doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26);doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0);doc.setFontSize(6.5);doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5);doc.text('DATE',M+10,y+5);doc.text('ROUTE',M+36,y+5);doc.text('DRIVER',M+90,y+5);doc.text('CAR',M+130,y+5);doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244]));doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80);doc.setFontSize(6.5);doc.setFont('helvetica','normal');doc.text(String(i+1),M+2,y+5);doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60);doc.setFont('helvetica','bold');doc.text((t.fromStation||'').slice(0,9)+'‚Üí'+(t.toStation||'').slice(0,9),M+36,y+5);
    doc.setTextColor(60,60,60);doc.setFont('helvetica','normal');doc.text((t.driver||'').slice(0,18),M+90,y+5);doc.text(t.carPlate||'',M+130,y+5);
    doc.setTextColor(20,100,60);doc.setFont('helvetica','bold');doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FELISHA SACCO ‚Äî CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  doc.save('felisha-report-'+reportFilter+'-'+new Date().toISOString().slice(0,10)+'.pdf');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLog(){
  const el=document.getElementById('page-log');
  if(currentPage!=='log')return;
  if(tripState.driver)document.getElementById('driverBadge').textContent=tripState.driver.split(' ')[0]+' ¬∑ '+tripState.carPlate;
  else document.getElementById('driverBadge').textContent='‚Äî TAP TO LOGIN ‚Äî';

  const gbar=tripState.gpsStatus==='detecting'
    ?`<div class="gbar"><span>üì°</span>DETECTING LOCATION...</div>`
    :tripState.gpsStatus==='ok'&&tripState.nearestStation
    ?`<div class="gbar"><span>üìç</span>NEAREST: ${tripState.nearestStation.name} (${tripState.nearestStation.dist.toFixed(1)} KM)</div>`
    :tripState.gpsStatus==='error'
    ?`<div class="gbar err"><span>‚ö†</span>GPS UNAVAILABLE ‚Äî MANUAL SELECT &nbsp;<span onclick="getGPS()" style="cursor:pointer;text-decoration:underline">RETRY</span></div>`
    :`<div class="gbar"><span>üì°</span><span onclick="getGPS()" style="cursor:pointer;text-decoration:underline">TAP TO DETECT LOCATION</span></div>`;

  if(tripState.phase==='setup'){
    el.innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle">DRIVER LOGIN</div>
        <div class="field"><label>Select Driver</label>
          <select id="selD"><option value="">‚Äî Choose Driver ‚Äî</option>
          ${DRIVERS.map(d=>`<option value="${d}" ${d===tripState.driver?'selected':''}>${d}</option>`).join('')}</select>
        </div>
        <div class="field"><label>Car Plate</label>
          <select id="selP"><option value="">‚Äî Choose Car ‚Äî</option>
          ${CARS.map(c=>`<option value="${c}" ${c===tripState.carPlate?'selected':''}>${c}</option>`).join('')}</select>
        </div>
        <button class="bb bstart" onclick="saveDriver()">BEGIN SHIFT</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  if(tripState.phase==='idle'){
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">START TRIP</div>
        <div class="csub">// SELECT YOUR STARTING STATION</div>
        ${gbar}
        <div class="field"><label>FROM STATION</label></div>
        <div class="sgrid">${STATIONS.map(s=>{
          const d=distKm(s),isN=tripState.nearestStation?.name===s.name;
          return`<div class="sbtn ${tripState.fromStation?.name===s.name?'sel':''}" onclick="selFrom('${s.name}')">
            ${s.name}${isN?' üìç':''}
            ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
          </div>`;
        }).join('')}</div>
        <button class="bb bstart" onclick="startTrip()" ${!tripState.fromStation?'disabled':''}>üöå START TRIP</button>
        <button class="bout" onclick="goSetup()">CHANGE DRIVER / CAR</button>
      </div>
      ${renderTodayHistory()}`;
    if(tripState.nearestStation&&!tripState.fromStation)setTimeout(()=>selFrom(tripState.nearestStation.name),100);
    return;
  }

  if(tripState.phase==='active'){
    const secs=tripState.tripStart?Math.floor((Date.now()-tripState.tripStart)/1000):0;
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">TRIP IN PROGRESS</div>
        <div class="csub">// DRIVE TO DESTINATION THEN TAP ARRIVE</div>
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr">‚Üí</div>
          <div class="rs"><div class="rl">TO</div><div class="rn" style="color:var(--muted)">DESTINATION</div></div>
        </div>
        <div class="tdisp">
          <div class="tl">TRIP DURATION</div>
          <div class="tv" id="timerVal">${String(Math.floor(secs/3600)).padStart(2,'0')}:${String(Math.floor((secs%3600)/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}</div>
        </div>
        <div class="lock"><div class="lico">üîí</div><div class="ltxt">DESTINATION LOCKED<br>ARRIVE AT STATION FIRST</div></div>
        <button class="bb barrive" onclick="arrive()">üìç I HAVE ARRIVED</button>
        <button class="bout" onclick="if(confirm('Cancel this trip?')){tripState.phase='idle';clearInterval(timerInterval);renderLog();}">CANCEL TRIP</button>
      </div>`;
    startTimer();return;
  }

  if(tripState.phase==='arrived'){
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">END TRIP</div>
        <div class="csub">// SELECT WHERE YOU ARRIVED & ENTER AMOUNT</div>
        ${gbar}
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr">‚Üí</div>
          <div class="rs"><div class="rl">TO</div><div class="rn">${tripState.toStation?tripState.toStation.name:'???'}</div></div>
        </div>
        <div class="field"><label>TO STATION (WHERE YOU ARRIVED)</label></div>
        <div class="sgrid">${STATIONS.map(s=>{
          const d=distKm(s),isN=tripState.nearestStation?.name===s.name,same=s.name===tripState.fromStation?.name;
          return`<div class="sbtn ${tripState.toStation?.name===s.name?'sel':''} ${same?'dis':''}" onclick="selTo('${s.name}')">
            ${s.name}${isN?' üìç':''}
            ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
          </div>`;
        }).join('')}</div>
        <div class="field"><label>AMOUNT COLLECTED IN KES</label></div>
        <div class="awrap">
          <span class="apfx">KES</span>
          <input type="number" class="ainput" id="amtIn" placeholder="0" min="0" value="${tripState.amount||''}">
        </div>
        <button class="bb bend" onclick="endTrip()" ${!tripState.toStation?'disabled':''}>‚úÖ SUBMIT TRIP</button>
      </div>`;
    if(tripState.nearestStation&&!tripState.toStation&&tripState.nearestStation.name!==tripState.fromStation?.name)setTimeout(()=>selTo(tripState.nearestStation.name),100);
    return;
  }

  if(tripState.phase==='done'){
    const last=localTrips[0];
    el.innerHTML=`
      <div class="scard">
        <div class="sico">‚úÖ</div>
        <div class="stitle">TRIP LOGGED!</div>
        <div class="sdetails">
          <div class="drow"><span>DRIVER</span><span>${last.driver}</span></div>
          <div class="drow"><span>CAR</span><span>${last.carPlate}</span></div>
          <div class="drow"><span>ROUTE</span><span>${last.fromStation} ‚Üí ${last.toStation}</span></div>
          <div class="drow"><span>DURATION</span><span>${last.duration} MIN</span></div>
          <div class="drow"><span>AMOUNT</span><span>KES ${Number(last.amount).toLocaleString()}</span></div>
          <div class="drow"><span>TIME</span><span>${last.time}</span></div>
        </div>
        <div class="ssub">${appConfig.appsScriptUrl?'‚úÖ SYNCED TO GOOGLE SHEETS':'üíæ SAVED LOCALLY'}</div>
      </div>
      <button class="bb bstart" onclick="newTrip()">üöå START NEXT TRIP</button>
      <button class="bout" onclick="goSetup()">END SHIFT</button>
      ${renderTodayHistory()}`;
    return;
  }
}

function renderTodayHistory(){
  const today=new Date().toLocaleDateString('en-GB');
  const tt=localTrips.filter(t=>t.date===today);
  if(!tt.length)return'';
  const tot=tt.reduce((s,t)=>s+t.amount,0);
  return`<div class="hsect">
    <div class="stitle2">TODAY'S TRIPS (${tt.length}) ¬∑ KES ${tot.toLocaleString()}</div>
    ${tt.slice(0,8).map(t=>`<div class="hitem">
      <div class="htop"><span class="hroute">${t.fromStation} ‚Üí ${t.toStation}</span><span class="hamt">KES ${Number(t.amount).toLocaleString()}</span></div>
      <div class="hbot"><span>${t.driver} ¬∑ ${t.carPlate}</span><span class="htime">${t.time}</span></div>
    </div>`).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports(){
  const el=document.getElementById('page-reports');
  const all=[...sheetTrips,...localTrips.filter(lt=>!sheetTrips.find(st=>st.time===lt.time&&st.driver===lt.driver))];
  const filtered=filterTrips(all);
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const avg=filtered.length?Math.round(total/filtered.length):0;
  const cars=[...new Set(filtered.map(t=>t.carPlate))];
  const now=new Date();now.setHours(0,0,0,0);
  const todayT=all.filter(t=>{const d=parseDate(t.date);return d&&d>=now;});

  el.innerHTML=`
    <div class="exprow">
      <button class="bsm bg" onclick="loadSheetData()">‚ü≥ SYNC FROM SHEET</button>
      <button class="bsm by" onclick="exportPDF()">‚¨á EXPORT PDF</button>
    </div>
    <div class="sgrid2">
      <div class="sbox"><div class="sl">TOTAL TRIPS</div><div class="sv green">${filtered.length}</div></div>
      <div class="sbox"><div class="sl">TOTAL REVENUE</div><div class="sv green" style="font-size:1.2rem">KES ${total.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">AVG / TRIP</div><div class="sv yellow" style="font-size:1.2rem">KES ${avg.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">TODAY'S TRIPS</div><div class="sv">${todayT.length}</div></div>
    </div>
    <div class="fchips">
      ${['all','today','week','month'].map(f=>`<div class="fchip ${reportFilter===f?'active':''}" onclick="reportFilter='${f}';renderReports()">${f==='all'?'ALL TIME':f.toUpperCase()}</div>`).join('')}
    </div>
    ${filtered.length===0?'<div class="empty">NO DATA YET<br>TAP ‚ü≥ SYNC FROM SHEET</div>':`
    <div class="rtable">
      <div class="rth"><span>ROUTE</span><span>DRIVER</span><span>TIME</span><span>AMOUNT</span></div>
      ${filtered.slice(0,60).map(t=>`<div class="rtr">
        <div><div class="trroute">${(t.fromStation||'').slice(0,8)}‚Üí${(t.toStation||'').slice(0,8)}</div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted)">${t.date||''}</div></div>
        <div><div class="trdrv">${(t.driver||'').split(' ')[0]}</div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted)">${t.carPlate||''}</div></div>
        <div class="trtm">${(t.time||'').slice(0,5)}</div>
        <div class="tramt">KES ${Number(t.amount||0).toLocaleString()}</div>
      </div>`).join('')}
    </div>`}
    ${cars.length?`<div class="stitle2" style="margin-bottom:9px">REVENUE BY CAR</div>
    ${cars.map(car=>{
      const ct=filtered.filter(t=>t.carPlate===car),cr=ct.reduce((s,t)=>s+t.amount,0),pct=total?Math.round((cr/total)*100):0;
      return`<div class="hitem" style="margin-bottom:7px">
        <div class="htop"><span class="hroute">${car}</span><span class="hamt">KES ${cr.toLocaleString()}</span></div>
        <div style="height:5px;background:var(--border);border-radius:3px;margin-top:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:var(--accent);border-radius:3px"></div></div>
        <div class="hbot" style="margin-top:4px"><span>${ct.length} trips</span><span>${pct}% of revenue</span></div>
      </div>`;
    }).join('')}`:''}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdmin(){
  const el=document.getElementById('page-admin');
  if(!adminUnlocked){
    el.innerHTML=`
      <div class="apinbox">
        <div class="apintitle">ADMIN ACCESS</div>
        <div class="apinsub">ENTER PIN TO MANAGE DRIVERS, CARS & STATIONS</div>
        <input type="password" class="pininput" id="pinIn" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')checkPin()">
        <button class="bb bstart" style="max-width:200px;margin:0 auto;display:block" onclick="checkPin()">UNLOCK</button>
      </div>`;
    return;
  }

  el.innerHTML=`
    <div class="card" style="border-left:4px solid var(--accent2);margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="ctitle" style="margin:0">ADMIN PANEL</div>
        <button class="bghost" onclick="adminUnlocked=false;renderAdmin()">üîí LOCK</button>
      </div>
    </div>
    <div class="atabs">
      <button class="atab ${adminTab==='drivers'?'active':''}" onclick="adminTab='drivers';renderAdmin()">DRIVERS</button>
      <button class="atab ${adminTab==='cars'?'active':''}" onclick="adminTab='cars';renderAdmin()">CARS</button>
      <button class="atab ${adminTab==='stations'?'active':''}" onclick="adminTab='stations';renderAdmin()">STATIONS</button>
      <button class="atab ${adminTab==='config'?'active':''}" onclick="adminTab='config';renderAdmin()">CONFIG</button>
      <button class="atab ${adminTab==='settings'?'active':''}" onclick="adminTab='settings';renderAdmin()">SETTINGS</button>
    </div>

    <div id="asect-drivers" class="asect ${adminTab==='drivers'?'active':''}">
      <div class="card">
        <div class="ctitle">MANAGE DRIVERS <span class="pill">${DRIVERS.length}</span></div>
        <div class="alist">
          ${DRIVERS.map((d,i)=>`<div class="aitem">
            <div><div class="aitem-name">${d}</div><div class="aitem-sub">DRIVER #${i+1}</div></div>
            <button class="adel" onclick="removeDriver(${i})" title="Remove">‚úï</button>
          </div>`).join('')}
        </div>
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Driver Name</label><input type="text" id="newDriver" placeholder="FULL NAME IN CAPS"></div>
          <button class="bsm bg" onclick="addDriver()">ADD</button>
        </div>
      </div>
    </div>

    <div id="asect-cars" class="asect ${adminTab==='cars'?'active':''}">
      <div class="card">
        <div class="ctitle">MANAGE CARS <span class="pill">${CARS.length}</span></div>
        <div class="alist">
          ${CARS.map((c,i)=>`<div class="aitem">
            <div><div class="aitem-name">${c}</div><div class="aitem-sub">CAR #${i+1}</div></div>
            <button class="adel" onclick="removeCar(${i})">‚úï</button>
          </div>`).join('')}
        </div>
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Car Plate</label><input type="text" id="newCar" placeholder="e.g. KCA 123A"></div>
          <button class="bsm bg" onclick="addCar()">ADD</button>
        </div>
      </div>
    </div>

    <div id="asect-stations" class="asect ${adminTab==='stations'?'active':''}">
      <div class="card">
        <div class="ctitle">MANAGE STATIONS <span class="pill">${STATIONS.length}</span></div>
        <div class="alist">
          ${STATIONS.map((s,i)=>`<div class="aitem">
            <div><div class="aitem-name">${s.name}</div><div class="aitem-sub">${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}</div></div>
            <button class="adel" onclick="removeStation(${i})">‚úï</button>
          </div>`).join('')}
        </div>
        <div class="divline"></div>
        <div class="field"><label>Station Name</label><input type="text" id="newStn" placeholder="STATION NAME IN CAPS"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px">
          <div class="field" style="margin:0"><label>Latitude</label><input type="number" id="newLat" placeholder="-1.2833" step="any"></div>
          <div class="field" style="margin:0"><label>Longitude</label><input type="number" id="newLng" placeholder="36.8167" step="any"></div>
        </div>
        <button class="bsm bg" style="width:100%;padding:10px" onclick="addStation()">ADD STATION</button>
      </div>
    </div>

    <div id="asect-config" class="asect ${adminTab==='config'?'active':''}">
      <div class="card">
        <div class="ctitle">SYSTEM CONFIG</div>
        <div class="csub">// CHANGE ADMIN PIN</div>
        <div class="addrow">
          <div class="field"><label>New PIN (4-6 digits)</label><input type="password" id="newPin" placeholder="New PIN" maxlength="6"></div>
          <button class="bsm bg" onclick="changePin()">SAVE</button>
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// RESET TO DEFAULTS</div>
        <button class="bout" onclick="resetToDefaults()">RESET ALL DATA TO DEFAULTS</button>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// LOCAL TRIP DATA</div>
        <p style="font-size:.75rem;color:var(--muted);margin-bottom:9px">${localTrips.length} trips stored on this device.</p>
        <button class="bout" onclick="if(confirm('Clear all local trip data?')){localTrips=[];save('fs_trips',[]);toast('CLEARED');renderAdmin();}">CLEAR LOCAL TRIP DATA</button>
      </div>

    <div id="asect-settings" class="asect ${adminTab==='settings'?'active':''}">
      <div class="card">
        <div class="ctitle">SHEET CONNECTION</div>
        <div class="csub">// DEVELOPER ONLY ‚Äî CONNECT TO GOOGLE SHEET</div>
        <div style="margin-bottom:14px">
          <div class="stitle2">APPS SCRIPT URL (SEND DATA TO SHEET)</div>
          ${appConfig.appsScriptUrl?`<div class="conn-badge"><div class="dg"></div>CONNECTED</div><div class="urlbox">${appConfig.appsScriptUrl}</div>`:''}
          <div class="irow">
            <div class="field"><label>Web App URL</label><input type="text" id="scrUrl" placeholder="https://script.google.com/macros/s/.../exec" value="${appConfig.appsScriptUrl||''}"></div>
            <button class="bsm bg" onclick="saveScriptUrl()">SAVE</button>
          </div>
        </div>
        <div class="divline"></div>
        <div>
          <div class="stitle2">CSV URL (PULL REPORTS FROM SHEET)</div>
          ${appConfig.sheetCsvUrl?`<div class="conn-badge"><div class="dg"></div>URL SET</div>`:''}
          <div class="irow">
            <div class="field"><label>Published CSV URL</label><input type="text" id="csvUrl" value="${appConfig.sheetCsvUrl||''}" placeholder="...pub?output=csv"></div>
            <button class="bsm bg" onclick="saveCsvUrl()">SAVE</button>
          </div>
          <p style="font-size:.7rem;color:var(--muted);margin-top:8px;line-height:1.7">In Google Sheets ‚Üí <strong>File ‚Üí Share ‚Üí Publish to web</strong> ‚Üí Select sheet ‚Üí Choose <strong>CSV</strong> ‚Üí Copy URL ‚Üí Paste above.</p>
        </div>
      </div>
      <div class="card">
        <div class="ctitle">SETUP GUIDE</div>
        <div class="steps">
          <div class="step">Open your Google Sheet ‚Üí click <code>Extensions</code> ‚Üí <code>Apps Script</code></div>
          <div class="step">Delete all code ‚Üí paste the <strong>apps-script.js</strong> code ‚Üí Save (üíæ)</div>
          <div class="step">Click <code>Deploy</code> ‚Üí <code>New deployment</code> ‚Üí Select <code>Web app</code></div>
          <div class="step">Execute as: <code>Me</code> | Who has access: <code>Anyone</code> ‚Üí Deploy ‚Üí Authorize</div>
          <div class="step">Copy the Web App URL ‚Üí paste in Apps Script URL above ‚Üí SAVE</div>
          <div class="step">In Google Sheets ‚Üí <code>File ‚Üí Share ‚Üí Publish to web</code> ‚Üí CSV ‚Üí Copy URL ‚Üí paste in CSV URL ‚Üí SAVE</div>
        </div>
      </div>
    </div>

    </div>`;
}

function checkPin(){
  const pin=document.getElementById('pinIn')?.value;
  const storedPin=localStorage.getItem('fs_pin')||ADMIN_PIN;
  if(pin===storedPin){adminUnlocked=true;renderAdmin();}
  else{toast('WRONG PIN');}
}

function addDriver(){
  const n=(document.getElementById('newDriver')?.value||'').trim().toUpperCase();
  if(!n){toast('ENTER DRIVER NAME');return;}
  if(DRIVERS.includes(n)){toast('DRIVER ALREADY EXISTS');return;}
  DRIVERS.push(n);save('fs_drivers',DRIVERS);toast('DRIVER ADDED ‚úÖ');renderAdmin();
}
function removeDriver(i){
  if(!confirm('Remove '+DRIVERS[i]+'?'))return;
  DRIVERS.splice(i,1);save('fs_drivers',DRIVERS);renderAdmin();
}
function addCar(){
  const n=(document.getElementById('newCar')?.value||'').trim().toUpperCase();
  if(!n){toast('ENTER CAR PLATE');return;}
  if(CARS.includes(n)){toast('CAR ALREADY EXISTS');return;}
  CARS.push(n);save('fs_cars',CARS);toast('CAR ADDED ‚úÖ');renderAdmin();
}
function removeCar(i){
  if(!confirm('Remove '+CARS[i]+'?'))return;
  CARS.splice(i,1);save('fs_cars',CARS);renderAdmin();
}
function addStation(){
  const n=(document.getElementById('newStn')?.value||'').trim().toUpperCase();
  const lat=parseFloat(document.getElementById('newLat')?.value||'');
  const lng=parseFloat(document.getElementById('newLng')?.value||'');
  if(!n){toast('ENTER STATION NAME');return;}
  if(isNaN(lat)||isNaN(lng)){toast('ENTER VALID COORDINATES');return;}
  STATIONS.push({name:n,lat,lng});save('fs_stations',STATIONS);toast('STATION ADDED ‚úÖ');renderAdmin();
}
function removeStation(i){
  if(!confirm('Remove '+STATIONS[i].name+'?'))return;
  STATIONS.splice(i,1);save('fs_stations',STATIONS);renderAdmin();
}
function changePin(){
  const p=document.getElementById('newPin')?.value||'';
  if(p.length<4){toast('PIN MUST BE AT LEAST 4 DIGITS');return;}
  localStorage.setItem('fs_pin',p);toast('PIN UPDATED ‚úÖ');
}
function resetToDefaults(){
  if(!confirm('Reset ALL data to defaults? This cannot be undone.'))return;
  DRIVERS=[...DEFAULT_DRIVERS];CARS=[...DEFAULT_CARS];STATIONS=[...DEFAULT_STATIONS];
  save('fs_drivers',DRIVERS);save('fs_cars',CARS);save('fs_stations',STATIONS);
  toast('RESET COMPLETE');renderAdmin();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings(){
  // Settings are now rendered inside Admin panel
  return;
  const el=document.getElementById('page-settings');
  el.innerHTML=`
    <div class="card">
      <div class="ctitle">SHEET CONNECTION</div>
      <div class="csub">// CONNECT TO YOUR GOOGLE SHEET</div>
      <div style="margin-bottom:14px">
        <div class="stitle2">APPS SCRIPT URL (SEND DATA TO SHEET)</div>
        ${appConfig.appsScriptUrl?`<div class="conn-badge"><div class="dg"></div>CONNECTED</div><div class="urlbox">${appConfig.appsScriptUrl}</div>`:''}
        <div class="irow">
          <div class="field"><label>Web App URL</label><input type="text" id="scrUrl" placeholder="https://script.google.com/macros/s/.../exec" value="${appConfig.appsScriptUrl||''}"></div>
          <button class="bsm bg" onclick="saveScriptUrl()">SAVE</button>
        </div>
      </div>
      <div class="divline"></div>
      <div>
        <div class="stitle2">CSV URL (PULL REPORTS FROM SHEET)</div>
        ${appConfig.sheetCsvUrl?`<div class="conn-badge"><div class="dg"></div>URL SET</div>`:''}
        <div class="irow">
          <div class="field"><label>Published CSV URL</label><input type="text" id="csvUrl" value="${appConfig.sheetCsvUrl||''}" placeholder="...pub?output=csv"></div>
          <button class="bsm bg" onclick="saveCsvUrl()">SAVE</button>
        </div>
        <p style="font-size:.7rem;color:var(--muted);margin-top:8px;line-height:1.7">In Google Sheets ‚Üí <strong>File ‚Üí Share ‚Üí Publish to web</strong> ‚Üí Select sheet ‚Üí Choose <strong>CSV</strong> ‚Üí Copy URL ‚Üí Paste above.</p>
      </div>
    </div>

    <div class="card">
      <div class="ctitle">SETUP GUIDE</div>
      <div class="steps">
        <div class="step">Open your Google Sheet ‚Üí click <code>Extensions</code> ‚Üí <code>Apps Script</code></div>
        <div class="step">Delete all code ‚Üí paste the <strong>apps-script.js</strong> code ‚Üí Save (üíæ)</div>
        <div class="step">Click <code>Deploy</code> ‚Üí <code>New deployment</code> ‚Üí Select <code>Web app</code></div>
        <div class="step">Execute as: <code>Me</code> | Who has access: <code>Anyone</code> ‚Üí Deploy ‚Üí Authorize</div>
        <div class="step">Copy the Web App URL ‚Üí paste in Apps Script URL above ‚Üí SAVE</div>
        <div class="step">In Google Sheets ‚Üí <code>File ‚Üí Share ‚Üí Publish to web</code> ‚Üí Select sheet ‚Üí CSV ‚Üí Copy URL ‚Üí paste in CSV URL above ‚Üí SAVE</div>
      </div>
    </div>`;
}

function saveScriptUrl(){
  appConfig.appsScriptUrl=(document.getElementById('scrUrl')?.value||'').trim();
  save('fs_config',appConfig);toast(appConfig.appsScriptUrl?'‚úÖ APPS SCRIPT URL SAVED':'URL CLEARED');renderSettings();
}
function saveCsvUrl(){
  appConfig.sheetCsvUrl=(document.getElementById('csvUrl')?.value||'').trim();
  save('fs_config',appConfig);toast(appConfig.sheetCsvUrl?'‚úÖ CSV URL SAVED':'URL CLEARED');renderSettings();
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
if(tripState.driver)document.getElementById('driverBadge').textContent=tripState.driver.split(' ')[0]+' ¬∑ '+tripState.carPlate;
renderLog();
if(tripState.phase==='idle')getGPS();
</script>
</body>
</html>
