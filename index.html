<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FESTUS SACCO">
<meta name="theme-color" content="#1a7a3c" id="themeColorMeta">
<meta name="description" content="SACCO trip logging and fleet management">
<link rel="manifest" href="manifest.json">
<!-- Apple Touch Icons (inline SVG fallback) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%231a7a3c'/><text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-family='Arial Black,sans-serif' font-weight='900' font-size='110' fill='%23f0a500'>F</text></svg>">
<title>FESTUS SACCO</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f7f5;--card:#fff;--surface:#eef2ee;--border:#dde8dd;
  --accent:#1a7a3c;--alight:#e8f5ed;--accent2:#f0a500;
  --red:#e53935;--rlight:#fdecea;--text:#1a2e1a;--muted:#6a8a6a;
  --shadow:0 2px 16px rgba(26,122,60,.10);--shlg:0 8px 32px rgba(26,122,60,.15);
  --font-d:'Bebas Neue',sans-serif;--font-m:'Space Mono',monospace;--font-b:'DM Sans',sans-serif;
}
[data-theme="dark"]{
  --bg:#0d1410;--card:#141f18;--surface:#1a2820;--border:#2a3e2e;
  --accent:#22c55e;--alight:#0d2a1a;--accent2:#f0a500;
  --red:#ef4444;--rlight:#2a0f0f;--text:#e0f0e4;--muted:#5a8a6a;
  --shadow:0 2px 16px rgba(0,0,0,.4);--shlg:0 8px 32px rgba(0,0,0,.5);
}
body{background:var(--bg);color:var(--text);font-family:var(--font-b);min-height:100vh;max-width:480px;margin:0 auto;transition:background .3s,color .3s}

/* HEADER */
header{background:var(--accent);padding:13px 16px 10px;position:sticky;top:0;z-index:100}
.hrow{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
.logo{font-family:var(--font-d);font-size:1.6rem;letter-spacing:3px;color:#fff}
.logo span{color:var(--accent2)}
.hright{display:flex;align-items:center;gap:7px}
.hsub{font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.6);letter-spacing:2px;display:flex;align-items:center;gap:10px}
.dbadge{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);padding:4px 9px;font-family:var(--font-m);font-size:.52rem;color:#fff;letter-spacing:1px;cursor:pointer;transition:background .2s;white-space:nowrap}
.dbadge:hover{background:rgba(255,255,255,.25)}
.hico{background:rgba(255,255,255,.15);border:none;color:#fff;width:28px;height:28px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0}
.hico:hover{background:rgba(255,255,255,.3)}
.offline-badge{background:#ef4444;color:#fff;font-family:var(--font-m);font-size:.46rem;padding:2px 6px;letter-spacing:1px;display:none}
.offline-badge.show{display:inline-block}
.sync-timer{font-family:var(--font-m);font-size:.46rem;color:rgba(255,255,255,.55);letter-spacing:1px;white-space:nowrap}
/* Session bar: hidden by default, only shown in last 5 minutes */
.session-bar{font-family:var(--font-m);font-size:.46rem;color:rgba(255,220,100,.9);letter-spacing:1px;white-space:nowrap;display:none}
.session-bar.show{display:inline}
.session-bar.warn{color:#ff6b6b;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* NAV */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:100;transition:background .3s}
.nbtn{padding:9px 4px;text-align:center;cursor:pointer;border:none;background:transparent;transition:background .15s}
.nbtn.active{background:var(--alight)}
.nbtn .ni{font-size:1.15rem;display:block;margin-bottom:1px}
.nbtn .nl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.nbtn.active .nl{color:var(--accent)}

main{padding:13px 13px 74px}
.page{display:none}.page.active{display:block}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);animation:fadeUp .3s ease;transition:background .3s,border-color .3s}
.ctitle{font-family:var(--font-d);font-size:1.2rem;color:var(--accent);letter-spacing:2px;margin-bottom:4px}
.csub{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;margin-bottom:13px}

/* FIELD */
.field{margin-bottom:10px}
.field label{display:block;font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.field select,.field input,.field textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;transition:border-color .2s;appearance:none}
.field textarea{resize:vertical;min-height:66px;font-size:.82rem}
.field select:focus,.field input:focus,.field textarea:focus{border-color:var(--accent)}

/* STATION GRID */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px}
.sbtn{background:var(--bg);border:2px solid var(--border);padding:10px 7px;text-align:center;cursor:pointer;transition:all .2s;font-family:var(--font-b);font-size:.72rem;color:var(--text);font-weight:500;position:relative}
.sbtn:hover{border-color:var(--accent);color:var(--accent);background:var(--alight)}
.sbtn.sel{border-color:var(--accent);background:var(--accent);color:#fff}
.sbtn.dis{opacity:.22;cursor:not-allowed;pointer-events:none}
.sbtn.nearest{border-color:var(--accent2)}
.sbtn .dist{display:block;font-family:var(--font-m);font-size:.44rem;opacity:.7;margin-top:2px}
.sbtn.sel .dist{opacity:.8}

/* GPS BAR */
.gbar{display:flex;align-items:center;gap:7px;padding:8px 10px;background:var(--alight);border:1px solid var(--border);margin-bottom:11px;font-family:var(--font-m);font-size:.52rem;color:var(--accent);letter-spacing:1px}
.gbar.err{background:var(--rlight);border-color:var(--red);color:var(--red)}
.gbar.detecting{background:var(--surface);border-color:var(--border);color:var(--muted)}

/* ROUTE DISPLAY */
.rdisp{display:flex;align-items:center;gap:10px;padding:12px;background:var(--alight);border:1px solid var(--border);margin-bottom:12px}
.rs{flex:1;text-align:center}
.rs .rn{font-family:var(--font-m);font-size:.66rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.rs .rl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:2px}
.rarr{font-size:1.3rem;color:var(--accent)}

/* TIMER */
.tdisp{text-align:center;padding:13px;background:var(--text);color:var(--bg);margin-bottom:12px;transition:background .3s}
.tl{font-family:var(--font-m);font-size:.48rem;letter-spacing:2px;color:rgba(128,200,128,.7);text-transform:uppercase;margin-bottom:3px}
.tv{font-family:var(--font-d);font-size:2.5rem;letter-spacing:3px;color:#22c55e}

/* SPEED BADGE */
.speed-badge{display:inline-flex;align-items:center;gap:6px;background:var(--alight);border:1px solid var(--border);padding:6px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-bottom:10px}
.speed-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0}
.speed-dot.moving{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25)}

/* AMOUNT */
.awrap{position:relative;margin-bottom:12px}
.apfx{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-family:var(--font-m);font-size:.72rem;color:var(--muted);font-weight:700}
.ainput{width:100%;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:12px 12px 12px 48px;font-family:var(--font-m);font-size:1.1rem;font-weight:700;outline:none;transition:border-color .2s;letter-spacing:1px}
.ainput:focus{border-color:var(--accent)}

/* LOCK */
.lock{padding:15px;background:var(--surface);border:2px dashed var(--border);text-align:center;margin-bottom:12px}
.lico{font-size:1.6rem;margin-bottom:4px;opacity:.3}
.ltxt{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;line-height:1.8;text-transform:uppercase}

/* CONFIRM */
.confirm-card{background:var(--surface);border:2px solid var(--accent);padding:18px;margin-bottom:14px;animation:fadeUp .3s ease}
.confirm-title{font-family:var(--font-d);font-size:1.6rem;color:var(--accent);letter-spacing:3px;text-align:center;margin-bottom:16px}
.confirm-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.confirm-row:last-child{border-bottom:none}
.confirm-label{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase}
.confirm-val{font-family:var(--font-m);font-size:.72rem;color:var(--text);font-weight:700;text-align:right;max-width:60%}
.confirm-amount{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:2px}
.confirm-warn{background:rgba(240,165,0,.12);border:1px solid var(--accent2);padding:9px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent2);letter-spacing:1px;margin-bottom:12px;text-align:center}

/* SHIFT */
.shift-open{background:#22c55e;color:#fff;font-family:var(--font-m);font-size:.5rem;padding:2px 8px;letter-spacing:1px;display:inline-block}
.shift-closed{background:var(--red);color:#fff;font-family:var(--font-m);font-size:.5rem;padding:2px 8px;letter-spacing:1px;display:inline-block}
.shift-block{background:var(--rlight);border:2px solid var(--red);padding:20px;text-align:center;margin-bottom:12px}
.shift-block-title{font-family:var(--font-d);font-size:1.4rem;color:var(--red);letter-spacing:2px;margin-bottom:6px}
.shift-block-sub{font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:1.8}

/* PIN LOCKOUT */
.pin-locked{background:var(--rlight);border:1px solid var(--red);padding:10px 13px;font-family:var(--font-m);font-size:.58rem;color:var(--red);letter-spacing:1px;text-align:center;margin-bottom:10px}

/* BUTTONS */
.bb{width:100%;padding:13px;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;cursor:pointer;border:none;transition:all .2s;margin-bottom:7px}
.bstart{background:var(--accent);color:#fff}.bstart:hover{background:#156632}.bstart:disabled{background:var(--muted);cursor:not-allowed}
.barrive{background:var(--accent2);color:#fff}.barrive:hover{background:#d4920a}
.bend{background:var(--red);color:#fff}.bend:hover{background:#c0392b}.bend:disabled{background:var(--muted);cursor:not-allowed}
.bconfirm{background:#22c55e;color:#fff}.bconfirm:hover{background:#16a34a}
.bout{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.6rem;letter-spacing:1px;padding:9px;width:100%;cursor:pointer;margin-bottom:7px;transition:all .2s}
.bout:hover{border-color:var(--red);color:var(--red)}
.bsm{padding:7px 12px;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;cursor:pointer;border:none;transition:all .2s}
.bg{background:var(--accent);color:#fff}.by{background:var(--accent2);color:#fff}.br{background:var(--red);color:#fff}.bgray{background:var(--muted);color:#fff}
.bwa{background:#25D366;color:#fff}
.bghost{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.54rem;padding:7px 12px;cursor:pointer;transition:all .2s}
.bghost:hover{border-color:var(--accent);color:var(--accent)}

/* SUCCESS */
.scard{background:var(--accent);color:#fff;padding:20px 16px;text-align:center;margin-bottom:12px;box-shadow:var(--shlg);animation:fadeUp .4s ease}
.sico{font-size:2.2rem;margin-bottom:8px}
.stitle{font-family:var(--font-d);font-size:1.7rem;letter-spacing:3px;margin-bottom:5px}
.ssub{font-family:var(--font-m);font-size:.54rem;opacity:.8;letter-spacing:1px;line-height:1.8}
.sdetails{background:rgba(255,255,255,.15);padding:11px;margin:12px 0}
.drow{display:flex;justify-content:space-between;font-family:var(--font-m);font-size:.56rem;margin-bottom:4px}
.drow:last-child{margin-bottom:0}

/* HISTORY */
.hsect{margin-top:6px}
.stitle2{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.hitem{background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:7px;box-shadow:0 1px 4px rgba(0,0,0,.04);transition:background .3s}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.hroute{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.hamt{font-family:var(--font-m);font-size:.61rem;color:#22c55e;font-weight:700}
.hbot{display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted)}
.htime{font-family:var(--font-m);font-size:.5rem}

/* SHIFT SUMMARY */
.sumcard{background:var(--surface);border:1px solid var(--border);padding:14px;margin-bottom:12px}
.sumrow{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border)}
.sumrow:last-child{border-bottom:none}
.sumlbl{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.sumval{font-family:var(--font-d);font-size:1.3rem;color:var(--accent)}

/* REPORTS */
.sgrid2{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.sbox{background:var(--card);border:1px solid var(--border);padding:13px;box-shadow:var(--shadow);transition:background .3s}
.sbox .sl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.sbox .sv{font-family:var(--font-d);font-size:1.6rem;color:var(--text);line-height:1}
.sv.green{color:var(--accent)}.sv.yellow{color:var(--accent2)}
.fchips{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.fchip{background:var(--bg);border:1px solid var(--border);padding:4px 9px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;cursor:pointer;color:var(--muted);transition:all .15s;text-transform:uppercase}
.fchip.active{background:var(--accent);border-color:var(--accent);color:#fff}
.rtable{background:var(--card);border:1px solid var(--border);overflow:hidden;margin-bottom:10px;transition:background .3s}
.rth{display:grid;grid-template-columns:1fr 1fr 55px 72px;padding:7px 10px;background:var(--accent);font-family:var(--font-m);font-size:.44rem;color:#fff;letter-spacing:1px;text-transform:uppercase;gap:4px}
.rtr{display:grid;grid-template-columns:1fr 1fr 55px 72px;padding:9px 10px;border-bottom:1px solid var(--border);font-size:.66rem;gap:4px;align-items:center;transition:background .1s}
.rtr:hover{background:var(--alight)}.rtr:last-child{border-bottom:none}
.trroute{font-family:var(--font-m);font-size:.53rem;color:var(--accent);font-weight:700}
.tramt{font-family:var(--font-m);font-size:.58rem;color:#22c55e;font-weight:700;text-align:right}
.exprow{display:flex;gap:6px;margin-bottom:11px;flex-wrap:wrap}
.exprow button{flex:1;min-width:55px}

/* REPORT TABS */
.rtabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--border);overflow-x:auto}
.rtab{font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;padding:8px 12px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase;white-space:nowrap;margin-bottom:-2px}
.rtab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rsect{display:none}.rsect.active{display:block}

/* CHARTS */
.chart-wrap{background:var(--card);border:1px solid var(--border);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.chart-title{font-family:var(--font-m);font-size:.52rem;color:var(--accent);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px}
.chart-canvas{height:200px;position:relative}

/* LEADERBOARD */
.lb-item{display:grid;grid-template-columns:30px 1fr auto;gap:10px;align-items:center;padding:11px 12px;background:var(--card);border:1px solid var(--border);margin-bottom:7px;box-shadow:var(--shadow)}
.lb-rank{font-family:var(--font-d);font-size:1.4rem;color:var(--muted);text-align:center}
.lb-rank.g{color:#f0a500}.lb-rank.s{color:#9ca3af}.lb-rank.b{color:#b87333}
.lb-name{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--text);letter-spacing:1px}
.lb-sub{font-size:.6rem;color:var(--muted);margin-top:2px}
.lb-val{font-family:var(--font-d);font-size:1.3rem;color:var(--accent);text-align:right}
.lb-vsub{font-family:var(--font-m);font-size:.46rem;color:var(--muted);text-align:right;margin-top:2px}
.bar-mini{height:4px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden}
.bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 1s}
.target-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:5px}
.target-fill{height:100%;border-radius:3px;transition:width 1s}
.target-fill.low{background:var(--red)}.target-fill.mid{background:var(--accent2)}.target-fill.high{background:#22c55e}

/* PERFORMANCE */
.perf-card{background:var(--card);border:1px solid var(--border);padding:14px;margin-bottom:10px;box-shadow:var(--shadow)}
.perf-name{font-family:var(--font-d);font-size:1.05rem;color:var(--text);letter-spacing:2px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.score-badge{font-family:var(--font-d);font-size:1rem;padding:2px 9px;letter-spacing:2px}
.score-a{background:#22c55e;color:#fff}.score-b{background:var(--accent2);color:#fff}.score-c{background:var(--red);color:#fff}
.perf-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.pstat{text-align:center;padding:9px 6px;background:var(--surface);border:1px solid var(--border)}
.pstat .pl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.pstat .pv{font-family:var(--font-d);font-size:1.15rem;color:var(--accent)}

/* ADMIN */
.apinbox{text-align:center;padding:40px 16px}
.apintitle{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:3px;margin-bottom:7px}
.apinsub{font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;margin-bottom:18px;line-height:1.8}
.pininput{width:180px;text-align:center;font-family:var(--font-m);font-size:1.5rem;letter-spacing:8px;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:13px;outline:none;margin:0 auto 14px;display:block}
.pininput:focus{border-color:var(--accent)}
.atabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--border);overflow-x:auto}
.atab{font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:8px 10px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase;white-space:nowrap;margin-bottom:-2px}
.atab.active{color:var(--accent);border-bottom-color:var(--accent)}
.asect{display:none}.asect.active{display:block}
.aitem{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--card);border:1px solid var(--border);margin-bottom:6px;transition:background .3s}
.aitem-name{font-family:var(--font-m);font-size:.68rem;color:var(--text);font-weight:700;letter-spacing:1px}
.aitem-sub{font-size:.62rem;color:var(--muted);margin-top:2px}
.abtn-row{display:flex;gap:5px;flex-shrink:0}
.adel{background:none;border:1px solid var(--border);cursor:pointer;font-size:.72rem;color:var(--muted);padding:4px 8px;transition:all .2s}
.adel:hover{color:var(--red);border-color:var(--red)}
.aedit{background:none;border:1px solid var(--border);cursor:pointer;font-size:.72rem;color:var(--muted);padding:4px 8px;transition:all .2s}
.aedit:hover{color:var(--accent);border-color:var(--accent)}
.addrow{display:flex;gap:7px;align-items:end;margin-top:10px}
.addrow .field{flex:1;margin:0}
.irow{display:flex;gap:7px;align-items:end}
.irow .field{flex:1;margin:0}
.conn-badge{display:inline-flex;align-items:center;gap:5px;background:var(--alight);border:1px solid var(--accent);padding:4px 10px;font-family:var(--font-m);font-size:.5rem;color:var(--accent);letter-spacing:1px;margin-bottom:8px}
.dg{width:7px;height:7px;border-radius:50%;background:#22c55e}
.urlbox{background:var(--bg);border:1px solid var(--border);padding:8px 10px;font-family:var(--font-m);font-size:.5rem;color:var(--muted);word-break:break-all;line-height:1.6;margin-bottom:7px}
.steps{counter-reset:s}
.step{counter-increment:s;padding:8px 10px 8px 32px;border-left:2px solid var(--border);margin-bottom:7px;position:relative;font-size:.74rem;color:var(--text);line-height:1.6}
.step::before{content:counter(s);position:absolute;left:-12px;top:6px;width:22px;height:22px;background:var(--accent);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-m);font-size:.56rem;font-weight:700}
.step code{background:var(--alight);padding:1px 5px;font-family:var(--font-m);font-size:.64rem;color:var(--accent)}

/* SESSION TIMEOUT OVERLAY */
.timeout-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.timeout-overlay.open{display:flex}
.timeout-box{background:var(--card);border:3px solid var(--accent2);padding:30px 24px;text-align:center;max-width:320px;width:100%;animation:fadeUp .3s ease}
.timeout-title{font-family:var(--font-d);font-size:2rem;color:var(--accent2);letter-spacing:3px;margin-bottom:8px}
.timeout-sub{font-family:var(--font-m);font-size:.6rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:18px}
.timeout-count{font-family:var(--font-d);font-size:3rem;color:var(--red);letter-spacing:3px;margin-bottom:16px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-top:3px solid var(--accent);padding:22px;width:100%;max-width:380px;animation:fadeUp .3s ease;max-height:90vh;overflow-y:auto}
.modal-title{font-family:var(--font-d);font-size:1.4rem;color:var(--accent);letter-spacing:2px;margin-bottom:14px}
.modal-actions{display:flex;gap:8px;margin-top:14px}
.modal-actions button{flex:1}

/* SHIFT CLOSE SUMMARY MODAL */
.shift-summary-modal .modal{border-top-color:var(--red)}
.shift-sum-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-family:var(--font-m);font-size:.62rem}
.shift-sum-row:last-child{border-bottom:none}
.shift-sum-total{font-family:var(--font-d);font-size:1.6rem;color:var(--accent);margin-top:10px;text-align:center}

/* MISC */
.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:9px 16px;font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;z-index:999;opacity:0;transition:opacity .3s;max-width:90vw;text-align:center}
.toast.show{opacity:1}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:30px auto}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.empty{text-align:center;padding:30px 14px;font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:2}
.divline{height:1px;background:var(--border);margin:12px 0}
.pill{display:inline-block;background:var(--alight);color:var(--accent);font-family:var(--font-m);font-size:.44rem;padding:2px 6px;letter-spacing:1px;margin-left:5px;vertical-align:middle}
.tag-active{display:inline-flex;align-items:center;gap:4px;background:var(--accent);color:#fff;padding:3px 8px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;margin:0 3px 3px 0}
.tag-active span{cursor:pointer;opacity:.8}.tag-active span:hover{opacity:1}
.queue-banner{background:var(--accent2);color:#fff;padding:7px 13px;font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;display:none;align-items:center;justify-content:space-between;cursor:pointer}
.queue-banner.show{display:flex}

/* FLEET STATUS BOARD */
.fleet-board{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.fleet-card{background:var(--card);border:2px solid var(--border);padding:10px 11px;position:relative;overflow:hidden;transition:border-color .3s}
.fleet-card.status-active{border-color:#22c55e}
.fleet-card.status-arrived{border-color:#f59e0b}
.fleet-card.status-idle{border-color:var(--border);opacity:.8}
.fleet-card.status-offline{border-color:var(--border);opacity:.45}
.fleet-card-plate{font-family:var(--font-d);font-size:1.05rem;letter-spacing:3px;color:var(--text);margin-bottom:2px}
.fleet-card-driver{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
.fleet-card-status{display:inline-flex;align-items:center;gap:4px;font-family:var(--font-m);font-size:.44rem;letter-spacing:1px;padding:2px 7px;margin-bottom:5px}
.fleet-card-status.active{background:rgba(34,197,94,.15);color:#22c55e}
.fleet-card-status.arrived{background:rgba(245,158,11,.15);color:#f59e0b}
.fleet-card-status.idle{background:rgba(100,100,100,.12);color:var(--muted)}
.fleet-card-route{font-family:var(--font-b);font-size:.58rem;color:var(--text);line-height:1.4}
.fleet-card-route .arrow{color:var(--accent);margin:0 3px}
.fleet-card-time{font-size:.46rem;color:var(--muted);margin-top:3px}
.fleet-card-trips{position:absolute;top:7px;right:8px;font-family:var(--font-d);font-size:1.1rem;color:var(--border)}
.fleet-dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}
.fleet-dot.active{background:#22c55e;animation:live-pulse 1.5s infinite}
.fleet-dot.arrived{background:#f59e0b}
.fleet-dot.idle{background:var(--muted)}

/* ACTIVE TRIP RECOVERY OVERLAY */
.trip-recovery-overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.trip-recovery-overlay.show{display:flex;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.trip-recovery-box{background:var(--card);border:3px solid #f59e0b;width:100%;max-width:420px;overflow:hidden}
.trip-recovery-alert{background:#f59e0b;padding:14px 16px;display:flex;align-items:center;gap:10px}
.trip-recovery-alert-ico{font-size:2rem;flex-shrink:0}
.trip-recovery-alert-txt{font-family:var(--font-d);font-size:1.1rem;color:#1a1a1a;letter-spacing:2px;line-height:1.3}
.trip-recovery-body{padding:16px}
.trip-recovery-info{background:var(--surface);border:1px solid var(--border);padding:11px 13px;margin-bottom:12px}
.trip-recovery-row{display:flex;justify-content:space-between;font-size:.6rem;padding:4px 0;border-bottom:1px solid var(--border)}
.trip-recovery-row:last-child{border-bottom:none}
.trip-recovery-row span:first-child{font-family:var(--font-m);color:var(--muted);letter-spacing:1px}
.trip-recovery-row span:last-child{font-family:var(--font-m);color:var(--text);font-weight:700}
.trip-recovery-sub{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:14px;text-align:center}

/* REPORT VIEWER */
.rview-overlay{position:fixed;inset:0;background:var(--bg);z-index:300;display:none;flex-direction:column;overflow:hidden}
.rview-overlay.open{display:flex;animation:fadeUp .25s ease}
.rview-header{background:var(--card);border-bottom:2px solid var(--border);padding:11px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.rview-back{background:none;border:1px solid var(--border);color:var(--text);font-family:var(--font-m);font-size:.52rem;letter-spacing:1px;padding:6px 11px;cursor:pointer}
.rview-title{flex:1;font-family:var(--font-d);font-size:1rem;letter-spacing:2px;color:var(--accent)}
.rview-export-btn{background:var(--accent);border:none;color:#fff;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:5px}
.rview-body{flex:1;overflow-y:auto;padding:14px;padding-bottom:80px}
.rview-summary{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.rview-stat{background:var(--card);border:1px solid var(--border);padding:12px;text-align:center}
.rview-stat .rs-label{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:4px}
.rview-stat .rs-val{font-family:var(--font-d);font-size:1.5rem;color:var(--accent)}
.rview-stat.wide{grid-column:1/-1}
.rview-section-title{font-family:var(--font-m);font-size:.52rem;letter-spacing:2px;color:var(--muted);border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:8px;margin-top:14px}
.rview-trip{background:var(--card);border:1px solid var(--border);padding:9px 12px;margin-bottom:6px}
.rview-trip-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.rview-route{font-family:var(--font-m);font-size:.62rem;color:var(--accent);font-weight:700}
.rview-amt{font-family:var(--font-d);font-size:.9rem;color:var(--text)}
.rview-trip-bot{display:flex;justify-content:space-between;font-size:.56rem;color:var(--muted)}
.rview-car-row{background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:6px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.rview-car-badge{font-family:var(--font-m);font-size:.6rem;color:var(--accent);background:rgba(26,122,60,.1);padding:4px 8px;letter-spacing:1px}
.rview-bar-wrap{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:4px}
.rview-bar{height:100%;background:var(--accent);border-radius:3px;transition:width .8s}
.rview-export-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.rview-btn-pdf{background:#c0392b;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:11px 6px;cursor:pointer;transition:opacity .2s}
.rview-btn-xls{background:#217346;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:11px 6px;cursor:pointer;transition:opacity .2s}
.rview-btn-wa{background:#25D366;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:11px 6px;cursor:pointer;transition:opacity .2s}

/* ODOMETER / FUEL */
.odom-wrap{background:var(--bg);border:2px solid var(--border);padding:14px;margin-bottom:10px;transition:border-color .2s}
.odom-wrap.active{border-color:var(--accent)}
.odom-title{font-family:var(--font-m);font-size:.52rem;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:7px}
.odom-title span{flex:1}
.odom-notwork{display:inline-flex;align-items:center;gap:6px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:4px 10px;border:1px solid var(--border);cursor:pointer;background:var(--bg);color:var(--muted);transition:all .2s;user-select:none}
.odom-notwork.on{border-color:var(--red);color:var(--red);background:rgba(229,57,53,.06)}
.odom-notwork .odom-check{width:12px;height:12px;border:1.5px solid currentColor;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:.5rem}
.odom-input-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.odom-input{width:100%;background:var(--bg);border:2px solid var(--accent);color:var(--text);padding:10px 12px 10px 44px;font-family:var(--font-m);font-size:1.05rem;font-weight:700;letter-spacing:1px;outline:none;transition:border-color .2s}
.odom-input::-webkit-inner-spin-button{-webkit-appearance:none}
.odom-pfx{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;pointer-events:none}
.odom-unit{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;white-space:nowrap}
.odom-dist-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(26,122,60,.1);border:1px solid var(--accent);padding:5px 10px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-top:8px}
.odom-skip-badge{background:rgba(229,57,53,.08);border:1px solid var(--red);padding:9px 12px;font-family:var(--font-m);font-size:.52rem;color:var(--red);letter-spacing:1px;line-height:1.7;margin-bottom:0}
.odom-reason-label{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px;margin-top:10px}
.odom-reason{width:100%;background:var(--bg);border:1.5px solid var(--red);color:var(--text);padding:8px 10px;font-family:var(--font-b);font-size:.78rem;outline:none;resize:none;transition:border-color .2s}
.odom-reason:focus{border-color:var(--accent)}
.fuel-entry-toggle{display:flex;align-items:center;justify-content:space-between;padding:13px 14px;border:2px solid var(--border);cursor:pointer;user-select:none;transition:all .2s;margin-bottom:0}
.fuel-entry-toggle.on{border-color:#f59e0b;background:rgba(245,158,11,.06)}
.fuel-toggle-label{font-family:var(--font-m);font-size:.58rem;letter-spacing:1.5px;color:var(--muted)}
.fuel-toggle-label.on{color:#f59e0b}
.fuel-toggle-pill{width:42px;height:24px;border-radius:12px;background:var(--border);position:relative;transition:background .2s;flex-shrink:0}
.fuel-toggle-pill.on{background:#f59e0b}
.fuel-toggle-pill::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.fuel-toggle-pill.on::after{left:21px}
.fuel-fields{border:2px solid #f59e0b;border-top:none;padding:13px;background:rgba(245,158,11,.03);margin-bottom:10px}
.fuel-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:10px}
.fuel-field-label{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px;text-transform:uppercase}
.fuel-input{width:100%;background:var(--bg);border:2px solid #f59e0b;color:var(--text);padding:10px 11px;font-family:var(--font-m);font-size:.9rem;font-weight:700;outline:none;letter-spacing:1px;transition:border-color .2s}
.fuel-input::-webkit-inner-spin-button{-webkit-appearance:none}
.fuel-input:focus{border-color:var(--accent)}
.fuel-input.full{width:100%;box-sizing:border-box}
.fuel-efficiency-badge{display:flex;align-items:center;gap:8px;padding:10px 12px;background:linear-gradient(135deg,rgba(245,158,11,.12),rgba(26,122,60,.08));border:1px solid #f59e0b;margin-top:9px}
.fuel-eff-ico{font-size:1.5rem}
.fuel-eff-val{font-family:var(--font-d);font-size:1.6rem;color:#f59e0b;letter-spacing:1px}
.fuel-eff-unit{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px}
.fuel-eff-sub{font-size:.52rem;color:var(--muted);margin-top:2px}
.feff-good{color:#22c55e}.feff-avg{color:#f59e0b}.feff-poor{color:var(--red)}

.fuel-stat{background:var(--card);border:1px solid var(--border);padding:11px 12px;margin-bottom:7px}
.fuel-stat-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.fuel-stat-car{font-family:var(--font-m);font-size:.6rem;color:var(--accent);letter-spacing:1px}
.fuel-stat-km{font-family:var(--font-d);font-size:1.4rem;color:var(--text)}
.fuel-stat-sub{font-size:.6rem;color:var(--muted)}
.fuel-warn{background:rgba(229,57,53,.08);border-left:3px solid var(--red);padding:7px 10px;font-size:.6rem;color:var(--red);font-family:var(--font-m);letter-spacing:1px;margin-bottom:6px}

/* PWA INSTALL BANNER */
.pwa-banner{position:fixed;bottom:74px;left:50%;transform:translateX(-50%);width:calc(100% - 24px);max-width:456px;background:var(--accent);color:#fff;padding:11px 14px;display:none;align-items:center;gap:10px;z-index:150;box-shadow:var(--shlg);animation:fadeUp .4s ease}
.pwa-banner.show{display:flex}
.pwa-banner-text{flex:1;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;line-height:1.7}
.pwa-banner-text strong{display:block;font-size:.62rem;margin-bottom:2px}
.pwa-install-btn{background:#fff;color:var(--accent);border:none;font-family:var(--font-d);font-size:.8rem;letter-spacing:2px;padding:8px 14px;cursor:pointer;flex-shrink:0;transition:background .2s}
.pwa-install-btn:hover{background:rgba(255,255,255,.85)}
.pwa-dismiss{background:none;border:none;color:rgba(255,255,255,.6);font-size:1rem;cursor:pointer;padding:4px;flex-shrink:0}

/* STATION SEARCH */
.stsearch{width:100%;background:var(--bg);border:1px solid var(--border);border-bottom:2px solid var(--accent);color:var(--text);padding:9px 11px 9px 34px;font-family:var(--font-m);font-size:.72rem;outline:none;letter-spacing:1px;transition:border-color .2s;margin-bottom:9px}
.stsearch::placeholder{color:var(--muted)}
.stsearch-wrap{position:relative}
.stsearch-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:.85rem;pointer-events:none;opacity:.5}
.stsearch-clr{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:.75rem;cursor:pointer;color:var(--muted);background:none;border:none;padding:0;line-height:1}
.st-none{font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;text-align:center;padding:14px;grid-column:1/-1}

/* LIVE TAB */
.live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:5px;animation:live-pulse 1.4s infinite}
@keyframes live-pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.3)}}
.live-badge{background:#22c55e;color:#fff;font-family:var(--font-m);font-size:.44rem;padding:2px 6px;letter-spacing:1px;margin-left:5px;vertical-align:middle;border-radius:2px}
.live-item{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:10px 12px;margin-bottom:7px;animation:fadeUp .35s ease;transition:background .3s}
.live-item.new{border-left-color:#22c55e;background:var(--alight)}
.live-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.live-route{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.live-amt{font-family:var(--font-m);font-size:.61rem;color:#22c55e;font-weight:700}
.live-bot{display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted)}
.live-time{font-family:var(--font-m);font-size:.48rem;color:var(--muted)}
.live-car{font-family:var(--font-m);font-size:.5rem;background:var(--surface);padding:2px 6px;color:var(--accent)}
.live-empty{text-align:center;padding:40px 14px;font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:2.2}
.live-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:12px}
.live-stat{background:var(--card);border:1px solid var(--border);padding:10px;text-align:center}
.live-stat .lsl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px}
.live-stat .lsv{font-family:var(--font-d);font-size:1.4rem;color:var(--accent)}
.listener-status{display:flex;align-items:center;gap:7px;padding:7px 10px;font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;margin-bottom:10px;border:1px solid var(--border)}
.listener-status.on{color:#22c55e;border-color:#22c55e;background:rgba(34,197,94,.08)}
.listener-status.off{color:var(--muted);border-color:var(--border)}

/* DEV ACCESS OVERLAY */
.dev-pin-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:250;display:none;align-items:center;justify-content:center;padding:20px}
.dev-pin-overlay.open{display:flex;animation:fadeUp .25s ease}
.dev-pin-box{background:var(--card);border:3px solid var(--red);padding:30px 24px;text-align:center;max-width:320px;width:100%;animation:fadeUp .3s ease}
.dev-pin-title{font-family:var(--font-d);font-size:1.8rem;color:var(--red);letter-spacing:3px;margin-bottom:5px}
.dev-pin-sub{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:16px}

/* TARGET ALERT OVERLAY */
.target-overlay{position:fixed;inset:0;background:rgba(26,122,60,.97);z-index:400;display:none;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center}
.target-overlay.open{display:flex;animation:fadeUp .4s ease}
.target-trophy{font-size:4rem;margin-bottom:10px;animation:bounce 1s infinite}
.target-hit{font-family:var(--font-d);font-size:2.8rem;color:#fff;letter-spacing:4px;margin-bottom:6px}
.target-name{font-family:var(--font-m);font-size:.7rem;color:rgba(255,255,255,.8);letter-spacing:2px;margin-bottom:20px}
.target-amount{font-family:var(--font-d);font-size:3.5rem;color:var(--accent2);letter-spacing:3px;margin-bottom:6px}
.target-label{font-family:var(--font-m);font-size:.58rem;color:rgba(255,255,255,.6);letter-spacing:2px;margin-bottom:28px}
.target-close{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.4);color:#fff;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;padding:13px 32px;cursor:pointer;transition:background .2s}
.target-close:hover{background:rgba(255,255,255,.3)}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

@media print{
  .bnav,.hico,header .hright,.exprow,.fchips,.rtabs,.queue-banner,.timeout-overlay,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important;max-width:100%!important}
  main{padding:0!important}
  .page{display:block!important}
  #page-reports .rsect:not(#rsect-overview){display:none!important}
  #rsect-live{display:none!important}
}
</style>
</head>
<body>

<header>
  <div class="hrow">
    <div class="logo">FESTUS<span> SACCO</span></div>
    <div class="hright">
      <span class="session-bar" id="sessionBar"></span>
      <span class="offline-badge" id="offlineBadge">OFFLINE</span>
      <button class="hico" onclick="toggleDark()" id="darkBtn" title="Toggle dark mode">üåô</button>
      <div class="dbadge" id="driverBadge" onclick="goSetup()">‚Äî LOGIN ‚Äî</div>
    </div>
  </div>
  <div class="hsub">
    <span>// TRIP LOGGER</span>
    <span class="sync-timer" id="syncTimer"></span>
  </div>
</header>

<!-- ACTIVE TRIP RECOVERY OVERLAY -->
<div class="trip-recovery-overlay" id="tripRecoveryOverlay">
  <div class="trip-recovery-box">
    <div class="trip-recovery-alert">
      <div class="trip-recovery-alert-ico">‚ö†Ô∏è</div>
      <div class="trip-recovery-alert-txt">ACTIVE TRIP<br>DETECTED</div>
    </div>
    <div class="trip-recovery-body">
      <div class="trip-recovery-info" id="tripRecoveryInfo"></div>
      <div class="trip-recovery-sub">
        YOU REFRESHED WHILE A TRIP WAS IN PROGRESS.<br>
        YOUR TRIP HAS BEEN RESTORED ‚Äî PLEASE END IT BEFORE REFRESHING.
      </div>
      <button class="bb barrive" style="margin-bottom:8px" onclick="resumeActiveTrip()">
        ‚úÖ CONTINUE TRIP
      </button>
      <button class="bout" style="margin:0;border-color:var(--red);color:var(--red)"
        onclick="abandonTripAndReset()">
        ‚úï ABANDON TRIP &amp; LOGOUT
      </button>
    </div>
  </div>
</div>

<!-- PWA INSTALL BANNER -->
<div class="pwa-banner" id="pwaBanner">
  <div style="font-size:1.6rem;flex-shrink:0">üì≤</div>
  <div class="pwa-banner-text">
    <strong>INSTALL FESTUS SACCO</strong>
    ADD TO HOME SCREEN FOR FULL APP EXPERIENCE
  </div>
  <button class="pwa-install-btn" id="pwaInstallBtn">INSTALL</button>
  <button class="pwa-dismiss" onclick="dismissPwaBanner()" title="Dismiss">‚úï</button>
</div>

<div class="queue-banner" id="queueBanner" onclick="flushQueue()">
  <span id="queueMsg">üì¶ TRIPS QUEUED OFFLINE ‚Äî TAP TO SYNC</span>
  <span>‚Üí</span>
</div>

<main>
  <div id="page-log" class="page active"></div>
  <div id="page-reports" class="page"></div>
  <div id="page-admin" class="page"></div>
</main>

<nav class="bnav">
  <button class="nbtn active" id="nav-log" onclick="switchPage('log')">
    <span class="ni">üöå</span><span class="nl">LOG TRIP</span>
  </button>
  <button class="nbtn" id="nav-reports" onclick="switchPage('reports')">
    <span class="ni">üìä</span><span class="nl">REPORTS</span>
  </button>
  <button class="nbtn" id="nav-admin" onclick="switchPage('admin')">
    <span class="ni">üëë</span><span class="nl">ADMIN</span>
  </button>
</nav>

<!-- SESSION TIMEOUT OVERLAY -->
<div class="timeout-overlay" id="timeoutOverlay">
  <div class="timeout-box">
    <div class="timeout-title">‚è± STILL THERE?</div>
    <div class="timeout-sub">YOU'LL BE LOGGED OUT IN</div>
    <div class="timeout-count" id="timeoutCount">60</div>
    <div class="timeout-sub" style="margin-bottom:16px">SECONDS DUE TO INACTIVITY</div>
    <button class="bb bstart" style="margin:0" onclick="resetSessionTimer()">‚úã I'M STILL HERE</button>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">EDIT TRIP</div>
    <div class="field"><label>Driver</label><input type="text" id="editDriver"></div>
    <div class="field"><label>Car Plate</label><input type="text" id="editCar"></div>
    <div class="field"><label>From Station</label><input type="text" id="editFrom"></div>
    <div class="field"><label>To Station</label><input type="text" id="editTo"></div>
    <div class="field"><label>Amount (KES)</label><input type="number" id="editAmount"></div>
    <div class="field"><label>Date</label><input type="text" id="editDate"></div>
    <div class="modal-actions">
      <button class="bb bstart" style="margin:0" onclick="saveEditTrip()">SAVE</button>
      <button class="bb" style="margin:0;background:var(--border);color:var(--text)" onclick="closeEditModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- SHIFT CLOSE SUMMARY MODAL -->
<div class="modal-overlay shift-summary-modal" id="shiftSummaryModal">
  <div class="modal">
    <div class="modal-title" style="color:var(--red)">CLOSE SHIFT</div>
    <div id="shiftSummaryBody"></div>
    <div class="modal-actions">
      <button class="bb br" style="margin:0" id="shiftCloseConfirmBtn">CLOSE SHIFT</button>
      <button class="bb" style="margin:0;background:var(--border);color:var(--text)" onclick="document.getElementById('shiftSummaryModal').classList.remove('open')">CANCEL</button>
    </div>
  </div>
</div>

<!-- DEV ACCESS OVERLAY -->
<div class="dev-pin-overlay" id="devPinOverlay">
  <div class="dev-pin-box">
    <div class="dev-pin-title">üîß DEV ACCESS</div>
    <div class="dev-pin-sub">THIS AREA IS RESTRICTED<br>TO AUTHORISED DEVELOPERS ONLY<br><br>ENTER DEVELOPER PIN TO CONTINUE</div>
    <div id="devPinLockMsg"></div>
    <input type="password" class="pininput" id="devPinIn" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter')checkDevPin()">
    <button class="bb bend" style="margin-top:10px;margin-bottom:6px" onclick="checkDevPin()">UNLOCK DEV ACCESS</button>
    <button class="bghost" style="width:100%" onclick="closeDevPinOverlay()">CANCEL</button>
  </div>
</div>

<!-- ADMIN PIN RESET OVERLAY -->
<div class="dev-pin-overlay" id="resetPinOverlay">
  <div class="dev-pin-box" style="border-color:var(--accent2)">
    <div style="font-size:2rem;margin-bottom:8px">üîë</div>
    <div class="dev-pin-title" style="color:var(--accent2)">RESET ADMIN PIN</div>
    <div class="dev-pin-sub">ENTER YOUR <strong style="color:var(--text)">DEVELOPER PIN</strong><br>TO VERIFY YOUR IDENTITY,<br>THEN SET A NEW ADMIN PIN</div>
    <div id="resetStepVerify">
      <div id="resetVerifyMsg"></div>
      <input type="password" class="pininput" id="resetDevPinIn" maxlength="6" placeholder="DEV PIN"
        style="border-color:var(--accent2)"
        onkeydown="if(event.key==='Enter')verifyDevForReset()">
      <button class="bb bconfirm" style="margin-top:10px;margin-bottom:6px;max-width:220px;margin-left:auto;margin-right:auto;display:block"
        onclick="verifyDevForReset()">VERIFY IDENTITY</button>
    </div>
    <div id="resetStepNew" style="display:none">
      <div style="font-family:var(--font-m);font-size:.52rem;color:#22c55e;letter-spacing:1px;margin-bottom:12px">‚úÖ IDENTITY VERIFIED ‚Äî SET NEW PIN</div>
      <input type="password" class="pininput" id="resetNewPinIn" maxlength="6" placeholder="NEW PIN"
        style="border-color:var(--accent)"
        onkeydown="if(event.key==='Enter')commitResetPin()">
      <button class="bb bstart" style="margin-top:10px;margin-bottom:6px;max-width:220px;margin-left:auto;margin-right:auto;display:block"
        onclick="commitResetPin()">SET NEW PIN</button>
    </div>
    <button class="bghost" style="width:100%;margin-top:4px" onclick="closeResetOverlay()">CANCEL</button>
  </div>
</div>

<!-- TARGET ALERT OVERLAY -->
<div class="target-overlay" id="targetOverlay">
  <div class="target-trophy" id="targetTrophy">üèÜ</div>
  <div class="target-hit">TARGET HIT!</div>
  <div class="target-name" id="targetName"></div>
  <div class="target-amount" id="targetAmount"></div>
  <div class="target-label">DAILY TARGET REACHED</div>
  <button class="target-close" onclick="closeTargetAlert()">KEEP GOING! üöÄ</button>
</div>

<!-- GENERATE REPORT MODAL -->
<div class="modal-overlay" id="reportModal">
  <div class="modal" style="border-top-color:var(--accent2)">
    <div class="modal-title" style="color:var(--accent2)">üìã GENERATE REPORT</div>
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;margin-bottom:12px">CHOOSE WHAT TO INCLUDE IN THIS REPORT</div>

    <!-- PERIOD -->
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">PERIOD</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:5px;margin-bottom:14px" id="rModalPeriodBtns">
      <div class="fchip active" data-period="today" onclick="setReportPeriod('today')">TODAY</div>
      <div class="fchip" data-period="week" onclick="setReportPeriod('week')">WEEK</div>
      <div class="fchip" data-period="month" onclick="setReportPeriod('month')">MONTH</div>
      <div class="fchip" data-period="all" onclick="setReportPeriod('all')">ALL</div>
    </div>

    <!-- SCOPE -->
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">SCOPE</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:10px" id="rModalScopeBtns">
      <div class="fchip active" data-scope="all" onclick="setReportScope('all')">ALL</div>
      <div class="fchip" data-scope="driver" onclick="setReportScope('driver')">BY DRIVER</div>
      <div class="fchip" data-scope="car" onclick="setReportScope('car')">BY CAR</div>
    </div>

    <!-- DRIVER / CAR PICKER -->
    <div id="rModalDriverPick" style="display:none;margin-bottom:10px">
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px">SELECT DRIVER</div>
      <select id="rModalDriverSel" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;appearance:none">
        <option value="">‚Äî All Drivers ‚Äî</option>
      </select>
    </div>
    <div id="rModalCarPick" style="display:none;margin-bottom:10px">
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px">SELECT CAR</div>
      <select id="rModalCarSel" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;appearance:none">
        <option value="">‚Äî All Cars ‚Äî</option>
      </select>
    </div>

    <!-- PREVIEW COUNT -->
    <div id="rModalPreview" style="background:var(--surface);border:1px solid var(--border);padding:9px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-bottom:14px;text-align:center">
      ‚Äî SELECT OPTIONS ABOVE ‚Äî
    </div>

    <!-- VIEW REPORT -->
    <button class="bb bconfirm" style="margin:0 0 8px;font-size:.86rem;letter-spacing:2px;padding:13px" onclick="runReport('view')">üëÅ VIEW REPORT</button>

    <!-- EXPORT -->
    <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;margin-top:2px">‚Äî OR EXPORT DIRECTLY ‚Äî</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">
      <button style="background:#c0392b;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:10px 4px;cursor:pointer" onclick="runReport('pdf')">üìÑ PDF</button>
      <button style="background:#217346;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:10px 4px;cursor:pointer" onclick="runReport('xls')">üìä XLS</button>
      <button style="background:#25D366;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:10px 4px;cursor:pointer" onclick="runReport('wa')">üì± WA</button>
    </div>
    <button class="bout" style="margin:0" onclick="closeReportModal()">CANCEL</button>
  </div>
</div>

<!-- REPORT VIEWER OVERLAY -->
<div class="rview-overlay" id="rviewOverlay">
  <div class="rview-header">
    <button class="rview-back" onclick="closeReportViewer()">‚Üê BACK</button>
    <div class="rview-title" id="rviewTitle">REPORT</div>
    <button class="rview-export-btn" onclick="openExportMenuFromViewer()">‚¨Ü EXPORT</button>
  </div>
  <div class="rview-body" id="rviewBody"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA ‚Äî stations now include GPS coords
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_DRIVERS  = ['FESTUS KIPKURUI','TOM WASIKE','FELIX OTIENO','MUTUA KIRUI','JANETH TIONY','ABIGAEL CHEPKORIR','GRACE WANGECHI'];
const DEFAULT_CARS     = ['KBZ 300','KBY 400','KBU 500','KCA 200','KDY 260W','KYA 520X','KAF 2601'];
const DEFAULT_STATIONS = [
  {name:'NAIROBI CBD', lat:-1.2833, lng:36.8167},
  {name:'WESTLANDS',   lat:-1.2676, lng:36.8112},
  {name:'KAREN',       lat:-1.3197, lng:36.7073},
  {name:'NGONG',       lat:-1.3583, lng:36.6583},
  {name:'RONGAI',      lat:-1.3944, lng:36.7452},
  {name:"LANG'ATA",    lat:-1.3204, lng:36.7571},
  {name:'KIKUYU',      lat:-1.2463, lng:36.6637},
  {name:'LIMURU',      lat:-1.1095, lng:36.6431},
];
const ADMIN_PIN_KEY     = 'fs_pin';
const DEV_PIN_KEY       = 'fs_devpin';
const DEFAULT_DEV_PIN   = '9999';
const DEFAULT_ADMIN_PIN = '1234';
const SESSION_TIMEOUT   = 30 * 60;  // 30 min
const SESSION_WARN_SHOW = 5 * 60;   // show bar at 5 min remaining
const SESSION_WARN_OVL  = 60;       // overlay at 60s
const AMOUNT_MIN        = 10;
const AMOUNT_MAX        = 50000;
const MAX_PIN_ATTEMPTS  = 3;
const PIN_LOCKOUT_SECS  = 5 * 60;   // 5-minute lockout

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function load(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch(e){return d;}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}

let DRIVERS    = load('fs_drivers', DEFAULT_DRIVERS);
let CARS       = load('fs_cars', DEFAULT_CARS);
let STATIONS   = load('fs_stations', DEFAULT_STATIONS);
let localTrips = load('fs_trips', []);
let offlineQ      = load('fs_queue', []);
let driverPins    = load('fs_dpins', {});
let carTargets     = load('fs_targets', {});
let driverTargets  = load('fs_dtargets', {});
let shifts        = load('fs_shifts', {});
let firestoreTrips = [];   // trips fetched from Firebase
let appConfig     = load('fs_config', {
  apiKey:     'AIzaSyAYxULc7vcAX4EAZI6Y7jna5PBbCR8CTug',
  authDomain: 'psv-sacco-tracker.firebaseapp.com',
  projectId:  'psv-sacco-tracker',
  appId:      '1:849470601891:web:9b12cfa6f783bf7d975d16'
});

// PIN lockout state (in-memory only ‚Äî resets on page reload, intentional)
let adminPinFailures   = 0;
let adminLockedUntil   = 0;
let driverPinFailures  = {};  // {driverName: {count, until}}

let tripState = {
  phase:'setup', driver:'', carPlate:'',
  fromStation:null, toStation:null,
  amount:'', notes:'',
  tripStart:null, tripEnd:null,
  // GPS / motion
  gpsLat:null, gpsLng:null, gpsStatus:'unknown',
  nearestStation:null,
  gpsWatchId:null,
  speed:null,         // m/s from GPS, null = unknown
  // Odometer / fuel tracking
  odomStart:null,     // reading at trip start (km)
  odomEnd:null,       // reading at trip end (km)
  odomWorking:true,   // false if odometer is broken
  odomSkipReason:'',  // reason when not working
  // Fuel log
  refueled:false,     // did driver add fuel this trip?
  fuelLiters:null,    // litres added
  fuelCost:null,      // total KES paid for fuel
  fuelStation:'',     // petrol station name (optional)
};

const sd = load('fs_driver', null);
if(sd){tripState.driver=sd.driver; tripState.carPlate=sd.carPlate; tripState.phase='idle';}

let currentPage        = 'log';
let reportFilter       = 'all';
let filterCar='', filterDriver='', filterFrom='', filterTo='';
let adminTab           = 'shifts';
let reportTab          = 'overview';
let adminUnlocked      = false;
let devUnlocked        = false;
let timerInterval      = null;
let syncInterval       = null;
let syncCountdown      = 300;
let db                 = null;   // Firestore instance
let liveUnsubscribe    = null;   // Firestore onSnapshot unsubscriber
let liveTrips          = [];     // real-time trips from listener
let liveNewIds         = new Set(); // recently-arrived trip IDs for highlight
let liveSessionSub     = null;   // Firestore onSnapshot for sessions collection
let liveSessions       = {};     // {carPlate: sessionDoc} ‚Äî keyed by plate
let mySessionId        = null;   // Firestore doc ID of this driver's session
let stationSearch      = '';     // filter text for station grid
let sessionSecondsLeft = SESSION_TIMEOUT;
let sessionInterval    = null;
let showingTimeout     = false;
let darkMode           = load('fs_dark', false);
let charts             = {};
let chartTrendType     = 'driver';   // 'driver' | 'car'
let chartTrendEntity   = '';         // specific driver/car name, '' = show all
let chartTrendPeriod   = '30';       // '14' | '30' | 'weekly'
let editingTripId      = null;

if(darkMode){document.documentElement.setAttribute('data-theme','dark'); document.getElementById('darkBtn').textContent='‚òÄÔ∏è';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DARK MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDark(){
  darkMode=!darkMode; save('fs_dark',darkMode);
  document.documentElement.setAttribute('data-theme',darkMode?'dark':'light');
  document.getElementById('darkBtn').textContent=darkMode?'‚òÄÔ∏è':'üåô';
  if(currentPage==='reports'&&reportTab==='charts')setTimeout(renderCharts,100);
  if(typeof updatePwaTheme==='function')updatePwaTheme();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION TIMEOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startSessionTimer(){
  clearInterval(sessionInterval);
  sessionSecondsLeft=SESSION_TIMEOUT;
  showingTimeout=false;
  sessionInterval=setInterval(tickSession,1000);
  updateSessionBar();
}

function tickSession(){
  if(tripState.phase==='setup'||tripState.phase==='done'){
    clearInterval(sessionInterval);
    hideTimeoutOverlay();
    updateSessionBar();
    return;
  }
  sessionSecondsLeft--;
  updateSessionBar();
  if(sessionSecondsLeft<=0){
    clearInterval(sessionInterval);
    hideTimeoutOverlay();
    toast('SESSION EXPIRED ‚Äî PLEASE LOG IN AGAIN');
    autoLogout();
    return;
  }
  if(sessionSecondsLeft<=SESSION_WARN_OVL && !showingTimeout){
    showingTimeout=true;
    document.getElementById('timeoutOverlay').classList.add('open');
  }
  if(showingTimeout){
    document.getElementById('timeoutCount').textContent=sessionSecondsLeft;
    document.getElementById('sessionBar').textContent='‚è± '+sessionSecondsLeft+'s';
    document.getElementById('sessionBar').className='session-bar show warn';
  }
}

function updateSessionBar(){
  const bar=document.getElementById('sessionBar');
  if(tripState.phase==='setup'||tripState.phase==='done'){bar.textContent='';bar.className='session-bar';return;}
  if(showingTimeout)return;
  // Only show when ‚â§ 5 minutes left
  if(sessionSecondsLeft <= SESSION_WARN_SHOW){
    const m=Math.floor(sessionSecondsLeft/60);
    const s=sessionSecondsLeft%60;
    bar.textContent=`‚è± ${m}:${String(s).padStart(2,'0')}`;
    bar.className='session-bar show';
  } else {
    bar.textContent='';
    bar.className='session-bar';
  }
}

function resetSessionTimer(){
  sessionSecondsLeft=SESSION_TIMEOUT;
  showingTimeout=false;
  hideTimeoutOverlay();
  updateSessionBar();
  if(!sessionInterval||sessionSecondsLeft<=0)startSessionTimer();
}

function hideTimeoutOverlay(){
  document.getElementById('timeoutOverlay').classList.remove('open');
  showingTimeout=false;
}

function autoLogout(){
  clearInterval(timerInterval);
  stopGpsWatch();
  tripState={...tripState,phase:'setup',driver:'',carPlate:'',fromStation:null,toStation:null,amount:'',notes:'',tripStart:null,tripEnd:null,gpsLat:null,gpsLng:null,gpsStatus:'unknown',nearestStation:null,speed:null};
  save('fs_driver',null);
  document.getElementById('driverBadge').textContent='‚Äî LOGIN ‚Äî';
  document.getElementById('sessionBar').textContent='';
  document.getElementById('sessionBar').className='session-bar';
  switchPage('log');
}

['click','touchstart','keypress'].forEach(ev=>{
  document.addEventListener(ev,()=>{
    if(tripState.phase!=='setup'&&tripState.phase!=='done'&&!showingTimeout)resetSessionTimer();
  },{passive:true});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(p){
  currentPage=p;
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nbtn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  document.getElementById('nav-'+p).classList.add('active');
  if(p==='log')renderLog();
  if(p==='reports')renderReports();
  if(p==='admin')renderAdmin();
}
function goSetup(){
  clearInterval(timerInterval);
  stopGpsWatch();
  clearSavedTripState();
  endSession(); // Mark driver as offline in Firebase
  mySessionId = null;
  tripState.phase='setup';
  switchPage('log');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PIN LOCKOUT HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isAdminLocked(){return adminLockedUntil>Date.now();}
function adminLockSecsLeft(){return Math.ceil((adminLockedUntil-Date.now())/1000);}

function recordAdminFailure(){
  adminPinFailures++;
  if(adminPinFailures>=MAX_PIN_ATTEMPTS){
    adminLockedUntil=Date.now()+PIN_LOCKOUT_SECS*1000;
    adminPinFailures=0;
    toast(`üîí TOO MANY ATTEMPTS ‚Äî LOCKED FOR ${PIN_LOCKOUT_SECS/60} MINUTES`);
  } else {
    toast(`WRONG PIN ‚Äî ${MAX_PIN_ATTEMPTS-adminPinFailures} ATTEMPT${MAX_PIN_ATTEMPTS-adminPinFailures===1?'':'S'} LEFT`);
  }
}

function isDriverLocked(driver){
  const d=driverPinFailures[driver];
  return d&&d.until>Date.now();
}
function driverLockSecsLeft(driver){
  return Math.ceil((driverPinFailures[driver].until-Date.now())/1000);
}
function recordDriverFailure(driver){
  if(!driverPinFailures[driver])driverPinFailures[driver]={count:0,until:0};
  driverPinFailures[driver].count++;
  if(driverPinFailures[driver].count>=MAX_PIN_ATTEMPTS){
    driverPinFailures[driver].until=Date.now()+PIN_LOCKOUT_SECS*1000;
    driverPinFailures[driver].count=0;
    toast(`üîí TOO MANY ATTEMPTS ‚Äî LOCKED FOR ${PIN_LOCKOUT_SECS/60} MINUTES`);
  } else {
    const left=MAX_PIN_ATTEMPTS-driverPinFailures[driver].count;
    toast(`WRONG PIN ‚Äî ${left} ATTEMPT${left===1?'':'S'} LEFT`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OFFLINE / QUEUE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isOnline(){return navigator.onLine;}
function updateOfflineBadge(){
  document.getElementById('offlineBadge').className='offline-badge'+(isOnline()?'':' show');
  const banner=document.getElementById('queueBanner');
  if(offlineQ.length>0){banner.className='queue-banner show';document.getElementById('queueMsg').textContent=`üì¶ ${offlineQ.length} TRIP${offlineQ.length>1?'S':''} QUEUED ‚Äî TAP TO SYNC`;}
  else{banner.className='queue-banner';}
}
window.addEventListener('online',()=>{updateOfflineBadge();if(offlineQ.length)flushQueue();});
window.addEventListener('offline',()=>updateOfflineBadge());

async function flushQueue(){
  if(!offlineQ.length)return;
  if(!initFirebase()){toast('‚ö† CONFIGURE FIREBASE IN ADMIN FIRST');return;}
  if(!isOnline()){toast('STILL OFFLINE ‚Äî WILL SYNC WHEN CONNECTED');return;}
  toast('SYNCING '+offlineQ.length+' QUEUED TRIPS...');
  const remaining=[];
  for(const trip of offlineQ){
    try{await db.collection('trips').add(trip);}
    catch(e){remaining.push(trip);}
  }
  offlineQ=remaining; save('fs_queue',offlineQ);
  toast(remaining.length===0?'‚úÖ ALL TRIPS SYNCED':'‚ö† '+remaining.length+' STILL QUEUED');
  updateOfflineBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-SYNC ‚Äî refresh Firebase every 5 min
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startAutoSync(){
  clearInterval(syncInterval);
  syncCountdown=300;
  syncInterval=setInterval(()=>{
    syncCountdown--;
    const el=document.getElementById('syncTimer');
    if(el)el.textContent='SYNC '+Math.floor(syncCountdown/60)+':'+String(syncCountdown%60).padStart(2,'0');
    if(syncCountdown<=0){
      syncCountdown=300;
      if(isOnline())flushQueue();
      if(currentPage==='reports'&&isOnline())loadFirebaseData(true);
    }
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GPS ‚Äî passive watch (doesn't block flow)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hav(a,b,c,d){const R=6371,dL=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

function findNearest(lat,lng){
  let best=null,bd=Infinity;
  STATIONS.forEach(s=>{
    if(!s.lat||!s.lng)return;
    const d=hav(lat,lng,s.lat,s.lng);
    if(d<bd){bd=d;best={...s,dist:d};}
  });
  return best;
}

function startGpsWatch(){
  stopGpsWatch();
  if(!navigator.geolocation){tripState.gpsStatus='unsupported';return;}
  tripState.gpsStatus='detecting';
  tripState.gpsWatchId=navigator.geolocation.watchPosition(
    pos=>{
      const prevNearest=tripState.nearestStation?.name;
      tripState.gpsLat=pos.coords.latitude;
      tripState.gpsLng=pos.coords.longitude;
      tripState.gpsStatus='ok';
      tripState.speed=(pos.coords.speed!=null&&pos.coords.speed>=0)?pos.coords.speed:null;
      tripState.nearestStation=findNearest(tripState.gpsLat,tripState.gpsLng);

      // Driver picks stations manually ‚Äî GPS is reference only
      updateGpsElements();
    },
    err=>{tripState.gpsStatus='error';tripState.speed=null;updateGpsElements();},
    {enableHighAccuracy:true,maximumAge:5000,timeout:15000}
  );
}

// Patch only the GPS bar and speed badge without touching the rest of the page
function updateGpsElements(){
  const gbarEl=document.getElementById('gpsBar');
  if(gbarEl)gbarEl.outerHTML=gpsBarHtml().replace('<div','<div id="gpsBar"');
  // Re-insert with id so we can find it next time
  const gbarNew=document.querySelector('.gbar');
  if(gbarNew&&!gbarNew.id)gbarNew.id='gpsBar';

  const speedEl=document.getElementById('speedBadge');
  if(speedEl){
    const html=speedBadgeHtml();
    speedEl.outerHTML=html?html.replace('<div','<div id="speedBadge"'):'<div id="speedBadge" style="display:none"></div>';
  }
}

function stopGpsWatch(){
  if(tripState.gpsWatchId!=null){
    navigator.geolocation.clearWatch(tripState.gpsWatchId);
    tripState.gpsWatchId=null;
  }
  tripState.speed=null;
}

function gpsBarHtml(){
  if(tripState.gpsStatus==='detecting')
    return`<div id="gpsBar" class="gbar detecting"><span>üì°</span>DETECTING LOCATION...</div>`;
  if(tripState.gpsStatus==='ok'&&tripState.nearestStation)
    return`<div id="gpsBar" class="gbar"><span>üìç</span>NEAREST: ${tripState.nearestStation.name} (${tripState.nearestStation.dist.toFixed(1)} KM)</div>`;
  if(tripState.gpsStatus==='error')
    return`<div id="gpsBar" class="gbar err"><span>‚ö†</span>GPS UNAVAILABLE</div>`;
  return`<div id="gpsBar" class="gbar detecting"><span>üì°</span>WAITING FOR GPS...</div>`;
}

function speedBadgeHtml(){
  if(tripState.speed===null)return'<div id="speedBadge" style="display:none"></div>';
  const kmh=(tripState.speed*3.6).toFixed(0);
  const moving=tripState.speed>2;
  return`<div id="speedBadge" class="speed-badge">
    <div class="speed-dot ${moving?'moving':''}"></div>
    ${moving?`MOVING ‚Äî ${kmh} KM/H`:`STATIONARY ‚Äî ${kmh} KM/H`}
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX #1: TRIP TIMER ‚Äî was missing entirely
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTripTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    const el=document.getElementById('timerVal');
    if(el&&tripState.tripStart){
      const s=Math.floor((Date.now()-tripState.tripStart)/1000);
      el.textContent=`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }
  },1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHIFT CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isShiftOpen(plate){
  const hasAnyShift=Object.keys(shifts).length>0;
  if(!hasAnyShift)return true;
  return shifts[plate]?.open===true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRIVER LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveDriver(){
  const d=document.getElementById('selD')?.value, p=document.getElementById('selP')?.value;
  if(!d||!p){toast('SELECT DRIVER AND CAR PLATE');return;}
  if(driverPins[d]){
    // Check lockout
    if(isDriverLocked(d)){
      toast(`üîí LOCKED ‚Äî TRY AGAIN IN ${driverLockSecsLeft(d)}s`);
      return;
    }
    const n=d.replace(/'/g,"\\'"), q=p.replace(/'/g,"\\'");
    const lockMsg=isDriverLocked(d)?`<div class="pin-locked">üîí LOCKED ‚Äî TRY IN ${driverLockSecsLeft(d)}s</div>`:'';
    document.getElementById('page-log').innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle">DRIVER PIN</div>
        <div class="csub">// ENTER YOUR PIN TO CONTINUE</div>
        ${lockMsg}
        <div style="text-align:center;margin-bottom:14px">
          <div style="font-family:var(--font-m);font-size:.58rem;color:var(--muted);margin-bottom:10px">${d} ¬∑ ${p}</div>
          <input type="password" id="driverPinIn" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="pininput"
            onkeydown="if(event.key==='Enter')confirmDriverPin('${n}','${q}')">
        </div>
        <button class="bb bstart" onclick="confirmDriverPin('${n}','${q}')">CONFIRM</button>
        <button class="bout" onclick="renderLog()">BACK</button>
      </div>`;
    return;
  }
  finishLogin(d,p);
}

function confirmDriverPin(d,p){
  if(isDriverLocked(d)){toast(`üîí LOCKED ‚Äî TRY IN ${driverLockSecsLeft(d)}s`);return;}
  const pin=document.getElementById('driverPinIn')?.value;
  if(pin!==driverPins[d]){recordDriverFailure(d);if(!isDriverLocked(d))saveDriver();else renderLog();return;}
  // Success ‚Äî clear failures
  driverPinFailures[d]={count:0,until:0};
  finishLogin(d,p);
}

function finishLogin(d,p){
  tripState.driver=d; tripState.carPlate=p; tripState.phase='idle';
  save('fs_driver',{driver:d,carPlate:p});
  document.getElementById('driverBadge').textContent=d.split(' ')[0]+' ¬∑ '+p;
  startSessionTimer();
  startGpsWatch();
  // Write login session to Firebase so admin can see who is online
  setTimeout(()=>writeSession('online',{loginTime:Date.now()}),500);
  renderLog();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATION SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selFrom(n){
  tripState.fromStation=STATIONS.find(s=>s.name===n)||{name:n,lat:0,lng:0};
  renderLog();
}
function selTo(n){
  if(tripState.phase!=='arrived')return;
  tripState.toStation=STATIONS.find(s=>s.name===n)||{name:n,lat:0,lng:0};
  // Update session so admin sees the destination in real time
  writeSession('arrived',{
    from: tripState.fromStation?.name||'',
    to:   tripState.toStation.name
  });
  renderLog();
}

function stationGridHtml(selected, disabledName=null, mode='from'){
  const q=stationSearch.trim().toUpperCase();
  const visible=q ? STATIONS.filter(s=>s.name.includes(q)) : STATIONS;
  const gridItems = visible.length
    ? visible.map(s=>{
        const d=tripState.gpsLat?hav(tripState.gpsLat,tripState.gpsLng,s.lat,s.lng):null;
        const nearest=tripState.nearestStation?.name===s.name;
        const isSel=selected===s.name;
        const isDis=s.name===disabledName;
        return`<div class="sbtn ${isSel?'sel':''} ${isDis?'dis':''} ${nearest&&!isSel?'nearest':''}"
          onclick="${isDis?'':`sel${mode==='from'?'From':'To'}('${s.name.replace(/'/g,"\\'")}')` }"
          title="${nearest?'Nearest to you':''}">
          ${s.name}${nearest&&!isSel?' üìç':''}
          ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
        </div>`;
      }).join('')
    : `<div class="st-none">NO STATIONS MATCH "${q}"</div>`;
  const esc=q.replace(/'/g,"\\'");
  return`<div class="stsearch-wrap">
    <span class="stsearch-ico">üîç</span>
    <input class="stsearch" id="stSearch_${mode}" type="text" placeholder="SEARCH STATION..."
      value="${esc}"
      oninput="stationSearch=this.value.toUpperCase();renderLog()"
      onfocus="this.select()">
    ${q?`<button class="stsearch-clr" onclick="stationSearch='';renderLog()">‚úï</button>`:''}
  </div>
  <div class="sgrid" style="margin-bottom:0">${gridItems}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TARGET ALERT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let targetAlertShown = {};  // {driver+date: true} ‚Äî only alert once per day per driver

function checkTargetAlert(driver, todayTotal){
  const target = driverTargets[driver];
  if(!target || todayTotal < target) return;
  const key = driver + '_' + new Date().toLocaleDateString('en-GB');
  if(targetAlertShown[key]) return;
  targetAlertShown[key] = true;
  document.getElementById('targetName').textContent = driver.split(' ')[0] + ' ' + (driver.split(' ')[1]||'');
  document.getElementById('targetAmount').textContent = 'KES ' + todayTotal.toLocaleString();
  // Trophy varies by how much they exceeded target
  const pct = Math.round((todayTotal / target) * 100);
  document.getElementById('targetTrophy').textContent = pct >= 150 ? 'üèÜ' : pct >= 120 ? 'ü•á' : 'üéØ';
  document.getElementById('targetOverlay').classList.add('open');
  // Vibrate if supported
  if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 400]);
}

function closeTargetAlert(){
  document.getElementById('targetOverlay').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRIP FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRIP STATE PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FS_TRIPSTATE_KEY = 'fs_active_trip';
const ACTIVE_PHASES    = ['active','arrived','confirm'];

function saveTripState(){
  if(ACTIVE_PHASES.includes(tripState.phase)){
    // Save a snapshot ‚Äî exclude GPS watch ID (not serialisable)
    const snap = {...tripState, gpsWatchId:null};
    save(FS_TRIPSTATE_KEY, snap);
  } else {
    localStorage.removeItem(FS_TRIPSTATE_KEY);
  }
}

function clearSavedTripState(){
  localStorage.removeItem(FS_TRIPSTATE_KEY);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ODOMETER HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function odomStartHtml(){
  const working = tripState.odomWorking;
  const hasReading = working ? !!tripState.odomStart : !!tripState.odomSkipReason;
  return `
  <div class="odom-wrap" id="odomStartWrap"
    style="border-color:${hasReading?'var(--accent)':'var(--red)'}">
    <div class="odom-title">
      <span>‚è≤ ODOMETER READING ‚Äî TRIP START
        <span style="font-family:var(--font-b);font-size:.44rem;color:var(--red);letter-spacing:1px;margin-left:5px">‚òÖ REQUIRED</span>
      </span>
      <span class="odom-notwork ${!working?'on':''}" onclick="toggleOdomWorking()">
        <span class="odom-check">${!working?'‚úï':''}</span>
        NOT WORKING
      </span>
    </div>
    ${working ? `
      <div class="odom-input-row" style="position:relative">
        <div style="position:relative">
          <span class="odom-pfx">KM</span>
          <input class="odom-input" type="number" id="odomStartIn"
            placeholder="e.g. 24500 ‚Äî REQUIRED TO START"
            min="0" max="999999" value="${tripState.odomStart||''}"
            style="border-color:${tripState.odomStart?'var(--accent)':'var(--red)'}"
            oninput="updateOdomStartUI(this.value)">
        </div>
        <span class="odom-unit">KM</span>
      </div>
      <div id="odomStartStatus" style="font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;margin-top:6px;color:${tripState.odomStart?'#22c55e':'var(--red)'}">${tripState.odomStart?'‚úÖ READING CAPTURED':'‚ö† ENTER READING TO ENABLE TRIP START'}</div>
    ` : `
      <div class="odom-skip-badge">‚ö† ODOMETER NOT WORKING<br>PLEASE PROVIDE A REASON BELOW</div>
      <div class="odom-reason-label">REASON FOR NOT CAPTURING <span style="color:var(--red)">‚òÖ REQUIRED</span></div>
      <textarea class="odom-reason" id="odomSkipReasonIn" rows="2"
        style="border-color:${tripState.odomSkipReason?'var(--accent)':'var(--red)'}"
        placeholder="e.g. Odometer cable broken, digital display failed, odometer tampered..."
        oninput="updateOdomReasonUI(this.value)">${tripState.odomSkipReason||''}</textarea>
      <div id="odomReasonStatus" style="font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;margin-top:4px;color:${tripState.odomSkipReason?'#22c55e':'var(--red)'}">${tripState.odomSkipReason?'‚úÖ REASON CAPTURED':'‚ö† REASON REQUIRED TO ENABLE TRIP START'}</div>`}
  </div>`;
}

// Update odometer start UI without re-rendering the whole page
function updateOdomStartUI(val){
  tripState.odomStart = val ? parseInt(val) : null;
  const has = !!tripState.odomStart;
  // Border on input
  const inp = document.getElementById('odomStartIn');
  if(inp) inp.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  // Border on wrap
  const wrap = document.getElementById('odomStartWrap');
  if(wrap) wrap.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  // Status message
  const status = document.getElementById('odomStartStatus');
  if(status){ status.textContent = has ? '‚úÖ READING CAPTURED' : '‚ö† ENTER READING TO ENABLE TRIP START'; status.style.color = has ? '#22c55e' : 'var(--red)'; }
  // Update START TRIP button without full re-render
  updateStartTripBtn();
}

// Update reason textarea UI without re-rendering
function updateOdomReasonUI(val){
  tripState.odomSkipReason = val;
  const has = !!val.trim();
  const ta = document.getElementById('odomSkipReasonIn');
  if(ta) ta.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  const wrap = document.getElementById('odomStartWrap');
  if(wrap) wrap.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  const status = document.getElementById('odomReasonStatus');
  if(status){ status.textContent = has ? '‚úÖ REASON CAPTURED' : '‚ö† REASON REQUIRED TO ENABLE TRIP START'; status.style.color = has ? '#22c55e' : 'var(--red)'; }
  updateStartTripBtn();
}

// Update only the START TRIP button state ‚Äî no re-render
function updateStartTripBtn(){
  const btn = document.getElementById('startTripBtn');
  if(!btn) return;
  const odomReady = tripState.odomWorking ? !!tripState.odomStart : !!tripState.odomSkipReason;
  const canStart  = !!tripState.fromStation && odomReady;
  const why = !tripState.fromStation ? 'SELECT STATION' : !odomReady ? (tripState.odomWorking?'ENTER ODOMETER':'ENTER REASON') : '';
  btn.disabled = !canStart;
  btn.style.opacity = canStart ? '1' : '0.45';
  btn.style.cursor = canStart ? 'pointer' : 'not-allowed';
  btn.textContent = canStart ? 'üöå START TRIP' : `üöå BLOCKED ‚Äî ${why}`;
}

function odomEndHtml(){
  const working = tripState.odomWorking;
  const dist = (working && tripState.odomStart && tripState.odomEnd && tripState.odomEnd > tripState.odomStart)
    ? tripState.odomEnd - tripState.odomStart : null;
  return `
  <div class="odom-wrap ${working&&tripState.odomEnd?'active':''}" id="odomEndWrap">
    <div class="odom-title">
      <span>‚è≤ ODOMETER READING ‚Äî TRIP END</span>
    </div>
    ${!working ? `
      <div class="odom-skip-badge">‚ö† ODOMETER NOT WORKING<br>REASON: ${tripState.odomSkipReason||'Not specified'}</div>` : `
      ${tripState.odomStart?`<div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);margin-bottom:7px;letter-spacing:1px">START READING: <strong style="color:var(--accent)">${Number(tripState.odomStart).toLocaleString()} KM</strong></div>`:''}
      <div class="odom-input-row" style="position:relative">
        <div style="position:relative">
          <span class="odom-pfx">KM</span>
          <input class="odom-input" type="number" id="odomEndIn" placeholder="e.g. 24547"
            min="${tripState.odomStart||0}" max="999999" value="${tripState.odomEnd||''}"
            oninput="tripState.odomEnd=this.value?parseInt(this.value):null;updateOdomDist()">
        </div>
        <span class="odom-unit">KM</span>
      </div>
      <div id="odomDistBadge">
        ${dist!==null?`<div class="odom-dist-badge">üìè DISTANCE THIS TRIP: <strong>${dist} KM</strong></div>`:''}
        ${tripState.odomEnd&&tripState.odomStart&&tripState.odomEnd<=tripState.odomStart?
          `<div class="fuel-warn" style="margin-top:6px">‚ö† END READING MUST BE GREATER THAN START READING (${Number(tripState.odomStart).toLocaleString()} KM)</div>`:''}
      </div>`}
  </div>`;
}

function updateOdomDist(){
  const badge = document.getElementById('odomDistBadge');
  if(!badge) return;
  const start = tripState.odomStart;
  const end   = tripState.odomEnd;
  if(start && end && end > start){
    badge.innerHTML = `<div class="odom-dist-badge">üìè DISTANCE THIS TRIP: <strong>${end-start} KM</strong></div>`;
  } else if(end && start && end <= start){
    badge.innerHTML = `<div class="fuel-warn" style="margin-top:6px">‚ö† END READING MUST BE GREATER THAN START READING (${Number(start).toLocaleString()} KM)</div>`;
  } else {
    badge.innerHTML = '';
  }
}

function toggleOdomWorking(){
  tripState.odomWorking = !tripState.odomWorking;
  if(tripState.odomWorking){ tripState.odomSkipReason=''; }
  renderLog();
}

function saveOdomStart(){
  const v = document.getElementById('odomStartIn')?.value;
  tripState.odomStart = v ? parseInt(v) : null;
}

function saveOdomEnd(){
  const v = document.getElementById('odomEndIn')?.value;
  tripState.odomEnd = v ? parseInt(v) : null;
}

function startTrip(){
  stationSearch='';
  if(!tripState.fromStation){toast('SELECT YOUR STARTING STATION');return;}
  if(!isShiftOpen(tripState.carPlate)){toast('‚õî SHIFT IS CLOSED FOR '+tripState.carPlate);return;}
  // Validate odometer ‚Äî hard block
  const odomVal = document.getElementById('odomStartIn')?.value;
  if(odomVal) tripState.odomStart = parseInt(odomVal);
  const reasonVal = document.getElementById('odomSkipReasonIn')?.value?.trim();
  if(reasonVal) tripState.odomSkipReason = reasonVal;
  if(tripState.odomWorking && !tripState.odomStart){
    toast('‚ö† ODOMETER READING REQUIRED ‚Äî ENTER START KM TO PROCEED');
    // Shake the odom input visually
    const inp = document.getElementById('odomStartIn');
    if(inp){ inp.style.borderColor='var(--red)'; inp.focus(); setTimeout(()=>inp.style.borderColor='var(--red)',600); }
    return;
  }
  if(!tripState.odomWorking && !tripState.odomSkipReason){
    toast('‚ö† REASON REQUIRED ‚Äî EXPLAIN WHY ODOMETER IS NOT WORKING');
    const ta = document.getElementById('odomSkipReasonIn');
    if(ta){ ta.style.borderColor='var(--red)'; ta.focus(); }
    return;
  }
  tripState.phase='active';
  tripState.tripStart=Date.now();
  tripState.toStation=null;
  tripState.notes='';
  saveTripState();
  // Tell admin: this car is now driving
  writeSession('driving', {
    from: tripState.fromStation?.name || '',
    to: '',
    tripStartMs: tripState.tripStart
  });
  renderLog();
  startTripTimer();
  toast('TRIP STARTED ‚Äî SAFE JOURNEY! üöå');
}

function arrive(){
  stationSearch='';
  tripState.phase='arrived';
  tripState.tripEnd=Date.now();
  clearInterval(timerInterval);
  tripState.toStation=null;
  saveTripState();
  // Tell admin: vehicle has arrived, logging details
  writeSession('arrived', {
    from: tripState.fromStation?.name || '',
    to: '',
    arrivedMs: tripState.tripEnd
  });
  renderLog();
  toast('ARRIVED ‚Äî SELECT YOUR DESTINATION');
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FUEL SECTION HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fuelSectionHtml(){
  const dist = (tripState.odomWorking && tripState.odomStart && tripState.odomEnd && tripState.odomEnd > tripState.odomStart)
    ? tripState.odomEnd - tripState.odomStart : null;
  const eff  = (dist && tripState.fuelLiters && tripState.fuelLiters > 0)
    ? (dist / tripState.fuelLiters).toFixed(2) : null;
  const costPerKm = (dist && tripState.fuelCost && tripState.fuelCost > 0)
    ? (tripState.fuelCost / dist).toFixed(1) : null;

  return `
  <div style="margin-bottom:${tripState.refueled?'0':'10px'}">
    <div class="fuel-entry-toggle ${tripState.refueled?'on':''}" onclick="toggleRefuel()">
      <div>
        <div class="fuel-toggle-label ${tripState.refueled?'on':''}">‚õΩ DID YOU REFUEL THIS TRIP?</div>
        <div style="font-family:var(--font-b);font-size:.62rem;color:var(--muted);margin-top:2px">${tripState.refueled?'TAP TO REMOVE':'TAP TO RECORD FUEL ADDED'}</div>
      </div>
      <div class="fuel-toggle-pill ${tripState.refueled?'on':''}"></div>
    </div>
  </div>
  ${tripState.refueled ? `
  <div class="fuel-fields">
    <div class="fuel-grid">
      <div>
        <div class="fuel-field-label">LITRES ADDED *</div>
        <input class="fuel-input" type="number" id="fuelLitresIn" placeholder="e.g. 40"
          min="0.1" max="300" step="0.1" value="${tripState.fuelLiters||''}"
          oninput="tripState.fuelLiters=parseFloat(this.value)||null;updateFuelEfficiency()">
      </div>
      <div>
        <div class="fuel-field-label">TOTAL COST (KES) *</div>
        <input class="fuel-input" type="number" id="fuelCostIn" placeholder="e.g. 6500"
          min="1" max="999999" value="${tripState.fuelCost||''}"
          oninput="tripState.fuelCost=parseFloat(this.value)||null;updateFuelEfficiency()">
      </div>
    </div>
    <div>
      <div class="fuel-field-label">PETROL STATION (optional)</div>
      <input class="fuel-input full" type="text" id="fuelStationIn"
        placeholder="e.g. Total Rongai, Shell Ngong Rd..."
        value="${tripState.fuelStation||''}"
        oninput="tripState.fuelStation=this.value">
    </div>
    ${tripState.fuelLiters?`
    <div style="margin-top:7px;font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px">
      COST PER LITRE: <strong style="color:#f59e0b">KES ${tripState.fuelCost&&tripState.fuelLiters?(tripState.fuelCost/tripState.fuelLiters).toFixed(0):'‚Äî'}</strong>
    </div>`:''  }
    <div id="fuelEffBadge">
      ${eff?`
      <div class="fuel-efficiency-badge">
        <div class="fuel-eff-ico">‚ö°</div>
        <div style="flex:1">
          <div style="display:flex;align-items:baseline;gap:5px">
            <span class="fuel-eff-val ${parseFloat(eff)>=10?'feff-good':parseFloat(eff)>=7?'feff-avg':'feff-poor'}">${eff}</span>
            <span class="fuel-eff-unit">KM / LITRE</span>
          </div>
          <div class="fuel-eff-sub">
            ${dist} km √∑ ${tripState.fuelLiters}L
            ${costPerKm?`¬∑ KES ${costPerKm}/km`:''}
            ¬∑ ${parseFloat(eff)>=10?'‚úÖ GOOD EFFICIENCY':parseFloat(eff)>=7?'‚ö† AVERAGE':'üî¥ POOR ‚Äî CHECK ENGINE'}
          </div>
        </div>
      </div>`:''}
    </div>
  </div>`:``}`;
}

function toggleRefuel(){
  tripState.refueled = !tripState.refueled;
  if(!tripState.refueled){ tripState.fuelLiters=null; tripState.fuelCost=null; tripState.fuelStation=''; }
  renderLog();
}

function updateFuelEfficiency(){
  const badge = document.getElementById('fuelEffBadge');
  if(!badge) return;
  const dist = (tripState.odomWorking && tripState.odomStart && tripState.odomEnd && tripState.odomEnd > tripState.odomStart)
    ? tripState.odomEnd - tripState.odomStart : null;
  const liters = parseFloat(document.getElementById('fuelLitresIn')?.value) || null;
  const cost   = parseFloat(document.getElementById('fuelCostIn')?.value) || null;
  if(liters) tripState.fuelLiters = liters;
  if(cost)   tripState.fuelCost   = cost;
  const eff = (dist && liters && liters > 0) ? (dist / liters).toFixed(2) : null;
  const costPerKm = (dist && cost && cost > 0) ? (cost / dist).toFixed(1) : null;
  if(eff){
    const cls = parseFloat(eff)>=10?'feff-good':parseFloat(eff)>=7?'feff-avg':'feff-poor';
    const tag = parseFloat(eff)>=10?'‚úÖ GOOD EFFICIENCY':parseFloat(eff)>=7?'‚ö† AVERAGE':'üî¥ POOR ‚Äî CHECK ENGINE';
    badge.innerHTML = `
      <div class="fuel-efficiency-badge">
        <div class="fuel-eff-ico">‚ö°</div>
        <div style="flex:1">
          <div style="display:flex;align-items:baseline;gap:5px">
            <span class="fuel-eff-val ${cls}">${eff}</span>
            <span class="fuel-eff-unit">KM / LITRE</span>
          </div>
          <div class="fuel-eff-sub">
            ${dist} km √∑ ${liters}L${costPerKm?` ¬∑ KES ${costPerKm}/km`:''} ¬∑ ${tag}
          </div>
        </div>
      </div>`;
  } else {
    badge.innerHTML = '';
  }
  // Also update cost-per-litre display
  const cplEl = badge.previousElementSibling;
}

function reviewTrip(){
  const amt=parseFloat(document.getElementById('amtIn')?.value||'0');
  const notes=(document.getElementById('notesIn')?.value||'').trim();
  if(!tripState.toStation){toast('SELECT DESTINATION STATION');return;}
  if(!amt||amt<=0){toast('ENTER AMOUNT COLLECTED');return;}
  if(amt<AMOUNT_MIN){toast(`AMOUNT TOO LOW ‚Äî MINIMUM KES ${AMOUNT_MIN}`);return;}
  if(amt>AMOUNT_MAX){toast(`AMOUNT TOO HIGH ‚Äî MAXIMUM KES ${AMOUNT_MAX.toLocaleString()}`);return;}
  if(tripState.toStation.name===tripState.fromStation.name){toast('TO STATION MUST BE DIFFERENT');return;}
  // Capture odometer end reading
  const odomEndVal = document.getElementById('odomEndIn')?.value;
  if(odomEndVal) tripState.odomEnd = parseInt(odomEndVal);
  if(tripState.odomWorking && tripState.odomStart && tripState.odomEnd){
    if(tripState.odomEnd <= tripState.odomStart){
      toast('‚ö† END ODOMETER MUST BE GREATER THAN START READING'); return;
    }
  }
  // Capture fuel inputs
  const fuelL = parseFloat(document.getElementById('fuelLitresIn')?.value)||null;
  const fuelC = parseFloat(document.getElementById('fuelCostIn')?.value)||null;
  const fuelS = (document.getElementById('fuelStationIn')?.value||'').trim();
  if(tripState.refueled){
    if(!fuelL||fuelL<=0){toast('‚õΩ ENTER LITRES ADDED'); return;}
    if(!fuelC||fuelC<=0){toast('‚õΩ ENTER FUEL COST (KES)'); return;}
    tripState.fuelLiters = fuelL;
    tripState.fuelCost   = fuelC;
    tripState.fuelStation = fuelS;
  }
  tripState.amount=amt; tripState.notes=notes;
  tripState.phase='confirm';
  saveTripState();
  renderLog();
}

function confirmAndSubmit(){
  const tenMin=10*60*1000;
  const dup=localTrips.find(t=>
    t.driver===tripState.driver&&t.carPlate===tripState.carPlate&&
    t.fromStation===tripState.fromStation.name&&t.toStation===tripState.toStation.name&&
    (Date.now()-new Date(t.timestamp).getTime())<tenMin
  );
  if(dup&&!confirm('‚ö† SIMILAR TRIP LOGGED WITHIN 10 MINUTES ‚Äî SUBMIT ANYWAY?'))return;
  const _now=new Date();
  const _odomDist=(tripState.odomWorking&&tripState.odomStart&&tripState.odomEnd&&tripState.odomEnd>tripState.odomStart)
    ? tripState.odomEnd-tripState.odomStart : null;
  const trip={
    id:Date.now(),driver:tripState.driver,carPlate:tripState.carPlate,
    fromStation:tripState.fromStation.name,toStation:tripState.toStation.name,
    amount:tripState.amount,duration:Math.floor((tripState.tripEnd-tripState.tripStart)/60000),
    notes:tripState.notes,date:_now.toLocaleDateString('en-GB'),
    time:_now.toLocaleTimeString(),timestamp:_now.toISOString(),
    dateMs:_now.getTime(),  // used for Firestore range queries
    // Odometer
    odomStart:tripState.odomStart||null,
    odomEnd:tripState.odomEnd||null,
    odomWorking:tripState.odomWorking,
    odomSkipReason:tripState.odomSkipReason||null,
    distance:_odomDist,  // km covered this trip
    // Fuel
    refueled:tripState.refueled,
    fuelLiters:tripState.refueled?tripState.fuelLiters:null,
    fuelCost:tripState.refueled?tripState.fuelCost:null,
    fuelStation:tripState.refueled?(tripState.fuelStation||null):null,
    fuelEfficiency:(_odomDist&&tripState.refueled&&tripState.fuelLiters)
      ? parseFloat((_odomDist/tripState.fuelLiters).toFixed(2)) : null,  // km/L
    fuelCostPerKm:(_odomDist&&tripState.refueled&&tripState.fuelCost)
      ? parseFloat((tripState.fuelCost/_odomDist).toFixed(2)) : null,   // KES/km
  };
  localTrips.unshift(trip); save('fs_trips',localTrips.slice(0,200));
  tripState.phase='done';
  clearSavedTripState();
  submitToFirebase(trip);
  // Tell admin: trip complete, car is idle again
  writeSession('idle', {
    from: '',
    to: '',
    lastTrip: tripState.fromStation?.name + ' ‚Üí ' + tripState.toStation?.name,
    lastTripMs: Date.now()
  });
  playSuccessSound();
  renderLog();
  // Check driver target after render
  const _today=_now.toLocaleDateString('en-GB');
  const _todayTotal=localTrips.filter(t=>t.date===_today&&t.driver===tripState.driver).reduce((s,t)=>s+t.amount,0);
  setTimeout(()=>checkTargetAlert(tripState.driver, _todayTotal), 600);
}

function backToEdit(){tripState.phase='arrived';renderLog();}

function newTrip(){
  const prev=tripState.toStation;
  tripState.phase='idle';
  tripState.fromStation=prev;
  tripState.toStation=null; tripState.amount=''; tripState.notes='';
  tripState.tripStart=null; tripState.tripEnd=null;
  // For next trip: start odometer = previous end reading (auto-fill convenience)
  tripState.odomStart = tripState.odomEnd || null;
  tripState.odomEnd = null;
  // Keep odomWorking and odomSkipReason ‚Äî driver's car doesn't change between trips
  // Reset fuel ‚Äî each trip captures its own fuel event
  tripState.refueled=false; tripState.fuelLiters=null; tripState.fuelCost=null; tripState.fuelStation='';
  resetSessionTimer();
  renderLog();
  toast('READY FOR NEXT TRIP');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIRMATION SOUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function playSuccessSound(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    // Three-note ascending chime: C5 ‚Üí E5 ‚Üí G5
    const notes=[523.25, 659.25, 783.99];
    notes.forEach((freq,i)=>{
      const osc=ctx.createOscillator();
      const gain=ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type='sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime+i*0.13);
      gain.gain.setValueAtTime(0, ctx.currentTime+i*0.13);
      gain.gain.linearRampToValueAtTime(0.28, ctx.currentTime+i*0.13+0.04);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+i*0.13+0.32);
      osc.start(ctx.currentTime+i*0.13);
      osc.stop(ctx.currentTime+i*0.13+0.35);
    });
  }catch(e){ /* AudioContext not supported ‚Äî silent fail */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBMIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitToFirebase(trip){
  if(!initFirebase()){
    if(!isOnline()){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast('üì¶ SAVED TO OFFLINE QUEUE');}
    else toast('üíæ SAVED LOCALLY ‚Äî CONFIGURE FIREBASE IN ADMIN');
    return;
  }
  if(!isOnline()){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast('üì¶ OFFLINE ‚Äî QUEUED');return;}
  try{
    await db.collection('trips').add(trip);
    toast('‚úÖ SYNCED TO FIREBASE');
  }catch(e){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast('‚ö† QUEUED FOR RETRY');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHATSAPP DAILY SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateWhatsAppSummary(){
  const all=allData();
  const today=new Date().toLocaleDateString('en-GB');
  const todayT=all.filter(t=>t.date===today);
  if(!todayT.length){toast('NO TRIPS TODAY TO SUMMARIZE');return;}
  const total=todayT.reduce((s,t)=>s+t.amount,0);
  const avg=Math.round(total/todayT.length);
  const cars=[...new Set(todayT.map(t=>t.carPlate).filter(Boolean))];
  const carLines=cars.map(car=>{
    const ct=todayT.filter(t=>t.carPlate===car);
    const cr=ct.reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car];
    const pct=target?` (${Math.round((cr/target)*100)}% of target)`:'';
    return`  üöó ${car}: ${ct.length} trips ¬∑ KES ${cr.toLocaleString()}${pct}`;
  }).join('\n');
  const drivers=[...new Set(todayT.map(t=>t.driver).filter(Boolean))];
  const driverLines=drivers.map(d=>{
    const dt=todayT.filter(t=>t.driver===d);
    const dr=dt.reduce((s,t)=>s+t.amount,0);
    return`  üë§ ${d}: ${dt.length} trips ¬∑ KES ${dr.toLocaleString()}`;
  }).join('\n');
  const msg=`üöå *FESTUS SACCO ‚Äî DAILY REPORT*\nüìÖ ${today}\n\nüìä *SUMMARY*\n‚Ä¢ Total Trips: ${todayT.length}\n‚Ä¢ Total Revenue: KES ${total.toLocaleString()}\n‚Ä¢ Average/Trip: KES ${avg.toLocaleString()}\n\nüöó *BY CAR*\n${carLines}\n\nüë§ *BY DRIVER*\n${driverLines}\n\n_Generated by FESTUS SACCO App_`;
  const encoded=encodeURIComponent(msg);
  if(navigator.clipboard){navigator.clipboard.writeText(msg).then(()=>toast('üìã COPIED! OPENING WHATSAPP...')).catch(()=>{});}
  setTimeout(()=>window.open(`https://wa.me/?text=${encoded}`,'_blank'),500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE ‚Äî init + data layer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initFirebase(){
  if(!appConfig.projectId){return false;}
  if(db)return true;  // already initialised
  try{
    if(!firebase.apps.length){
      firebase.initializeApp({
        apiKey:appConfig.apiKey,
        authDomain:appConfig.authDomain,
        projectId:appConfig.projectId,
        appId:appConfig.appId
      });
    }
    db=firebase.firestore();
    // Offline persistence ‚Äî survives network drops
    db.enablePersistence({synchronizeTabs:true}).catch(()=>{});
    return true;
  }catch(e){console.error('Firebase init error:',e);return false;}
}

async function loadFirebaseData(silent=false){
  if(!initFirebase()){if(!silent)toast('‚ö† CONFIGURE FIREBASE IN ADMIN');return;}
  if(!isOnline()&&!silent){toast('OFFLINE ‚Äî SHOWING CACHED DATA');return;}
  try{
    // Build date range based on current filter
    const now=new Date(); now.setHours(23,59,59,999);
    let startMs=0;
    if(reportFilter==='today'){const s=new Date();s.setHours(0,0,0,0);startMs=s.getTime();}
    else if(reportFilter==='week'){const s=new Date();s.setDate(s.getDate()-s.getDay());s.setHours(0,0,0,0);startMs=s.getTime();}
    else if(reportFilter==='month'){const s=new Date(now.getFullYear(),now.getMonth(),1);startMs=s.getTime();}
    else{// 'all' ‚Äî load last 90 days to keep query fast
      const s=new Date();s.setDate(s.getDate()-90);s.setHours(0,0,0,0);startMs=s.getTime();}

    let q=db.collection('trips').where('dateMs','>=',startMs).orderBy('dateMs','desc');
    // Extra car/driver filters pushed to Firestore where possible
    if(filterCar)q=q.where('carPlate','==',filterCar);
    const snap=await q.get();
    firestoreTrips=snap.docs.map(d=>({...d.data(),_fbId:d.id}));
    if(!silent)toast('‚úÖ '+firestoreTrips.length+' RECORDS LOADED');
    if(currentPage==='reports')renderReports();
  }catch(e){
    if(!silent)toast('‚ö† LOAD ERROR: '+e.message);
    if(currentPage==='reports')renderReports();
  }
}

function allData(){
  // Merge Firebase trips with local trips (local takes priority for dedup)
  const fbFiltered=firestoreTrips.filter(ft=>!localTrips.find(lt=>lt.timestamp===ft.timestamp&&lt.driver===ft.driver));
  return[...localTrips,...fbFiltered];
}

function parseDate(str){
  if(!str)return null;let d=new Date(str);if(!isNaN(d))return d;
  const m=str.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
  if(m){const yr=m[3].length===2?'20'+m[3]:m[3];return new Date(`${yr}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`);}
  return null;
}


function filterTrips(trips){
  const now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return trips.filter(t=>{
    if(reportFilter!=='all'){
      const d=parseDate(t.date);if(!d)return false;
      if(reportFilter==='today'&&d<today)return false;
      if(reportFilter==='week'){const ws=new Date(today);ws.setDate(today.getDate()-today.getDay());if(d<ws)return false;}
      if(reportFilter==='month'&&(d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear()))return false;
    }
    if(filterCar&&(t.carPlate||'').trim()!==filterCar)return false;
    if(filterDriver&&(t.driver||'').trim()!==filterDriver)return false;
    if(filterFrom&&(t.fromStation||'').trim()!==filterFrom)return false;
    if(filterTo&&(t.toStation||'').trim()!==filterTo)return false;
    return true;
  });
}
function clearFilters(){filterCar='';filterDriver='';filterFrom='';filterTo='';reportFilter='all';renderReports();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const filtered=filterTrips(allData());
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=18;let y=M;
  doc.setFillColor(26,122,60);doc.rect(0,0,W,38,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('FESTUS SACCO',M,16);
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.text('TRIP REPORT ‚Äî '+reportFilter.toUpperCase(),M,24);doc.text('Generated: '+new Date().toLocaleString(),M,31);
  y=46;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:String(filtered.length)},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():'‚Äî'},{l:'UNIQUE CARS',v:String([...new Set(filtered.map(t=>t.carPlate))].length)}].forEach((b,i)=>{
    const bx=M+i*(bw+3);doc.setFillColor(245,250,245);doc.rect(bx,y,bw,20,'F');doc.setFillColor(26,122,60);doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(6);doc.setFont('helvetica','normal');doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26);doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0);doc.setFontSize(6.5);doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5);doc.text('DATE',M+10,y+5);doc.text('ROUTE',M+36,y+5);doc.text('DRIVER',M+90,y+5);doc.text('CAR',M+130,y+5);doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244]));doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80);doc.setFontSize(6.5);doc.setFont('helvetica','normal');doc.text(String(i+1),M+2,y+5);doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60);doc.setFont('helvetica','bold');doc.text((t.fromStation||'').slice(0,9)+'‚Üí'+(t.toStation||'').slice(0,9),M+36,y+5);
    doc.setTextColor(60,60,60);doc.setFont('helvetica','normal');doc.text((t.driver||'').slice(0,18),M+90,y+5);doc.text(t.carPlate||'',M+130,y+5);
    doc.setTextColor(20,100,60);doc.setFont('helvetica','bold');doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FESTUS SACCO ‚Äî CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  doc.save('FESTUS-report-'+new Date().toISOString().slice(0,10)+'.pdf');
}

function exportExcel(){
  const filtered=filterTrips(allData());
  const data=filtered.map(t=>({'DATE':t.date,'TIME':t.time,'FROM':t.fromStation,'TO':t.toStation,'DRIVER':t.driver,'CAR':t.carPlate,'AMOUNT':t.amount,'DURATION(MIN)':t.duration,'NOTES':t.notes||''}));
  const ws=XLSX.utils.json_to_sheet(data);
  ws['!cols']=[{wch:12},{wch:10},{wch:14},{wch:14},{wch:20},{wch:10},{wch:10},{wch:12},{wch:20}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Trips');
  const carRevs=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))].map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car);
    return{'CAR':car,'TRIPS':ct.length,'REVENUE':ct.reduce((s,t)=>s+t.amount,0),'AVG':ct.length?Math.round(ct.reduce((s,t)=>s+t.amount,0)/ct.length):0};
  });
  if(carRevs.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(carRevs),'By Car');
  XLSX.writeFile(wb,'FESTUS-'+new Date().toISOString().slice(0,10)+'.xlsx');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCharts(){
  const all=allData(),isDark=darkMode;
  const tc=isDark?'#5a8a6a':'#6a8a6a',gc=isDark?'#2a3e2e':'#dde8dd';
  Chart.defaults.color=tc;Chart.defaults.borderColor=gc;
  Chart.defaults.font.family="'Space Mono',monospace";Chart.defaults.font.size=10;

  const PALETTE=['#1a7a3c','#f0a500','#2196a8','#e53935','#6d4fc2','#22c55e','#fb923c','#ec4899','#0ea5e9','#84cc16'];

  function mk(id,type,labels,datasets,legend=false,height=200){
    if(charts[id])charts[id].destroy();
    const canvas=document.getElementById(id);if(!canvas)return;
    const wrap=canvas.parentElement;if(wrap)wrap.style.height=height+'px';
    charts[id]=new Chart(canvas.getContext('2d'),{
      type,data:{labels,datasets},
      options:{
        responsive:true,maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        plugins:{
          legend:{display:legend,labels:{color:tc,font:{size:9},boxWidth:12,padding:10}},
          tooltip:{backgroundColor:isDark?'#1a2820':'#fff',titleColor:isDark?'#e0f0e4':'#1a2e1a',bodyColor:isDark?'#5a8a6a':'#6a8a6a',borderColor:gc,borderWidth:1}
        },
        scales:type!=='doughnut'?{
          x:{grid:{color:gc},ticks:{color:tc,maxRotation:45,font:{size:9}}},
          y:{grid:{color:gc},ticks:{color:tc,beginAtZero:true,callback:v=>v>=1000?(v/1000).toFixed(0)+'K':v}}
        }:undefined
      }
    });
  }

  // ‚îÄ‚îÄ Build date labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildDayLabels(n){
    const arr=[];
    for(let i=n-1;i>=0;i--){
      const d=new Date();d.setDate(d.getDate()-i);d.setHours(0,0,0,0);arr.push(d);
    }
    return arr;
  }
  function buildWeekLabels(n){
    const arr=[];
    for(let i=n-1;i>=0;i--){
      const ws=new Date();ws.setDate(ws.getDate()-ws.getDay()-i*7);ws.setHours(0,0,0,0);
      const we=new Date(ws);we.setDate(ws.getDate()+7);arr.push({ws,we,label:'W'+(n-i)});
    }
    return arr;
  }
  function revForDay(trips,dayStart){
    const dayEnd=new Date(dayStart);dayEnd.setDate(dayStart.getDate()+1);
    return trips.filter(t=>{const d=parseDate(t.date);return d&&d>=dayStart&&d<dayEnd;}).reduce((s,t)=>s+(t.amount||0),0);
  }
  function revForWeek(trips,ws,we){
    return trips.filter(t=>{const d=parseDate(t.date);return d&&d>=ws&&d<we;}).reduce((s,t)=>s+(t.amount||0),0);
  }

  // ‚îÄ‚îÄ CHART 1: Daily revenue bar ‚Äî 30 days ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const days30=buildDayLabels(30);
  mk('chartDaily','bar',
    days30.map(d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})),
    [{label:'Revenue',data:days30.map(d=>revForDay(all,d)),backgroundColor:'rgba(26,122,60,0.7)',borderColor:'#1a7a3c',borderWidth:1,borderRadius:3}]
  );

  // ‚îÄ‚îÄ CHART 2: Weekly comparison bar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const weeks=buildWeekLabels(8);
  mk('chartWeekly','bar',
    weeks.map(w=>w.label),
    [{label:'Revenue',data:weeks.map(w=>revForWeek(all,w.ws,w.we)),
      backgroundColor:weeks.map((_,i)=>i===weeks.length-1?'rgba(240,165,0,0.8)':'rgba(26,122,60,0.5)'),
      borderColor:weeks.map((_,i)=>i===weeks.length-1?'#f0a500':'#1a7a3c'),borderWidth:1,borderRadius:3}]
  );

  // ‚îÄ‚îÄ CHART 3: Revenue by car doughnut ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const cars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))];
  mk('chartCars','doughnut',cars,
    [{data:cars.map(car=>all.filter(t=>t.carPlate===car).reduce((s,t)=>s+(t.amount||0),0)),
      backgroundColor:PALETTE,borderColor:isDark?'#141f18':'#fff',borderWidth:2}],true
  );

  // ‚îÄ‚îÄ CHART 4: Daily trips count ‚Äî 14 days ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const days14=buildDayLabels(14);
  mk('chartTrips','line',
    days14.map(d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})),
    [{label:'Trips',data:days14.map(d=>{
        const de=new Date(d);de.setDate(d.getDate()+1);
        return all.filter(t=>{const rd=parseDate(t.date);return rd&&rd>=d&&rd<de;}).length;
      }),
      borderColor:'#f0a500',backgroundColor:'rgba(240,165,0,0.08)',borderWidth:2,fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#f0a500'}]
  );

  // ‚îÄ‚îÄ CHARTS 5 & 6: Revenue trends per driver / per car ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderTrendCharts(all,isDark,tc,gc,PALETTE,mk,buildDayLabels,buildWeekLabels,revForDay,revForWeek);
}

function hexRgba(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;}

function renderTrendCharts(all,isDark,tc,gc,PALETTE,mk,buildDayLabels,buildWeekLabels,revForDay,revForWeek){
  const n   = chartTrendPeriod==='weekly' ? null : parseInt(chartTrendPeriod);
  const isWeekly = chartTrendPeriod==='weekly';

  // Build labels
  const labels = isWeekly
    ? buildWeekLabels(12).map(w=>w.label)
    : buildDayLabels(n).map(d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'}));
  const periods = isWeekly ? buildWeekLabels(12) : buildDayLabels(n);

  function revForPeriod(trips,p){
    return isWeekly ? revForWeek(trips,p.ws,p.we) : revForDay(trips,p);
  }

  // ‚îÄ‚îÄ Chart 5: DRIVER trend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const allDrivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  let driverDatasets=[];
  if(chartTrendType==='driver'){
    const selected = chartTrendEntity
      ? allDrivers.filter(d=>d===chartTrendEntity)
      : allDrivers.slice(0,6); // cap at 6 for readability
    selected.forEach((driver,i)=>{
      const dTrips=all.filter(t=>t.driver===driver);
      const color=PALETTE[i%PALETTE.length];
      driverDatasets.push({
        label:driver.split(' ')[0]+(driver.split(' ')[1]?' '+driver.split(' ')[1].charAt(0)+'.':''),
        data:periods.map(p=>revForPeriod(dTrips,p)),
        borderColor:color,
        backgroundColor:hexRgba(color,.08),
        borderWidth:chartTrendEntity?2.5:1.8,
        fill:!!chartTrendEntity,tension:0.4,
        pointRadius:chartTrendEntity?4:2,pointHoverRadius:6,
        pointBackgroundColor:color
      });
    });
  }
  mk('chartDriverTrend','line',labels,driverDatasets,true,220);

  // ‚îÄ‚îÄ Chart 6: CAR trend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const allCars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  let carDatasets=[];
  if(chartTrendType==='car'){
    const selected = chartTrendEntity
      ? allCars.filter(c=>c===chartTrendEntity)
      : allCars.slice(0,6);
    selected.forEach((car,i)=>{
      const cTrips=all.filter(t=>t.carPlate===car);
      const color=PALETTE[i%PALETTE.length];
      carDatasets.push({
        label:car,
        data:periods.map(p=>revForPeriod(cTrips,p)),
        borderColor:color,
        backgroundColor:hexRgba(color,.08),
        borderWidth:chartTrendEntity?2.5:1.8,
        fill:!!chartTrendEntity,tension:0.4,
        pointRadius:chartTrendEntity?4:2,pointHoverRadius:6,
        pointBackgroundColor:color
      });
    });
  }
  mk('chartCarTrend','line',labels,carDatasets,true,220);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER LOG PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLog(){
  const el=document.getElementById('page-log');
  if(currentPage!=='log')return;
  if(tripState.driver)document.getElementById('driverBadge').textContent=tripState.driver.split(' ')[0]+' ¬∑ '+tripState.carPlate;
  else document.getElementById('driverBadge').textContent='‚Äî LOGIN ‚Äî';

  // SETUP
  if(tripState.phase==='setup'){
    el.innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle">DRIVER LOGIN</div>
        <div class="field"><label>Select Driver</label>
          <select id="selD"><option value="">‚Äî Choose Driver ‚Äî</option>
          ${DRIVERS.map(d=>`<option value="${d}" ${d===tripState.driver?'selected':''}>${d}</option>`).join('')}</select></div>
        <div class="field"><label>Car Plate</label>
          <select id="selP"><option value="">‚Äî Choose Car ‚Äî</option>
          ${CARS.map(c=>`<option value="${c}" ${c===tripState.carPlate?'selected':''}>${c}${shifts[c]?.open===false?' üî¥ CLOSED':shifts[c]?.open===true?' üü¢':''}</option>`).join('')}</select></div>
        <button class="bb bstart" onclick="saveDriver()">BEGIN SHIFT</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  // IDLE
  if(tripState.phase==='idle'){
    if(!isShiftOpen(tripState.carPlate)){
      el.innerHTML=`
        <div class="shift-block">
          <div class="shift-block-title">‚õî SHIFT CLOSED</div>
          <div class="shift-block-sub">THE SHIFT FOR <strong>${tripState.carPlate}</strong> IS CURRENTLY CLOSED<br>CONTACT YOUR SUPERVISOR TO OPEN THE SHIFT</div>
        </div>
        <button class="bout" onclick="goSetup()">CHANGE CAR / DRIVER</button>`;
      return;
    }
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">START TRIP</div>
        <div class="csub">// SELECT YOUR STARTING STATION</div>
        ${gpsBarHtml()}
        ${speedBadgeHtml()}
        <div class="field"><label>FROM STATION</label></div>
        ${stationGridHtml(tripState.fromStation?.name||null, null, 'from')}
        ${odomStartHtml()}
        ${(()=>{
          const odomReady = tripState.odomWorking ? !!tripState.odomStart : !!tripState.odomSkipReason;
          const canStart  = !!tripState.fromStation && odomReady;
          const why = !tripState.fromStation ? 'SELECT STATION' : !odomReady ? (tripState.odomWorking?'ENTER ODOMETER':'ENTER REASON') : '';
          return `<button id="startTripBtn" class="bb bstart" onclick="startTrip()" ${!canStart?'disabled':''}
            style="opacity:${canStart?'1':'0.45'};cursor:${canStart?'pointer':'not-allowed'}">
            üöå ${canStart?'START TRIP':`BLOCKED ‚Äî ${why}`}
          </button>`;
        })()}
        <button class="bout" onclick="goSetup()">CHANGE DRIVER / CAR</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  // ACTIVE
  if(tripState.phase==='active'){
    const secs=tripState.tripStart?Math.floor((Date.now()-tripState.tripStart)/1000):0;
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">TRIP IN PROGRESS</div>
        <div class="csub">// DRIVE TO DESTINATION ‚Äî TAP ARRIVE WHEN THERE</div>
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr">‚Üí</div>
          <div class="rs"><div class="rl">TO</div><div class="rn" style="color:var(--muted)">DESTINATION</div></div>
        </div>
        ${speedBadgeHtml()}
        <div class="tdisp">
          <div class="tl">TRIP DURATION</div>
          <div class="tv" id="timerVal">${String(Math.floor(secs/3600)).padStart(2,'0')}:${String(Math.floor((secs%3600)/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}</div>
        </div>
        <div class="lock"><div class="lico">üîí</div><div class="ltxt">DESTINATION LOCKED<br>ARRIVE AT STATION FIRST</div></div>
        <button class="bb barrive" onclick="arrive()">üìç I HAVE ARRIVED</button>
        <button class="bout" onclick="if(confirm('Cancel this trip?')){tripState.phase='idle';clearInterval(timerInterval);renderLog();}">CANCEL TRIP</button>
      </div>`;
    startTripTimer();
    return;
  }

  // ARRIVED
  if(tripState.phase==='arrived'){
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">END TRIP</div>
        <div class="csub">// CONFIRM DESTINATION & ENTER AMOUNT</div>
        ${gpsBarHtml()}
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr">‚Üí</div>
          <div class="rs"><div class="rl">TO</div><div class="rn">${tripState.toStation?tripState.toStation.name:'???'}</div></div>
        </div>
        <div class="field"><label>TO STATION</label></div>
        ${stationGridHtml(tripState.toStation?.name||null, tripState.fromStation.name, 'to')}
        <div class="field"><label>AMOUNT COLLECTED IN KES</label></div>
        <div class="awrap">
          <span class="apfx">KES</span>
          <input type="number" class="ainput" id="amtIn" placeholder="0" min="${AMOUNT_MIN}" max="${AMOUNT_MAX}" value="${tripState.amount||''}">
        </div>
        ${odomEndHtml()}
        ${fuelSectionHtml()}
        <div class="field"><label>TRIP NOTES (optional)</label>
          <textarea id="notesIn" placeholder="e.g. Road closed, vehicle issue, extra passengers...">${tripState.notes||''}</textarea>
        </div>
        <button class="bb bend" onclick="reviewTrip()" ${!tripState.toStation?'disabled':''}>REVIEW & CONFIRM ‚Üí</button>
      </div>`;
    return;
  }

  // CONFIRM
  if(tripState.phase==='confirm'){
    const dur=Math.floor((tripState.tripEnd-tripState.tripStart)/60000);
    const isHighAmount=tripState.amount>20000;
    el.innerHTML=`
      <div class="card" style="border-top:4px solid #22c55e">
        <div class="confirm-title">CONFIRM TRIP</div>
        ${isHighAmount?`<div class="confirm-warn">‚ö† AMOUNT IS HIGHER THAN USUAL ‚Äî PLEASE VERIFY</div>`:''}
        <div class="confirm-card">
          <div class="confirm-row"><span class="confirm-label">DRIVER</span><span class="confirm-val">${tripState.driver}</span></div>
          <div class="confirm-row"><span class="confirm-label">CAR</span><span class="confirm-val">${tripState.carPlate}</span></div>
          <div class="confirm-row"><span class="confirm-label">FROM</span><span class="confirm-val">${tripState.fromStation.name}</span></div>
          <div class="confirm-row"><span class="confirm-label">TO</span><span class="confirm-val">${tripState.toStation.name}</span></div>
          <div class="confirm-row"><span class="confirm-label">DURATION</span><span class="confirm-val">${dur} MIN</span></div>
          <div class="confirm-row"><span class="confirm-label">TIME</span><span class="confirm-val">${new Date().toLocaleTimeString()}</span></div>
          ${tripState.notes?`<div class="confirm-row"><span class="confirm-label">NOTES</span><span class="confirm-val">${tripState.notes}</span></div>`:''}
          ${tripState.odomWorking&&tripState.odomStart?`<div class="confirm-row"><span class="confirm-label">ODOM START</span><span class="confirm-val">${Number(tripState.odomStart).toLocaleString()} KM</span></div>`:''}
          ${tripState.odomWorking&&tripState.odomEnd?`<div class="confirm-row"><span class="confirm-label">ODOM END</span><span class="confirm-val">${Number(tripState.odomEnd).toLocaleString()} KM</span></div>`:''}
          ${tripState.odomWorking&&tripState.odomStart&&tripState.odomEnd&&tripState.odomEnd>tripState.odomStart?
            `<div class="confirm-row"><span class="confirm-label">DISTANCE</span><span class="confirm-val" style="color:var(--accent)">üìè ${tripState.odomEnd-tripState.odomStart} KM</span></div>`:
            !tripState.odomWorking?`<div class="confirm-row"><span class="confirm-label">ODOMETER</span><span class="confirm-val" style="color:var(--red)">‚ö† NOT WORKING</span></div>`:''}
          ${tripState.refueled?`
          <div class="confirm-row" style="border-top:1px dashed #f59e0b;padding-top:10px;margin-top:6px;border-bottom:none">
            <span class="confirm-label" style="color:#f59e0b">‚õΩ FUEL ADDED</span>
            <span class="confirm-val" style="color:#f59e0b">${tripState.fuelLiters} L</span>
          </div>
          <div class="confirm-row"><span class="confirm-label">FUEL COST</span><span class="confirm-val">KES ${Number(tripState.fuelCost).toLocaleString()}</span></div>
          ${tripState.fuelStation?`<div class="confirm-row"><span class="confirm-label">STATION</span><span class="confirm-val">${tripState.fuelStation}</span></div>`:''}
          ${tripState.fuelEfficiency?`<div class="confirm-row"><span class="confirm-label">EFFICIENCY</span><span class="confirm-val" style="color:${tripState.fuelEfficiency>=10?'#22c55e':tripState.fuelEfficiency>=7?'#f59e0b':'var(--red)'}">‚ö° ${(tripState.distance/tripState.fuelLiters).toFixed(2)} KM/L</span></div>`:''}
          `:''}
          <div class="confirm-row" style="padding-top:14px;margin-top:4px;border-top:2px solid var(--accent);border-bottom:none">
            <span class="confirm-label">AMOUNT COLLECTED</span>
            <span class="confirm-amount">KES ${Number(tripState.amount).toLocaleString()}</span>
          </div>
        </div>
        <button class="bb bconfirm" onclick="confirmAndSubmit()">‚úÖ CONFIRM &amp; SUBMIT</button>
        <button class="bout" onclick="backToEdit()">‚Üê GO BACK &amp; EDIT</button>
      </div>`;
    return;
  }

  // DONE
  if(tripState.phase==='done'){
    const last=localTrips[0];
    const today=new Date().toLocaleDateString('en-GB');
    const todayTrips=localTrips.filter(t=>t.date===today&&t.driver===tripState.driver);
    const todayTotal=todayTrips.reduce((s,t)=>s+t.amount,0);
    const carTarget=carTargets[tripState.carPlate];
    const driverTarget=driverTargets[tripState.driver];
    const target=driverTarget||carTarget;  // driver target takes priority
    const tpct=target?Math.min(100,Math.round((todayTotal/target)*100)):null;
    el.innerHTML=`
      <div class="scard">
        <div class="sico">‚úÖ</div>
        <div class="stitle">TRIP LOGGED!</div>
        <div class="sdetails">
          <div class="drow"><span>ROUTE</span><span>${last.fromStation} ‚Üí ${last.toStation}</span></div>
          <div class="drow"><span>DURATION</span><span>${last.duration} MIN</span></div>
          <div class="drow"><span>AMOUNT</span><span>KES ${Number(last.amount).toLocaleString()}</span></div>
          ${last.notes?`<div class="drow"><span>NOTES</span><span style="max-width:60%;text-align:right">${last.notes}</span></div>`:''}
          ${last.distance?`<div class="drow"><span>DISTANCE</span><span style="color:var(--accent)">üìè ${last.distance} KM</span></div>`:''}
          ${last.odomWorking===false?`<div class="drow"><span>ODOMETER</span><span style="color:var(--red)">‚ö† NOT WORKING</span></div>`:''}
          ${last.refueled?`<div class="drow" style="border-top:1px dashed #f59e0b;padding-top:8px;margin-top:4px"><span style="color:#f59e0b">‚õΩ FUEL ADDED</span><span style="color:#f59e0b">${last.fuelLiters} L ¬∑ KES ${Number(last.fuelCost).toLocaleString()}</span></div>`:''}
          ${last.fuelEfficiency?`<div class="drow"><span>EFFICIENCY</span><span style="color:${last.fuelEfficiency>=10?'#22c55e':last.fuelEfficiency>=7?'#f59e0b':'var(--red)'}">‚ö° ${last.fuelEfficiency} KM/L</span></div>`:''}
          ${last.fuelStation?`<div class="drow"><span>FUEL STATION</span><span>${last.fuelStation}</span></div>`:''}
        </div>
        <div class="ssub">${db&&isOnline()?'‚úÖ SYNCED TO FIREBASE':offlineQ.length?'üì¶ QUEUED FOR SYNC':'üíæ SAVED LOCALLY ‚Äî CONFIGURE FIREBASE IN ADMIN'}</div>
      </div>
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle" style="margin-bottom:12px">MY SHIFT TODAY</div>
        <div class="sumcard" style="margin-bottom:0">
          <div class="sumrow"><span class="sumlbl">TRIPS TODAY</span><span class="sumval">${todayTrips.length}</span></div>
          <div class="sumrow"><span class="sumlbl">REVENUE TODAY</span><span class="sumval">KES ${todayTotal.toLocaleString()}</span></div>
          <div class="sumrow"><span class="sumlbl">AVG PER TRIP</span><span class="sumval">KES ${todayTrips.length?Math.round(todayTotal/todayTrips.length).toLocaleString():'‚Äî'}</span></div>
          ${target?`<div class="sumrow"><span class="sumlbl">TARGET PROGRESS</span><span class="sumval" style="color:${tpct>=100?'#22c55e':'var(--red)'}">${tpct}%</span></div>
          <div style="margin-top:8px"><div class="target-bar"><div class="target-fill ${tpct>=100?'high':tpct>=50?'mid':'low'}" style="width:${tpct}%"></div></div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);margin-top:4px">KES ${todayTotal.toLocaleString()} of KES ${Number(target).toLocaleString()} ${driverTarget?'PERSONAL':'CAR'} TARGET</div></div>`:''}
        </div>
      </div>
      <button class="bb bstart" onclick="newTrip()">üöå START NEXT TRIP</button>
      <button class="bout" onclick="goSetup()">END SHIFT</button>
      ${renderTodayHistory()}`;
    return;
  }
}

function renderTodayHistory(){
  const today=new Date().toLocaleDateString('en-GB');
  const tt=localTrips.filter(t=>t.date===today&&t.driver===tripState.driver);
  if(!tt.length)return'';
  const tot=tt.reduce((s,t)=>s+t.amount,0);
  return`<div class="hsect"><div class="stitle2">MY TRIPS TODAY (${tt.length}) ¬∑ KES ${tot.toLocaleString()}</div>
  ${tt.slice(0,8).map(t=>`<div class="hitem">
    <div class="htop"><span class="hroute">${t.fromStation} ‚Üí ${t.toStation}</span><span class="hamt">KES ${Number(t.amount).toLocaleString()}</span></div>
    <div class="hbot"><span>${t.carPlate}${t.distance?` ¬∑ üìè ${t.distance}km`:''}${t.notes?` ¬∑ üìù ${t.notes.slice(0,22)}`:''}</span><span class="htime">${t.time}</span></div>
  </div>`).join('')}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderReports(){
  const el=document.getElementById('page-reports');
  const all=allData();
  const filtered=filterTrips(all);
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const avg=filtered.length?Math.round(total/filtered.length):0;
  const now=new Date();now.setHours(0,0,0,0);
  const todayT=all.filter(t=>{const d=parseDate(t.date);return d&&d>=now;});
  const allCars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const allDrivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  const allStations=[...new Set([...all.map(t=>t.fromStation),...all.map(t=>t.toStation)].filter(Boolean))].sort();
  const activeTags=[];
  if(filterCar)activeTags.push({l:'CAR: '+filterCar,c:"filterCar='';renderReports()"});
  if(filterDriver)activeTags.push({l:'DRV: '+filterDriver.split(' ')[0],c:"filterDriver='';renderReports()"});
  if(filterFrom)activeTags.push({l:'FROM: '+filterFrom,c:"filterFrom='';renderReports()"});
  if(filterTo)activeTags.push({l:'TO: '+filterTo,c:"filterTo='';renderReports()"});
  if(reportFilter!=='all')activeTags.push({l:reportFilter.toUpperCase(),c:"reportFilter='all';renderReports()"});

  el.innerHTML=`
    <div class="exprow">
      <button class="bsm bg" onclick="loadFirebaseData()">‚ü≥</button>
      <button class="bsm by" style="flex:3;letter-spacing:2px" onclick="openReportModal()">üìã GENERATE REPORT</button>
      <button class="bsm bgray" onclick="clearFilters()">‚úï</button>
    </div>
    <div class="sgrid2">
      <div class="sbox"><div class="sl">TOTAL TRIPS</div><div class="sv green">${filtered.length}</div></div>
      <div class="sbox"><div class="sl">TOTAL REVENUE</div><div class="sv green" style="font-size:1.1rem">KES ${total.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">AVG / TRIP</div><div class="sv yellow" style="font-size:1.1rem">KES ${avg.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">TODAY'S TRIPS</div><div class="sv">${todayT.length}</div></div>
    </div>
    <div class="rtabs">
      <button class="rtab ${reportTab==='overview'?'active':''}" onclick="reportTab='overview';renderReports()">OVERVIEW</button>
      <button class="rtab ${reportTab==='charts'?'active':''}" onclick="reportTab='charts';renderReports();setTimeout(renderCharts,80)">CHARTS</button>
      <button class="rtab ${reportTab==='leaderboard'?'active':''}" onclick="reportTab='leaderboard';renderReports()">LEADERBOARD</button>
      <button class="rtab ${reportTab==='performance'?'active':''}" onclick="reportTab='performance';renderReports()">PERFORMANCE</button>
      <button class="rtab ${reportTab==='live'?'active':''}" onclick="reportTab='live';renderReports();if(!liveSessionSub&&db)startSessionListener();"><span class="live-dot" style="display:${liveUnsubscribe?'inline-block':'none'}"></span>LIVE</button>
      <button class="rtab ${reportTab==='fuel'?'active':''}" onclick="reportTab='fuel';renderReports()">‚õΩ FUEL</button>
    </div>
    <div id="rsect-overview" class="rsect ${reportTab==='overview'?'active':''}">
      <div class="card" style="padding:13px;margin-bottom:11px">
        <div class="stitle2" style="margin-bottom:9px">üîç FILTER REPORTS</div>
        <div class="fchips">${['all','today','week','month'].map(f=>`<div class="fchip ${reportFilter===f?'active':''}" onclick="reportFilter='${f}';renderReports()">${f==='all'?'ALL TIME':f.toUpperCase()}</div>`).join('')}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px">
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">BY CAR</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterCar=this.value;renderReports()">
              <option value="">All Cars</option>${allCars.map(c=>`<option value="${c}" ${filterCar===c?'selected':''}>${c}</option>`).join('')}</select></div>
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">BY DRIVER</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterDriver=this.value;renderReports()">
              <option value="">All Drivers</option>${allDrivers.map(d=>`<option value="${d}" ${filterDriver===d?'selected':''}>${d.split(' ')[0]}</option>`).join('')}</select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">FROM</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterFrom=this.value;renderReports()">
              <option value="">Any</option>${allStations.map(s=>`<option value="${s}" ${filterFrom===s?'selected':''}>${s}</option>`).join('')}</select></div>
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">TO</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterTo=this.value;renderReports()">
              <option value="">Any</option>${allStations.map(s=>`<option value="${s}" ${filterTo===s?'selected':''}>${s}</option>`).join('')}</select></div>
        </div>
        ${activeTags.length?`<div style="margin-top:9px;display:flex;flex-wrap:wrap;gap:4px">${activeTags.map(t=>`<div class="tag-active">${t.l} <span onclick="${t.c}">‚úï</span></div>`).join('')}</div>`:''}
        <div style="margin-top:10px;padding:10px 12px;background:var(--accent);display:flex;justify-content:space-between;align-items:center">
          <div style="font-family:var(--font-m);font-size:.48rem;color:rgba(255,255,255,.7);letter-spacing:1px">MATCHING TRIPS</div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <span style="font-family:var(--font-d);font-size:1.5rem;color:#fff;letter-spacing:2px">${filtered.length}</span>
            <span style="font-family:var(--font-m);font-size:.52rem;color:rgba(255,255,255,.7)">¬∑ KES ${total.toLocaleString()}</span>
          </div>
        </div>
      </div>
      ${filtered.length===0?'<div class="empty">NO RESULTS<br>TRY DIFFERENT FILTERS OR SYNC</div>':`
      <div class="rtable">
        <div class="rth"><span>ROUTE</span><span>DRIVER</span><span>DATE</span><span>AMOUNT</span></div>
        ${filtered.slice(0,80).map(t=>`<div class="rtr">
          <div><div class="trroute">${(t.fromStation||'').slice(0,7)}‚Üí${(t.toStation||'').slice(0,7)}</div><div style="font-family:var(--font-m);font-size:.43rem;color:var(--muted)">${t.carPlate||''}</div></div>
          <div style="font-size:.64rem;color:var(--muted)">${(t.driver||'').split(' ')[0]}</div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted)">${(t.date||'').slice(0,10)}</div>
          <div class="tramt">KES ${Number(t.amount||0).toLocaleString()}</div>
        </div>`).join('')}
      </div>
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-align:center;padding:6px">SHOWING ${Math.min(80,filtered.length)} OF ${filtered.length}</div>`}
      ${renderCarBars(filtered,total)}
    </div>
    <div class="rsect ${reportTab==='charts'?'active':''}">
      <!-- Standard charts -->
      <div class="chart-wrap"><div class="chart-title">DAILY REVENUE ‚Äî 30 DAYS</div><div class="chart-canvas"><canvas id="chartDaily"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">WEEKLY COMPARISON</div><div class="chart-canvas"><canvas id="chartWeekly"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">REVENUE BY CAR ‚Äî TOTAL SHARE</div><div class="chart-canvas"><canvas id="chartCars"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">DAILY TRIPS ‚Äî 14 DAYS</div><div class="chart-canvas"><canvas id="chartTrips"></canvas></div></div>

      <!-- Trend charts with filter -->
      <div class="card" style="padding:13px;margin-bottom:11px">
        <div class="chart-title" style="margin-bottom:10px">üìà REVENUE TREND FILTER</div>

        <!-- Type toggle -->
        <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px">VIEW BY</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
          <div class="fchip ${chartTrendType==='driver'?'active':''}"
            onclick="chartTrendType='driver';chartTrendEntity='';renderReports();setTimeout(renderCharts,60)">üë§ DRIVER</div>
          <div class="fchip ${chartTrendType==='car'?'active':''}"
            onclick="chartTrendType='car';chartTrendEntity='';renderReports();setTimeout(renderCharts,60)">üöó CAR</div>
        </div>

        <!-- Entity selector -->
        <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px">
          ${chartTrendType==='driver'?'SELECT DRIVER (BLANK = ALL)':'SELECT CAR (BLANK = ALL)'}
        </div>
        <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.82rem;outline:none;appearance:none;margin-bottom:10px"
          onchange="chartTrendEntity=this.value;renderCharts()">
          <option value="">‚Äî ${chartTrendType==='driver'?'All Drivers (compare top 6)':'All Cars (compare top 6)'} ‚Äî</option>
          ${chartTrendType==='driver'
            ? [...new Set(allData().map(t=>t.driver).filter(Boolean))].sort().map(d=>`<option value="${d}" ${chartTrendEntity===d?'selected':''}>${d}</option>`).join('')
            : [...new Set(allData().map(t=>t.carPlate).filter(Boolean))].sort().map(car=>`<option value="${car}" ${chartTrendEntity===car?'selected':''}>${car}</option>`).join('')
          }
        </select>

        <!-- Period toggle -->
        <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px">PERIOD</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
          <div class="fchip ${chartTrendPeriod==='14'?'active':''}"
            onclick="chartTrendPeriod='14';renderCharts()">14 DAYS</div>
          <div class="fchip ${chartTrendPeriod==='30'?'active':''}"
            onclick="chartTrendPeriod='30';renderCharts()">30 DAYS</div>
          <div class="fchip ${chartTrendPeriod==='weekly'?'active':''}"
            onclick="chartTrendPeriod='weekly';renderCharts()">WEEKLY</div>
        </div>
      </div>

      <!-- Driver trend chart -->
      <div class="chart-wrap" style="${chartTrendType==='driver'?'':'display:none'}">
        <div class="chart-title">
          REVENUE TREND ‚Äî ${chartTrendEntity?chartTrendEntity:'TOP DRIVERS'}
          <span style="font-size:.44rem;color:var(--muted);font-family:var(--font-b);letter-spacing:0;font-weight:400;margin-left:6px">
            ${chartTrendPeriod==='weekly'?'WEEKLY ¬∑ 12 WEEKS':chartTrendPeriod+' DAYS'}
          </span>
        </div>
        <div class="chart-canvas" style="height:220px"><canvas id="chartDriverTrend"></canvas></div>
      </div>

      <!-- Car trend chart -->
      <div class="chart-wrap" style="${chartTrendType==='car'?'':'display:none'}">
        <div class="chart-title">
          REVENUE TREND ‚Äî ${chartTrendEntity?chartTrendEntity:'ALL CARS'}
          <span style="font-size:.44rem;color:var(--muted);font-family:var(--font-b);letter-spacing:0;font-weight:400;margin-left:6px">
            ${chartTrendPeriod==='weekly'?'WEEKLY ¬∑ 12 WEEKS':chartTrendPeriod+' DAYS'}
          </span>
        </div>
        <div class="chart-canvas" style="height:220px"><canvas id="chartCarTrend"></canvas></div>
      </div>
    </div>
    <div class="rsect ${reportTab==='leaderboard'?'active':''}">${renderLeaderboard(filtered)}</div>
    <div class="rsect ${reportTab==='performance'?'active':''}">${renderPerformance(all)}</div>
    <div id="rsect-live" class="rsect ${reportTab==='live'?'active':''}" ></div>
  <div id="rsect-fuel" class="rsect ${reportTab==='fuel'?'active':''}" ></div>`;
  if(reportTab==='live')setTimeout(renderLiveTab,0);
  if(reportTab==='fuel')setTimeout(renderFuelTab,0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER FUEL / ODOMETER TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFuelTab(){
  const el = document.getElementById('rsect-fuel');
  if(!el) return;
  const all = allData();

  // Trips with valid odometer distance
  const odomTrips   = all.filter(t => t.distance && t.distance > 0);
  // Trips where fuel was added
  const fuelTrips   = all.filter(t => t.refueled && t.fuelLiters > 0 && t.fuelCost > 0);
  // Trips with both distance AND fuel (efficiency computable)
  const effTrips    = all.filter(t => t.fuelEfficiency && t.fuelEfficiency > 0);
  // Trips where odometer broken
  const noOdomTrips = all.filter(t => t.odomWorking === false);

  const allCars    = [...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const allDrivers = [...new Set(all.map(t=>t.driver).filter(Boolean))].sort();

  // Fleet totals
  const totalLitres   = fuelTrips.reduce((s,t)=>s+(t.fuelLiters||0),0);
  const totalFuelCost = fuelTrips.reduce((s,t)=>s+(t.fuelCost||0),0);
  const totalKm       = odomTrips.reduce((s,t)=>s+(t.distance||0),0);
  const fleetEff      = effTrips.length
    ? (effTrips.reduce((s,t)=>s+t.fuelEfficiency,0)/effTrips.length).toFixed(2) : null;
  const capRate       = all.length ? Math.round((odomTrips.length/all.length)*100) : 0;

  // Per-car stats
  const carStats = allCars.map(car=>{
    const cFuel = fuelTrips.filter(t=>t.carPlate===car);
    const cOdom = odomTrips.filter(t=>t.carPlate===car);
    const cEff  = effTrips.filter(t=>t.carPlate===car);
    const litres    = cFuel.reduce((s,t)=>s+(t.fuelLiters||0),0);
    const fuelCost  = cFuel.reduce((s,t)=>s+(t.fuelCost||0),0);
    const km        = cOdom.reduce((s,t)=>s+(t.distance||0),0);
    const avgEff    = cEff.length?(cEff.reduce((s,t)=>s+t.fuelEfficiency,0)/cEff.length).toFixed(2):null;
    const costPerKm = (fuelCost&&km)?(fuelCost/km).toFixed(1):null;
    const lastOdom  = [...cOdom].sort((a,b)=>b.dateMs-a.dateMs)[0]?.odomEnd;
    const noOdom    = noOdomTrips.filter(t=>t.carPlate===car).length;
    const allCarT   = all.filter(t=>t.carPlate===car).length;
    const capR      = allCarT?Math.round((cOdom.length/allCarT)*100):0;
    const fuelEvents= cFuel.length;
    return{car,litres,fuelCost,km,avgEff,costPerKm,lastOdom,noOdom,capR,fuelEvents,effCount:cEff.length};
  }).filter(s=>s.km>0||s.litres>0||s.noOdom>0);

  // Per-driver stats
  const driverStats = allDrivers.map(driver=>{
    const dFuel = fuelTrips.filter(t=>t.driver===driver);
    const dOdom = odomTrips.filter(t=>t.driver===driver);
    const dEff  = effTrips.filter(t=>t.driver===driver);
    const litres   = dFuel.reduce((s,t)=>s+(t.fuelLiters||0),0);
    const fuelCost = dFuel.reduce((s,t)=>s+(t.fuelCost||0),0);
    const km       = dOdom.reduce((s,t)=>s+(t.distance||0),0);
    const avgEff   = dEff.length?(dEff.reduce((s,t)=>s+t.fuelEfficiency,0)/dEff.length).toFixed(2):null;
    return{driver,litres,fuelCost,km,avgEff,fuelEvents:dFuel.length};
  }).filter(s=>s.km>0||s.litres>0);

  // Recent fuel log (last 20 fuel events)
  const recentFuel = fuelTrips.sort((a,b)=>b.dateMs-a.dateMs).slice(0,20);
  // Skip log
  const skipLog    = all.filter(t=>t.odomWorking===false&&t.odomSkipReason)
    .sort((a,b)=>b.dateMs-a.dateMs).slice(0,15);

  function effColor(v){ return v>=10?'#22c55e':v>=7?'#f59e0b':'var(--red)'; }
  function effLabel(v){ return v>=10?'GOOD':v>=7?'AVG':'POOR'; }

  el.innerHTML = `
    <!-- ‚îÄ‚îÄ FLEET SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px">
      <div class="live-stat" style="grid-column:1/-1">
        <div class="lsl">FLEET FUEL COST (ALL TIME)</div>
        <div class="lsv" style="font-size:1.1rem;color:#f59e0b">KES ${totalFuelCost.toLocaleString()}</div>
      </div>
      <div class="live-stat"><div class="lsl">TOTAL LITRES</div><div class="lsv" style="color:#f59e0b">${totalLitres.toFixed(1)}L</div></div>
      <div class="live-stat"><div class="lsl">TOTAL KM TRACKED</div><div class="lsv">${(totalKm/1000).toFixed(1)}K</div></div>
      <div class="live-stat"><div class="lsl">FLEET AVG EFFICIENCY</div>
        <div class="lsv" style="color:${fleetEff?effColor(parseFloat(fleetEff)):'var(--muted)'}">${fleetEff||'‚Äî'}<span style="font-size:.7rem;font-family:var(--font-b);color:var(--muted)"> KM/L</span></div>
      </div>
      <div class="live-stat"><div class="lsl">ODOM CAPTURE RATE</div>
        <div class="lsv" style="color:${capRate>=80?'#22c55e':capRate>=50?'#f59e0b':'var(--red)'}">${capRate}%</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ BY CAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="stitle2" style="margin-bottom:8px">‚õΩ FUEL EFFICIENCY BY CAR</div>
    ${carStats.length ? carStats.sort((a,b)=>parseFloat(b.avgEff||0)-parseFloat(a.avgEff||0)).map(s=>`
      <div class="fuel-stat">
        <div class="fuel-stat-top">
          <span class="fuel-stat-car">${s.car}</span>
          <div style="text-align:right">
            ${s.avgEff?`<span class="fuel-stat-km" style="color:${effColor(parseFloat(s.avgEff))}">${s.avgEff}<span style="font-size:.65rem;font-family:var(--font-b);color:var(--muted)"> KM/L</span></span>`
            :`<span style="font-family:var(--font-m);font-size:.52rem;color:var(--muted)">NO EFF DATA</span>`}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:7px">
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">TOTAL KM</div><div style="font-size:.72rem;font-family:var(--font-m)">${s.km.toLocaleString()}</div></div>
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">LITRES</div><div style="font-size:.72rem;font-family:var(--font-m)">${s.litres.toFixed(1)}</div></div>
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">FUEL COST</div><div style="font-size:.72rem;font-family:var(--font-m)">KES ${(s.fuelCost/1000).toFixed(1)}K</div></div>
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">KES/KM</div><div style="font-size:.72rem;font-family:var(--font-m)">${s.costPerKm||'‚Äî'}</div></div>
        </div>
        ${s.lastOdom?`<div style="font-size:.5rem;color:var(--muted);font-family:var(--font-m);margin-bottom:4px">LAST READING: <strong style="color:var(--text)">${Number(s.lastOdom).toLocaleString()} KM</strong> ¬∑ CAPTURE RATE: <strong style="color:${s.capR>=80?'#22c55e':'#f59e0b'}">${s.capR}%</strong></div>`:''}
        ${s.avgEff?`<div style="height:5px;background:var(--border);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(100,(parseFloat(s.avgEff)/15)*100)}%;background:${effColor(parseFloat(s.avgEff))};border-radius:3px;transition:width 1s"></div></div>`:''}
        ${s.noOdom>0?`<div class="fuel-warn" style="margin-top:6px;margin-bottom:0">‚ö† ${s.noOdom} TRIP${s.noOdom>1?'S':''} WITH ODOMETER NOT WORKING</div>`:''}
      </div>`).join('')
    : `<div style="text-align:center;padding:24px;color:var(--muted);font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;line-height:2">NO FUEL DATA YET<br>DRIVERS MUST TOGGLE "REFUEL" WHEN ADDING FUEL</div>`}

    <!-- ‚îÄ‚îÄ BY DRIVER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    ${driverStats.length?`
    <div class="stitle2" style="margin:12px 0 8px">üë§ EFFICIENCY BY DRIVER</div>
    ${driverStats.filter(s=>s.avgEff).sort((a,b)=>parseFloat(b.avgEff)-parseFloat(a.avgEff)).map((s,i)=>`
      <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:6px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center">
        <div style="font-family:var(--font-d);font-size:1.3rem;color:${i===0?'#f0a500':i===1?'var(--muted)':i===2?'#cd7f32':'var(--border)'}">${i+1}</div>
        <div>
          <div style="font-family:var(--font-m);font-size:.62rem;font-weight:600">${s.driver}</div>
          <div style="font-size:.5rem;color:var(--muted)">${s.km.toLocaleString()} km ¬∑ ${s.litres.toFixed(1)}L ¬∑ ${s.fuelEvents} fill-up${s.fuelEvents!==1?'s':''}</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:var(--font-d);font-size:1.25rem;color:${effColor(parseFloat(s.avgEff))}">${s.avgEff}</div>
          <div style="font-family:var(--font-m);font-size:.42rem;color:var(--muted)">KM/L</div>
        </div>
      </div>`).join('')}`:''}

    <!-- ‚îÄ‚îÄ RECENT FUEL LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    ${recentFuel.length?`
    <div class="stitle2" style="margin:12px 0 8px">‚õΩ RECENT FUEL EVENTS</div>
    ${recentFuel.map(t=>`
      <div style="background:var(--card);border:1px solid var(--border);border-left:3px solid #f59e0b;padding:9px 12px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-family:var(--font-m);font-size:.6rem;font-weight:700;color:#f59e0b">‚õΩ ${t.fuelLiters}L ¬∑ KES ${Number(t.fuelCost).toLocaleString()}</span>
          <span style="font-size:.5rem;color:var(--muted)">${t.date||''} ${t.time||''}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.58rem">
          <span><strong style="color:var(--text)">${t.driver?t.driver.split(' ')[0]:''}</strong> ¬∑ <span style="color:var(--accent)">${t.carPlate||''}</span>${t.fuelStation?` ¬∑ ${t.fuelStation}`:''}</span>
          ${t.fuelEfficiency?`<span style="font-family:var(--font-m);font-size:.56rem;font-weight:700;color:${effColor(t.fuelEfficiency)}">‚ö° ${t.fuelEfficiency} KM/L</span>`:''}
        </div>
        ${t.distance?`<div style="font-size:.5rem;color:var(--muted);margin-top:2px">${t.fromStation||'?'} ‚Üí ${t.toStation||'?'} ¬∑ ${t.distance} km${t.fuelCostPerKm?` ¬∑ KES ${t.fuelCostPerKm}/km`:''}</div>`:''}
      </div>`).join('')}`:''}

    <!-- ‚îÄ‚îÄ ODOMETER SKIP LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    ${skipLog.length?`
    <div class="stitle2" style="margin:12px 0 8px">‚ö† ODOMETER SKIP LOG</div>
    ${skipLog.map(t=>`
      <div style="background:var(--card);border:1px solid var(--border);border-left:3px solid var(--red);padding:9px 12px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
          <span style="font-family:var(--font-m);font-size:.58rem;font-weight:600">${t.driver?t.driver.split(' ')[0]:''} ¬∑ <span style="color:var(--accent)">${t.carPlate||''}</span></span>
          <span style="font-size:.5rem;color:var(--muted)">${t.date||''}</span>
        </div>
        <div style="font-size:.64rem;color:var(--text)">${t.odomSkipReason}</div>
        <div style="font-size:.5rem;color:var(--muted);margin-top:2px">${t.fromStation||'?'} ‚Üí ${t.toStation||'?'}</div>
      </div>`).join('')}`:''}
  `;
}

function renderCarBars(filtered,total){
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  if(!cars.length)return'';
  const today=new Date().toLocaleDateString('en-GB');
  return`<div class="stitle2" style="margin-bottom:9px;margin-top:4px">REVENUE BY CAR</div>
  ${cars.map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car),cr=ct.reduce((s,t)=>s+t.amount,0),pct=total?Math.round((cr/total)*100):0;
    const todayRev=localTrips.filter(t=>t.carPlate===car&&t.date===today).reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car],tpct=target?Math.min(100,Math.round((todayRev/target)*100)):null;
    return`<div class="hitem" style="margin-bottom:7px;cursor:pointer" onclick="filterCar=filterCar==='${car}'?'':'${car}';renderReports()">
      <div class="htop"><span class="hroute">${car}${shifts[car]?.open===false?' <span style=\\"background:var(--red);color:#fff;font-size:.42rem;padding:1px 5px\\">CLOSED</span>':''}</span><span class="hamt">KES ${cr.toLocaleString()}</span></div>
      <div class="bar-mini"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="hbot" style="margin-top:4px"><span>${ct.length} trips ¬∑ ${pct}% of total</span>${target?`<span style="color:${tpct>=100?'#22c55e':tpct>=50?'var(--accent2)':'var(--red)'}">TODAY ${tpct}%</span>`:''}</div>
    </div>`;
  }).join('')}`;
}

function renderLeaderboard(filtered){
  if(!filtered.length)return'<div class="empty">NO DATA<br>SYNC FROM FIREBASE OR LOG TRIPS</div>';
  const dm={};filtered.forEach(t=>{const d=t.driver||'?';if(!dm[d])dm[d]={trips:0,revenue:0};dm[d].trips++;dm[d].revenue+=t.amount||0;});
  const dr=Object.entries(dm).sort((a,b)=>b[1].revenue-a[1].revenue);
  const mr=dr[0]?.[1].revenue||1;
  const cm={};filtered.forEach(t=>{const c=t.carPlate||'?';if(!cm[c])cm[c]={trips:0,revenue:0};cm[c].trips++;cm[c].revenue+=t.amount||0;});
  const cr=Object.entries(cm).sort((a,b)=>b[1].revenue-a[1].revenue);
  return`
    <div class="stitle2" style="margin-bottom:9px">üèÜ TOP DRIVERS BY REVENUE</div>
    ${dr.slice(0,7).map(([name,data],i)=>{
      const dt=driverTargets[name];
      const today=new Date().toLocaleDateString('en-GB');
      const todayRev=filtered.filter(t=>t.driver===name&&t.date===today).reduce((s,t)=>s+t.amount,0);
      const tpct=dt?Math.min(100,Math.round((todayRev/dt)*100)):null;
      return`<div class="lb-item">
        <div class="lb-rank ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
        <div style="flex:1;min-width:0">
          <div class="lb-name">${name.split(' ')[0]} ${name.split(' ')[1]||''}</div>
          <div class="lb-sub">${data.trips} trips${dt?' ¬∑ üéØ KES '+Number(dt).toLocaleString():''}</div>
          <div class="bar-mini" style="width:90%"><div class="bar-fill" style="width:${Math.round((data.revenue/mr)*100)}%"></div></div>
          ${dt?`<div class="target-bar" style="margin-top:3px;width:90%"><div class="target-fill ${tpct>=100?'high':tpct>=50?'mid':'low'}" style="width:${tpct}%"></div></div>
          <div style="font-family:var(--font-m);font-size:.42rem;color:var(--muted);margin-top:2px">TODAY ${tpct}% OF DAILY TARGET</div>`:''}
        </div>
        <div><div class="lb-val">KES ${(data.revenue/1000).toFixed(1)}K</div><div class="lb-vsub">KES ${data.trips?Math.round(data.revenue/data.trips).toLocaleString():'‚Äî'}/trip</div></div>
      </div>`;
    }).join('')}
    <div class="stitle2" style="margin-bottom:9px;margin-top:14px">üöó TOP CARS BY REVENUE</div>
    ${cr.map(([plate,data],i)=>`<div class="lb-item">
      <div class="lb-rank ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
      <div><div class="lb-name">${plate}</div><div class="lb-sub">${data.trips} trips</div>
      <div class="bar-mini" style="width:80%"><div class="bar-fill" style="width:${Math.round((data.revenue/(cr[0][1].revenue||1))*100)}%"></div></div></div>
      <div><div class="lb-val">KES ${(data.revenue/1000).toFixed(1)}K</div><div class="lb-vsub">${data.trips?Math.round(data.revenue/data.trips).toLocaleString():''}/trip</div></div>
    </div>`).join('')}`;
}

function renderPerformance(all){
  if(!all.length)return'<div class="empty">NO DATA<br>SYNC FROM FIREBASE OR LOG TRIPS</div>';
  const drivers=[...new Set(all.map(t=>t.driver).filter(Boolean))];
  const allAvgs=drivers.map(d=>{const dt=all.filter(t=>t.driver===d);return dt.length?dt.reduce((s,t)=>s+t.amount,0)/dt.length:0;});
  const maxAvg=Math.max(...allAvgs)||1;
  const allDays=drivers.map(d=>[...new Set(all.filter(t=>t.driver===d).map(t=>t.date))].length);
  const maxDays=Math.max(...allDays)||1;
  const allTrips=drivers.map(d=>all.filter(t=>t.driver===d).length);
  const maxTrips=Math.max(...allTrips)||1;
  return drivers.map((driver,di)=>{
    const dtrips=all.filter(t=>t.driver===driver);
    const rev=dtrips.reduce((s,t)=>s+t.amount,0);
    const avg=dtrips.length?Math.round(rev/dtrips.length):0;
    const days=[...new Set(dtrips.map(t=>t.date))].length;
    const bestDay=dtrips.reduce((best,t)=>{const dr=dtrips.filter(x=>x.date===t.date).reduce((s,x)=>s+x.amount,0);return dr>best?dr:best;},0);
    const score=Math.round((allAvgs[di]/maxAvg)*50+(allDays[di]/maxDays)*30+(allTrips[di]/maxTrips)*20);
    const grade=score>=80?'A':score>=60?'B':'C';
    return`<div class="perf-card">
      <div class="perf-name">${driver.split(' ')[0]} ${driver.split(' ')[1]||''} <span class="score-badge score-${grade.toLowerCase()}">${grade}</span></div>
      <div class="perf-grid">
        <div class="pstat"><div class="pl">TOTAL TRIPS</div><div class="pv">${dtrips.length}</div></div>
        <div class="pstat"><div class="pl">REVENUE</div><div class="pv" style="font-size:.85rem">KES ${(rev/1000).toFixed(1)}K</div></div>
        <div class="pstat"><div class="pl">AVG/TRIP</div><div class="pv" style="font-size:.85rem">KES ${avg.toLocaleString()}</div></div>
        <div class="pstat"><div class="pl">DAYS ACTIVE</div><div class="pv">${days}</div></div>
        <div class="pstat"><div class="pl">BEST DAY</div><div class="pv" style="font-size:.85rem">KES ${bestDay.toLocaleString()}</div></div>
        <div class="pstat"><div class="pl">SCORE</div><div class="pv">${score}/100</div></div>
      </div>
      <div style="margin-top:9px"><div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);margin-bottom:4px">PERFORMANCE SCORE</div>
      <div class="target-bar"><div class="target-fill ${score>=80?'high':score>=60?'mid':'low'}" style="width:${score}%"></div></div></div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAdmin(){
  const el=document.getElementById('page-admin');
  if(!adminUnlocked){
    const locked=isAdminLocked();
    el.innerHTML=`
      <div class="apinbox">
        <div class="apintitle">ADMIN ACCESS</div>
        <div class="apinsub">ENTER PIN TO MANAGE SHIFTS,<br>STATIONS, DRIVERS & SETTINGS</div>
        ${locked?`<div class="pin-locked">üîí TOO MANY ATTEMPTS<br>TRY AGAIN IN ${adminLockSecsLeft()}s</div>`:''}
        <input type="password" class="pininput" id="pinIn" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          ${locked?'disabled':''} onkeydown="if(event.key==='Enter')checkPin()">
        <button class="bb bstart" style="max-width:200px;margin:0 auto;display:block"
          onclick="checkPin()" ${locked?'disabled':''}>UNLOCK</button>
        <div style="margin-top:14px">
          <button class="bghost" style="font-size:.48rem;letter-spacing:1px;padding:5px 12px;border:none;color:var(--muted)"
            onclick="openResetOverlay()">üîë FORGOT PIN?</button>
        </div>
      </div>`;
    return;
  }
  el.innerHTML=`
    <div class="card" style="border-left:4px solid var(--accent2);margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="ctitle" style="margin:0">ADMIN PANEL</div>
        <button class="bghost" onclick="adminUnlocked=false;devUnlocked=false;adminTab='shifts';renderAdmin()">üîí LOCK</button>
      </div>
    </div>
    <div class="atabs">
      <button class="atab ${adminTab==='shifts'?'active':''}" onclick="adminTab='shifts';renderAdmin()">SHIFTS</button>
      <button class="atab ${adminTab==='drivers'?'active':''}" onclick="adminTab='drivers';renderAdmin()">DRIVERS</button>
      <button class="atab ${adminTab==='cars'?'active':''}" onclick="adminTab='cars';renderAdmin()">CARS</button>
      <button class="atab ${adminTab==='stations'?'active':''}" onclick="adminTab='stations';renderAdmin()">STATIONS</button>
      <button class="atab ${adminTab==='trips'?'active':''}" onclick="adminTab='trips';renderAdmin()">TRIPS</button>
      <button class="atab ${adminTab==='config'?'active':''}" onclick="openDevTab('config')"
        style="${adminTab==='config'?'':''}">
        CONFIG <span style="font-size:.38rem;opacity:.6">üîí</span>
      </button>
      <button class="atab ${adminTab==='settings'?'active':''}" onclick="openDevTab('settings')"
        style="${adminTab==='settings'?'color:var(--red);border-bottom-color:var(--red)':'color:var(--red);opacity:.7'}">
        ‚öô DEV <span style="font-size:.38rem;opacity:.6">üîí</span>
      </button>
    </div>

    <!-- SHIFTS -->
    <div class="asect ${adminTab==='shifts'?'active':''}">
      <div class="card">
        <div class="ctitle">SHIFT MANAGEMENT</div>
        <div class="csub">// OPEN OR CLOSE SHIFTS PER CAR ‚Äî CLOSED CARS CANNOT LOG TRIPS</div>
        ${CARS.map(car=>{
          const s=shifts[car];
          const isOpen=s?.open===true;
          const isClosed=s?.open===false;
          const openTime=s?.openedAt?new Date(s.openedAt).toLocaleTimeString():'';
          return`<div class="aitem" style="margin-bottom:8px">
            <div style="flex:1">
              <div class="aitem-name">${car}</div>
              <div class="aitem-sub">
                ${isOpen?`<span class="shift-open">üü¢ OPEN</span> since ${openTime} by ${s.openedBy||'?'}`
                :isClosed?`<span class="shift-closed">üî¥ CLOSED</span> at ${s?.closedAt?new Date(s.closedAt).toLocaleTimeString():''}`
                :'<span style="font-family:var(--font-m);font-size:.52rem;color:var(--muted)">NO SHIFT SET</span>'}
              </div>
            </div>
            <div class="abtn-row">
              ${!isOpen?`<button class="bsm bg" onclick="openShift('${car}')">OPEN</button>`:''}
              ${isOpen?`<button class="bsm br" onclick="showCloseShiftSummary('${car}')">CLOSE</button>`:''}
            </div>
          </div>`;
        }).join('')}
        <div class="divline"></div>
        <div style="display:flex;gap:7px">
          <button class="bsm bg" style="flex:1;padding:10px" onclick="openAllShifts()">OPEN ALL</button>
          <button class="bsm br" style="flex:1;padding:10px" onclick="closeAllShifts()">CLOSE ALL</button>
        </div>
      </div>
    </div>

    <!-- DRIVERS -->
    <div class="asect ${adminTab==='drivers'?'active':''}">
      <div class="card">
        <div class="ctitle">DRIVERS <span class="pill">${DRIVERS.length}</span></div>
        <div class="csub">// SET DAILY REVENUE TARGETS PER DRIVER</div>
        ${DRIVERS.map((d,i)=>{
          const esc=d.replace(/'/g,"\'");
          const target=driverTargets[d];
          return`<div class="aitem" style="flex-direction:column;align-items:stretch;gap:8px;padding:12px">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div class="aitem-name">${d}</div>
                <div class="aitem-sub">PIN: ${driverPins[d]?'SET ‚úì':'NOT SET'} &nbsp;¬∑&nbsp; Target: ${target?'KES '+Number(target).toLocaleString():'<span style="color:var(--muted)">Not set</span>'}</div>
              </div>
              <div class="abtn-row">
                <button class="aedit" onclick="adminSetDriverPin('${esc}')">üîë</button>
                <button class="adel" onclick="removeDriver(${i})">‚úï</button>
              </div>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);white-space:nowrap;letter-spacing:1px">DAILY TARGET KES</div>
              <input type="number" id="dt_${i}" placeholder="e.g. 5000" value="${target||''}"
                style="flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:7px 9px;font-family:var(--font-m);font-size:.78rem;outline:none;min-width:0"
                onkeydown="if(event.key==='Enter')saveDriverTarget('${esc}',${i})">
              <button class="bsm bg" onclick="saveDriverTarget('${esc}',${i})">SET</button>
              ${target?`<button class="bsm br" onclick="removeDriverTarget('${esc}')">‚úï</button>`:''}
            </div>
          </div>`;
        }).join('')}
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Driver Name</label><input type="text" id="newDriver" placeholder="FULL NAME IN CAPS"></div>
          <button class="bsm bg" onclick="addDriver()">ADD</button>
        </div>
      </div>
    </div>

    <!-- CARS -->
    <div class="asect ${adminTab==='cars'?'active':''}">
      <div class="card">
        <div class="ctitle">CARS <span class="pill">${CARS.length}</span></div>
        ${CARS.map((c,i)=>`<div class="aitem">
          <div><div class="aitem-name">${c}</div><div class="aitem-sub">Target: ${carTargets[c]?'KES '+Number(carTargets[c]).toLocaleString():'Not set'}</div></div>
          <div class="abtn-row">
            <button class="aedit" onclick="adminSetTarget('${c}')">üéØ</button>
            <button class="adel" onclick="removeCar(${i})">‚úï</button>
          </div>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Car Plate</label><input type="text" id="newCar" placeholder="e.g. KCA 123A"></div>
          <button class="bsm bg" onclick="addCar()">ADD</button>
        </div>
      </div>
    </div>

    <!-- STATIONS -->
    <div class="asect ${adminTab==='stations'?'active':''}">
      <div class="card">
        <div class="ctitle">STATIONS <span class="pill">${STATIONS.length}</span></div>
        ${STATIONS.map((s,i)=>`<div class="aitem">
          <div>
            <div class="aitem-name">${s.name}</div>
            <div class="aitem-sub">${s.lat?`${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}`:'No GPS'}</div>
          </div>
          <button class="adel" onclick="removeStation(${i})">‚úï</button>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="field"><label>Station Name</label><input type="text" id="newStn" placeholder="STATION NAME IN CAPS"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:8px">
          <div class="field" style="margin:0"><label>Latitude</label><input type="number" id="newLat" placeholder="-1.2833" step="any"></div>
          <div class="field" style="margin:0"><label>Longitude</label><input type="number" id="newLng" placeholder="36.8167" step="any"></div>
        </div>
        <button class="bsm bg" style="width:100%;padding:10px" onclick="addStation()">ADD STATION</button>
      </div>
    </div>

    <!-- TRIPS -->
    <div class="asect ${adminTab==='trips'?'active':''}">
      <div class="card">
        <div class="ctitle">LOCAL TRIPS <span class="pill">${localTrips.length}</span></div>
        <div class="csub">// EDIT OR DELETE LOCAL TRIP RECORDS</div>
        ${localTrips.length===0?'<div class="empty">NO LOCAL TRIPS</div>':localTrips.slice(0,30).map(t=>`
          <div class="aitem" style="margin-bottom:7px">
            <div style="flex:1">
              <div class="aitem-name" style="font-size:.6rem">${t.fromStation} ‚Üí ${t.toStation}</div>
              <div class="aitem-sub">${t.driver} ¬∑ ${t.carPlate} ¬∑ KES ${t.amount} ¬∑ ${t.date}</div>
              ${t.notes?`<div class="aitem-sub">üìù ${t.notes}</div>`:''}
            </div>
            <div class="abtn-row">
              <button class="aedit" onclick="openEditTrip(${t.id})">‚úè</button>
              <button class="adel" onclick="deleteTrip(${t.id})">‚úï</button>
            </div>
          </div>`).join('')}
      </div>
    </div>

    <!-- CONFIG -->
    <div class="asect ${adminTab==='config'?'active':''}">
      ${!devUnlocked?devLockedHtml('CONFIG'):`
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="ctitle" style="margin:0">SYSTEM CONFIG</div>
          <button class="bghost" style="color:var(--red);border-color:var(--red)" onclick="lockDev()">üîí LOCK DEV</button>
        </div>
        <div class="csub">// CHANGE ADMIN PIN</div>
        <div class="irow">
          <div class="field"><label>New Admin PIN (4-6 digits)</label><input type="password" id="newPin" placeholder="New PIN" maxlength="6"></div>
          <button class="bsm bg" onclick="changePin()">SAVE</button>
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// CHANGE DEV PIN</div>
        <div class="irow">
          <div class="field"><label>New Developer PIN (4-6 digits)</label><input type="password" id="newDevPin" placeholder="New Dev PIN" maxlength="6"></div>
          <button class="bsm br" onclick="changeDevPin()">SAVE</button>
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// SECURITY SETTINGS</div>
        <div style="font-size:.74rem;color:var(--muted);margin-bottom:9px;line-height:1.8">
          ‚Ä¢ Session timeout: <strong>30 minutes</strong> of inactivity<br>
          ‚Ä¢ Countdown bar shows only in final <strong>5 minutes</strong><br>
          ‚Ä¢ Warning overlay at <strong>60 seconds</strong> remaining<br>
          ‚Ä¢ PIN lockout: <strong>3 failed attempts</strong> = 5 min lock
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// LOCAL DATA</div>
        <p style="font-size:.74rem;color:var(--muted);margin-bottom:9px">${localTrips.length} trips stored locally ¬∑ ${offlineQ.length} queued for Firebase sync</p>
        ${offlineQ.length?`<button class="bsm by" style="width:100%;padding:10px;margin-bottom:8px" onclick="flushQueue()">SYNC ${offlineQ.length} QUEUED TRIPS TO FIREBASE</button>`:''}
        <button class="bout" onclick="if(confirm('Reset all lists to defaults?')){resetToDefaults();}">RESET LISTS TO DEFAULTS</button>
        <button class="bout" onclick="if(confirm('Clear all local trips? This cannot be undone.')){localTrips=[];save('fs_trips',[]);toast('CLEARED');renderAdmin();}">CLEAR LOCAL TRIP DATA</button>
      </div>`}
    </div>

    <!-- FIREBASE CONFIG -->
    <div class="asect ${adminTab==='settings'?'active':''}">
      ${!devUnlocked?devLockedHtml('DEV'):`
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="ctitle" style="margin:0;color:var(--red)">FIREBASE CONFIG</div>
          <button class="bghost" style="color:var(--red);border-color:var(--red)" onclick="lockDev()">üîí LOCK DEV</button>
        </div>
        <div class="csub">// CONNECT TO FIREBASE FIRESTORE</div>
        ${db?'<div class="conn-badge"><div class="dg"></div>FIREBASE CONNECTED</div>':''}
        <div class="field"><label>API KEY</label>
          <input type="text" id="fbApiKey" value="${appConfig.apiKey||''}" placeholder="AIzaSy..."></div>
        <div class="field"><label>AUTH DOMAIN</label>
          <input type="text" id="fbAuthDomain" value="${appConfig.authDomain||''}" placeholder="your-app.firebaseapp.com"></div>
        <div class="field"><label>PROJECT ID</label>
          <input type="text" id="fbProjectId" value="${appConfig.projectId||''}" placeholder="your-project-id"></div>
        <div class="field"><label>APP ID</label>
          <input type="text" id="fbAppId" value="${appConfig.appId||''}" placeholder="1:123456:web:abc..."></div>
        <button class="bb bstart" style="margin-top:4px" onclick="saveFirebaseConfig()">SAVE & CONNECT</button>
        <button class="bout" onclick="testFirebaseConnection()">TEST CONNECTION</button>
      </div>
      <div class="card">
        <div class="ctitle">SETUP GUIDE</div>
        <div class="steps">
          <div class="step">Go to <code>console.firebase.google.com</code> ‚Üí Create project ‚Üí Disable Google Analytics</div>
          <div class="step">Click <code>Firestore Database</code> ‚Üí <code>Create database</code> ‚Üí Start in <strong>test mode</strong> ‚Üí Choose region</div>
          <div class="step">Click <code>Project settings</code> (‚öô) ‚Üí <code>Your apps</code> ‚Üí <code>&lt;/&gt; Web</code> ‚Üí Register app ‚Üí Copy the config values above</div>
          <div class="step">In Firestore ‚Üí <code>Rules</code> tab ‚Üí Paste:<br><code>allow read, write: if true;</code> ‚Üí Publish</div>
          <div class="step">Paste all 4 config values above ‚Üí <strong>SAVE & CONNECT</strong></div>
          <div class="step">Done! All trips from all 50 cars now sync instantly to Firebase. No limits.</div>
        </div>
      </div>`}
    </div>`;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkPin(){
  if(isAdminLocked()){toast(`üîí LOCKED ‚Äî TRY IN ${adminLockSecsLeft()}s`);return;}
  const pin=document.getElementById('pinIn')?.value;
  if(pin===(localStorage.getItem(ADMIN_PIN_KEY)||DEFAULT_ADMIN_PIN)){
    adminPinFailures=0;
    adminUnlocked=true;
    renderAdmin();
  } else {
    recordAdminFailure();
    renderAdmin();
  }
}

// SHIFT CLOSE WITH SUMMARY
function showCloseShiftSummary(plate){
  const today=new Date().toLocaleDateString('en-GB');
  const shiftStart=shifts[plate]?.openedAt;
  const tripsInShift=localTrips.filter(t=>
    t.carPlate===plate&&t.date===today&&
    (!shiftStart||new Date(t.timestamp).getTime()>=shiftStart)
  );
  const revenue=tripsInShift.reduce((s,t)=>s+t.amount,0);
  const drivers=[...new Set(tripsInShift.map(t=>t.driver).filter(Boolean))];

  document.getElementById('shiftSummaryBody').innerHTML=`
    <div style="font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;margin-bottom:12px">
      SHIFT SUMMARY FOR <strong style="color:var(--text)">${plate}</strong>
    </div>
    <div class="shift-sum-row"><span>TOTAL TRIPS</span><strong>${tripsInShift.length}</strong></div>
    <div class="shift-sum-row"><span>DRIVERS ON SHIFT</span><strong>${drivers.length?drivers.map(d=>d.split(' ')[0]).join(', '):'None'}</strong></div>
    <div class="shift-sum-row"><span>OPENED AT</span><strong>${shifts[plate]?.openedAt?new Date(shifts[plate].openedAt).toLocaleTimeString():'‚Äî'}</strong></div>
    <div class="shift-sum-row"><span>CLOSING AT</span><strong>${new Date().toLocaleTimeString()}</strong></div>
    <div class="shift-sum-total">KES ${revenue.toLocaleString()}</div>
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-align:center;margin-top:4px">TOTAL REVENUE THIS SHIFT</div>`;

  document.getElementById('shiftCloseConfirmBtn').onclick=()=>closeShift(plate);
  document.getElementById('shiftSummaryModal').classList.add('open');
}

function openShift(plate){
  const by=prompt('Who is opening this shift?')||'ADMIN';
  shifts[plate]={open:true,openedAt:Date.now(),openedBy:by.toUpperCase(),closedAt:null};
  save('fs_shifts',shifts);toast(`‚úÖ SHIFT OPENED FOR ${plate}`);renderAdmin();
}
function closeShift(plate){
  shifts[plate]={...shifts[plate],open:false,closedAt:Date.now()};
  save('fs_shifts',shifts);
  document.getElementById('shiftSummaryModal').classList.remove('open');
  toast(`üî¥ SHIFT CLOSED FOR ${plate}`);
  renderAdmin();
}
function openAllShifts(){
  const by=prompt('Who is opening all shifts?')||'ADMIN';
  CARS.forEach(c=>{shifts[c]={open:true,openedAt:Date.now(),openedBy:by.toUpperCase(),closedAt:null};});
  save('fs_shifts',shifts);toast('‚úÖ ALL SHIFTS OPENED');renderAdmin();
}
function closeAllShifts(){
  if(!confirm('Close ALL shifts?'))return;
  CARS.forEach(c=>{shifts[c]={...shifts[c],open:false,closedAt:Date.now()};});
  save('fs_shifts',shifts);toast('üî¥ ALL SHIFTS CLOSED');renderAdmin();
}

// DRIVERS & CARS
function saveDriverTarget(driver, idx){
  const input=document.getElementById('dt_'+idx);
  const val=(input?.value||'').trim();
  if(val===''){delete driverTargets[driver];save('fs_dtargets',driverTargets);toast('TARGET REMOVED');renderAdmin();return;}
  const n=parseFloat(val);
  if(isNaN(n)||n<=0){toast('ENTER A VALID AMOUNT');return;}
  driverTargets[driver]=n;
  save('fs_dtargets',driverTargets);
  toast('üéØ TARGET SET ‚Äî KES '+n.toLocaleString()+' FOR '+driver.split(' ')[0]);
  renderAdmin();
}
function removeDriverTarget(driver){
  delete driverTargets[driver];
  save('fs_dtargets',driverTargets);
  toast('TARGET REMOVED');
  renderAdmin();
}
function adminSetDriverPin(driver){
  const pin=prompt(`Set PIN for ${driver.split(' ')[0]} (blank to remove):`);
  if(pin===null)return;
  if(pin===''){delete driverPins[driver];}
  else if(pin.length>=4){driverPins[driver]=pin;}
  else{toast('PIN MUST BE AT LEAST 4 DIGITS');return;}
  save('fs_dpins',driverPins);toast(pin?'PIN SET ‚úÖ':'PIN REMOVED');renderAdmin();
}
function adminSetTarget(plate){
  const t=prompt(`Daily revenue target for ${plate} (KES, blank to remove):`);
  if(t===null)return;
  if(t===''){delete carTargets[plate];}
  else{const n=parseFloat(t);if(isNaN(n)||n<=0){toast('INVALID AMOUNT');return;}carTargets[plate]=n;}
  save('fs_targets',carTargets);toast(t?'TARGET SET ‚úÖ':'TARGET REMOVED');renderAdmin();
}
function addDriver(){const n=(document.getElementById('newDriver')?.value||'').trim().toUpperCase();if(!n){toast('ENTER NAME');return;}if(DRIVERS.includes(n)){toast('ALREADY EXISTS');return;}DRIVERS.push(n);save('fs_drivers',DRIVERS);toast('DRIVER ADDED ‚úÖ');renderAdmin();}
function removeDriver(i){if(!confirm('Remove '+DRIVERS[i]+'?'))return;const d=DRIVERS[i];delete driverPins[d];save('fs_dpins',driverPins);DRIVERS.splice(i,1);save('fs_drivers',DRIVERS);renderAdmin();}
function addCar(){const n=(document.getElementById('newCar')?.value||'').trim().toUpperCase();if(!n){toast('ENTER PLATE');return;}if(CARS.includes(n)){toast('ALREADY EXISTS');return;}CARS.push(n);save('fs_cars',CARS);toast('CAR ADDED ‚úÖ');renderAdmin();}
function removeCar(i){if(!confirm('Remove '+CARS[i]+'?'))return;CARS.splice(i,1);save('fs_cars',CARS);renderAdmin();}
function addStation(){
  const n=(document.getElementById('newStn')?.value||'').trim().toUpperCase();
  const lat=parseFloat(document.getElementById('newLat')?.value||'');
  const lng=parseFloat(document.getElementById('newLng')?.value||'');
  if(!n){toast('ENTER NAME');return;}
  STATIONS.push({name:n,lat:isNaN(lat)?0:lat,lng:isNaN(lng)?0:lng});
  save('fs_stations',STATIONS);toast('STATION ADDED ‚úÖ');renderAdmin();
}
function removeStation(i){if(!confirm('Remove '+STATIONS[i].name+'?'))return;STATIONS.splice(i,1);save('fs_stations',STATIONS);renderAdmin();}
function changePin(){const p=document.getElementById('newPin')?.value||'';if(p.length<4){toast('MIN 4 DIGITS');return;}localStorage.setItem(ADMIN_PIN_KEY,p);toast('PIN UPDATED ‚úÖ');}
function resetToDefaults(){DRIVERS=[...DEFAULT_DRIVERS];CARS=[...DEFAULT_CARS];STATIONS=DEFAULT_STATIONS.map(s=>({...s}));save('fs_drivers',DRIVERS);save('fs_cars',CARS);save('fs_stations',STATIONS);toast('RESET ‚úÖ');renderAdmin();}

// TRIPS
function openEditTrip(id){
  const trip=localTrips.find(t=>t.id===id);if(!trip)return;
  editingTripId=id;
  document.getElementById('editDriver').value=trip.driver||'';
  document.getElementById('editCar').value=trip.carPlate||'';
  document.getElementById('editFrom').value=trip.fromStation||'';
  document.getElementById('editTo').value=trip.toStation||'';
  document.getElementById('editAmount').value=trip.amount||'';
  document.getElementById('editDate').value=trip.date||'';
  document.getElementById('editModal').classList.add('open');
}
function closeEditModal(){document.getElementById('editModal').classList.remove('open');editingTripId=null;}
function saveEditTrip(){
  const idx=localTrips.findIndex(t=>t.id===editingTripId);if(idx<0)return;
  localTrips[idx]={...localTrips[idx],driver:document.getElementById('editDriver').value,carPlate:document.getElementById('editCar').value,fromStation:document.getElementById('editFrom').value,toStation:document.getElementById('editTo').value,amount:parseFloat(document.getElementById('editAmount').value)||0,date:document.getElementById('editDate').value};
  save('fs_trips',localTrips);closeEditModal();toast('TRIP UPDATED ‚úÖ');renderAdmin();
}
function deleteTrip(id){if(!confirm('Delete this trip?'))return;localTrips=localTrips.filter(t=>t.id!==id);save('fs_trips',localTrips);toast('DELETED');renderAdmin();}

function saveFirebaseConfig(){
  appConfig.apiKey      =(document.getElementById('fbApiKey')?.value||'').trim();
  appConfig.authDomain  =(document.getElementById('fbAuthDomain')?.value||'').trim();
  appConfig.projectId   =(document.getElementById('fbProjectId')?.value||'').trim();
  appConfig.appId       =(document.getElementById('fbAppId')?.value||'').trim();
  save('fs_config',appConfig);
  db=null; // force re-init with new config
  if(appConfig.projectId&&initFirebase()){
    toast('‚úÖ FIREBASE CONNECTED!');
    startLiveListener();
  }
  else{toast(appConfig.projectId?'‚ö† CHECK CONFIG VALUES':'CONFIG SAVED ‚Äî ENTER ALL 4 VALUES');}
  renderAdmin();
}
async function testFirebaseConnection(){
  if(!initFirebase()){toast('‚ö† SAVE CONFIG FIRST');return;}
  try{
    await db.collection('_test').limit(1).get();
    toast('‚úÖ FIREBASE CONNECTION OK!');
  }catch(e){toast('‚ö† CONNECTION FAILED: '+e.message);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rModalPeriod = 'today';
let rModalScope  = 'all';

function openReportModal(){
  rModalPeriod='today'; rModalScope='all';
  // Populate driver/car selects from current data
  const all=allData();
  const drivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  const cars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const dSel=document.getElementById('rModalDriverSel');
  const cSel=document.getElementById('rModalCarSel');
  dSel.innerHTML='<option value="">‚Äî All Drivers ‚Äî</option>'+drivers.map(d=>`<option value="${d}">${d}</option>`).join('');
  cSel.innerHTML='<option value="">‚Äî All Cars ‚Äî</option>'+cars.map(c=>`<option value="${c}">${c}</option>`).join('');
  // Reset chips
  document.querySelectorAll('#rModalPeriodBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.period==='today'));
  document.querySelectorAll('#rModalScopeBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.scope==='all'));
  document.getElementById('rModalDriverPick').style.display='none';
  document.getElementById('rModalCarPick').style.display='none';
  updateReportPreview();
  document.getElementById('reportModal').classList.add('open');
}

function closeReportModal(){
  document.getElementById('reportModal').classList.remove('open');
}

function setReportPeriod(p){
  rModalPeriod=p;
  document.querySelectorAll('#rModalPeriodBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.period===p));
  updateReportPreview();
}

function setReportScope(s){
  rModalScope=s;
  document.querySelectorAll('#rModalScopeBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.scope===s));
  document.getElementById('rModalDriverPick').style.display=s==='driver'?'block':'none';
  document.getElementById('rModalCarPick').style.display=s==='car'?'block':'none';
  updateReportPreview();
}

function getReportTrips(){
  const all=allData();
  const now=new Date();
  const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const filtered=all.filter(t=>{
    const d=parseDate(t.date); if(!d)return false;
    if(rModalPeriod==='today'&&d<todayStart)return false;
    if(rModalPeriod==='week'){const ws=new Date(todayStart);ws.setDate(todayStart.getDate()-todayStart.getDay());if(d<ws)return false;}
    if(rModalPeriod==='month'&&(d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear()))return false;
    if(rModalScope==='driver'){const sel=document.getElementById('rModalDriverSel')?.value;if(sel&&t.driver!==sel)return false;}
    if(rModalScope==='car'){const sel=document.getElementById('rModalCarSel')?.value;if(sel&&t.carPlate!==sel)return false;}
    return true;
  });
  return filtered;
}

function getReportLabel(){
  const period=rModalPeriod==='all'?'ALL TIME':rModalPeriod.toUpperCase();
  if(rModalScope==='driver'){
    const sel=document.getElementById('rModalDriverSel')?.value;
    return sel?`${sel} ¬∑ ${period}`:`ALL DRIVERS ¬∑ ${period}`;
  }
  if(rModalScope==='car'){
    const sel=document.getElementById('rModalCarSel')?.value;
    return sel?`${sel} ¬∑ ${period}`:`ALL CARS ¬∑ ${period}`;
  }
  return `FULL REPORT ¬∑ ${period}`;
}

function updateReportPreview(){
  const trips=getReportTrips();
  const total=trips.reduce((s,t)=>s+(t.amount||0),0);
  const el=document.getElementById('rModalPreview');
  if(!el)return;
  if(!trips.length){el.textContent='NO TRIPS MATCH THIS SELECTION';el.style.color='var(--red)';return;}
  el.style.color='var(--accent)';
  el.innerHTML=`<strong style="font-size:.9rem">${trips.length}</strong> TRIPS &nbsp;¬∑&nbsp; KES <strong>${total.toLocaleString()}</strong>`;
}

// Live preview when driver/car select changes
document.addEventListener('change',e=>{
  if(e.target.id==='rModalDriverSel'||e.target.id==='rModalCarSel')updateReportPreview();
});

function runReport(format){
  const trips=getReportTrips();
  if(!trips.length){toast('NO TRIPS FOR THIS SELECTION');return;}
  const label=getReportLabel();
  if(format==='view'){
    closeReportModal();
    openReportViewer(trips,label);
    return;
  }
  if(format==='pdf') runReportPDF(trips,label);
  else if(format==='xls') runReportExcel(trips,label);
  else if(format==='wa') runReportWA(trips,label);
  closeReportModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT VIEWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rviewTrips = [];
let rviewLabel = '';

function openReportViewer(trips, label){
  rviewTrips = trips;
  rviewLabel = label;
  document.getElementById('rviewTitle').textContent = label;
  renderReportViewer(trips, label);
  document.getElementById('rviewOverlay').classList.add('open');
}

function closeReportViewer(){
  document.getElementById('rviewOverlay').classList.remove('open');
}

function openExportMenuFromViewer(){
  // Show a mini export picker sheet
  const sheet = document.getElementById('rviewExportSheet');
  if(sheet){ sheet.style.display = sheet.style.display==='none'?'block':'none'; return; }
  // Inject it into viewer body
  const body = document.getElementById('rviewBody');
  const div = document.createElement('div');
  div.id = 'rviewExportSheet';
  div.style.cssText = 'position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:2px solid var(--border);padding:16px;z-index:400;animation:fadeUp .2s ease';
  div.innerHTML = `
    <div style="font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">EXPORT THIS REPORT AS</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
      <button class="rview-btn-pdf" onclick="runReportPDF(rviewTrips,rviewLabel);closeExportSheet()">üìÑ PDF</button>
      <button class="rview-btn-xls" onclick="runReportExcel(rviewTrips,rviewLabel);closeExportSheet()">üìä XLS</button>
      <button class="rview-btn-wa" onclick="runReportWA(rviewTrips,rviewLabel);closeExportSheet()">üì± WHATSAPP</button>
    </div>
    <button class="bout" style="margin:0;width:100%" onclick="closeExportSheet()">CANCEL</button>`;
  document.body.appendChild(div);
}

function closeExportSheet(){
  const s = document.getElementById('rviewExportSheet');
  if(s) s.remove();
}

function renderReportViewer(trips, label){
  const body = document.getElementById('rviewBody');
  if(!body) return;

  const total     = trips.reduce((s,t)=>s+(t.amount||0),0);
  const avg       = trips.length ? Math.round(total/trips.length) : 0;
  const totalKm   = trips.reduce((s,t)=>s+(t.distance||0),0);
  const fuelTrips = trips.filter(t=>t.refueled&&t.fuelLiters>0);
  const totalL    = fuelTrips.reduce((s,t)=>s+(t.fuelLiters||0),0);
  const totalFuel = fuelTrips.reduce((s,t)=>s+(t.fuelCost||0),0);
  const fleetEff  = fuelTrips.length&&totalKm
    ? (totalKm/totalL).toFixed(2) : null;

  // Group by car
  const carMap = {};
  trips.forEach(t=>{
    const k = t.carPlate||'Unknown';
    if(!carMap[k]) carMap[k]={trips:0,revenue:0,km:0};
    carMap[k].trips++; carMap[k].revenue+=t.amount||0; carMap[k].km+=t.distance||0;
  });
  const cars = Object.entries(carMap).sort((a,b)=>b[1].revenue-a[1].revenue);
  const maxRev = cars[0]?.[1].revenue||1;

  // Group by driver
  const drvMap = {};
  trips.forEach(t=>{
    const k = t.driver||'Unknown';
    if(!drvMap[k]) drvMap[k]={trips:0,revenue:0};
    drvMap[k].trips++; drvMap[k].revenue+=t.amount||0;
  });
  const drivers = Object.entries(drvMap).sort((a,b)=>b[1].revenue-a[1].revenue);

  // Date range
  const dates = trips.map(t=>t.date).filter(Boolean);
  const dateRange = dates.length ? (dates[dates.length-1]===dates[0]?dates[0]:`${dates[dates.length-1]} ‚Äî ${dates[0]}`) : '';

  body.innerHTML = `
    <!-- Export row at top of viewer -->
    <div class="rview-export-row" style="margin-bottom:14px">
      <button class="rview-btn-pdf" onclick="runReportPDF(rviewTrips,rviewLabel)">üìÑ PDF</button>
      <button class="rview-btn-xls" onclick="runReportExcel(rviewTrips,rviewLabel)">üìä XLS</button>
      <button class="rview-btn-wa" onclick="runReportWA(rviewTrips,rviewLabel)">üì± WHATSAPP</button>
    </div>

    <!-- Label + date range -->
    <div style="background:var(--accent);padding:12px 14px;margin-bottom:12px">
      <div style="font-family:var(--font-d);font-size:1.3rem;color:#fff;letter-spacing:2px">${label}</div>
      ${dateRange?`<div style="font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.7);letter-spacing:1px;margin-top:3px">${dateRange}</div>`:''}
    </div>

    <!-- Summary stats -->
    <div class="rview-summary">
      <div class="rview-stat wide">
        <div class="rs-label">TOTAL REVENUE</div>
        <div class="rs-val" style="font-size:2rem">KES ${total.toLocaleString()}</div>
      </div>
      <div class="rview-stat"><div class="rs-label">TOTAL TRIPS</div><div class="rs-val">${trips.length}</div></div>
      <div class="rview-stat"><div class="rs-label">AVG / TRIP</div><div class="rs-val" style="font-size:1.1rem">KES ${avg.toLocaleString()}</div></div>
      ${totalKm?`<div class="rview-stat"><div class="rs-label">TOTAL KM</div><div class="rs-val">${totalKm.toLocaleString()}</div></div>`:''}
      ${fleetEff?`<div class="rview-stat"><div class="rs-label">AVG EFFICIENCY</div><div class="rs-val" style="color:#f59e0b">${fleetEff}<span style="font-size:.7rem;font-family:var(--font-b)"> KM/L</span></div></div>`:''}
      ${totalFuel?`<div class="rview-stat wide"><div class="rs-label">TOTAL FUEL COST</div><div class="rs-val" style="color:#f59e0b;font-size:1.2rem">KES ${totalFuel.toLocaleString()}</div></div>`:''}
    </div>

    <!-- By Car breakdown -->
    ${cars.length>1?`
    <div class="rview-section-title">BREAKDOWN BY CAR</div>
    ${cars.map(([car,s])=>`
      <div class="rview-car-row">
        <span class="rview-car-badge">${car}</span>
        <div>
          <div style="font-size:.6rem;color:var(--muted)">${s.trips} trip${s.trips!==1?'s':''}${s.km?` ¬∑ ${s.km.toLocaleString()} km`:''}</div>
          <div class="rview-bar-wrap"><div class="rview-bar" style="width:${Math.round((s.revenue/maxRev)*100)}%"></div></div>
        </div>
        <div style="font-family:var(--font-m);font-size:.72rem;font-weight:700;color:var(--accent)">KES ${(s.revenue/1000).toFixed(1)}K</div>
      </div>`).join('')}`:''}

    <!-- By Driver breakdown -->
    ${drivers.length>1?`
    <div class="rview-section-title">BREAKDOWN BY DRIVER</div>
    ${drivers.map(([drv,s],i)=>`
      <div class="rview-car-row">
        <div style="font-family:var(--font-d);font-size:1.1rem;color:${i===0?'#f0a500':i===1?'#aaa':i===2?'#cd7f32':'var(--border)'}">${i+1}</div>
        <div>
          <div style="font-family:var(--font-m);font-size:.62rem;font-weight:600">${drv}</div>
          <div style="font-size:.54rem;color:var(--muted)">${s.trips} trip${s.trips!==1?'s':''} ¬∑ avg KES ${Math.round(s.revenue/s.trips).toLocaleString()}</div>
        </div>
        <div style="font-family:var(--font-m);font-size:.72rem;font-weight:700;color:var(--accent)">KES ${(s.revenue/1000).toFixed(1)}K</div>
      </div>`).join('')}`:''}

    <!-- Trip list -->
    <div class="rview-section-title">ALL TRIPS (${trips.length})</div>
    ${trips.slice(0,100).map((t,i)=>`
      <div class="rview-trip">
        <div class="rview-trip-top">
          <span class="rview-route">${t.fromStation||'?'} ‚Üí ${t.toStation||'?'}</span>
          <span class="rview-amt">KES ${Number(t.amount||0).toLocaleString()}</span>
        </div>
        <div class="rview-trip-bot">
          <span>${t.driver?t.driver.split(' ')[0]:''} ¬∑ ${t.carPlate||''}${t.distance?` ¬∑ üìè ${t.distance}km`:''}${t.fuelEfficiency?` ¬∑ ‚ö°${t.fuelEfficiency}km/L`:''}</span>
          <span>${t.date||''} ${t.time||''}</span>
        </div>
        ${t.notes?`<div style="font-size:.52rem;color:var(--muted);margin-top:3px;font-style:italic">üìù ${t.notes}</div>`:''}
      </div>`).join('')}
    ${trips.length>100?`<div style="text-align:center;font-family:var(--font-m);font-size:.52rem;color:var(--muted);padding:12px">SHOWING 100 OF ${trips.length} ‚Äî EXPORT TO SEE ALL</div>`:''}
  `;
}

function runReportPDF(filtered,label){
  const {jsPDF}=window.jspdf;
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=18;let y=M;
  doc.setFillColor(26,122,60);doc.rect(0,0,W,42,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('FESTUS SACCO',M,16);
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.text(label,M,24);doc.text('Generated: '+new Date().toLocaleString(),M,31);
  y=50;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:String(filtered.length)},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():'‚Äî'},{l:'UNIQUE CARS',v:String([...new Set(filtered.map(t=>t.carPlate))].length)}].forEach((b,i)=>{
    const bx=M+i*(bw+3);doc.setFillColor(245,250,245);doc.rect(bx,y,bw,20,'F');doc.setFillColor(26,122,60);doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(6);doc.setFont('helvetica','normal');doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26);doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0);doc.setFontSize(6.5);doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5);doc.text('DATE',M+10,y+5);doc.text('ROUTE',M+36,y+5);doc.text('DRIVER',M+90,y+5);doc.text('CAR',M+130,y+5);doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244]));doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80);doc.setFontSize(6.5);doc.setFont('helvetica','normal');doc.text(String(i+1),M+2,y+5);doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60);doc.setFont('helvetica','bold');doc.text((t.fromStation||'').slice(0,9)+'‚Üí'+(t.toStation||'').slice(0,9),M+36,y+5);
    doc.setTextColor(60,60,60);doc.setFont('helvetica','normal');doc.text((t.driver||'').slice(0,18),M+90,y+5);doc.text(t.carPlate||'',M+130,y+5);
    doc.setTextColor(20,100,60);doc.setFont('helvetica','bold');doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FESTUS SACCO ‚Äî CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  const fname='FESTUS-'+label.replace(/[^a-zA-Z0-9]/g,'-').replace(/-+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.pdf';
  doc.save(fname);
  toast('üìÑ PDF SAVED');
}

function runReportExcel(filtered,label){
  const data=filtered.map(t=>({'DATE':t.date,'TIME':t.time,'FROM':t.fromStation,'TO':t.toStation,'DRIVER':t.driver,'CAR':t.carPlate,'AMOUNT':t.amount,'DURATION(MIN)':t.duration,'NOTES':t.notes||''}));
  const ws=XLSX.utils.json_to_sheet(data);
  ws['!cols']=[{wch:12},{wch:10},{wch:14},{wch:14},{wch:20},{wch:10},{wch:10},{wch:12},{wch:20}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Trips');
  // Summary sheet
  const total=filtered.reduce((s,t)=>s+t.amount,0);
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  const carRows=cars.map(car=>{const ct=filtered.filter(t=>t.carPlate===car);return{'CAR':car,'TRIPS':ct.length,'REVENUE':ct.reduce((s,t)=>s+t.amount,0),'AVG/TRIP':ct.length?Math.round(ct.reduce((s,t)=>s+t.amount,0)/ct.length):0};});
  if(carRows.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(carRows),'By Car');
  const drivers=[...new Set(filtered.map(t=>t.driver).filter(Boolean))];
  const drvRows=drivers.map(d=>{const dt=filtered.filter(t=>t.driver===d);return{'DRIVER':d,'TRIPS':dt.length,'REVENUE':dt.reduce((s,t)=>s+t.amount,0),'AVG/TRIP':dt.length?Math.round(dt.reduce((s,t)=>s+t.amount,0)/dt.length):0};});
  if(drvRows.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(drvRows),'By Driver');
  const fname='FESTUS-'+label.replace(/[^a-zA-Z0-9]/g,'-').replace(/-+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.xlsx';
  XLSX.writeFile(wb,fname);
  toast('üìä EXCEL SAVED');
}

function runReportWA(filtered,label){
  const total=filtered.reduce((s,t)=>s+t.amount,0);
  const avg=filtered.length?Math.round(total/filtered.length):0;
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  const carLines=cars.map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car);
    const cr=ct.reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car];
    const pct=target?` (${Math.round((cr/target)*100)}% of target)`:'';
    return`  üöó ${car}: ${ct.length} trips ¬∑ KES ${cr.toLocaleString()}${pct}`;
  }).join('\n');
  const drivers=[...new Set(filtered.map(t=>t.driver).filter(Boolean))];
  const drvLines=drivers.map(d=>{
    const dt=filtered.filter(t=>t.driver===d);
    return`  üë§ ${d}: ${dt.length} trips ¬∑ KES ${dt.reduce((s,t)=>s+t.amount,0).toLocaleString()}`;
  }).join('\n');
  const msg=`üöå *FESTUS SACCO ‚Äî ${label}*\nüìÖ ${new Date().toLocaleDateString('en-GB')}\n\nüìä *SUMMARY*\n‚Ä¢ Total Trips: ${filtered.length}\n‚Ä¢ Total Revenue: KES ${total.toLocaleString()}\n‚Ä¢ Average/Trip: KES ${avg.toLocaleString()}\n${cars.length>1?`\nüöó *BY CAR*\n${carLines}\n`:''}${drivers.length>1?`\nüë§ *BY DRIVER*\n${drvLines}\n`:''}\n_Generated by FESTUS SACCO App_`;
  const encoded=encodeURIComponent(msg);
  if(navigator.clipboard){navigator.clipboard.writeText(msg).then(()=>toast('üìã COPIED! OPENING WHATSAPP...')).catch(()=>{});}
  setTimeout(()=>window.open(`https://wa.me/?text=${encoded}`,'_blank'),500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN PIN RESET (via Dev PIN verification)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let resetDevVerifyFailures = 0;

function openResetOverlay(){
  resetDevVerifyFailures = 0;
  // Reset both steps
  document.getElementById('resetStepVerify').style.display = 'block';
  document.getElementById('resetStepNew').style.display = 'none';
  const vm = document.getElementById('resetVerifyMsg');
  if(vm) vm.innerHTML = '';
  const di = document.getElementById('resetDevPinIn');
  if(di){ di.value = ''; di.style.borderColor = 'var(--accent2)'; }
  const ni = document.getElementById('resetNewPinIn');
  if(ni){ ni.value = ''; }
  document.getElementById('resetPinOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('resetDevPinIn')?.focus(), 120);
}

function closeResetOverlay(){
  document.getElementById('resetPinOverlay').classList.remove('open');
}

function verifyDevForReset(){
  const pin = (document.getElementById('resetDevPinIn')?.value || '').trim();
  const correct = localStorage.getItem(DEV_PIN_KEY) || DEFAULT_DEV_PIN;
  if(pin === correct){
    // Identity confirmed ‚Äî show new PIN step
    document.getElementById('resetStepVerify').style.display = 'none';
    document.getElementById('resetStepNew').style.display = 'block';
    setTimeout(()=>document.getElementById('resetNewPinIn')?.focus(), 80);
  } else {
    resetDevVerifyFailures++;
    const vm = document.getElementById('resetVerifyMsg');
    const di = document.getElementById('resetDevPinIn');
    if(di){ di.value = ''; di.style.borderColor = 'var(--red)'; setTimeout(()=>{if(di)di.style.borderColor='var(--accent2)';},600); }
    if(resetDevVerifyFailures >= 3){
      // Lock out and close
      adminLockedUntil = Date.now() + PIN_LOCKOUT_SECS * 1000;
      closeResetOverlay();
      renderAdmin();
      toast('üîí TOO MANY FAILED ATTEMPTS ‚Äî LOCKED FOR 5 MINUTES');
    } else {
      const left = 3 - resetDevVerifyFailures;
      if(vm) vm.innerHTML = `<div class="pin-locked" style="margin-bottom:10px;font-size:.52rem">WRONG DEV PIN ‚Äî ${left} ATTEMPT${left===1?'':'S'} LEFT</div>`;
      di?.focus();
    }
  }
}

function commitResetPin(){
  const newPin = (document.getElementById('resetNewPinIn')?.value || '').trim();
  if(newPin.length < 4){
    const ni = document.getElementById('resetNewPinIn');
    if(ni){ ni.style.borderColor = 'var(--red)'; setTimeout(()=>{if(ni)ni.style.borderColor='var(--accent)';},600); }
    toast('PIN MUST BE AT LEAST 4 DIGITS');
    return;
  }
  localStorage.setItem(ADMIN_PIN_KEY, newPin);
  // Clear any lockout
  adminLockedUntil = 0;
  adminPinFailures = 0;
  closeResetOverlay();
  renderAdmin();
  toast('‚úÖ ADMIN PIN RESET SUCCESSFULLY ‚Äî USE YOUR NEW PIN TO LOGIN');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEV PIN SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let devPinFailures = 0;
let devLockedUntil = 0;

function isDevLocked(){ return devLockedUntil > Date.now(); }
function devLockSecsLeft(){ return Math.ceil((devLockedUntil - Date.now()) / 1000); }

function recordDevFailure(){
  devPinFailures++;
  if(devPinFailures >= MAX_PIN_ATTEMPTS){
    devLockedUntil = Date.now() + PIN_LOCKOUT_SECS * 1000;
    devPinFailures = 0;
    toast('üîí TOO MANY ATTEMPTS ‚Äî DEV ACCESS LOCKED FOR 5 MINUTES');
    closeDevPinOverlay();
    renderAdmin();
  } else {
    const left = MAX_PIN_ATTEMPTS - devPinFailures;
    const lockEl = document.getElementById('devPinLockMsg');
    if(lockEl) lockEl.innerHTML = `<div class="pin-locked" style="margin-bottom:10px">WRONG PIN ‚Äî ${left} ATTEMPT${left===1?'':'S'} LEFT</div>`;
    const inp = document.getElementById('devPinIn');
    if(inp){ inp.value=''; inp.focus(); inp.style.borderColor='var(--red)'; setTimeout(()=>inp.style.borderColor='',600); }
  }
}

function checkDevPin(){
  if(isDevLocked()){
    toast(`üîí DEV ACCESS LOCKED ‚Äî TRY IN ${devLockSecsLeft()}s`);
    return;
  }
  const pin = (document.getElementById('devPinIn')?.value || '').trim();
  const correct = localStorage.getItem(DEV_PIN_KEY) || DEFAULT_DEV_PIN;
  if(pin === correct){
    devPinFailures = 0;
    devUnlocked = true;
    adminTab = pendingDevTab || 'settings';
    closeDevPinOverlay();
    renderAdmin();
    toast('üîß DEV ACCESS GRANTED');
  } else {
    recordDevFailure();
  }
}

function openDevTab(tab){
  if(devUnlocked){
    adminTab = tab;
    renderAdmin();
    return;
  }
  // Show the dev PIN overlay, remember which tab was requested
  pendingDevTab = tab;
  const lockEl = document.getElementById('devPinLockMsg');
  if(lockEl) lockEl.innerHTML = '';
  const inp = document.getElementById('devPinIn');
  if(inp){ inp.value=''; inp.style.borderColor=''; }
  if(isDevLocked()){
    // Show lock message directly without opening overlay
    toast(`üîí DEV ACCESS LOCKED ‚Äî TRY IN ${devLockSecsLeft()}s`);
    return;
  }
  document.getElementById('devPinOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('devPinIn')?.focus(), 100);
}

// Store which tab was requested when overlay was opened
let pendingDevTab = 'settings';

function closeDevPinOverlay(){
  document.getElementById('devPinOverlay').classList.remove('open');
}

function lockDev(){
  devUnlocked = false;
  adminTab = 'shifts';
  renderAdmin();
  toast('üîí DEV ACCESS LOCKED');
}

function devLockedHtml(area){
  if(isDevLocked()){
    return `<div class="card" style="border:2px solid var(--red);text-align:center;padding:30px 20px">
      <div style="font-size:2rem;margin-bottom:8px">üîí</div>
      <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--red);letter-spacing:2px;margin-bottom:6px">DEV ACCESS LOCKED</div>
      <div style="font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:1.8">TOO MANY FAILED ATTEMPTS<br>TRY AGAIN IN ${devLockSecsLeft()}s</div>
    </div>`;
  }
  return `<div class="card" style="border:2px solid var(--red);text-align:center;padding:30px 20px">
    <div style="font-size:2rem;margin-bottom:8px">üîß</div>
    <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--red);letter-spacing:2px;margin-bottom:6px">${area} ‚Äî DEV ONLY</div>
    <div style="font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:16px">THIS SECTION IS RESTRICTED<br>TO AUTHORISED DEVELOPERS ONLY</div>
    <button class="bb bend" style="margin:0;max-width:220px" onclick="openDevTab('${area.toLowerCase()==='dev'?'settings':'config'}')">üîß ENTER DEV PIN</button>
  </div>`;
}

function changeDevPin(){
  const p = (document.getElementById('newDevPin')?.value || '').trim();
  if(p.length < 4){ toast('DEV PIN MUST BE AT LEAST 4 DIGITS'); return; }
  localStorage.setItem(DEV_PIN_KEY, p);
  toast('üîß DEV PIN UPDATED ‚úÖ');
  document.getElementById('newDevPin').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION TRACKING ‚Äî writes driver login/phase to Firestore
// So the admin can see who is logged in and what they're doing
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function writeSession(status, extra){
  // status: 'online' | 'driving' | 'arrived' | 'idle' | 'offline'
  if(!db || !tripState.driver || !tripState.carPlate) return;
  try{
    const doc = {
      driver:    tripState.driver,
      carPlate:  tripState.carPlate,
      status:    status,
      updatedAt: Date.now(),
      date:      new Date().toLocaleDateString('en-GB'),
      ...extra
    };
    if(mySessionId){
      // Update existing session document
      await db.collection('sessions').doc(mySessionId).set(doc, {merge:true});
    } else {
      // Create new session document
      const ref = await db.collection('sessions').add(doc);
      mySessionId = ref.id;
    }
  } catch(e){ console.warn('Session write failed:', e); }
}

async function endSession(){
  if(!db || !mySessionId) return;
  try{
    await db.collection('sessions').doc(mySessionId).set({
      status:'offline',
      updatedAt: Date.now(),
      driver: tripState.driver,
      carPlate: tripState.carPlate
    }, {merge:true});
    mySessionId = null;
  } catch(e){}
}

// ‚îÄ‚îÄ Listener for ALL sessions (admin side) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startSessionListener(){
  if(!db) return;
  if(liveSessionSub){ liveSessionSub(); liveSessionSub=null; }
  try{
    // Only sessions updated in last 14 hours (today's shift)
    const since = Date.now() - (14*60*60*1000);
    liveSessionSub = db.collection('sessions')
      .where('updatedAt','>=',since)
      .onSnapshot(snap=>{
        snap.forEach(doc=>{
          const s = {...doc.data(), _id: doc.id};
          liveSessions[s.carPlate] = s; // latest doc per plate
        });
        if(currentPage==='reports' && reportTab==='live') renderLiveTab();
      }, err=>{ console.warn('Session listener error:', err); });
  } catch(e){}
}

function stopSessionListener(){
  if(liveSessionSub){ liveSessionSub(); liveSessionSub=null; }
  liveSessions = {};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE LISTENER ‚Äî Firebase onSnapshot
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startLiveListener(){
  if(liveUnsubscribe){liveUnsubscribe();liveUnsubscribe=null;}
  if(!initFirebase()){updateListenerStatus(false);return;}
  updateListenerStatus('connecting');
  startSessionListener(); // Also listen for driver sessions
  // Listen to trips from last 12 hours so manager sees today's activity
  const since=Date.now()-(12*60*60*1000);
  try{
    liveUnsubscribe=db.collection('trips')
      .where('dateMs','>=',since)
      .orderBy('dateMs','desc')
      .onSnapshot(snap=>{
        snap.docChanges().forEach(change=>{
          if(change.type==='added'){
            const trip={...change.doc.data(),_fbId:change.doc.id};
            // Avoid duplicates
            if(!liveTrips.find(t=>t._fbId===trip._fbId)){
              liveTrips.unshift(trip);
              liveNewIds.add(trip._fbId);
              setTimeout(()=>{liveNewIds.delete(trip._fbId);renderLiveTab();},4000);
            }
          }
        });
        // Sort newest first
        liveTrips.sort((a,b)=>(b.dateMs||0)-(a.dateMs||0));
        // Keep last 200
        if(liveTrips.length>200)liveTrips=liveTrips.slice(0,200);
        updateListenerStatus(true);
        if(currentPage==='reports'&&reportTab==='live')renderLiveTab();
      }, err=>{
        console.error('Live listener error:',err);
        updateListenerStatus(false);
      });
  }catch(e){updateListenerStatus(false);}
}

function stopLiveListener(){
  if(liveUnsubscribe){liveUnsubscribe();liveUnsubscribe=null;}
  liveTrips=[];
  stopSessionListener();
  updateListenerStatus(false);
  if(currentPage==='reports'&&reportTab==='live')renderLiveTab();
}

function updateListenerStatus(state){
  const el=document.getElementById('listenerStatusBar');
  if(!el)return;
  if(state===true){
    el.className='listener-status on';
    el.innerHTML=`<span class="live-dot"></span>LIVE ‚Äî LISTENING FOR NEW TRIPS`;
  }else if(state==='connecting'){
    el.className='listener-status on';
    el.innerHTML=`<span class="live-dot"></span>CONNECTING...`;
  }else{
    el.className='listener-status off';
    el.innerHTML=`‚óè LISTENER OFF ‚Äî ${appConfig.projectId?'TAP START':'CONFIGURE FIREBASE IN ADMIN'}`;
  }
}

function renderLiveTab(){
  const el=document.getElementById('rsect-live');
  if(!el)return;
  const today=new Date().toLocaleDateString('en-GB');
  const now=Date.now();
  const todayLive=liveTrips.filter(t=>t.date===today);
  const totalRev=todayLive.reduce((s,t)=>s+(t.amount||0),0);
  const isOn=!!liveUnsubscribe;

  // ‚îÄ‚îÄ Build per-car data combining sessions + trips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Get all known cars from sessions + today's trips
  const knownPlates = new Set([
    ...Object.keys(liveSessions),
    ...todayLive.map(t=>t.carPlate).filter(Boolean)
  ]);

  // For each plate, merge session info with trip stats
  const STALE_MS = 14 * 60 * 60 * 1000; // 14h ‚Äî same as listener window
  const fleetData = [...knownPlates].map(plate=>{
    const sess   = liveSessions[plate] || null;
    const cTrips = todayLive.filter(t=>t.carPlate===plate);
    const lastTrip = cTrips.length ? cTrips.reduce((a,b)=>((a.dateMs||0)>(b.dateMs||0)?a:b)) : null;
    const cRev   = cTrips.reduce((s,t)=>s+(t.amount||0),0);

    // Determine status: session doc wins, fallback to trips
    let status = 'offline';
    if(sess){
      const age = now - (sess.updatedAt||0);
      if(age < STALE_MS) status = sess.status || 'online';
      if(age > 3*60*60*1000) status = 'offline'; // 3h no update = offline
    } else if(lastTrip && (now-(lastTrip.dateMs||0)) < 90*60*1000){
      status = 'idle'; // had a trip <90min ago, no session = older app version
    }

    return {
      plate,
      driver:   sess?.driver || lastTrip?.driver || '‚Äî',
      status,
      from:     sess?.from   || lastTrip?.fromStation || '',
      to:       sess?.to     || lastTrip?.toStation   || '',
      updatedAt: sess?.updatedAt || lastTrip?.dateMs || 0,
      loginTime: sess?.loginTime || null,
      lastTrip,
      trips:    cTrips.length,
      revenue:  cRev
    };
  }).filter(v=>v.status!=='offline' || v.trips>0 ) // hide truly offline + no trips today
    .sort((a,b)=>{
      const order={driving:0,arrived:1,idle:2,online:3,offline:4};
      return (order[a.status]??5)-(order[b.status]??5) || b.updatedAt-a.updatedAt;
    });

  const onlineCount   = fleetData.filter(v=>v.status==='driving'||v.status==='arrived'||v.status==='online').length;
  const drivingCount  = fleetData.filter(v=>v.status==='driving').length;
  const idleCount     = fleetData.filter(v=>v.status==='idle').length;

  function minsAgo(ms){ const m=Math.floor((now-(ms||0))/60000); return m<1?'JUST NOW':m<60?m+'M AGO':Math.floor(m/60)+'H '+m%60+'M AGO'; }
  function statusLabel(s){return{driving:'üöå ON THE ROAD',arrived:'üìç ARRIVED',idle:'‚è∏ IDLE',online:'‚úÖ LOGGED IN',offline:'‚óã OFFLINE'}[s]||s.toUpperCase();}
  function statusColor(s){return{driving:'#22c55e',arrived:'#f59e0b',idle:'var(--muted)',online:'var(--accent)',offline:'var(--border)'}[s]||'var(--muted)';}
  function statusBorder(s){return{driving:'#22c55e',arrived:'#f59e0b',idle:'var(--border)',online:'var(--accent)',offline:'var(--border)'}[s]||'var(--border)';}

  el.innerHTML=`
    <!-- Listener bar -->
    <div class="listener-status ${isOn?'on':'off'}" id="listenerStatusBar">
      ${isOn?`<span class="live-dot"></span>LIVE ‚Äî FLEET MONITORING ACTIVE`:`‚óè LISTENER OFF ‚Äî ${appConfig.projectId?'TAP START':'CONFIGURE FIREBASE IN ADMIN'}`}
    </div>
    <div style="display:flex;gap:7px;margin-bottom:12px">
      ${isOn
        ?`<button class="bsm br" style="flex:1;padding:10px" onclick="stopLiveListener()">‚¨õ STOP</button>`
        :`<button class="bsm bg" style="flex:1;padding:10px" onclick="startLiveListener()">‚ñ∂ START LIVE MONITORING</button>`}
    </div>

    <!-- Fleet summary strip -->
    <div class="live-stats" style="margin-bottom:14px">
      <div class="live-stat"><div class="lsl">ON THE ROAD</div><div class="lsv" style="color:#22c55e">${drivingCount}</div></div>
      <div class="live-stat"><div class="lsl">ONLINE TODAY</div><div class="lsv" style="color:var(--accent)">${onlineCount}</div></div>
      <div class="live-stat"><div class="lsl">TODAY TRIPS</div><div class="lsv">${todayLive.length}</div></div>
      <div class="live-stat"><div class="lsl">TODAY REVENUE</div><div class="lsv" style="font-size:.8rem">KES ${(totalRev/1000).toFixed(1)}K</div></div>
    </div>

    ${fleetData.length?`
    <!-- ‚îÄ‚îÄ FLEET STATUS BOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
      <div class="stitle2" style="margin:0">üöå FLEET STATUS</div>
      <div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px">${new Date().toLocaleTimeString()}</div>
    </div>

    ${fleetData.map(v=>`
    <div style="background:var(--card);border:2px solid ${statusBorder(v.status)};margin-bottom:9px;overflow:hidden;transition:border-color .4s">

      <!-- TOP ROW: plate + driver + status badge -->
      <div style="display:grid;grid-template-columns:auto 1fr auto;gap:0;align-items:stretch">

        <!-- Plate -->
        <div style="background:${statusBorder(v.status)};padding:10px 14px;display:flex;align-items:center;justify-content:center;min-width:88px;transition:background .4s">
          <div style="text-align:center">
            <div style="font-family:var(--font-d);font-size:1.05rem;letter-spacing:3px;color:${v.status==='offline'?'var(--muted)':'#fff'};line-height:1">${v.plate}</div>
            ${v.status==='driving'?`<div style="font-family:var(--font-m);font-size:.38rem;color:rgba(255,255,255,.8);letter-spacing:1px;margin-top:3px">IN MOTION</div>`:''}
          </div>
        </div>

        <!-- Driver + route -->
        <div style="padding:9px 11px">
          <div style="font-family:var(--font-m);font-size:.66rem;font-weight:700;color:var(--text);letter-spacing:1px;margin-bottom:3px">${v.driver}</div>

          ${v.status==='driving'?`
          <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px">
            <span style="font-family:var(--font-m);font-size:.54rem;color:var(--muted)">${v.from||'?'}</span>
            <span style="color:#22c55e;font-size:.6rem">‚Üí</span>
            <span style="font-family:var(--font-m);font-size:.54rem;color:#22c55e;font-weight:700">DESTINATION</span>
          </div>
          <div style="font-size:.46rem;color:#22c55e;font-family:var(--font-m)">üöå DEPARTED ${minsAgo(v.updatedAt)}</div>
          `:v.status==='arrived'?`
          <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px">
            <span style="font-family:var(--font-m);font-size:.54rem;color:var(--muted)">${v.from||'?'}</span>
            <span style="color:#f59e0b;font-size:.6rem">‚Üí</span>
            <span style="font-family:var(--font-m);font-size:.54rem;color:#f59e0b;font-weight:700">${v.to||'LOGGING...'}</span>
          </div>
          <div style="font-size:.46rem;color:#f59e0b;font-family:var(--font-m)">üìç ARRIVED ${minsAgo(v.updatedAt)}</div>
          `:v.status==='idle'?`
          <div style="font-size:.52rem;color:var(--muted);margin-bottom:2px">LAST: ${v.from||'?'} ‚Üí ${v.to||'?'}</div>
          <div style="font-size:.46rem;color:var(--muted)">${minsAgo(v.updatedAt)}</div>
          `:v.status==='online'?`
          <div style="font-size:.52rem;color:var(--accent);margin-bottom:2px">‚úÖ LOGGED IN ‚Äî READY</div>
          <div style="font-size:.46rem;color:var(--muted)">${v.loginTime?'SINCE '+minsAgo(v.loginTime):minsAgo(v.updatedAt)}</div>
          `:`
          <div style="font-size:.52rem;color:var(--muted)">LAST SEEN ${minsAgo(v.updatedAt)}</div>
          `}
        </div>

        <!-- Right: trips + revenue -->
        <div style="padding:9px 11px;text-align:right;display:flex;flex-direction:column;justify-content:center;border-left:1px solid var(--border)">
          <div style="font-family:var(--font-d);font-size:1.3rem;color:var(--accent);line-height:1">${v.trips}</div>
          <div style="font-family:var(--font-m);font-size:.42rem;color:var(--muted);letter-spacing:1px">TRIPS</div>
          ${v.revenue?`<div style="font-family:var(--font-m);font-size:.52rem;color:var(--accent);margin-top:4px;font-weight:700">KES ${(v.revenue/1000).toFixed(1)}K</div>`:''}
        </div>
      </div>

      <!-- PROGRESS BAR for driving/arrived -->
      ${v.status==='driving'?`<div style="height:3px;background:rgba(34,197,94,.15)"><div style="height:100%;background:#22c55e;width:60%;animation:none"></div></div>`:
        v.status==='arrived'?`<div style="height:3px;background:rgba(245,158,11,.15)"><div style="height:100%;background:#f59e0b;width:85%"></div></div>`:''}
    </div>`).join('')}

    <!-- ‚îÄ‚îÄ TRIP FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    ${todayLive.length?`
    <div class="stitle2" style="margin:14px 0 8px">üìã TODAY'S TRIP FEED</div>
    ${liveTrips.slice(0,50).map(t=>`
      <div class="live-item ${liveNewIds.has(t._fbId)?'new':''}">
        <div class="live-top">
          <span style="display:flex;align-items:center;gap:6px">
            <span style="font-family:var(--font-m);font-size:.52rem;background:var(--accent);color:#fff;padding:2px 8px;letter-spacing:1px">${t.carPlate||'‚Äî'}</span>
            <span class="live-route">${t.fromStation||'?'} ‚Üí ${t.toStation||'?'}</span>
          </span>
          <span class="live-amt">KES ${Number(t.amount||0).toLocaleString()}</span>
        </div>
        <div class="live-bot">
          <span>${t.driver||'‚Äî'}${t.distance?` ¬∑ üìè ${t.distance}km`:''}</span>
          <span class="live-time">${t.time||t.date||''}</span>
        </div>
      </div>`).join('')}`:''}
    `:`<div class="live-empty">${isOn?'‚è≥ WAITING FOR DRIVERS TO LOG IN...<br><br>EACH VEHICLE WILL APPEAR HERE<br>WHEN THE DRIVER STARTS THE APP':'‚ñ∂ START THE LISTENER ABOVE<br>TO MONITOR ALL VEHICLES IN REAL TIME<br><br>REQUIRES FIREBASE CONNECTION'}</div>`}`;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT ‚Äî with trip recovery + login reset on refresh
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initApp(){
  const savedTrip = load(FS_TRIPSTATE_KEY, null);

  if(savedTrip && ACTIVE_PHASES.includes(savedTrip.phase)){
    // ‚îÄ‚îÄ Restore the active trip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    Object.assign(tripState, savedTrip);
    // tripStart/tripEnd were saved as timestamps (numbers) ‚Äî ensure they stay numbers
    if(tripState.tripStart) tripState.tripStart = Number(tripState.tripStart);
    if(tripState.tripEnd)   tripState.tripEnd   = Number(tripState.tripEnd);
    tripState.gpsWatchId = null; // will be re-acquired below

    // Show driver badge
    document.getElementById('driverBadge').textContent =
      tripState.driver.split(' ')[0] + ' ¬∑ ' + tripState.carPlate;

    // Show recovery overlay
    showTripRecoveryOverlay(savedTrip);

    // Start background services ‚Äî trip is still going
    startSessionTimer();
    startGpsWatch();
    if(tripState.phase === 'active') startTripTimer();

  } else {
    // ‚îÄ‚îÄ No active trip ‚Äî go back to Driver Login ‚îÄ
    clearSavedTripState();
    // Reset tripState to setup regardless of what was saved
    tripState.phase   = 'setup';
    tripState.driver  = '';
    tripState.carPlate= '';
    tripState.fromStation = null;
    tripState.toStation   = null;
    tripState.amount  = '';
    tripState.notes   = '';
    tripState.tripStart = null;
    tripState.tripEnd   = null;
    // Clear persisted login so badge shows "LOGIN"
    save('fs_driver', null);
    document.getElementById('driverBadge').textContent = '‚Äî LOGIN ‚Äî';
  }

  updateOfflineBadge();
  startAutoSync();
  initFirebase();
  renderLog();
  if(appConfig.projectId && isOnline()){
    loadFirebaseData(true);
    startLiveListener();
  }
})();

function showTripRecoveryOverlay(snap){
  const info = document.getElementById('tripRecoveryInfo');
  if(!info) return;

  const elapsed = snap.tripStart
    ? Math.floor((Date.now() - Number(snap.tripStart)) / 60000) : null;

  const phaseLabel = snap.phase==='active'
    ? 'üöå IN PROGRESS'
    : snap.phase==='arrived'
    ? 'üìç ARRIVED ‚Äî AWAITING END DETAILS'
    : snap.phase==='confirm'
    ? '‚úÖ READY TO SUBMIT'
    : snap.phase.toUpperCase();

  info.innerHTML = `
    <div class="trip-recovery-row"><span>DRIVER</span><span>${snap.driver||'‚Äî'}</span></div>
    <div class="trip-recovery-row"><span>CAR</span><span>${snap.carPlate||'‚Äî'}</span></div>
    <div class="trip-recovery-row"><span>FROM</span><span>${snap.fromStation?.name||snap.fromStation||'‚Äî'}</span></div>
    ${snap.toStation?`<div class="trip-recovery-row"><span>TO</span><span>${snap.toStation?.name||snap.toStation}</span></div>`:''}
    <div class="trip-recovery-row"><span>STATUS</span><span style="color:#f59e0b">${phaseLabel}</span></div>
    ${elapsed!==null?`<div class="trip-recovery-row"><span>TRIP TIME</span><span>${elapsed} MIN AGO</span></div>`:''}
    ${snap.amount?`<div class="trip-recovery-row"><span>AMOUNT</span><span>KES ${Number(snap.amount).toLocaleString()}</span></div>`:''}`;

  document.getElementById('tripRecoveryOverlay').classList.add('show');
}

function resumeActiveTrip(){
  document.getElementById('tripRecoveryOverlay').classList.remove('show');
  renderLog();
  toast('‚úÖ TRIP RESTORED ‚Äî PLEASE COMPLETE AND SUBMIT');
}

function abandonTripAndReset(){
  if(!confirm('‚ö† ARE YOU SURE? THIS WILL DISCARD YOUR CURRENT TRIP AND LOG YOU OUT.')){return;}
  clearSavedTripState();
  save('fs_driver', null);
  tripState.phase='setup';
  tripState.driver=''; tripState.carPlate='';
  tripState.fromStation=null; tripState.toStation=null;
  tripState.amount=''; tripState.notes='';
  tripState.tripStart=null; tripState.tripEnd=null;
  clearInterval(timerInterval);
  document.getElementById('driverBadge').textContent='‚Äî LOGIN ‚Äî';
  document.getElementById('tripRecoveryOverlay').classList.remove('show');
  renderLog();
  toast('LOGGED OUT ‚Äî PLEASE LOG IN AGAIN');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BEFOREUNLOAD ‚Äî warn on active trip + save state
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('beforeunload', e => {
  if(ACTIVE_PHASES.includes(tripState.phase)){
    // Always save latest state before the page unloads
    saveTripState();
    // Show browser-native warning dialog
    const msg = 'YOU HAVE AN ACTIVE TRIP IN PROGRESS! Refresh now and your trip details will be restored, but please end it first.';
    e.preventDefault();
    e.returnValue = msg;
    return msg;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PWA ‚Äî Service Worker + Install Prompt
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pwaInstallEvent = null;

// Register service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('sw.js')
      .then(reg=>{
        console.log('[PWA] Service worker registered:', reg.scope);
        // Check for updates every time the app loads
        reg.addEventListener('updatefound', ()=>{
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', ()=>{
            if(newWorker.state==='installed' && navigator.serviceWorker.controller){
              toast('üîÑ APP UPDATE AVAILABLE ‚Äî REFRESH TO UPDATE');
            }
          });
        });
      })
      .catch(err => console.log('[PWA] Service worker registration failed:', err));
  });
}

// Capture the install prompt (Android Chrome)
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  pwaInstallEvent = e;
  // Show banner only if not already installed and not dismissed recently
  const dismissed = localStorage.getItem('pwa_dismissed');
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
  if(!isInstalled && (!dismissed || Date.now() - parseInt(dismissed) > 7*24*60*60*1000)){
    setTimeout(()=>document.getElementById('pwaBanner')?.classList.add('show'), 3000);
  }
});

// Handle install button tap
document.getElementById('pwaInstallBtn')?.addEventListener('click', async ()=>{
  if(!pwaInstallEvent){ toast('TO INSTALL: TAP BROWSER MENU ‚Üí ADD TO HOME SCREEN'); return; }
  pwaInstallEvent.prompt();
  const { outcome } = await pwaInstallEvent.userChoice;
  if(outcome === 'accepted'){
    toast('‚úÖ FESTUS SACCO INSTALLED!');
    document.getElementById('pwaBanner')?.classList.remove('show');
  }
  pwaInstallEvent = null;
});

function dismissPwaBanner(){
  document.getElementById('pwaBanner')?.classList.remove('show');
  localStorage.setItem('pwa_dismissed', Date.now().toString());
}

// If already running as installed PWA, update theme color for dark mode
function updatePwaTheme(){
  const meta = document.getElementById('themeColorMeta');
  if(meta) meta.setAttribute('content', darkMode ? '#0d1410' : '#1a7a3c');
}
updatePwaTheme();

// Show iOS install instructions if Safari and not installed
(function(){
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /safari/i.test(navigator.userAgent) && !/chrome/i.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone === true;
  const dismissed = localStorage.getItem('pwa_ios_dismissed');
  if(isIos && isSafari && !isStandalone && (!dismissed || Date.now()-parseInt(dismissed)>7*24*60*60*1000)){
    setTimeout(()=>{
      const banner = document.getElementById('pwaBanner');
      const btn    = document.getElementById('pwaInstallBtn');
      if(banner && btn){
        banner.querySelector('.pwa-banner-text').innerHTML =
          '<strong>INSTALL ON IPHONE</strong>TAP <strong>Share ‚¨Ü</strong> THEN <strong>"ADD TO HOME SCREEN"</strong>';
        btn.style.display='none';
        banner.classList.add('show');
        // Auto dismiss after 8 seconds
        setTimeout(()=>{
          banner.classList.remove('show');
          localStorage.setItem('pwa_ios_dismissed', Date.now().toString());
        }, 8000);
      }
    }, 3000);
  }
})();
</script>
</body>
</html>
