<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FELISHA SACCO ‚Äî Trip Logger</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f5f7f5;
  --card: #ffffff;
  --border: #dde8dd;
  --accent: #1a7a3c;
  --accent-light: #e8f5ed;
  --accent2: #f0a500;
  --red: #e53935;
  --red-light: #fdecea;
  --text: #1a2e1a;
  --muted: #6a8a6a;
  --font-display: 'Bebas Neue', sans-serif;
  --font-mono: 'Space Mono', monospace;
  --font-body: 'DM Sans', sans-serif;
  --shadow: 0 2px 16px rgba(26,122,60,0.10);
  --shadow-lg: 0 8px 32px rgba(26,122,60,0.15);
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  max-width: 480px;
  margin: 0 auto;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  background: var(--accent);
  padding: 20px 24px 16px;
  position: sticky; top: 0; z-index: 100;
}
.header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
.logo { font-family: var(--font-display); font-size: 1.8rem; letter-spacing: 3px; color: #fff; }
.logo span { color: var(--accent2); }
.header-sub { font-family: var(--font-mono); font-size: 0.6rem; color: rgba(255,255,255,0.6); letter-spacing: 2px; text-transform: uppercase; }
.driver-badge {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2);
  padding: 5px 12px; font-family: var(--font-mono); font-size: 0.62rem;
  color: #fff; letter-spacing: 1px; cursor: pointer;
  transition: background 0.2s;
}
.driver-badge:hover { background: rgba(255,255,255,0.25); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main { padding: 20px 16px 40px; }

/* ‚îÄ‚îÄ DRIVER SETUP ‚îÄ‚îÄ */
.setup-card {
  background: var(--card); border: 1px solid var(--border);
  border-left: 4px solid var(--accent2);
  padding: 24px; margin-bottom: 20px;
  box-shadow: var(--shadow); animation: fadeUp 0.4s ease;
}
.setup-title { font-family: var(--font-display); font-size: 1.4rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 16px; }

.field { margin-bottom: 14px; }
.field label { display: block; font-family: var(--font-mono); font-size: 0.58rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 6px; }
.field select, .field input {
  width: 100%; background: var(--bg); border: 1px solid var(--border);
  color: var(--text); padding: 11px 14px; font-family: var(--font-body);
  font-size: 0.9rem; outline: none; transition: border-color 0.2s; appearance: none;
}
.field select:focus, .field input:focus { border-color: var(--accent); }

/* ‚îÄ‚îÄ STATUS CARD ‚îÄ‚îÄ */
.status-card {
  background: var(--card); border: 1px solid var(--border);
  padding: 20px 24px; margin-bottom: 20px;
  box-shadow: var(--shadow); animation: fadeUp 0.4s ease;
}
.status-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
.status-dot.idle { background: var(--muted); }
.status-dot.active { background: #22c55e; animation: pulse 1.5s infinite; }
.status-dot.arrived { background: var(--accent2); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
.status-label { font-family: var(--font-mono); font-size: 0.62rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
.status-value { font-family: var(--font-display); font-size: 1.1rem; color: var(--text); letter-spacing: 1px; }

/* ‚îÄ‚îÄ TRIP CARD ‚îÄ‚îÄ */
.trip-card {
  background: var(--card); border: 1px solid var(--border);
  padding: 24px; margin-bottom: 20px;
  box-shadow: var(--shadow); animation: fadeUp 0.4s ease;
}
.trip-title { font-family: var(--font-display); font-size: 1.3rem; color: var(--accent); letter-spacing: 2px; margin-bottom: 6px; }
.trip-sub { font-family: var(--font-mono); font-size: 0.6rem; color: var(--muted); letter-spacing: 1px; margin-bottom: 20px; }

/* ‚îÄ‚îÄ STATION SELECTOR ‚îÄ‚îÄ */
.station-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.station-btn {
  background: var(--bg); border: 2px solid var(--border);
  padding: 14px 10px; text-align: center; cursor: pointer;
  transition: all 0.2s; font-family: var(--font-body); font-size: 0.82rem;
  color: var(--text); font-weight: 500;
}
.station-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }
.station-btn.selected { border-color: var(--accent); background: var(--accent); color: #fff; }
.station-btn.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
.station-btn .dist { display: block; font-family: var(--font-mono); font-size: 0.55rem; color: inherit; opacity: 0.7; margin-top: 3px; }
.station-btn.selected .dist { color: rgba(255,255,255,0.7); }

/* ‚îÄ‚îÄ GPS STATUS ‚îÄ‚îÄ */
.gps-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px; background: var(--accent-light);
  border: 1px solid var(--border); margin-bottom: 16px;
  font-family: var(--font-mono); font-size: 0.62rem; color: var(--accent);
  letter-spacing: 1px;
}
.gps-bar.error { background: var(--red-light); border-color: var(--red); color: var(--red); }
.gps-icon { font-size: 1rem; }

/* ‚îÄ‚îÄ ROUTE DISPLAY ‚îÄ‚îÄ */
.route-display {
  display: flex; align-items: center; gap: 12px;
  padding: 16px; background: var(--accent-light);
  border: 1px solid var(--border); margin-bottom: 16px;
}
.route-station { flex: 1; text-align: center; }
.route-station .name { font-family: var(--font-mono); font-size: 0.78rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
.route-station .role { font-family: var(--font-mono); font-size: 0.55rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.route-arrow { font-size: 1.4rem; color: var(--accent); }

/* ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ */
.timer-display {
  text-align: center; padding: 16px;
  background: var(--text); color: #fff;
  margin-bottom: 16px;
}
.timer-label { font-family: var(--font-mono); font-size: 0.58rem; letter-spacing: 2px; color: rgba(255,255,255,0.5); text-transform: uppercase; margin-bottom: 6px; }
.timer-value { font-family: var(--font-display); font-size: 2.8rem; letter-spacing: 3px; color: #22c55e; }

/* ‚îÄ‚îÄ AMOUNT INPUT ‚îÄ‚îÄ */
.amount-section { margin-bottom: 16px; }
.amount-label { font-family: var(--font-mono); font-size: 0.58rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 8px; }
.amount-input-wrap { position: relative; }
.amount-prefix { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-family: var(--font-mono); font-size: 0.82rem; color: var(--muted); font-weight: 700; }
.amount-input {
  width: 100%; background: var(--bg); border: 2px solid var(--border);
  color: var(--text); padding: 14px 14px 14px 56px;
  font-family: var(--font-mono); font-size: 1.2rem; font-weight: 700;
  outline: none; transition: border-color 0.2s; letter-spacing: 1px;
}
.amount-input:focus { border-color: var(--accent); }

/* ‚îÄ‚îÄ LOCKED SECTION ‚îÄ‚îÄ */
.locked-section {
  padding: 20px; background: #f8f8f8; border: 2px dashed var(--border);
  text-align: center; margin-bottom: 16px;
}
.locked-icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.3; }
.locked-text { font-family: var(--font-mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 1px; line-height: 1.8; text-transform: uppercase; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-block {
  width: 100%; padding: 16px; font-family: var(--font-display);
  font-size: 1.2rem; letter-spacing: 3px; cursor: pointer;
  border: none; transition: all 0.2s; margin-bottom: 10px;
}
.btn-start { background: var(--accent); color: #fff; }
.btn-start:hover { background: #156632; }
.btn-start:disabled { background: var(--muted); cursor: not-allowed; }
.btn-arrive { background: var(--accent2); color: #fff; }
.btn-arrive:hover { background: #d4920a; }
.btn-arrive:disabled { background: var(--muted); cursor: not-allowed; }
.btn-end { background: var(--red); color: #fff; }
.btn-end:hover { background: #c0392b; }
.btn-end:disabled { background: var(--muted); cursor: not-allowed; }
.btn-reset { background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: var(--font-mono); font-size: 0.7rem; letter-spacing: 1px; padding: 10px; width: 100%; cursor: pointer; }
.btn-reset:hover { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ SUCCESS CARD ‚îÄ‚îÄ */
.success-card {
  background: var(--accent); color: #fff;
  padding: 28px 24px; text-align: center;
  margin-bottom: 20px; box-shadow: var(--shadow-lg);
  animation: fadeUp 0.4s ease;
}
.success-icon { font-size: 3rem; margin-bottom: 12px; }
.success-title { font-family: var(--font-display); font-size: 2rem; letter-spacing: 3px; margin-bottom: 8px; }
.success-sub { font-family: var(--font-mono); font-size: 0.65rem; opacity: 0.8; letter-spacing: 1px; line-height: 1.8; }
.success-details { background: rgba(255,255,255,0.15); padding: 14px; margin: 16px 0; }
.success-detail-row { display: flex; justify-content: space-between; font-family: var(--font-mono); font-size: 0.68rem; margin-bottom: 6px; }
.success-detail-row:last-child { margin-bottom: 0; }

/* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
.history-section { margin-top: 8px; }
.history-title { font-family: var(--font-mono); font-size: 0.62rem; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
.history-item {
  background: var(--card); border: 1px solid var(--border);
  padding: 14px 16px; margin-bottom: 8px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.history-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.history-route { font-family: var(--font-mono); font-size: 0.78rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
.history-amount { font-family: var(--font-mono); font-size: 0.72rem; color: #22c55e; font-weight: 700; }
.history-bottom { display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--muted); }
.history-driver { font-size: 0.68rem; }
.history-time { font-family: var(--font-mono); font-size: 0.6rem; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--text); color: #fff; padding: 12px 24px;
  font-family: var(--font-mono); font-size: 0.68rem; letter-spacing: 1px;
  z-index: 999; opacity: 0; transition: opacity 0.3s;
  max-width: 90vw; text-align: center;
}
.toast.show { opacity: 1; }

@keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.divider { display: flex; align-items: center; gap: 12px; margin: 16px 0; }
.divider-line { flex: 1; height: 1px; background: var(--border); }
.divider-text { font-family: var(--font-mono); font-size: 0.58rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
</style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="logo">FELISHA<span> SACCO</span></div>
    <div class="driver-badge" id="driverBadge" onclick="resetDriver()">‚Äî NO DRIVER ‚Äî</div>
  </div>
  <div class="header-sub">// TRIP LOGGER</div>
</header>

<main id="mainContent">
  <!-- Dynamically rendered -->
</main>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ STATIONS ‚Äî Edit these to match your actual stations ‚îÄ‚îÄ
const STATIONS = [
  { name: 'NAIROBI CBD',    lat: -1.2833, lng: 36.8167 },
  { name: 'WESTLANDS',      lat: -1.2676, lng: 36.8112 },
  { name: 'KAREN',          lat: -1.3197, lng: 36.7073 },
  { name: 'NGONG',          lat: -1.3583, lng: 36.6583 },
  { name: 'RONGAI',         lat: -1.3944, lng: 36.7452 },
  { name: 'LANG\'ATA',      lat: -1.3204, lng: 36.7571 },
  { name: 'KIKUYU',         lat: -1.2463, lng: 36.6637 },
  { name: 'LIMURU',         lat: -1.1095, lng: 36.6431 },
];

const DRIVERS = [
  'FESTUS KIPKURUI',
  'TOM WASIKE',
  'FELIX OTIENO',
  'MUTUA KIRUI',
  'JANETH TIONY',
  'GRACE WANGECHI',
];

const CAR_PLATES = ['KBZ 300','KBY 400','KBU 500','KCA 200'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let state = {
  phase: 'setup',      // setup | idle | active | arrived | done
  driver: '',
  carPlate: '',
  fromStation: null,
  toStation: null,
  amount: '',
  tripStart: null,
  tripEnd: null,
  gpsLat: null,
  gpsLng: null,
  gpsStatus: 'unknown', // unknown | detecting | ok | error
  nearestStation: null,
  history: [],
};

// Load history from localStorage
try { state.history = JSON.parse(localStorage.getItem('felishaTrips') || '[]'); } catch(e) {}

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ
function getGPS() {
  state.gpsStatus = 'detecting';
  render();
  if (!navigator.geolocation) {
    state.gpsStatus = 'error'; render(); return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      state.gpsLat = pos.coords.latitude;
      state.gpsLng = pos.coords.longitude;
      state.gpsStatus = 'ok';
      state.nearestStation = findNearest(state.gpsLat, state.gpsLng);
      render();
    },
    err => { state.gpsStatus = 'error'; render(); },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLng = (lng2-lng1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function findNearest(lat, lng) {
  let best = null, bestDist = Infinity;
  STATIONS.forEach(s => {
    const d = haversine(lat, lng, s.lat, s.lng);
    if (d < bestDist) { bestDist = d; best = { ...s, dist: d }; }
  });
  return best;
}

function distKm(station) {
  if (!state.gpsLat || !station) return null;
  return haversine(state.gpsLat, state.gpsLng, station.lat, station.lng);
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
let timerInterval = null;
function startTimer() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const el = document.getElementById('timerVal');
    if (el && state.tripStart) {
      const secs = Math.floor((Date.now() - state.tripStart) / 1000);
      const h = String(Math.floor(secs/3600)).padStart(2,'0');
      const m = String(Math.floor((secs%3600)/60)).padStart(2,'0');
      const s = String(secs%60).padStart(2,'0');
      el.textContent = `${h}:${m}:${s}`;
    }
  }, 1000);
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ
function saveDriver() {
  const d = document.getElementById('selDriver')?.value;
  const p = document.getElementById('selPlate')?.value;
  if (!d || !p) { showToast('SELECT DRIVER AND CAR PLATE'); return; }
  state.driver = d;
  state.carPlate = p;
  state.phase = 'idle';
  document.getElementById('driverBadge').textContent = d.split(' ')[0];
  getGPS();
  render();
}

function selectFromStation(name) {
  state.fromStation = STATIONS.find(s => s.name === name);
  render();
}

function selectToStation(name) {
  if (state.phase !== 'arrived') return;
  state.toStation = STATIONS.find(s => s.name === name);
  render();
}

function startTrip() {
  if (!state.fromStation) { showToast('SELECT YOUR STARTING STATION'); return; }
  state.phase = 'active';
  state.tripStart = Date.now();
  state.toStation = null;
  render();
  startTimer();
  showToast('TRIP STARTED ‚Äî SAFE JOURNEY!');
}

function arriveAtStation() {
  // Re-detect GPS to suggest destination
  state.phase = 'arrived';
  state.tripEnd = Date.now();
  clearInterval(timerInterval);
  getGPS();
  render();
  showToast('ARRIVAL CONFIRMED ‚Äî SELECT DESTINATION & ENTER AMOUNT');
}

function endTrip() {
  const amtEl = document.getElementById('amountInput');
  const amt = amtEl ? parseFloat(amtEl.value) : 0;
  if (!state.toStation) { showToast('SELECT YOUR DESTINATION STATION'); return; }
  if (!amt || amt <= 0) { showToast('ENTER AMOUNT COLLECTED'); return; }
  if (state.toStation.name === state.fromStation.name) { showToast('TO STATION MUST BE DIFFERENT FROM FROM STATION'); return; }

  state.amount = amt;
  const duration = Math.floor((state.tripEnd - state.tripStart) / 60000);

  // Save trip
  const trip = {
    id: Date.now(),
    driver: state.driver,
    carPlate: state.carPlate,
    fromStation: state.fromStation.name,
    toStation: state.toStation.name,
    amount: amt,
    duration,
    date: new Date().toLocaleDateString('en-GB'),
    time: new Date().toLocaleTimeString(),
    timestamp: new Date().toISOString(),
  };
  state.history.unshift(trip);
  localStorage.setItem('felishaTrips', JSON.stringify(state.history.slice(0, 50)));

  // Submit to Google Sheets via fetch (using form POST)
  submitToSheets(trip);

  state.phase = 'done';
  render();
}

function newTrip() {
  // After completing a trip, FROM = previous TO
  const prevTo = state.toStation;
  state.phase = 'idle';
  state.fromStation = prevTo; // Start from where you ended
  state.toStation = null;
  state.amount = '';
  state.tripStart = null;
  state.tripEnd = null;
  getGPS();
  render();
  showToast('READY FOR NEXT TRIP');
}

function resetDriver() {
  clearInterval(timerInterval);
  state = { ...state, phase: 'setup', driver: '', carPlate: '', fromStation: null, toStation: null, amount: '', tripStart: null, tripEnd: null };
  document.getElementById('driverBadge').textContent = '‚Äî NO DRIVER ‚Äî';
  render();
}

// ‚îÄ‚îÄ GOOGLE SHEETS SUBMIT ‚îÄ‚îÄ
// To connect: replace FORM_ACTION_URL with your Google Form's action URL
// and update the entry IDs to match your form fields
const FORM_ACTION_URL = ''; // e.g. https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse

async function submitToSheets(trip) {
  if (!FORM_ACTION_URL) return; // Not configured yet
  const params = new URLSearchParams({
    'entry.DATE':        trip.date,
    'entry.FROM':        trip.fromStation,
    'entry.TO':          trip.toStation,
    'entry.DRIVER':      trip.driver,
    'entry.CAR':         trip.carPlate,
    'entry.AMOUNT':      trip.amount,
  });
  try {
    await fetch(FORM_ACTION_URL, { method:'POST', mode:'no-cors', body: params });
  } catch(e) { /* silent fail ‚Äî data saved locally */ }
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render() {
  const main = document.getElementById('mainContent');

  if (state.phase === 'setup') {
    main.innerHTML = `
      <div class="setup-card">
        <div class="setup-title">DRIVER LOGIN</div>
        <div class="field">
          <label>Select Driver</label>
          <select id="selDriver">
            <option value="">‚Äî Choose Driver ‚Äî</option>
            ${DRIVERS.map(d => `<option value="${d}" ${d===state.driver?'selected':''}>${d}</option>`).join('')}
          </select>
        </div>
        <div class="field">
          <label>Car Plate</label>
          <select id="selPlate">
            <option value="">‚Äî Choose Car ‚Äî</option>
            ${CAR_PLATES.map(p => `<option value="${p}" ${p===state.carPlate?'selected':''}>${p}</option>`).join('')}
          </select>
        </div>
        <button class="btn-block btn-start" onclick="saveDriver()">BEGIN SHIFT</button>
      </div>
      ${renderHistory()}`;
    return;
  }

  const gpsBar = state.gpsStatus === 'detecting'
    ? `<div class="gps-bar"><span class="gps-icon">üì°</span>DETECTING YOUR LOCATION...</div>`
    : state.gpsStatus === 'ok' && state.nearestStation
    ? `<div class="gps-bar"><span class="gps-icon">üìç</span>NEAREST: ${state.nearestStation.name} (${state.nearestStation.dist.toFixed(1)} KM)</div>`
    : state.gpsStatus === 'error'
    ? `<div class="gps-bar error"><span class="gps-icon">‚ö†</span>GPS UNAVAILABLE ‚Äî SELECT STATION MANUALLY</div>`
    : `<div class="gps-bar"><span class="gps-icon">üì°</span><span onclick="getGPS()" style="cursor:pointer;text-decoration:underline">TAP TO DETECT LOCATION</span></div>`;

  if (state.phase === 'idle') {
    main.innerHTML = `
      <div class="trip-card">
        <div class="trip-title">START TRIP</div>
        <div class="trip-sub">// SELECT YOUR STARTING STATION</div>
        ${gpsBar}
        <div class="field"><label>FROM STATION</label></div>
        <div class="station-grid">
          ${STATIONS.map(s => {
            const d = distKm(s);
            const isNearest = state.nearestStation?.name === s.name;
            return `<div class="station-btn ${state.fromStation?.name===s.name?'selected':''} ${isNearest?'nearest':''}"
              onclick="selectFromStation('${s.name}')">
              ${s.name}${isNearest?' üìç':''}
              ${d !== null ? `<span class="dist">${d.toFixed(1)} km</span>` : ''}
            </div>`;
          }).join('')}
        </div>
        <button class="btn-block btn-start" onclick="startTrip()" ${!state.fromStation?'disabled':''}>
          üöå START TRIP
        </button>
      </div>
      ${renderHistory()}`;
    // Auto-select nearest if GPS available
    if (state.nearestStation && !state.fromStation) {
      setTimeout(() => selectFromStation(state.nearestStation.name), 100);
    }
    return;
  }

  if (state.phase === 'active') {
    const secs = state.tripStart ? Math.floor((Date.now() - state.tripStart)/1000) : 0;
    const h = String(Math.floor(secs/3600)).padStart(2,'0');
    const m = String(Math.floor((secs%3600)/60)).padStart(2,'0');
    const s = String(secs%60).padStart(2,'0');

    main.innerHTML = `
      <div class="trip-card">
        <div class="trip-title">TRIP IN PROGRESS</div>
        <div class="trip-sub">// DRIVE TO YOUR DESTINATION THEN TAP ARRIVE</div>
        <div class="route-display">
          <div class="route-station">
            <div class="role">FROM</div>
            <div class="name">${state.fromStation.name}</div>
          </div>
          <div class="route-arrow">‚Üí</div>
          <div class="route-station">
            <div class="role">TO</div>
            <div class="name" style="color:var(--muted)">DESTINATION</div>
          </div>
        </div>
        <div class="timer-display">
          <div class="timer-label">TRIP DURATION</div>
          <div class="timer-value" id="timerVal">${h}:${m}:${s}</div>
        </div>
        <div class="locked-section">
          <div class="locked-icon">üîí</div>
          <div class="locked-text">DESTINATION LOCKED<br>ARRIVE AT STATION FIRST<br>THEN TAP BUTTON BELOW</div>
        </div>
        <button class="btn-block btn-arrive" onclick="arriveAtStation()">
          üìç I HAVE ARRIVED
        </button>
        <button class="btn-reset" onclick="if(confirm('Cancel this trip?')){state.phase='idle';render();}">CANCEL TRIP</button>
      </div>`;
    startTimer();
    return;
  }

  if (state.phase === 'arrived') {
    main.innerHTML = `
      <div class="trip-card">
        <div class="trip-title">END TRIP</div>
        <div class="trip-sub">// SELECT DESTINATION & ENTER AMOUNT</div>
        ${gpsBar}
        <div class="route-display">
          <div class="route-station">
            <div class="role">FROM</div>
            <div class="name">${state.fromStation.name}</div>
          </div>
          <div class="route-arrow">‚Üí</div>
          <div class="route-station">
            <div class="role">TO</div>
            <div class="name">${state.toStation ? state.toStation.name : '???'}</div>
          </div>
        </div>
        <div class="field"><label>TO STATION (SELECT ARRIVAL)</label></div>
        <div class="station-grid">
          ${STATIONS.map(s => {
            const d = distKm(s);
            const isNearest = state.nearestStation?.name === s.name;
            const isSameAsFrom = s.name === state.fromStation?.name;
            return `<div class="station-btn ${state.toStation?.name===s.name?'selected':''} ${isSameAsFrom?'disabled':''}"
              onclick="selectToStation('${s.name}')">
              ${s.name}${isNearest?' üìç':''}
              ${d !== null ? `<span class="dist">${d.toFixed(1)} km</span>` : ''}
            </div>`;
          }).join('')}
        </div>
        <div class="amount-section">
          <div class="amount-label">AMOUNT COLLECTED IN KES</div>
          <div class="amount-input-wrap">
            <span class="amount-prefix">KES</span>
            <input type="number" class="amount-input" id="amountInput" placeholder="0" min="0" value="${state.amount||''}">
          </div>
        </div>
        <button class="btn-block btn-end" onclick="endTrip()" ${!state.toStation?'disabled':''}>
          ‚úÖ SUBMIT TRIP
        </button>
      </div>`;
    // Auto-select nearest as destination
    if (state.nearestStation && !state.toStation && state.nearestStation.name !== state.fromStation?.name) {
      setTimeout(() => selectToStation(state.nearestStation.name), 100);
    }
    return;
  }

  if (state.phase === 'done') {
    const last = state.history[0];
    main.innerHTML = `
      <div class="success-card">
        <div class="success-icon">‚úÖ</div>
        <div class="success-title">TRIP LOGGED!</div>
        <div class="success-details">
          <div class="success-detail-row"><span>DRIVER</span><span>${last.driver}</span></div>
          <div class="success-detail-row"><span>CAR</span><span>${last.carPlate}</span></div>
          <div class="success-detail-row"><span>ROUTE</span><span>${last.fromStation} ‚Üí ${last.toStation}</span></div>
          <div class="success-detail-row"><span>DURATION</span><span>${last.duration} MIN</span></div>
          <div class="success-detail-row"><span>AMOUNT</span><span>KES ${Number(last.amount).toLocaleString()}</span></div>
          <div class="success-detail-row"><span>TIME</span><span>${last.time}</span></div>
        </div>
        <div class="success-sub">DATA SAVED LOCALLY<br>SYNCS TO GOOGLE SHEETS WHEN CONNECTED</div>
      </div>
      <button class="btn-block btn-start" onclick="newTrip()" style="margin-bottom:10px">
        üöå START NEXT TRIP
      </button>
      <button class="btn-reset" onclick="resetDriver()">END SHIFT</button>
      ${renderHistory()}`;
    return;
  }
}

function renderHistory() {
  if (!state.history.length) return '';
  return `
    <div class="history-section">
      <div class="history-title">TODAY'S TRIPS (${state.history.filter(t=>t.date===new Date().toLocaleDateString('en-GB')).length})</div>
      ${state.history.slice(0,10).map(t => `
        <div class="history-item">
          <div class="history-top">
            <span class="history-route">${t.fromStation} ‚Üí ${t.toStation}</span>
            <span class="history-amount">KES ${Number(t.amount).toLocaleString()}</span>
          </div>
          <div class="history-bottom">
            <span class="history-driver">${t.driver} ¬∑ ${t.carPlate}</span>
            <span class="history-time">${t.time}</span>
          </div>
        </div>`).join('')}
    </div>`;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
render();
</script>
</body>
</html>
