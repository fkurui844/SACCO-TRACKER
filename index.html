<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>FELISHA SACCO</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* (Styles omitted for brevity, keeping your existing CSS structure) */
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root{
            --bg:#f5f7f5;--card:#fff;--surface:#eef2ee;--border:#dde8dd;
            --accent:#1a7a3c;--alight:#e8f5ed;--accent2:#f0a500;
            --red:#e53935;--rlight:#fdecea;--text:#1a2e1a;--muted:#6a8a6a;
            --shadow:0 2px 16px rgba(26,122,60,.10);--shlg:0 8px 32px rgba(26,122,60,.15);
            --font-d:'Bebas Neue',sans-serif;--font-m:'Space Mono',monospace;--font-b:'DM Sans',sans-serif;
        }
        [data-theme="dark"]{
            --bg:#0d1410;--card:#141f18;--surface:#1a2820;--border:#2a3e2e;
            --accent:#22c55e;--alight:#0d2a1a;--accent2:#f0a500;
            --red:#ef4444;--rlight:#2a0f0f;--text:#e0f0e4;--muted:#5a8a6a;
            --shadow:0 2px 16px rgba(0,0,0,.4);--shlg:0 8px 32px rgba(0,0,0,.5);
        }
        body{background:var(--bg);color:var(--text);font-family:var(--font-b);min-height:100vh;max-width:480px;margin:0 auto;transition:background .3s,color .3s}
        header{background:var(--accent);padding:13px 16px 10px;position:sticky;top:0;z-index:100}
        .hrow{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
        .logo{font-family:var(--font-d);font-size:1.6rem;letter-spacing:3px;color:#fff}
        .logo span{color:var(--accent2)}
        .hright{display:flex;align-items:center;gap:7px}
        .hsub{font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.6);letter-spacing:2px;display:flex;align-items:center;gap:10px}
        .dbadge{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);padding:4px 9px;font-family:var(--font-m);font-size:.52rem;color:#fff;letter-spacing:1px;cursor:pointer;white-space:nowrap}
        .bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:100}
        .nbtn{padding:9px 4px;text-align:center;cursor:pointer;border:none;background:transparent}
        .nbtn.active{background:var(--alight)}
        .nbtn .ni{font-size:1.15rem;display:block}
        .nbtn .nl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);text-transform:uppercase}
        .nbtn.active .nl{color:var(--accent)}
        main{padding:13px 13px 74px}
        .page{display:none}.page.active{display:block}
        .card{background:var(--card);border:1px solid var(--border);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
        .field label{display:block;font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
        .field select, .field input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b)}
        .bb{width:100%;padding:13px;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;cursor:pointer;border:none;margin-bottom:7px}
        .bstart{background:var(--accent);color:#fff}
        .bwa{background:#25D366;color:#fff}
        .scard{background:var(--accent);color:#fff;padding:20px 16px;text-align:center}
        .tdisp{text-align:center;padding:13px;background:var(--text);color:var(--bg);margin-bottom:12px}
        .tv{font-family:var(--font-d);font-size:2.5rem;color:#22c55e}
        .toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:8px 16px;border-radius:20px;font-size:12px;opacity:0;transition:opacity 0.3s;z-index:999}
    </style>
</head>
<body>

<header>
    <div class="hrow">
        <div class="logo">FELISHA<span> SACCO</span></div>
        <div class="hright">
            <span class="session-bar" id="sessionBar"></span>
            <div class="dbadge" id="driverBadge" onclick="tripState.phase='setup';renderPage();">LOGIN</div>
        </div>
    </div>
</header>

<main>
    <div id="app-container"></div>
</main>

<nav class="bnav">
    <button class="nbtn active" onclick="switchPage('log')"><span class="ni">üöå</span><span class="nl">LOG</span></button>
    <button class="nbtn" onclick="switchPage('reports')"><span class="ni">üìä</span><span class="nl">STATS</span></button>
    <button class="nbtn" onclick="switchPage('admin')"><span class="ni">üëë</span><span class="nl">ADMIN</span></button>
</nav>

<div class="toast" id="toast"></div>

<script>
// --- STATE & DATA ---
const STATIONS = [
    {name:'NAIROBI CBD',lat:-1.2833,lng:36.8167},
    {name:'RONGAI',lat:-1.3944,lng:36.7452},
    {name:'NGONG',lat:-1.3583,lng:36.6583}
];
const DRIVERS = ['FESTUS KIPKURUI','TOM WASIKE','FELIX OTIENO'];
const CARS = ['KBZ 300','KBY 400','KBU 500'];

let tripState = {
    phase: 'setup', // setup, idle, active, done
    driver: '', carPlate: '', fromStation: '', toStation: '', amount: 0,
    startTime: null, gpsLocked: false
};

let localTrips = JSON.parse(localStorage.getItem('fs_trips') || '[]');

// --- UTILS ---
function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 2000);
}

// --- GEO-FENCING ---

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // meters
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function checkLocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos => {
        const station = STATIONS.find(s => s.name === tripState.fromStation);
        if (station) {
            const dist = getDistance(pos.coords.latitude, pos.coords.longitude, station.lat, station.lng);
            tripState.gpsLocked = dist < 500; // Locked if within 500m
            renderPage();
        }
    });
}

// --- WHATSAPP RECEIPT ---
function shareReceipt() {
    const t = localTrips[0];
    const msg = encodeURIComponent(
        `*FELISHA SACCO OFFICIAL RECEIPT*\n` +
        `--------------------------\n` +
        `*VEHICLE:* ${t.car}\n` +
        `*ROUTE:* ${t.from} ‚ûî ${t.to}\n` +
        `*FARE:* KES ${t.amount}\n` +
        `*DRIVER:* ${t.driver}\n` +
        `--------------------------\n` +
        `_Safe Journey!_`
    );
    window.open(`https://wa.me/?text=${msg}`, '_blank');
}

// --- UI ENGINE ---
function renderPage() {
    const container = document.getElementById('app-container');
    const badge = document.getElementById('driverBadge');
    
    if (tripState.phase === 'setup') {
        badge.textContent = "LOGIN";
        container.innerHTML = `
            <div class="card">
                <div class="ctitle">DRIVER SETUP</div>
                <div class="field"><label>Select Driver</label>
                    <select id="selDriver">${DRIVERS.map(d => `<option>${d}</option>`).join('')}</select>
                </div>
                <div class="field"><label>Select Car</label>
                    <select id="selCar">${CARS.map(c => `<option>${c}</option>`).join('')}</select>
                </div>
                <button class="bb bstart" onclick="saveSetup()">START SHIFT</button>
            </div>`;
    } 
    else if (tripState.phase === 'idle') {
        badge.textContent = tripState.driver;
        container.innerHTML = `
            <div class="card">
                <div class="ctitle">NEW TRIP</div>
                <div class="field"><label>From Station</label>
                    <select id="selFrom" onchange="tripState.fromStation=this.value; checkLocation();">
                        <option value="">Choose Station...</option>
                        ${STATIONS.map(s => `<option>${s.name}</option>`).join('')}
                    </select>
                </div>
                <div class="field"><label>To Destination</label>
                    <select id="selTo">${STATIONS.map(s => `<option>${s.name}</option>`).join('')}</select>
                </div>
                <p style="font-size:10px; color:${tripState.gpsLocked ? 'green':'red'}">
                    ${tripState.gpsLocked ? '‚úÖ At Station' : '‚ùå Distance too far from station'}
                </p>
                <button class="bb bstart" ${!tripState.gpsLocked ? 'disabled' : ''} onclick="startTrip()">DEPART NOW</button>
            </div>`;
    }
    else if (tripState.phase === 'active') {
        container.innerHTML = `
            <div class="tdisp">
                <div class="tl">TRIP IN PROGRESS</div>
                <div class="tv" id="timer">00:00</div>
            </div>
            <div class="card">
                <div class="field"><label>Fare Amount (KES)</label>
                    <input type="number" id="fareAmt" placeholder="e.g. 100">
                </div>
                <button class="bb bstart" style="background:var(--accent2)" onclick="completeTrip()">ARRIVE & LOG</button>
            </div>`;
        startTimer();
    }
    else if (tripState.phase === 'done') {
        container.innerHTML = `
            <div class="scard">
                <div class="stitle">SUCCESS</div>
                <p>Trip logged to SACCO records.</p>
                <button class="bb bwa" onclick="shareReceipt()">SEND RECEIPT</button>
                <button class="bb" style="background:#fff; color:#333" onclick="tripState.phase='idle'; renderPage();">NEW TRIP</button>
            </div>`;
    }
}

// --- LOGIC HANDLERS ---
function saveSetup() {
    tripState.driver = document.getElementById('selDriver').value;
    tripState.carPlate = document.getElementById('selCar').value;
    tripState.phase = 'idle';
    renderPage();
}

function startTrip() {
    tripState.fromStation = document.getElementById('selFrom').value;
    tripState.toStation = document.getElementById('selTo').value;
    tripState.phase = 'active';
    tripState.startTime = Date.now();
    renderPage();
}

function completeTrip() {
    const amt = document.getElementById('fareAmt').value;
    if(!amt) return toast("Enter Amount");
    
    const trip = {
        driver: tripState.driver,
        car: tripState.carPlate,
        from: tripState.fromStation,
        to: tripState.toStation,
        amount: amt,
        timestamp: new Date()
    };
    localTrips.unshift(trip);
    localStorage.setItem('fs_trips', JSON.stringify(localTrips));
    tripState.phase = 'done';
    renderPage();
}

function startTimer() {
    setInterval(() => {
        if(tripState.phase !== 'active') return;
        const diff = Math.floor((Date.now() - tripState.startTime) / 1000);
        const m = Math.floor(diff / 60).toString().padStart(2, '0');
        const s = (diff % 60).toString().padStart(2, '0');
        const el = document.getElementById('timer');
        if(el) el.textContent = `${m}:${s}`;
    }, 1000);
}

// Init
renderPage();
</script>
</body>
</html>
