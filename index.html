<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FESTUS SACCO">
<meta name="theme-color" content="#1a7a3c" id="themeColorMeta">
<meta name="description" content="SACCO trip logging and fleet management">
<link rel="manifest" href="manifest.json">
<!-- Apple Touch Icons (inline SVG fallback) -->
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' rx='40' fill='%231a7a3c'/><text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-family='Arial Black,sans-serif' font-weight='900' font-size='110' fill='%23f0a500'>F</text></svg>">
<title>FESTUS SACCO</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f7f5;--card:#fff;--surface:#eef2ee;--border:#dde8dd;
  --accent:#1a7a3c;--alight:#e8f5ed;--accent2:#f0a500;
  --red:#e53935;--rlight:#fdecea;--text:#1a2e1a;--muted:#6a8a6a;
  --shadow:0 2px 16px rgba(26,122,60,.10);--shlg:0 8px 32px rgba(26,122,60,.15);
  --font-d:'Bebas Neue',sans-serif;--font-m:'Space Mono',monospace;--font-b:'DM Sans',sans-serif;
}
[data-theme="dark"]{
  --bg:#0d1410;--card:#141f18;--surface:#1a2820;--border:#2a3e2e;
  --accent:#22c55e;--alight:#0d2a1a;--accent2:#f0a500;
  --red:#ef4444;--rlight:#2a0f0f;--text:#e0f0e4;--muted:#5a8a6a;
  --shadow:0 2px 16px rgba(0,0,0,.4);--shlg:0 8px 32px rgba(0,0,0,.5);
}
body{background:var(--bg);color:var(--text);font-family:var(--font-b);min-height:100vh;max-width:480px;margin:0 auto;transition:background .3s,color .3s}

/* HEADER */
header{background:var(--accent);padding:13px 16px 10px;position:sticky;top:0;z-index:100}
.hrow{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
.logo{font-family:var(--font-d);font-size:1.6rem;letter-spacing:3px;color:#fff}
.logo span{color:var(--accent2)}
.hright{display:flex;align-items:center;gap:7px}
.hsub{font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.6);letter-spacing:2px;display:flex;align-items:center;gap:10px}
.dbadge{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);padding:4px 9px;font-family:var(--font-m);font-size:.52rem;color:#fff;letter-spacing:1px;cursor:pointer;transition:background .2s;white-space:nowrap}
.dbadge:hover{background:rgba(255,255,255,.25)}
.hico{background:rgba(255,255,255,.15);border:none;color:#fff;width:28px;height:28px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0}
.hico:hover{background:rgba(255,255,255,.3)}
.offline-badge{background:#ef4444;color:#fff;font-family:var(--font-m);font-size:.46rem;padding:2px 6px;letter-spacing:1px;display:none}
.offline-badge.show{display:inline-block}
.sync-timer{font-family:var(--font-m);font-size:.46rem;color:rgba(255,255,255,.55);letter-spacing:1px;white-space:nowrap}
/* Session bar: hidden by default, only shown in last 5 minutes */
.session-bar{font-family:var(--font-m);font-size:.46rem;color:rgba(255,220,100,.9);letter-spacing:1px;white-space:nowrap;display:none}
.session-bar.show{display:inline}
.session-bar.warn{color:#ff6b6b;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* NAV */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:100;transition:background .3s}
.nbtn{padding:9px 4px;text-align:center;cursor:pointer;border:none;background:transparent;transition:background .15s}
.nbtn.active{background:var(--alight)}
.nbtn .ni{font-size:1.15rem;display:block;margin-bottom:1px}
.nbtn .nl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.nbtn.active .nl{color:var(--accent)}

main{padding:13px 13px 74px}
.page{display:none}.page.active{display:block}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);animation:fadeUp .3s ease;transition:background .3s,border-color .3s}
.ctitle{font-family:var(--font-d);font-size:1.2rem;color:var(--accent);letter-spacing:2px;margin-bottom:4px}
.csub{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;margin-bottom:13px}

/* FIELD */
.field{margin-bottom:10px}
.field label{display:block;font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.field select,.field input,.field textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;transition:border-color .2s;appearance:none}
.field textarea{resize:vertical;min-height:66px;font-size:.82rem}
.field select:focus,.field input:focus,.field textarea:focus{border-color:var(--accent)}

/* STATION GRID */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px}
.sbtn{background:var(--bg);border:2px solid var(--border);padding:10px 7px;text-align:center;cursor:pointer;transition:all .2s;font-family:var(--font-b);font-size:.72rem;color:var(--text);font-weight:500;position:relative}
.sbtn:hover{border-color:var(--accent);color:var(--accent);background:var(--alight)}
.sbtn.sel{border-color:var(--accent);background:var(--accent);color:#fff}
.sbtn.dis{opacity:.22;cursor:not-allowed;pointer-events:none}
.sbtn.nearest{border-color:var(--accent2)}
.sbtn .dist{display:block;font-family:var(--font-m);font-size:.44rem;opacity:.7;margin-top:2px}
.sbtn.sel .dist{opacity:.8}

/* GPS BAR */
.gbar{display:flex;align-items:center;gap:7px;padding:8px 10px;background:var(--alight);border:1px solid var(--border);margin-bottom:11px;font-family:var(--font-m);font-size:.52rem;color:var(--accent);letter-spacing:1px}
.gbar.err{background:var(--rlight);border-color:var(--red);color:var(--red)}
.gbar.detecting{background:var(--surface);border-color:var(--border);color:var(--muted)}

/* ROUTE DISPLAY */
.rdisp{display:flex;align-items:center;gap:10px;padding:12px;background:var(--alight);border:1px solid var(--border);margin-bottom:12px}
.rs{flex:1;text-align:center}
.rs .rn{font-family:var(--font-m);font-size:.66rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.rs .rl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:2px}
.rarr{font-size:1.3rem;color:var(--accent)}

/* TIMER */
.tdisp{text-align:center;padding:13px;background:var(--text);color:var(--bg);margin-bottom:12px;transition:background .3s}
.tl{font-family:var(--font-m);font-size:.48rem;letter-spacing:2px;color:rgba(128,200,128,.7);text-transform:uppercase;margin-bottom:3px}
.tv{font-family:var(--font-d);font-size:2.5rem;letter-spacing:3px;color:#22c55e}

/* SPEED BADGE */
.speed-badge{display:inline-flex;align-items:center;gap:6px;background:var(--alight);border:1px solid var(--border);padding:6px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-bottom:10px}
.speed-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0}
.speed-dot.moving{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25)}

/* AMOUNT */
.awrap{position:relative;margin-bottom:12px}
.apfx{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-family:var(--font-m);font-size:.72rem;color:var(--muted);font-weight:700}
.ainput{width:100%;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:12px 12px 12px 48px;font-family:var(--font-m);font-size:1.1rem;font-weight:700;outline:none;transition:border-color .2s;letter-spacing:1px}
.ainput:focus{border-color:var(--accent)}

/* LOCK */
.lock{padding:15px;background:var(--surface);border:2px dashed var(--border);text-align:center;margin-bottom:12px}
.lico{font-size:1.6rem;margin-bottom:4px;opacity:.3}
.ltxt{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;line-height:1.8;text-transform:uppercase}

/* CONFIRM */
.confirm-card{background:var(--surface);border:2px solid var(--accent);padding:18px;margin-bottom:14px;animation:fadeUp .3s ease}
.confirm-title{font-family:var(--font-d);font-size:1.6rem;color:var(--accent);letter-spacing:3px;text-align:center;margin-bottom:16px}
.confirm-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.confirm-row:last-child{border-bottom:none}
.confirm-label{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase}
.confirm-val{font-family:var(--font-m);font-size:.72rem;color:var(--text);font-weight:700;text-align:right;max-width:60%}
.confirm-amount{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:2px}
.confirm-warn{background:rgba(240,165,0,.12);border:1px solid var(--accent2);padding:9px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent2);letter-spacing:1px;margin-bottom:12px;text-align:center}

/* SHIFT */
.shift-open{background:#22c55e;color:#fff;font-family:var(--font-m);font-size:.5rem;padding:2px 8px;letter-spacing:1px;display:inline-block}
.shift-closed{background:var(--red);color:#fff;font-family:var(--font-m);font-size:.5rem;padding:2px 8px;letter-spacing:1px;display:inline-block}
.shift-block{background:var(--rlight);border:2px solid var(--red);padding:20px;text-align:center;margin-bottom:12px}
.shift-block-title{font-family:var(--font-d);font-size:1.4rem;color:var(--red);letter-spacing:2px;margin-bottom:6px}
.shift-block-sub{font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:1.8}

/* PIN LOCKOUT */
.pin-locked{background:var(--rlight);border:1px solid var(--red);padding:10px 13px;font-family:var(--font-m);font-size:.58rem;color:var(--red);letter-spacing:1px;text-align:center;margin-bottom:10px}

/* BUTTONS */
.bb{width:100%;padding:13px;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;cursor:pointer;border:none;transition:all .2s;margin-bottom:7px}
.bstart{background:var(--accent);color:#fff}.bstart:hover{background:#156632}.bstart:disabled{background:var(--muted);cursor:not-allowed}
.barrive{background:var(--accent2);color:#fff}.barrive:hover{background:#d4920a}
.bend{background:var(--red);color:#fff}.bend:hover{background:#c0392b}.bend:disabled{background:var(--muted);cursor:not-allowed}
.bconfirm{background:#22c55e;color:#fff}.bconfirm:hover{background:#16a34a}
.bout{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.6rem;letter-spacing:1px;padding:9px;width:100%;cursor:pointer;margin-bottom:7px;transition:all .2s}
.bout:hover{border-color:var(--red);color:var(--red)}
.bsm{padding:7px 12px;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;cursor:pointer;border:none;transition:all .2s}
.bg{background:var(--accent);color:#fff}.by{background:var(--accent2);color:#fff}.br{background:var(--red);color:#fff}.bgray{background:var(--muted);color:#fff}
.bwa{background:#25D366;color:#fff}
.bghost{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.54rem;padding:7px 12px;cursor:pointer;transition:all .2s}
.bghost:hover{border-color:var(--accent);color:var(--accent)}

/* SUCCESS */
.scard{background:var(--accent);color:#fff;padding:20px 16px;text-align:center;margin-bottom:12px;box-shadow:var(--shlg);animation:fadeUp .4s ease}
.sico{font-size:2.2rem;margin-bottom:8px}
.stitle{font-family:var(--font-d);font-size:1.7rem;letter-spacing:3px;margin-bottom:5px}
.ssub{font-family:var(--font-m);font-size:.54rem;opacity:.8;letter-spacing:1px;line-height:1.8}
.sdetails{background:rgba(255,255,255,.15);padding:11px;margin:12px 0}
.drow{display:flex;justify-content:space-between;font-family:var(--font-m);font-size:.56rem;margin-bottom:4px}
.drow:last-child{margin-bottom:0}

/* HISTORY */
.hsect{margin-top:6px}
.stitle2{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.hitem{background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:7px;box-shadow:0 1px 4px rgba(0,0,0,.04);transition:background .3s}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.hroute{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.hamt{font-family:var(--font-m);font-size:.61rem;color:#22c55e;font-weight:700}
.hbot{display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted)}
.htime{font-family:var(--font-m);font-size:.5rem}

/* SHIFT SUMMARY */
.sumcard{background:var(--surface);border:1px solid var(--border);padding:14px;margin-bottom:12px}
.sumrow{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border)}
.sumrow:last-child{border-bottom:none}
.sumlbl{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.sumval{font-family:var(--font-d);font-size:1.3rem;color:var(--accent)}

/* REPORTS */
.sgrid2{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.sbox{background:var(--card);border:1px solid var(--border);padding:13px;box-shadow:var(--shadow);transition:background .3s}
.sbox .sl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.sbox .sv{font-family:var(--font-d);font-size:1.6rem;color:var(--text);line-height:1}
.sv.green{color:var(--accent)}.sv.yellow{color:var(--accent2)}
.fchips{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.fchip{background:var(--bg);border:1px solid var(--border);padding:4px 9px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;cursor:pointer;color:var(--muted);transition:all .15s;text-transform:uppercase}
.fchip.active{background:var(--accent);border-color:var(--accent);color:#fff}
.rtable{background:var(--card);border:1px solid var(--border);overflow:hidden;margin-bottom:10px;transition:background .3s}
.rth{display:grid;grid-template-columns:1fr 1fr 55px 72px;padding:7px 10px;background:var(--accent);font-family:var(--font-m);font-size:.44rem;color:#fff;letter-spacing:1px;text-transform:uppercase;gap:4px}
.rtr{display:grid;grid-template-columns:1fr 1fr 55px 72px;padding:9px 10px;border-bottom:1px solid var(--border);font-size:.66rem;gap:4px;align-items:center;transition:background .1s}
.rtr:hover{background:var(--alight)}.rtr:last-child{border-bottom:none}
.trroute{font-family:var(--font-m);font-size:.53rem;color:var(--accent);font-weight:700}
.tramt{font-family:var(--font-m);font-size:.58rem;color:#22c55e;font-weight:700;text-align:right}
.exprow{display:flex;gap:6px;margin-bottom:11px;flex-wrap:wrap}
.exprow button{flex:1;min-width:55px}

/* REPORT TABS */
.rtabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--border);overflow-x:auto}
.rtab{font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;padding:8px 12px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase;white-space:nowrap;margin-bottom:-2px}
.rtab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rsect{display:none}.rsect.active{display:block}

/* CHARTS */
.chart-wrap{background:var(--card);border:1px solid var(--border);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.chart-title{font-family:var(--font-m);font-size:.52rem;color:var(--accent);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px}
.chart-canvas{height:200px;position:relative}

/* LEADERBOARD */
.lb-item{display:grid;grid-template-columns:30px 1fr auto;gap:10px;align-items:center;padding:11px 12px;background:var(--card);border:1px solid var(--border);margin-bottom:7px;box-shadow:var(--shadow)}
.lb-rank{font-family:var(--font-d);font-size:1.4rem;color:var(--muted);text-align:center}
.lb-rank.g{color:#f0a500}.lb-rank.s{color:#9ca3af}.lb-rank.b{color:#b87333}
.lb-name{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--text);letter-spacing:1px}
.lb-sub{font-size:.6rem;color:var(--muted);margin-top:2px}
.lb-val{font-family:var(--font-d);font-size:1.3rem;color:var(--accent);text-align:right}
.lb-vsub{font-family:var(--font-m);font-size:.46rem;color:var(--muted);text-align:right;margin-top:2px}
.bar-mini{height:4px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden}
.bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 1s}
.target-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:5px}
.target-fill{height:100%;border-radius:3px;transition:width 1s}
.target-fill.low{background:var(--red)}.target-fill.mid{background:var(--accent2)}.target-fill.high{background:#22c55e}

/* PERFORMANCE */
.perf-card{background:var(--card);border:1px solid var(--border);padding:14px;margin-bottom:10px;box-shadow:var(--shadow)}
.perf-name{font-family:var(--font-d);font-size:1.05rem;color:var(--text);letter-spacing:2px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.score-badge{font-family:var(--font-d);font-size:1rem;padding:2px 9px;letter-spacing:2px}
.score-a{background:#22c55e;color:#fff}.score-b{background:var(--accent2);color:#fff}.score-c{background:var(--red);color:#fff}
.perf-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.pstat{text-align:center;padding:9px 6px;background:var(--surface);border:1px solid var(--border)}
.pstat .pl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.pstat .pv{font-family:var(--font-d);font-size:1.15rem;color:var(--accent)}

/* ADMIN */
.apinbox{text-align:center;padding:40px 16px}
.apintitle{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:3px;margin-bottom:7px}
.apinsub{font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;margin-bottom:18px;line-height:1.8}
.pininput{width:180px;text-align:center;font-family:var(--font-m);font-size:1.5rem;letter-spacing:8px;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:13px;outline:none;margin:0 auto 14px;display:block}
.pininput:focus{border-color:var(--accent)}
.atabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--border);overflow-x:auto}
.atab{font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:8px 10px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase;white-space:nowrap;margin-bottom:-2px}
.atab.active{color:var(--accent);border-bottom-color:var(--accent)}
.asect{display:none}.asect.active{display:block}
.aitem{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--card);border:1px solid var(--border);margin-bottom:6px;transition:background .3s}
.aitem-name{font-family:var(--font-m);font-size:.68rem;color:var(--text);font-weight:700;letter-spacing:1px}
.aitem-sub{font-size:.62rem;color:var(--muted);margin-top:2px}
.abtn-row{display:flex;gap:5px;flex-shrink:0}
.adel{background:none;border:1px solid var(--border);cursor:pointer;font-size:.72rem;color:var(--muted);padding:4px 8px;transition:all .2s}
.adel:hover{color:var(--red);border-color:var(--red)}
.aedit{background:none;border:1px solid var(--border);cursor:pointer;font-size:.72rem;color:var(--muted);padding:4px 8px;transition:all .2s}
.aedit:hover{color:var(--accent);border-color:var(--accent)}
.addrow{display:flex;gap:7px;align-items:end;margin-top:10px}
.addrow .field{flex:1;margin:0}
.irow{display:flex;gap:7px;align-items:end}
.irow .field{flex:1;margin:0}
.conn-badge{display:inline-flex;align-items:center;gap:5px;background:var(--alight);border:1px solid var(--accent);padding:4px 10px;font-family:var(--font-m);font-size:.5rem;color:var(--accent);letter-spacing:1px;margin-bottom:8px}
.dg{width:7px;height:7px;border-radius:50%;background:#22c55e}
.urlbox{background:var(--bg);border:1px solid var(--border);padding:8px 10px;font-family:var(--font-m);font-size:.5rem;color:var(--muted);word-break:break-all;line-height:1.6;margin-bottom:7px}
.steps{counter-reset:s}
.step{counter-increment:s;padding:8px 10px 8px 32px;border-left:2px solid var(--border);margin-bottom:7px;position:relative;font-size:.74rem;color:var(--text);line-height:1.6}
.step::before{content:counter(s);position:absolute;left:-12px;top:6px;width:22px;height:22px;background:var(--accent);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-m);font-size:.56rem;font-weight:700}
.step code{background:var(--alight);padding:1px 5px;font-family:var(--font-m);font-size:.64rem;color:var(--accent)}

/* SESSION TIMEOUT OVERLAY */
.timeout-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.timeout-overlay.open{display:flex}
.timeout-box{background:var(--card);border:3px solid var(--accent2);padding:30px 24px;text-align:center;max-width:320px;width:100%;animation:fadeUp .3s ease}
.timeout-title{font-family:var(--font-d);font-size:2rem;color:var(--accent2);letter-spacing:3px;margin-bottom:8px}
.timeout-sub{font-family:var(--font-m);font-size:.6rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:18px}
.timeout-count{font-family:var(--font-d);font-size:3rem;color:var(--red);letter-spacing:3px;margin-bottom:16px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-top:3px solid var(--accent);padding:22px;width:100%;max-width:380px;animation:fadeUp .3s ease;max-height:90vh;overflow-y:auto}
.modal-title{font-family:var(--font-d);font-size:1.4rem;color:var(--accent);letter-spacing:2px;margin-bottom:14px}
.modal-actions{display:flex;gap:8px;margin-top:14px}
.modal-actions button{flex:1}

/* SHIFT CLOSE SUMMARY MODAL */
.shift-summary-modal .modal{border-top-color:var(--red)}
.shift-sum-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-family:var(--font-m);font-size:.62rem}
.shift-sum-row:last-child{border-bottom:none}
.shift-sum-total{font-family:var(--font-d);font-size:1.6rem;color:var(--accent);margin-top:10px;text-align:center}

/* MISC */
.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:9px 16px;font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;z-index:999;opacity:0;transition:opacity .3s;max-width:90vw;text-align:center}
.toast.show{opacity:1}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:30px auto}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.empty{text-align:center;padding:30px 14px;font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:2}
.divline{height:1px;background:var(--border);margin:12px 0}
.pill{display:inline-block;background:var(--alight);color:var(--accent);font-family:var(--font-m);font-size:.44rem;padding:2px 6px;letter-spacing:1px;margin-left:5px;vertical-align:middle}
.tag-active{display:inline-flex;align-items:center;gap:4px;background:var(--accent);color:#fff;padding:3px 8px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;margin:0 3px 3px 0}
.tag-active span{cursor:pointer;opacity:.8}.tag-active span:hover{opacity:1}
.queue-banner{background:var(--accent2);color:#fff;padding:7px 13px;font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;display:none;align-items:center;justify-content:space-between;cursor:pointer}
.queue-banner.show{display:flex}

/* AUTH SCREENS */
.auth-landing{display:flex;flex-direction:column;gap:14px;margin-top:4px}
.auth-landing-card{background:var(--card);border:2px solid var(--border);padding:20px;cursor:pointer;transition:border-color .2s,transform .1s;position:relative;overflow:hidden}
.auth-landing-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.auth-landing-card.admin-card{border-left:4px solid var(--accent2)}
.auth-landing-card.driver-card{border-left:4px solid var(--accent)}
.auth-landing-card-ico{font-size:2rem;margin-bottom:6px}
.auth-landing-card-title{font-family:var(--font-d);font-size:1.3rem;letter-spacing:3px;margin-bottom:4px}
.auth-landing-card.admin-card .auth-landing-card-title{color:var(--accent2)}
.auth-landing-card.driver-card .auth-landing-card-title{color:var(--accent)}
.auth-landing-card-sub{font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;line-height:1.7}
.auth-landing-card-arrow{position:absolute;top:50%;right:16px;transform:translateY(-50%);font-size:1.4rem;color:var(--border)}
.auth-back-btn{background:none;border:none;font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;cursor:pointer;padding:6px 0;display:flex;align-items:center;gap:5px;margin-bottom:14px}
.auth-back-btn:hover{color:var(--accent)}
.auth-panel-title{font-family:var(--font-d);font-size:1.5rem;letter-spacing:3px;margin-bottom:4px}
.auth-panel-sub{font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;line-height:1.7;margin-bottom:18px}
/* DRIVER PAGES */
.dpage{display:none}
.dpage.active{display:block}
.driver-tab-bar{display:flex;border-bottom:2px solid var(--border);margin-bottom:14px;position:sticky;top:0;background:var(--bg);z-index:10;padding-top:4px}
.driver-tab{flex:1;background:none;border:none;padding:10px 4px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;color:var(--muted);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;margin-bottom:-2px;text-align:center}
.driver-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.perf-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.perf-stat{background:var(--card);border:1px solid var(--border);padding:12px 11px}
.perf-stat-lbl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px;margin-bottom:4px}
.perf-stat-val{font-family:var(--font-d);font-size:1.6rem;color:var(--text);line-height:1}
.perf-stat-sub{font-family:var(--font-m);font-size:.44rem;color:var(--muted);margin-top:3px}
.note-card{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:12px 13px;margin-bottom:8px}
.note-card.reason{border-left-color:var(--red)}
.note-card.strategy{border-left-color:#22c55e}
.note-card-type{font-family:var(--font-m);font-size:.44rem;letter-spacing:1px;margin-bottom:4px}
.note-card-type.strategy{color:#22c55e}
.note-card-type.reason{color:var(--red)}
.note-card-text{font-family:var(--font-b);font-size:.64rem;color:var(--text);line-height:1.5;margin-bottom:4px}
.note-card-meta{font-family:var(--font-m);font-size:.46rem;color:var(--muted)}
.note-type-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.note-type-btn{background:var(--card);border:2px solid var(--border);padding:10px;font-family:var(--font-m);font-size:.52rem;letter-spacing:1px;cursor:pointer;text-align:center;transition:all .2s;color:var(--muted)}
.note-type-btn.selected.strategy{border-color:#22c55e;color:#22c55e;background:rgba(34,197,94,.08)}
.note-type-btn.selected.reason{border-color:var(--red);color:var(--red);background:rgba(229,57,53,.08)}
.week-bar{display:flex;align-items:flex-end;gap:3px;height:60px;margin:10px 0}
.week-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px}
.week-bar-fill{width:100%;background:var(--accent);border-radius:2px 2px 0 0;min-height:2px;transition:height .3s}
.week-bar-lbl{font-family:var(--font-m);font-size:.4rem;color:var(--muted);letter-spacing:.5px}
.auth-invite-header{background:linear-gradient(135deg,var(--accent),#0f5e2a);padding:20px;margin:-22px -0px 20px;text-align:center;border-radius:0}
.auth-invite-sacco{font-family:var(--font-d);font-size:1.6rem;letter-spacing:4px;color:#fff;margin-bottom:3px}
.auth-invite-sub{font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.75);letter-spacing:1.5px}
.auth-invite-from{background:rgba(255,255,255,.15);border-radius:0;padding:8px 12px;margin-top:10px;font-family:var(--font-m);font-size:.52rem;color:#fff;letter-spacing:1px}
.onboard-banner{background:linear-gradient(135deg,var(--accent2),#e08a00);padding:14px 16px;margin-bottom:14px;display:flex;align-items:flex-start;gap:12px}
.onboard-banner-ico{font-size:1.8rem;flex-shrink:0}
.onboard-banner-text{flex:1}
.onboard-banner-title{font-family:var(--font-d);font-size:1.1rem;letter-spacing:2px;color:#fff;margin-bottom:3px}
.onboard-banner-sub{font-family:var(--font-m);font-size:.48rem;color:rgba(255,255,255,.85);letter-spacing:1px;line-height:1.7}
.invite-success-box{background:#e8f5ed;border:2px solid var(--accent);padding:14px;text-align:center;margin-top:10px}
.invite-success-ico{font-size:2rem;margin-bottom:6px}
.invite-success-title{font-family:var(--font-d);font-size:1.1rem;letter-spacing:2px;color:var(--accent);margin-bottom:6px}
.invite-success-email{font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;word-break:break-all;margin-bottom:8px}
.invite-success-note{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;line-height:1.7}
.invite-link-box{background:var(--bg);border:1px dashed var(--border);padding:10px;font-family:var(--font-m);font-size:.44rem;color:var(--muted);word-break:break-all;cursor:pointer;margin-top:8px;letter-spacing:.5px}
.invite-link-box:hover{border-color:var(--accent);color:var(--accent)}
.auth-tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:18px}
.auth-tab{flex:1;background:none;border:none;padding:11px 6px;font-family:var(--font-d);font-size:.9rem;letter-spacing:2px;color:var(--muted);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;margin-bottom:-2px}
.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.auth-tab.admin-tab.active{color:var(--accent2);border-bottom-color:var(--accent2)}
.auth-setup-header{background:linear-gradient(135deg,var(--accent),#0d5a2a);padding:18px 20px;margin:-22px -20px 20px;text-align:center}
.auth-setup-header-title{font-family:var(--font-d);font-size:1.4rem;letter-spacing:3px;color:#fff;margin-bottom:4px}
.auth-setup-header-sub{font-family:var(--font-m);font-size:.46rem;color:rgba(255,255,255,.75);letter-spacing:1.5px;line-height:1.7}
.auth-step{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px}
.auth-step-num{width:20px;height:20px;border-radius:50%;background:var(--accent);color:#fff;font-size:.5rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:var(--font-d)}
.auth-overlay{position:fixed;inset:0;background:var(--bg);z-index:600;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.auth-overlay.hidden{display:none}
.auth-box{width:100%;max-width:400px}
.auth-logo{text-align:center;margin-bottom:28px}
.auth-logo-ico{font-size:3rem;margin-bottom:6px}
.auth-logo-name{font-family:var(--font-d);font-size:2.2rem;letter-spacing:4px;color:var(--accent);line-height:1}
.auth-logo-sub{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:2px;margin-top:4px}
.auth-card{background:var(--card);border:2px solid var(--border);padding:22px 20px}
.auth-card-title{font-family:var(--font-d);font-size:1.4rem;letter-spacing:3px;color:var(--accent);margin-bottom:4px}
.auth-card-sub{font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:20px;line-height:1.7}
.auth-field{margin-bottom:14px}
.auth-field label{display:block;font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px;text-transform:uppercase}
.auth-input{width:100%;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:12px 13px;font-family:var(--font-m);font-size:.9rem;outline:none;transition:border-color .2s;letter-spacing:1px}
.auth-input:focus{border-color:var(--accent)}
.auth-input.error{border-color:var(--red)}
.auth-input-wrap{position:relative}
.auth-eye{position:absolute;right:11px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;padding:4px}
.auth-btn{width:100%;background:var(--accent);border:none;color:#fff;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;padding:14px;cursor:pointer;transition:opacity .2s;margin-top:6px}
.auth-btn:hover{opacity:.88}
.auth-btn:disabled{opacity:.4;cursor:not-allowed}
.auth-btn.secondary{background:transparent;border:2px solid var(--border);color:var(--muted);font-size:.7rem;letter-spacing:2px;margin-top:8px;padding:11px}
.auth-btn.secondary:hover{border-color:var(--accent);color:var(--accent)}
.auth-error{background:var(--rlight);border:1px solid var(--red);color:var(--red);font-family:var(--font-m);font-size:.52rem;padding:10px 12px;letter-spacing:1px;margin-bottom:12px;display:none;white-space:pre-wrap;line-height:1.7}
.auth-error.show{display:block}
.auth-success{background:#e8f5ed;border:1px solid var(--accent);color:var(--accent);font-family:var(--font-m);font-size:.54rem;padding:10px 12px;letter-spacing:1px;margin-bottom:12px;display:none}
.auth-success.show{display:block}
.auth-divider{display:flex;align-items:center;gap:10px;margin:14px 0}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-divider-txt{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px}
.auth-link{font-family:var(--font-m);font-size:.52rem;color:var(--accent);cursor:pointer;text-decoration:underline;background:none;border:none;padding:0;display:block;text-align:center;margin-top:12px;letter-spacing:1px}
.auth-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.driver-reg-card{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:11px 13px;margin-bottom:8px}
.driver-reg-name{font-family:var(--font-m);font-size:.65rem;font-weight:700;color:var(--text)}
.driver-reg-email{font-size:.54rem;color:var(--muted);margin-top:2px}
.driver-reg-status{display:inline-block;font-family:var(--font-m);font-size:.44rem;letter-spacing:1px;padding:2px 7px;margin-top:4px}
.driver-reg-status.active{background:rgba(34,197,94,.12);color:#22c55e}
.driver-reg-status.pending{background:rgba(240,165,0,.12);color:#f59e0b}

/* FLEET STATUS BOARD */
.fleet-board{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.fleet-card{background:var(--card);border:2px solid var(--border);padding:10px 11px;position:relative;overflow:hidden;transition:border-color .3s}
.fleet-card.status-active{border-color:#22c55e}
.fleet-card.status-arrived{border-color:#f59e0b}
.fleet-card.status-idle{border-color:var(--border);opacity:.8}
.fleet-card.status-offline{border-color:var(--border);opacity:.45}
.fleet-card-plate{font-family:var(--font-d);font-size:1.05rem;letter-spacing:3px;color:var(--text);margin-bottom:2px}
.fleet-card-driver{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
.fleet-card-status{display:inline-flex;align-items:center;gap:4px;font-family:var(--font-m);font-size:.44rem;letter-spacing:1px;padding:2px 7px;margin-bottom:5px}
.fleet-card-status.active{background:rgba(34,197,94,.15);color:#22c55e}
.fleet-card-status.arrived{background:rgba(245,158,11,.15);color:#f59e0b}
.fleet-card-status.idle{background:rgba(100,100,100,.12);color:var(--muted)}
.fleet-card-route{font-family:var(--font-b);font-size:.58rem;color:var(--text);line-height:1.4}
.fleet-card-route .arrow{color:var(--accent);margin:0 3px}
.fleet-card-time{font-size:.46rem;color:var(--muted);margin-top:3px}
.fleet-card-trips{position:absolute;top:7px;right:8px;font-family:var(--font-d);font-size:1.1rem;color:var(--border)}
.fleet-dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}
.fleet-dot.active{background:#22c55e;animation:live-pulse 1.5s infinite}
.fleet-dot.arrived{background:#f59e0b}
.fleet-dot.idle{background:var(--muted)}

/* ACTIVE TRIP RECOVERY OVERLAY */
.trip-recovery-overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.trip-recovery-overlay.show{display:flex;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.trip-recovery-box{background:var(--card);border:3px solid #f59e0b;width:100%;max-width:420px;overflow:hidden}
.trip-recovery-alert{background:#f59e0b;padding:14px 16px;display:flex;align-items:center;gap:10px}
.trip-recovery-alert-ico{font-size:2rem;flex-shrink:0}
.trip-recovery-alert-txt{font-family:var(--font-d);font-size:1.1rem;color:#1a1a1a;letter-spacing:2px;line-height:1.3}
.trip-recovery-body{padding:16px}
.trip-recovery-info{background:var(--surface);border:1px solid var(--border);padding:11px 13px;margin-bottom:12px}
.trip-recovery-row{display:flex;justify-content:space-between;font-size:.6rem;padding:4px 0;border-bottom:1px solid var(--border)}
.trip-recovery-row:last-child{border-bottom:none}
.trip-recovery-row span:first-child{font-family:var(--font-m);color:var(--muted);letter-spacing:1px}
.trip-recovery-row span:last-child{font-family:var(--font-m);color:var(--text);font-weight:700}
.trip-recovery-sub{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:14px;text-align:center}

/* REPORT VIEWER */
.rview-overlay{position:fixed;inset:0;background:var(--bg);z-index:300;display:none;flex-direction:column;overflow:hidden}
.rview-overlay.open{display:flex;animation:fadeUp .25s ease}
.rview-header{background:var(--card);border-bottom:2px solid var(--border);padding:11px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.rview-back{background:none;border:1px solid var(--border);color:var(--text);font-family:var(--font-m);font-size:.52rem;letter-spacing:1px;padding:6px 11px;cursor:pointer}
.rview-title{flex:1;font-family:var(--font-d);font-size:1rem;letter-spacing:2px;color:var(--accent)}
.rview-export-btn{background:var(--accent);border:none;color:#fff;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:5px}
.rview-body{flex:1;overflow-y:auto;padding:14px;padding-bottom:80px}
.rview-summary{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.rview-stat{background:var(--card);border:1px solid var(--border);padding:12px;text-align:center}
.rview-stat .rs-label{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:4px}
.rview-stat .rs-val{font-family:var(--font-d);font-size:1.5rem;color:var(--accent)}
.rview-stat.wide{grid-column:1/-1}
.rview-section-title{font-family:var(--font-m);font-size:.52rem;letter-spacing:2px;color:var(--muted);border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:8px;margin-top:14px}
.rview-trip{background:var(--card);border:1px solid var(--border);padding:9px 12px;margin-bottom:6px}
.rview-trip-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.rview-route{font-family:var(--font-m);font-size:.62rem;color:var(--accent);font-weight:700}
.rview-amt{font-family:var(--font-d);font-size:.9rem;color:var(--text)}
.rview-trip-bot{display:flex;justify-content:space-between;font-size:.56rem;color:var(--muted)}
.rview-car-row{background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:6px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
.rview-car-badge{font-family:var(--font-m);font-size:.6rem;color:var(--accent);background:rgba(26,122,60,.1);padding:4px 8px;letter-spacing:1px}
.rview-bar-wrap{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:4px}
.rview-bar{height:100%;background:var(--accent);border-radius:3px;transition:width .8s}
.rview-export-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.rview-btn-pdf{background:#c0392b;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:11px 6px;cursor:pointer;transition:opacity .2s}
.rview-btn-xls{background:#217346;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:11px 6px;cursor:pointer;transition:opacity .2s}
.rview-btn-wa{background:#25D366;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:11px 6px;cursor:pointer;transition:opacity .2s}

/* ODOMETER / FUEL */
.odom-wrap{background:var(--bg);border:2px solid var(--border);padding:14px;margin-bottom:10px;transition:border-color .2s}
.odom-wrap.active{border-color:var(--accent)}
.odom-title{font-family:var(--font-m);font-size:.52rem;letter-spacing:1.5px;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:7px}
.odom-title span{flex:1}
.odom-notwork{display:inline-flex;align-items:center;gap:6px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:4px 10px;border:1px solid var(--border);cursor:pointer;background:var(--bg);color:var(--muted);transition:all .2s;user-select:none}
.odom-notwork.on{border-color:var(--red);color:var(--red);background:rgba(229,57,53,.06)}
.odom-notwork .odom-check{width:12px;height:12px;border:1.5px solid currentColor;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:.5rem}
.odom-input-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.odom-input{width:100%;background:var(--bg);border:2px solid var(--accent);color:var(--text);padding:10px 12px 10px 44px;font-family:var(--font-m);font-size:1.05rem;font-weight:700;letter-spacing:1px;outline:none;transition:border-color .2s}
.odom-input::-webkit-inner-spin-button{-webkit-appearance:none}
.odom-pfx{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;pointer-events:none}
.odom-unit{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;white-space:nowrap}
.odom-dist-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(26,122,60,.1);border:1px solid var(--accent);padding:5px 10px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-top:8px}
.odom-skip-badge{background:rgba(229,57,53,.08);border:1px solid var(--red);padding:9px 12px;font-family:var(--font-m);font-size:.52rem;color:var(--red);letter-spacing:1px;line-height:1.7;margin-bottom:0}
.odom-reason-label{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px;margin-top:10px}
.odom-reason{width:100%;background:var(--bg);border:1.5px solid var(--red);color:var(--text);padding:8px 10px;font-family:var(--font-b);font-size:.78rem;outline:none;resize:none;transition:border-color .2s}
.odom-reason:focus{border-color:var(--accent)}
.fuel-entry-toggle{display:flex;align-items:center;justify-content:space-between;padding:13px 14px;border:2px solid var(--border);cursor:pointer;user-select:none;transition:all .2s;margin-bottom:0}
.fuel-entry-toggle.on{border-color:#f59e0b;background:rgba(245,158,11,.06)}
.fuel-toggle-label{font-family:var(--font-m);font-size:.58rem;letter-spacing:1.5px;color:var(--muted)}
.fuel-toggle-label.on{color:#f59e0b}
.fuel-toggle-pill{width:42px;height:24px;border-radius:12px;background:var(--border);position:relative;transition:background .2s;flex-shrink:0}
.fuel-toggle-pill.on{background:#f59e0b}
.fuel-toggle-pill::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.fuel-toggle-pill.on::after{left:21px}
.fuel-fields{border:2px solid #f59e0b;border-top:none;padding:13px;background:rgba(245,158,11,.03);margin-bottom:10px}
.fuel-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:10px}
.fuel-field-label{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px;text-transform:uppercase}
.fuel-input{width:100%;background:var(--bg);border:2px solid #f59e0b;color:var(--text);padding:10px 11px;font-family:var(--font-m);font-size:.9rem;font-weight:700;outline:none;letter-spacing:1px;transition:border-color .2s}
.fuel-input::-webkit-inner-spin-button{-webkit-appearance:none}
.fuel-input:focus{border-color:var(--accent)}
.fuel-input.full{width:100%;box-sizing:border-box}
.fuel-efficiency-badge{display:flex;align-items:center;gap:8px;padding:10px 12px;background:linear-gradient(135deg,rgba(245,158,11,.12),rgba(26,122,60,.08));border:1px solid #f59e0b;margin-top:9px}
.fuel-eff-ico{font-size:1.5rem}
.fuel-eff-val{font-family:var(--font-d);font-size:1.6rem;color:#f59e0b;letter-spacing:1px}
.fuel-eff-unit{font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px}
.fuel-eff-sub{font-size:.52rem;color:var(--muted);margin-top:2px}
.feff-good{color:#22c55e}.feff-avg{color:#f59e0b}.feff-poor{color:var(--red)}

.fuel-stat{background:var(--card);border:1px solid var(--border);padding:11px 12px;margin-bottom:7px}
.fuel-stat-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.fuel-stat-car{font-family:var(--font-m);font-size:.6rem;color:var(--accent);letter-spacing:1px}
.fuel-stat-km{font-family:var(--font-d);font-size:1.4rem;color:var(--text)}
.fuel-stat-sub{font-size:.6rem;color:var(--muted)}
.fuel-warn{background:rgba(229,57,53,.08);border-left:3px solid var(--red);padding:7px 10px;font-size:.6rem;color:var(--red);font-family:var(--font-m);letter-spacing:1px;margin-bottom:6px}

/* PWA INSTALL BANNER */
.pwa-banner{position:fixed;bottom:74px;left:50%;transform:translateX(-50%);width:calc(100% - 24px);max-width:456px;background:var(--accent);color:#fff;padding:11px 14px;display:none;align-items:center;gap:10px;z-index:150;box-shadow:var(--shlg);animation:fadeUp .4s ease}
.pwa-banner.show{display:flex}
.pwa-banner-text{flex:1;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;line-height:1.7}
.pwa-banner-text strong{display:block;font-size:.62rem;margin-bottom:2px}
.pwa-install-btn{background:#fff;color:var(--accent);border:none;font-family:var(--font-d);font-size:.8rem;letter-spacing:2px;padding:8px 14px;cursor:pointer;flex-shrink:0;transition:background .2s}
.pwa-install-btn:hover{background:rgba(255,255,255,.85)}
.pwa-dismiss{background:none;border:none;color:rgba(255,255,255,.6);font-size:1rem;cursor:pointer;padding:4px;flex-shrink:0}

/* STATION SEARCH */
.stsearch{width:100%;background:var(--bg);border:1px solid var(--border);border-bottom:2px solid var(--accent);color:var(--text);padding:9px 11px 9px 34px;font-family:var(--font-m);font-size:.72rem;outline:none;letter-spacing:1px;transition:border-color .2s;margin-bottom:9px}
.stsearch::placeholder{color:var(--muted)}
.stsearch-wrap{position:relative}
.stsearch-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:.85rem;pointer-events:none;opacity:.5}
.stsearch-clr{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:.75rem;cursor:pointer;color:var(--muted);background:none;border:none;padding:0;line-height:1}
.st-none{font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;text-align:center;padding:14px;grid-column:1/-1}

/* LIVE TAB */
.live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#22c55e;margin-right:5px;animation:live-pulse 1.4s infinite}
@keyframes live-pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(1.3)}}
.live-badge{background:#22c55e;color:#fff;font-family:var(--font-m);font-size:.44rem;padding:2px 6px;letter-spacing:1px;margin-left:5px;vertical-align:middle;border-radius:2px}
.live-item{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--accent);padding:10px 12px;margin-bottom:7px;animation:fadeUp .35s ease;transition:background .3s}
.live-item.new{border-left-color:#22c55e;background:var(--alight)}
.live-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.live-route{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.live-amt{font-family:var(--font-m);font-size:.61rem;color:#22c55e;font-weight:700}
.live-bot{display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted)}
.live-time{font-family:var(--font-m);font-size:.48rem;color:var(--muted)}
.live-car{font-family:var(--font-m);font-size:.5rem;background:var(--surface);padding:2px 6px;color:var(--accent)}
.live-empty{text-align:center;padding:40px 14px;font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:2.2}
.live-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:12px}
.live-stat{background:var(--card);border:1px solid var(--border);padding:10px;text-align:center}
.live-stat .lsl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px}
.live-stat .lsv{font-family:var(--font-d);font-size:1.4rem;color:var(--accent)}
.listener-status{display:flex;align-items:center;gap:7px;padding:7px 10px;font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;margin-bottom:10px;border:1px solid var(--border)}
.listener-status.on{color:#22c55e;border-color:#22c55e;background:rgba(34,197,94,.08)}
.listener-status.off{color:var(--muted);border-color:var(--border)}

/* DEV ACCESS OVERLAY */
.dev-pin-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:250;display:none;align-items:center;justify-content:center;padding:20px}
.dev-pin-overlay.open{display:flex;animation:fadeUp .25s ease}
.dev-pin-box{background:var(--card);border:3px solid var(--red);padding:30px 24px;text-align:center;max-width:320px;width:100%;animation:fadeUp .3s ease}
.dev-pin-title{font-family:var(--font-d);font-size:1.8rem;color:var(--red);letter-spacing:3px;margin-bottom:5px}
.dev-pin-sub{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:16px}

/* TARGET ALERT OVERLAY */
.target-overlay{position:fixed;inset:0;background:rgba(26,122,60,.97);z-index:400;display:none;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center}
.target-overlay.open{display:flex;animation:fadeUp .4s ease}
.target-trophy{font-size:4rem;margin-bottom:10px;animation:bounce 1s infinite}
.target-hit{font-family:var(--font-d);font-size:2.8rem;color:#fff;letter-spacing:4px;margin-bottom:6px}
.target-name{font-family:var(--font-m);font-size:.7rem;color:rgba(255,255,255,.8);letter-spacing:2px;margin-bottom:20px}
.target-amount{font-family:var(--font-d);font-size:3.5rem;color:var(--accent2);letter-spacing:3px;margin-bottom:6px}
.target-label{font-family:var(--font-m);font-size:.58rem;color:rgba(255,255,255,.6);letter-spacing:2px;margin-bottom:28px}
.target-close{background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.4);color:#fff;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;padding:13px 32px;cursor:pointer;transition:background .2s}
.target-close:hover{background:rgba(255,255,255,.3)}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

@media print{
  .bnav,.hico,header .hright,.exprow,.fchips,.rtabs,.queue-banner,.timeout-overlay,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important;max-width:100%!important}
  main{padding:0!important}
  .page{display:block!important}
  #page-reports .rsect:not(#rsect-overview){display:none!important}
  #rsect-live{display:none!important}
}
</style>
</head>
<body>

<header>
  <div class="hrow">
    <div class="logo" id="headerLogo">FESTUS<span> SACCO</span></div>
    <div class="hright">
      <span class="session-bar" id="sessionBar"></span>
      <span class="offline-badge" id="offlineBadge">OFFLINE</span>
      <button class="hico" onclick="toggleDark()" id="darkBtn" title="Toggle dark mode"></button>
      <div class="dbadge" id="driverBadge" onclick="isAdminUser?null:goSetup()"> LOGIN </div>
    </div>
  </div>
  <div class="hsub">
    <span id="headerSubText">// FLEET MANAGEMENT</span>
    <span class="sync-timer" id="syncTimer"></span>
  </div>
</header>

<!-- 
     AUTH OVERLAY   Landing / Create / Login / Forgot
 -->
<div class="auth-overlay hidden" id="authOverlay">
  <div class="auth-box">

    <!-- LOGO -->
    <div class="auth-logo">
      <div class="auth-logo-ico"></div>
      <div class="auth-logo-name" id="authLogoName">FESTUS SACCO</div>
      <div class="auth-logo-sub">FLEET MANAGEMENT SYSTEM</div>
    </div>

    <!--  PANEL: LANDING  -->
    <div id="authPanelLanding" style="display:none">
      <div class="auth-landing">
        <div class="auth-landing-card admin-card" onclick="switchToPanel('create')">
          <div class="auth-landing-card-ico"></div>
          <div class="auth-landing-card-title">CREATE ACCOUNT</div>
          <div class="auth-landing-card-sub">FIRST TIME? SET UP YOUR SACCO OWNER ACCOUNT<br>YOU'LL THEN REGISTER DRIVERS &amp; MANAGE YOUR FLEET</div>
          <div class="auth-landing-card-arrow"></div>
        </div>
        <div class="auth-landing-card driver-card" onclick="switchToPanel('login')">
          <div class="auth-landing-card-ico"></div>
          <div class="auth-landing-card-title">LOG IN</div>
          <div class="auth-landing-card-sub">ALREADY HAVE AN ACCOUNT?<br>ADMIN, MANAGERS AND DRIVERS ALL LOGIN HERE</div>
          <div class="auth-landing-card-arrow"></div>
        </div>
      </div>
    </div>

    <!--  PANEL: CREATE ADMIN ACCOUNT  -->
    <div id="authPanelCreate" style="display:none">
      <button class="auth-back-btn" onclick="switchToPanel('landing')"> BACK</button>
      <div class="auth-panel-title" style="color:var(--accent2)">SACCO SETUP</div>
      <div class="auth-panel-sub">CREATE YOUR OWNER ACCOUNT. YOU'LL THEN<br>REGISTER DRIVERS FROM YOUR DASHBOARD.</div>
      <div class="auth-error" id="authSetupError"></div>
      <div class="auth-field">
        <label>Your Full Name</label>
        <input class="auth-input" type="text" id="setupName" placeholder="e.g. FESTUS MWANGI"
          style="text-transform:uppercase"
          onkeydown="if(event.key==='Enter')document.getElementById('setupSaccoName').focus()">
      </div>
      <div class="auth-field">
        <label>Sacco / Company Name</label>
        <input class="auth-input" type="text" id="setupSaccoName" placeholder="e.g. FESTUS SACCO"
          style="text-transform:uppercase"
          onkeydown="if(event.key==='Enter')document.getElementById('setupEmail').focus()">
      </div>
      <div class="auth-field">
        <label>Your Email Address</label>
        <input class="auth-input" type="email" id="setupEmail" placeholder="owner@gmail.com"
          onkeydown="if(event.key==='Enter')document.getElementById('setupPass').focus()">
      </div>
      <div class="auth-field">
        <label>Create Password <span style="color:var(--muted);font-size:.44rem">(min 6 characters)</span></label>
        <div class="auth-input-wrap">
          <input class="auth-input" type="password" id="setupPass" placeholder=""
            onkeydown="if(event.key==='Enter')authSetupAdmin()">
          <button class="auth-eye" onclick="toggleSetupEye()" id="setupEyeBtn"></button>
        </div>
      </div>
      <button class="auth-btn" id="setupBtn" onclick="authSetupAdmin()"
        style="background:var(--accent2)">
         CREATE OWNER ACCOUNT
      </button>
    </div>

    <!--  PANEL: LOGIN  -->
    <div id="authPanelLogin" style="display:none">
      <button class="auth-back-btn" onclick="switchToPanel('landing')"> BACK</button>
      <div class="auth-panel-title">LOG IN</div>
      <div class="auth-panel-sub">WORKS FOR ADMINS AND DRIVERS.<br>YOUR DASHBOARD OPENS AUTOMATICALLY.</div>
      <div class="auth-error" id="authLoginError"></div>
      <div class="auth-field">
        <label>Email Address</label>
        <input class="auth-input" type="email" id="authEmail" placeholder="your@email.com"
          autocomplete="email"
          onkeydown="if(event.key==='Enter')document.getElementById('authPass').focus()">
      </div>
      <div class="auth-field">
        <label>Password</label>
        <div class="auth-input-wrap">
          <input class="auth-input" type="password" id="authPass" placeholder=""
            autocomplete="current-password"
            onkeydown="if(event.key==='Enter')authLogin()">
          <button class="auth-eye" onclick="toggleAuthEye()" id="authEyeBtn"></button>
        </div>
      </div>
      <button class="auth-btn" id="authLoginBtn" onclick="authLogin()">LOG IN</button>
      <button class="auth-link" onclick="switchToPanel('forgot')">Forgot your password?</button>
    </div>

    <!--  PANEL: FORGOT PASSWORD  -->
    <div id="authPanelForgot" style="display:none">
      <button class="auth-back-btn" onclick="switchToPanel('login')"> BACK TO LOGIN</button>
      <div class="auth-panel-title">RESET PASSWORD</div>
      <div class="auth-panel-sub">ENTER YOUR EMAIL  WE'LL SEND A RESET LINK</div>
      <div class="auth-error" id="authForgotError"></div>
      <div class="auth-success" id="authForgotSuccess"></div>
      <div class="auth-field">
        <label>Email Address</label>
        <input class="auth-input" type="email" id="authForgotEmail" placeholder="your@email.com"
          onkeydown="if(event.key==='Enter')authForgotPassword()">
      </div>
      <button class="auth-btn" id="authForgotBtn" onclick="authForgotPassword()">SEND RESET LINK</button>
    </div>

    <!--  PANEL: DRIVER INVITATION (magic link acceptance)  -->
    <div id="authPanelInvite" style="display:none">
      <div id="inviteLoadingState">
        <div style="text-align:center;padding:28px 0">
          <div style="font-size:2rem;margin-bottom:10px"></div>
          <div style="font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1.5px">VERIFYING YOUR INVITATION...</div>
        </div>
      </div>
      <div id="inviteFormState" style="display:none">
        <div class="auth-invite-header">
          <div style="font-size:2rem;margin-bottom:6px"></div>
          <div class="auth-invite-sacco" id="inviteSaccoName">FESTUS SACCO</div>
          <div class="auth-invite-sub">YOU HAVE BEEN INVITED TO JOIN THE FLEET</div>
          <div class="auth-invite-from" id="inviteDriverNameBadge">WELCOME!</div>
        </div>
        <div class="auth-error" id="authInviteError"></div>
        <div class="auth-field">
          <label>Confirm Your Email Address</label>
          <input class="auth-input" type="email" id="inviteEmail" placeholder="Enter the email that received this invite"
            autocomplete="email"
            onkeydown="if(event.key==='Enter')document.getElementById('inviteNewPass').focus()">
        </div>
        <div class="auth-field">
          <label>Create Your Password <span style="color:var(--muted);font-size:.44rem">(min 6 characters)</span></label>
          <div class="auth-input-wrap">
            <input class="auth-input" type="password" id="inviteNewPass" placeholder="Choose a secure password"
              onkeydown="if(event.key==='Enter')acceptInvitation()">
            <button class="auth-eye" id="inviteEyeBtn" onclick="toggleInviteEye()"></button>
          </div>
        </div>
        <button class="auth-btn" id="inviteAcceptBtn" onclick="acceptInvitation()"
          style="background:var(--accent)">
           ACCEPT INVITATION &amp; LOG IN
        </button>
        <div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);text-align:center;margin-top:10px;letter-spacing:1px">
          YOUR ACCOUNT WILL BE CREATED AUTOMATICALLY
        </div>
        <div style="text-align:center;margin-top:12px">
          <button class="auth-link" style="font-size:.46rem" onclick="switchToPanel('login')">
            Already have an account? Log in 
          </button>
        </div>
      </div>
      <div id="inviteErrorState" style="display:none">
        <div style="text-align:center;padding:20px 0">
          <div style="font-size:2rem;margin-bottom:10px"></div>
          <div style="font-family:var(--font-d);font-size:1.1rem;letter-spacing:2px;color:var(--red);margin-bottom:8px">INVITATION EXPIRED</div>
          <div style="font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;line-height:1.8">This invite link has expired or already been used.<br>Ask your admin to send a new invitation.</div>
          <button class="auth-btn secondary" style="margin-top:16px" onclick="switchToPanel('login')">GO TO LOGIN INSTEAD</button>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ACTIVE TRIP RECOVERY OVERLAY -->
<div class="trip-recovery-overlay" id="tripRecoveryOverlay">
  <div class="trip-recovery-box">
    <div class="trip-recovery-alert">
      <div class="trip-recovery-alert-ico"></div>
      <div class="trip-recovery-alert-txt">ACTIVE TRIP<br>DETECTED</div>
    </div>
    <div class="trip-recovery-body">
      <div class="trip-recovery-info" id="tripRecoveryInfo"></div>
      <div class="trip-recovery-sub">
        YOU REFRESHED WHILE A TRIP WAS IN PROGRESS.<br>
        YOUR TRIP HAS BEEN RESTORED  PLEASE END IT BEFORE REFRESHING.
      </div>
      <button class="bb barrive" style="margin-bottom:8px" onclick="resumeActiveTrip()">
         CONTINUE TRIP
      </button>
      <button class="bout" style="margin:0;border-color:var(--red);color:var(--red)"
        onclick="abandonTripAndReset()">
         ABANDON TRIP &amp; LOGOUT
      </button>
    </div>
  </div>
</div>

<!-- PWA INSTALL BANNER -->
<div class="pwa-banner" id="pwaBanner">
  <div style="font-size:1.6rem;flex-shrink:0"></div>
  <div class="pwa-banner-text">
    <strong>INSTALL FESTUS SACCO</strong>
    ADD TO HOME SCREEN FOR FULL APP EXPERIENCE
  </div>
  <button class="pwa-install-btn" id="pwaInstallBtn">INSTALL</button>
  <button class="pwa-dismiss" onclick="dismissPwaBanner()" title="Dismiss"></button>
</div>

<div class="queue-banner" id="queueBanner" onclick="flushQueue()">
  <span id="queueMsg"> TRIPS QUEUED OFFLINE  TAP TO SYNC</span>
  <span></span>
</div>

<main>
  <div id="page-log" class="page active"></div>
  <div id="page-reports" class="page"></div>
  <div id="page-admin" class="page"></div>
  <div id="page-performance" class="page"></div>
  <div id="page-notes" class="page"></div>
</main>

<!-- ADMIN NAV (shown only for admin users) -->
<nav class="bnav" id="navAdmin" style="display:none">
  <button class="nbtn" id="nav-admin" onclick="switchPage('admin')">
    <span class="ni"></span><span class="nl">DASHBOARD</span>
  </button>
  <button class="nbtn" id="nav-reports" onclick="switchPage('reports')">
    <span class="ni"></span><span class="nl">REPORTS</span>
  </button>
  <button class="nbtn" onclick="adminLogoutQuick()">
    <span class="ni"></span><span class="nl">LOG OUT</span>
  </button>
</nav>

<!-- DRIVER NAV (shown only for driver users) -->
<nav class="bnav" id="navDriver" style="display:none">
  <button class="nbtn active" id="nav-log" onclick="switchPage('log')">
    <span class="ni"></span><span class="nl">LOG TRIP</span>
  </button>
  <button class="nbtn" id="nav-performance" onclick="switchPage('performance')">
    <span class="ni"></span><span class="nl">MY STATS</span>
  </button>
  <button class="nbtn" id="nav-notes" onclick="switchPage('notes')">
    <span class="ni"></span><span class="nl">MY NOTES</span>
  </button>
</nav>

<!-- SESSION TIMEOUT OVERLAY -->
<div class="timeout-overlay" id="timeoutOverlay">
  <div class="timeout-box">
    <div class="timeout-title"> STILL THERE?</div>
    <div class="timeout-sub">YOU'LL BE LOGGED OUT IN</div>
    <div class="timeout-count" id="timeoutCount">60</div>
    <div class="timeout-sub" style="margin-bottom:16px">SECONDS DUE TO INACTIVITY</div>
    <button class="bb bstart" style="margin:0" onclick="resetSessionTimer()"> I'M STILL HERE</button>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">EDIT TRIP</div>
    <div class="field"><label>Driver</label><input type="text" id="editDriver"></div>
    <div class="field"><label>Car Plate</label><input type="text" id="editCar"></div>
    <div class="field"><label>From Station</label><input type="text" id="editFrom"></div>
    <div class="field"><label>To Station</label><input type="text" id="editTo"></div>
    <div class="field"><label>Amount (KES)</label><input type="number" id="editAmount"></div>
    <div class="field"><label>Date</label><input type="text" id="editDate"></div>
    <div class="modal-actions">
      <button class="bb bstart" style="margin:0" onclick="saveEditTrip()">SAVE</button>
      <button class="bb" style="margin:0;background:var(--border);color:var(--text)" onclick="closeEditModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- SHIFT CLOSE SUMMARY MODAL -->
<div class="modal-overlay shift-summary-modal" id="shiftSummaryModal">
  <div class="modal">
    <div class="modal-title" style="color:var(--red)">CLOSE SHIFT</div>
    <div id="shiftSummaryBody"></div>
    <div class="modal-actions">
      <button class="bb br" style="margin:0" id="shiftCloseConfirmBtn">CLOSE SHIFT</button>
      <button class="bb" style="margin:0;background:var(--border);color:var(--text)" onclick="document.getElementById('shiftSummaryModal').classList.remove('open')">CANCEL</button>
    </div>
  </div>
</div>

<!-- DEV ACCESS OVERLAY -->
<div class="dev-pin-overlay" id="devPinOverlay">
  <div class="dev-pin-box">
    <div class="dev-pin-title"> DEV ACCESS</div>
    <div class="dev-pin-sub">THIS AREA IS RESTRICTED<br>TO AUTHORISED DEVELOPERS ONLY<br><br>ENTER DEVELOPER PIN TO CONTINUE</div>
    <div id="devPinLockMsg"></div>
    <input type="password" class="pininput" id="devPinIn" maxlength="6" placeholder=""
      onkeydown="if(event.key==='Enter')checkDevPin()">
    <button class="bb bend" style="margin-top:10px;margin-bottom:6px" onclick="checkDevPin()">UNLOCK DEV ACCESS</button>
    <button class="bghost" style="width:100%" onclick="closeDevPinOverlay()">CANCEL</button>
  </div>
</div>

<!-- ADMIN PIN RESET OVERLAY -->
<div class="dev-pin-overlay" id="resetPinOverlay">
  <div class="dev-pin-box" style="border-color:var(--accent2)">
    <div style="font-size:2rem;margin-bottom:8px"></div>
    <div class="dev-pin-title" style="color:var(--accent2)">RESET ADMIN PIN</div>
    <div class="dev-pin-sub">ENTER YOUR <strong style="color:var(--text)">DEVELOPER PIN</strong><br>TO VERIFY YOUR IDENTITY,<br>THEN SET A NEW ADMIN PIN</div>
    <div id="resetStepVerify">
      <div id="resetVerifyMsg"></div>
      <input type="password" class="pininput" id="resetDevPinIn" maxlength="6" placeholder="DEV PIN"
        style="border-color:var(--accent2)"
        onkeydown="if(event.key==='Enter')verifyDevForReset()">
      <button class="bb bconfirm" style="margin-top:10px;margin-bottom:6px;max-width:220px;margin-left:auto;margin-right:auto;display:block"
        onclick="verifyDevForReset()">VERIFY IDENTITY</button>
    </div>
    <div id="resetStepNew" style="display:none">
      <div style="font-family:var(--font-m);font-size:.52rem;color:#22c55e;letter-spacing:1px;margin-bottom:12px"> IDENTITY VERIFIED  SET NEW PIN</div>
      <input type="password" class="pininput" id="resetNewPinIn" maxlength="6" placeholder="NEW PIN"
        style="border-color:var(--accent)"
        onkeydown="if(event.key==='Enter')commitResetPin()">
      <button class="bb bstart" style="margin-top:10px;margin-bottom:6px;max-width:220px;margin-left:auto;margin-right:auto;display:block"
        onclick="commitResetPin()">SET NEW PIN</button>
    </div>
    <button class="bghost" style="width:100%;margin-top:4px" onclick="closeResetOverlay()">CANCEL</button>
  </div>
</div>

<!-- TARGET ALERT OVERLAY -->
<div class="target-overlay" id="targetOverlay">
  <div class="target-trophy" id="targetTrophy"></div>
  <div class="target-hit">TARGET HIT!</div>
  <div class="target-name" id="targetName"></div>
  <div class="target-amount" id="targetAmount"></div>
  <div class="target-label">DAILY TARGET REACHED</div>
  <button class="target-close" onclick="closeTargetAlert()">KEEP GOING! </button>
</div>

<!-- GENERATE REPORT MODAL -->
<div class="modal-overlay" id="reportModal">
  <div class="modal" style="border-top-color:var(--accent2)">
    <div class="modal-title" style="color:var(--accent2)"> GENERATE REPORT</div>
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;margin-bottom:12px">CHOOSE WHAT TO INCLUDE IN THIS REPORT</div>

    <!-- PERIOD -->
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">PERIOD</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:5px;margin-bottom:14px" id="rModalPeriodBtns">
      <div class="fchip active" data-period="today" onclick="setReportPeriod('today')">TODAY</div>
      <div class="fchip" data-period="week" onclick="setReportPeriod('week')">WEEK</div>
      <div class="fchip" data-period="month" onclick="setReportPeriod('month')">MONTH</div>
      <div class="fchip" data-period="all" onclick="setReportPeriod('all')">ALL</div>
    </div>

    <!-- SCOPE -->
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px">SCOPE</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:10px" id="rModalScopeBtns">
      <div class="fchip active" data-scope="all" onclick="setReportScope('all')">ALL</div>
      <div class="fchip" data-scope="driver" onclick="setReportScope('driver')">BY DRIVER</div>
      <div class="fchip" data-scope="car" onclick="setReportScope('car')">BY CAR</div>
    </div>

    <!-- DRIVER / CAR PICKER -->
    <div id="rModalDriverPick" style="display:none;margin-bottom:10px">
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px">SELECT DRIVER</div>
      <select id="rModalDriverSel" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;appearance:none">
        <option value=""> All Drivers </option>
      </select>
    </div>
    <div id="rModalCarPick" style="display:none;margin-bottom:10px">
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px">SELECT CAR</div>
      <select id="rModalCarSel" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;appearance:none">
        <option value=""> All Cars </option>
      </select>
    </div>

    <!-- PREVIEW COUNT -->
    <div id="rModalPreview" style="background:var(--surface);border:1px solid var(--border);padding:9px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-bottom:14px;text-align:center">
       SELECT OPTIONS ABOVE 
    </div>

    <!-- VIEW REPORT -->
    <button class="bb bconfirm" style="margin:0 0 8px;font-size:.86rem;letter-spacing:2px;padding:13px" onclick="runReport('view')"> VIEW REPORT</button>

    <!-- EXPORT -->
    <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;margin-top:2px"> OR EXPORT DIRECTLY </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">
      <button style="background:#c0392b;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:10px 4px;cursor:pointer" onclick="runReport('pdf')"> PDF</button>
      <button style="background:#217346;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:10px 4px;cursor:pointer" onclick="runReport('xls')"> XLS</button>
      <button style="background:#25D366;border:none;color:#fff;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;padding:10px 4px;cursor:pointer" onclick="runReport('wa')"> WA</button>
    </div>
    <button class="bout" style="margin:0" onclick="closeReportModal()">CANCEL</button>
  </div>
</div>

<!-- REPORT VIEWER OVERLAY -->
<div class="rview-overlay" id="rviewOverlay">
  <div class="rview-header">
    <button class="rview-back" onclick="closeReportViewer()"> BACK</button>
    <div class="rview-title" id="rviewTitle">REPORT</div>
    <button class="rview-export-btn" onclick="openExportMenuFromViewer()"> EXPORT</button>
  </div>
  <div class="rview-body" id="rviewBody"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// 
// DEFAULT DATA  stations now include GPS coords
// 
const DEFAULT_DRIVERS  = ['FESTUS KIPKURUI','TOM WASIKE','FELIX OTIENO','MUTUA KIRUI','JANETH TIONY','ABIGAEL CHEPKORIR','GRACE WANGECHI'];
const DEFAULT_CARS     = ['KBZ 300','KBY 400','KBU 500','KCA 200','KDY 260W','KYA 520X','KAF 2601'];
const DEFAULT_STATIONS = [
  {name:'NAIROBI CBD', lat:-1.2833, lng:36.8167},
  {name:'WESTLANDS',   lat:-1.2676, lng:36.8112},
  {name:'KAREN',       lat:-1.3197, lng:36.7073},
  {name:'NGONG',       lat:-1.3583, lng:36.6583},
  {name:'RONGAI',      lat:-1.3944, lng:36.7452},
  {name:"LANG'ATA",    lat:-1.3204, lng:36.7571},
  {name:'KIKUYU',      lat:-1.2463, lng:36.6637},
  {name:'LIMURU',      lat:-1.1095, lng:36.6431},
];
const ADMIN_PIN_KEY     = 'fs_pin';
const DEV_PIN_KEY       = 'fs_devpin';
const DEFAULT_DEV_PIN   = '9999';
const DEFAULT_ADMIN_PIN = '1234';
const SESSION_TIMEOUT   = 30 * 60;  // 30 min
const SESSION_WARN_SHOW = 5 * 60;   // show bar at 5 min remaining
const SESSION_WARN_OVL  = 60;       // overlay at 60s
const AMOUNT_MIN        = 10;
const AMOUNT_MAX        = 50000;
const MAX_PIN_ATTEMPTS  = 3;
const PIN_LOCKOUT_SECS  = 5 * 60;   // 5-minute lockout

// 
// STATE
// 
function load(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch(e){return d;}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}

let DRIVERS    = load('fs_drivers', DEFAULT_DRIVERS);
let CARS       = load('fs_cars', DEFAULT_CARS);
let STATIONS   = load('fs_stations', DEFAULT_STATIONS);
let localTrips = load('fs_trips', []);
let offlineQ      = load('fs_queue', []);
let driverPins    = load('fs_dpins', {});
let carTargets     = load('fs_targets', {});
let driverTargets  = load('fs_dtargets', {});
let shifts        = load('fs_shifts', {});
let firestoreTrips = [];   // trips fetched from Firebase
// Firebase credentials  ALWAYS loaded from hardcoded defaults first,
// then overlaid with any saved preferences (saccoName etc.)
// This means even if fs_config was saved without API keys, they're always present.
const FIREBASE_DEFAULTS = {
  apiKey:     'AIzaSyAYxULc7vcAX4EAZI6Y7jna5PBbCR8CTug',
  authDomain: 'psv-sacco-tracker.firebaseapp.com',
  projectId:  'psv-sacco-tracker',
  appId:      '1:849470601891:web:9b12cfa6f783bf7d975d16',
};
const _savedConfig = load('fs_config', {});
let appConfig = Object.assign({
  saccoName: '',
  appUrl: ''
}, FIREBASE_DEFAULTS, {
  // Only allow saccoName and appUrl to be overridden from saved config
  saccoName: _savedConfig.saccoName || '',
  appUrl:    _savedConfig.appUrl    || ''
});
// Always keep appUrl current
appConfig.appUrl = window.location.origin + window.location.pathname;

// PIN lockout state (in-memory only  resets on page reload, intentional)
let adminPinFailures   = 0;
let adminLockedUntil   = 0;
let driverPinFailures  = {};  // {driverName: {count, until}}

let tripState = {
  phase:'setup', driver:'', carPlate:'',
  fromStation:null, toStation:null,
  amount:'', notes:'',
  tripStart:null, tripEnd:null,
  // GPS / motion
  gpsLat:null, gpsLng:null, gpsStatus:'unknown',
  nearestStation:null,
  gpsWatchId:null,
  speed:null,         // m/s from GPS, null = unknown
  // Odometer / fuel tracking
  odomStart:null,     // reading at trip start (km)
  odomEnd:null,       // reading at trip end (km)
  odomWorking:true,   // false if odometer is broken
  odomSkipReason:'',  // reason when not working
  // Fuel log
  refueled:false,     // did driver add fuel this trip?
  fuelLiters:null,    // litres added
  fuelCost:null,      // total KES paid for fuel
  fuelStation:'',     // petrol station name (optional)
};

const sd = load('fs_driver', null);
if(sd){tripState.driver=sd.driver; tripState.carPlate=sd.carPlate; tripState.phase='idle';}

let currentPage        = 'log';
let reportFilter       = 'all';
let filterCar='', filterDriver='', filterFrom='', filterTo='';
let adminTab           = 'shifts';
let reportTab          = 'overview';
let adminUnlocked      = false;
let devUnlocked        = false;
let timerInterval      = null;
let syncInterval       = null;
let syncCountdown      = 300;
let db                 = null;   // Firestore instance
let liveUnsubscribe    = null;   // Firestore onSnapshot unsubscriber
let liveTrips          = [];     // real-time trips from listener
let liveNewIds         = new Set(); // recently-arrived trip IDs for highlight
let liveSessionSub     = null;   // Firestore onSnapshot for sessions collection
let liveSessions       = {};     // {carPlate: sessionDoc}  keyed by plate
let mySessionId        = null;   // Firestore doc ID of this driver's session
// Firebase Auth
let auth               = null;   // firebase.auth() instance
let currentAuthUser    = null;   // Currently signed-in Firebase user
let currentDriverDoc   = null;   // Firestore driver profile {name, email, carPlate, ...}
let currentAuthRole    = 'driver'; // 'driver' | 'admin'  which tab is selected
let isAdminUser        = false;  // true when logged-in user is an admin
// Driver pages state
let driverNotes        = [];     // loaded from Firestore
let driverNoteType     = 'strategy'; // 'strategy' | 'reason'  currently selected type
// Invitation state
let pendingInviteData  = null;   // stored pending invite from Firestore
let isFirstAdminLogin  = false;  // true on very first admin login (no drivers yet)
let stationSearch      = '';     // filter text for station grid
let sessionSecondsLeft = SESSION_TIMEOUT;
let sessionInterval    = null;
let showingTimeout     = false;
let darkMode           = load('fs_dark', false);
let charts             = {};
let chartTrendType     = 'driver';   // 'driver' | 'car'
let chartTrendEntity   = '';         // specific driver/car name, '' = show all
let chartTrendPeriod   = '30';       // '14' | '30' | 'weekly'
let editingTripId      = null;

if(darkMode){document.documentElement.setAttribute('data-theme','dark'); document.getElementById('darkBtn').textContent='';}

// 
// DARK MODE
// 
function toggleDark(){
  darkMode=!darkMode; save('fs_dark',darkMode);
  document.documentElement.setAttribute('data-theme',darkMode?'dark':'light');
  document.getElementById('darkBtn').textContent=darkMode?'':'';
  if(currentPage==='reports'&&reportTab==='charts')setTimeout(renderCharts,100);
  if(typeof updatePwaTheme==='function')updatePwaTheme();
}

// 
// SESSION TIMEOUT
// 
function startSessionTimer(){
  clearInterval(sessionInterval);
  sessionSecondsLeft=SESSION_TIMEOUT;
  showingTimeout=false;
  sessionInterval=setInterval(tickSession,1000);
  updateSessionBar();
}

function tickSession(){
  if(tripState.phase==='setup'||tripState.phase==='done'){
    clearInterval(sessionInterval);
    hideTimeoutOverlay();
    updateSessionBar();
    return;
  }
  sessionSecondsLeft--;
  updateSessionBar();
  if(sessionSecondsLeft<=0){
    clearInterval(sessionInterval);
    hideTimeoutOverlay();
    toast('SESSION EXPIRED  PLEASE LOG IN AGAIN');
    autoLogout();
    return;
  }
  if(sessionSecondsLeft<=SESSION_WARN_OVL && !showingTimeout){
    showingTimeout=true;
    document.getElementById('timeoutOverlay').classList.add('open');
  }
  if(showingTimeout){
    document.getElementById('timeoutCount').textContent=sessionSecondsLeft;
    document.getElementById('sessionBar').textContent=' '+sessionSecondsLeft+'s';
    document.getElementById('sessionBar').className='session-bar show warn';
  }
}

function updateSessionBar(){
  const bar=document.getElementById('sessionBar');
  if(tripState.phase==='setup'||tripState.phase==='done'){bar.textContent='';bar.className='session-bar';return;}
  if(showingTimeout)return;
  // Only show when  5 minutes left
  if(sessionSecondsLeft <= SESSION_WARN_SHOW){
    const m=Math.floor(sessionSecondsLeft/60);
    const s=sessionSecondsLeft%60;
    bar.textContent=` ${m}:${String(s).padStart(2,'0')}`;
    bar.className='session-bar show';
  } else {
    bar.textContent='';
    bar.className='session-bar';
  }
}

function resetSessionTimer(){
  sessionSecondsLeft=SESSION_TIMEOUT;
  showingTimeout=false;
  hideTimeoutOverlay();
  updateSessionBar();
  if(!sessionInterval||sessionSecondsLeft<=0)startSessionTimer();
}

function hideTimeoutOverlay(){
  document.getElementById('timeoutOverlay').classList.remove('open');
  showingTimeout=false;
}

function autoLogout(){
  clearInterval(timerInterval);
  stopGpsWatch();
  tripState={...tripState,phase:'setup',driver:'',carPlate:'',fromStation:null,toStation:null,amount:'',notes:'',tripStart:null,tripEnd:null,gpsLat:null,gpsLng:null,gpsStatus:'unknown',nearestStation:null,speed:null};
  save('fs_driver',null);
  document.getElementById('driverBadge').textContent=' LOGIN ';
  document.getElementById('sessionBar').textContent='';
  document.getElementById('sessionBar').className='session-bar';
  switchPage('log');
}

['click','touchstart','keypress'].forEach(ev=>{
  document.addEventListener(ev,()=>{
    if(tripState.phase!=='setup'&&tripState.phase!=='done'&&!showingTimeout)resetSessionTimer();
  },{passive:true});
});

// 
// NAVIGATION
// 
function switchPage(p){
  currentPage=p;
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nbtn').forEach(x=>x.classList.remove('active'));
  const pageEl=document.getElementById('page-'+p);
  if(pageEl) pageEl.classList.add('active');
  const navEl=document.getElementById('nav-'+p);
  if(navEl) navEl.classList.add('active');
  if(p==='log')         renderLog();
  if(p==='reports')     renderReports();
  if(p==='admin')       renderAdmin();
  if(p==='performance') renderPerformancePage();
  if(p==='notes')       renderNotesPage();
}

function showNavFor(role){
  // 'admin' shows admin nav, 'driver' shows driver nav, null hides both
  document.getElementById('navAdmin').style.display  = role==='admin'  ? '' : 'none';
  document.getElementById('navDriver').style.display = role==='driver' ? '' : 'none';
}

function adminLogoutQuick(){
  authLogout();
}
function goSetup(){
  clearInterval(timerInterval);
  stopGpsWatch();
  clearSavedTripState();
  endSession();
  mySessionId  = null;
  tripState.phase  = 'setup';
  tripState.driver = ''; tripState.carPlate = '';
  save('fs_driver', null);
  driverNotes  = [];
  showNavFor(null);
  if(auth && currentAuthUser){
    window._intentionalSignOut = true;
    auth.signOut();
  } else {
    showAuthOverlay();
    switchToPanel('landing');
  }
}

// 
// PIN LOCKOUT HELPERS
// 
function isAdminLocked(){return adminLockedUntil>Date.now();}
function adminLockSecsLeft(){return Math.ceil((adminLockedUntil-Date.now())/1000);}

function recordAdminFailure(){
  adminPinFailures++;
  if(adminPinFailures>=MAX_PIN_ATTEMPTS){
    adminLockedUntil=Date.now()+PIN_LOCKOUT_SECS*1000;
    adminPinFailures=0;
    toast(` TOO MANY ATTEMPTS  LOCKED FOR ${PIN_LOCKOUT_SECS/60} MINUTES`);
  } else {
    toast(`WRONG PIN  ${MAX_PIN_ATTEMPTS-adminPinFailures} ATTEMPT${MAX_PIN_ATTEMPTS-adminPinFailures===1?'':'S'} LEFT`);
  }
}

function isDriverLocked(driver){
  const d=driverPinFailures[driver];
  return d&&d.until>Date.now();
}
function driverLockSecsLeft(driver){
  return Math.ceil((driverPinFailures[driver].until-Date.now())/1000);
}
function recordDriverFailure(driver){
  if(!driverPinFailures[driver])driverPinFailures[driver]={count:0,until:0};
  driverPinFailures[driver].count++;
  if(driverPinFailures[driver].count>=MAX_PIN_ATTEMPTS){
    driverPinFailures[driver].until=Date.now()+PIN_LOCKOUT_SECS*1000;
    driverPinFailures[driver].count=0;
    toast(` TOO MANY ATTEMPTS  LOCKED FOR ${PIN_LOCKOUT_SECS/60} MINUTES`);
  } else {
    const left=MAX_PIN_ATTEMPTS-driverPinFailures[driver].count;
    toast(`WRONG PIN  ${left} ATTEMPT${left===1?'':'S'} LEFT`);
  }
}

// 
// OFFLINE / QUEUE
// 
function isOnline(){return navigator.onLine;}
function updateOfflineBadge(){
  document.getElementById('offlineBadge').className='offline-badge'+(isOnline()?'':' show');
  const banner=document.getElementById('queueBanner');
  if(offlineQ.length>0){banner.className='queue-banner show';document.getElementById('queueMsg').textContent=` ${offlineQ.length} TRIP${offlineQ.length>1?'S':''} QUEUED  TAP TO SYNC`;}
  else{banner.className='queue-banner';}
}
window.addEventListener('online',()=>{updateOfflineBadge();if(offlineQ.length)flushQueue();});
window.addEventListener('offline',()=>updateOfflineBadge());

async function flushQueue(){
  if(!offlineQ.length)return;
  if(!initFirebase()){toast(' CONFIGURE FIREBASE IN ADMIN FIRST');return;}
  if(!isOnline()){toast('STILL OFFLINE  WILL SYNC WHEN CONNECTED');return;}
  toast('SYNCING '+offlineQ.length+' QUEUED TRIPS...');
  const remaining=[];
  for(const trip of offlineQ){
    try{await db.collection('trips').add(trip);}
    catch(e){remaining.push(trip);}
  }
  offlineQ=remaining; save('fs_queue',offlineQ);
  toast(remaining.length===0?' ALL TRIPS SYNCED':' '+remaining.length+' STILL QUEUED');
  updateOfflineBadge();
}

// 
// AUTO-SYNC  refresh Firebase every 5 min
// 
function startAutoSync(){
  clearInterval(syncInterval);
  syncCountdown=300;
  syncInterval=setInterval(()=>{
    syncCountdown--;
    const el=document.getElementById('syncTimer');
    if(el)el.textContent='SYNC '+Math.floor(syncCountdown/60)+':'+String(syncCountdown%60).padStart(2,'0');
    if(syncCountdown<=0){
      syncCountdown=300;
      if(isOnline())flushQueue();
      if(currentPage==='reports'&&isOnline())loadFirebaseData(true);
    }
  },1000);
}

// 
// GPS  passive watch (doesn't block flow)
// 
function hav(a,b,c,d){const R=6371,dL=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

function findNearest(lat,lng){
  let best=null,bd=Infinity;
  STATIONS.forEach(s=>{
    if(!s.lat||!s.lng)return;
    const d=hav(lat,lng,s.lat,s.lng);
    if(d<bd){bd=d;best={...s,dist:d};}
  });
  return best;
}

function startGpsWatch(){
  stopGpsWatch();
  if(!navigator.geolocation){tripState.gpsStatus='unsupported';return;}
  tripState.gpsStatus='detecting';
  tripState.gpsWatchId=navigator.geolocation.watchPosition(
    pos=>{
      const prevNearest=tripState.nearestStation?.name;
      tripState.gpsLat=pos.coords.latitude;
      tripState.gpsLng=pos.coords.longitude;
      tripState.gpsStatus='ok';
      tripState.speed=(pos.coords.speed!=null&&pos.coords.speed>=0)?pos.coords.speed:null;
      tripState.nearestStation=findNearest(tripState.gpsLat,tripState.gpsLng);

      // Driver picks stations manually  GPS is reference only
      updateGpsElements();
    },
    err=>{tripState.gpsStatus='error';tripState.speed=null;updateGpsElements();},
    {enableHighAccuracy:true,maximumAge:5000,timeout:15000}
  );
}

// Patch only the GPS bar and speed badge without touching the rest of the page
function updateGpsElements(){
  const gbarEl=document.getElementById('gpsBar');
  if(gbarEl)gbarEl.outerHTML=gpsBarHtml().replace('<div','<div id="gpsBar"');
  // Re-insert with id so we can find it next time
  const gbarNew=document.querySelector('.gbar');
  if(gbarNew&&!gbarNew.id)gbarNew.id='gpsBar';

  const speedEl=document.getElementById('speedBadge');
  if(speedEl){
    const html=speedBadgeHtml();
    speedEl.outerHTML=html?html.replace('<div','<div id="speedBadge"'):'<div id="speedBadge" style="display:none"></div>';
  }
}

function stopGpsWatch(){
  if(tripState.gpsWatchId!=null){
    navigator.geolocation.clearWatch(tripState.gpsWatchId);
    tripState.gpsWatchId=null;
  }
  tripState.speed=null;
}

function gpsBarHtml(){
  if(tripState.gpsStatus==='detecting')
    return`<div id="gpsBar" class="gbar detecting"><span></span>DETECTING LOCATION...</div>`;
  if(tripState.gpsStatus==='ok'&&tripState.nearestStation)
    return`<div id="gpsBar" class="gbar"><span></span>NEAREST: ${tripState.nearestStation.name} (${tripState.nearestStation.dist.toFixed(1)} KM)</div>`;
  if(tripState.gpsStatus==='error')
    return`<div id="gpsBar" class="gbar err"><span></span>GPS UNAVAILABLE</div>`;
  return`<div id="gpsBar" class="gbar detecting"><span></span>WAITING FOR GPS...</div>`;
}

function speedBadgeHtml(){
  if(tripState.speed===null)return'<div id="speedBadge" style="display:none"></div>';
  const kmh=(tripState.speed*3.6).toFixed(0);
  const moving=tripState.speed>2;
  return`<div id="speedBadge" class="speed-badge">
    <div class="speed-dot ${moving?'moving':''}"></div>
    ${moving?`MOVING  ${kmh} KM/H`:`STATIONARY  ${kmh} KM/H`}
  </div>`;
}

// 
// FIX #1: TRIP TIMER  was missing entirely
// 
function startTripTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    const el=document.getElementById('timerVal');
    if(el&&tripState.tripStart){
      const s=Math.floor((Date.now()-tripState.tripStart)/1000);
      el.textContent=`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }
  },1000);
}

// 
// TOAST
// 
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);}

// 
// SHIFT CHECK
// 
function isShiftOpen(plate){
  const hasAnyShift=Object.keys(shifts).length>0;
  if(!hasAnyShift)return true;
  return shifts[plate]?.open===true;
}

// 
// DRIVER LOGIN
// 
function saveDriver(){
  const d=document.getElementById('selD')?.value, p=document.getElementById('selP')?.value;
  if(!d||!p){toast('SELECT DRIVER AND CAR PLATE');return;}
  if(driverPins[d]){
    // Check lockout
    if(isDriverLocked(d)){
      toast(` LOCKED  TRY AGAIN IN ${driverLockSecsLeft(d)}s`);
      return;
    }
    const n=d.replace(/'/g,"\\'"), q=p.replace(/'/g,"\\'");
    const lockMsg=isDriverLocked(d)?`<div class="pin-locked"> LOCKED  TRY IN ${driverLockSecsLeft(d)}s</div>`:'';
    document.getElementById('page-log').innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle">DRIVER PIN</div>
        <div class="csub">// ENTER YOUR PIN TO CONTINUE</div>
        ${lockMsg}
        <div style="text-align:center;margin-bottom:14px">
          <div style="font-family:var(--font-m);font-size:.58rem;color:var(--muted);margin-bottom:10px">${d}  ${p}</div>
          <input type="password" id="driverPinIn" maxlength="6" placeholder="" class="pininput"
            onkeydown="if(event.key==='Enter')confirmDriverPin('${n}','${q}')">
        </div>
        <button class="bb bstart" onclick="confirmDriverPin('${n}','${q}')">CONFIRM</button>
        <button class="bout" onclick="renderLog()">BACK</button>
      </div>`;
    return;
  }
  finishLogin(d,p);
}

function confirmDriverPin(d,p){
  if(isDriverLocked(d)){toast(` LOCKED  TRY IN ${driverLockSecsLeft(d)}s`);return;}
  const pin=document.getElementById('driverPinIn')?.value;
  if(pin!==driverPins[d]){recordDriverFailure(d);if(!isDriverLocked(d))saveDriver();else renderLog();return;}
  // Success  clear failures
  driverPinFailures[d]={count:0,until:0};
  finishLogin(d,p);
}

function finishLogin(d,p){
  tripState.driver=d; tripState.carPlate=p; tripState.phase='idle';
  save('fs_driver',{driver:d,carPlate:p});
  document.getElementById('driverBadge').textContent=d.split(' ')[0]+'  '+p;
  startSessionTimer();
  startGpsWatch();
  // Write login session to Firebase so admin can see who is online
  setTimeout(()=>writeSession('online',{loginTime:Date.now()}),500);
  renderLog();
}

// 
// STATION SELECTION
// 
function selFrom(n){
  tripState.fromStation=STATIONS.find(s=>s.name===n)||{name:n,lat:0,lng:0};
  renderLog();
}
function selTo(n){
  if(tripState.phase!=='arrived')return;
  tripState.toStation=STATIONS.find(s=>s.name===n)||{name:n,lat:0,lng:0};
  // Update session so admin sees the destination in real time
  writeSession('arrived',{
    from: tripState.fromStation?.name||'',
    to:   tripState.toStation.name
  });
  renderLog();
}

function stationGridHtml(selected, disabledName=null, mode='from'){
  const q=stationSearch.trim().toUpperCase();
  const visible=q ? STATIONS.filter(s=>s.name.includes(q)) : STATIONS;
  const gridItems = visible.length
    ? visible.map(s=>{
        const d=tripState.gpsLat?hav(tripState.gpsLat,tripState.gpsLng,s.lat,s.lng):null;
        const nearest=tripState.nearestStation?.name===s.name;
        const isSel=selected===s.name;
        const isDis=s.name===disabledName;
        return`<div class="sbtn ${isSel?'sel':''} ${isDis?'dis':''} ${nearest&&!isSel?'nearest':''}"
          onclick="${isDis?'':`sel${mode==='from'?'From':'To'}('${s.name.replace(/'/g,"\\'")}')` }"
          title="${nearest?'Nearest to you':''}">
          ${s.name}${nearest&&!isSel?' ':''}
          ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
        </div>`;
      }).join('')
    : `<div class="st-none">NO STATIONS MATCH "${q}"</div>`;
  const esc=q.replace(/'/g,"\\'");
  return`<div class="stsearch-wrap">
    <span class="stsearch-ico"></span>
    <input class="stsearch" id="stSearch_${mode}" type="text" placeholder="SEARCH STATION..."
      value="${esc}"
      oninput="stationSearch=this.value.toUpperCase();renderLog()"
      onfocus="this.select()">
    ${q?`<button class="stsearch-clr" onclick="stationSearch='';renderLog()"></button>`:''}
  </div>
  <div class="sgrid" style="margin-bottom:0">${gridItems}</div>`;
}

// 
// TARGET ALERT
// 
let targetAlertShown = {};  // {driver+date: true}  only alert once per day per driver

function checkTargetAlert(driver, todayTotal){
  const target = driverTargets[driver];
  if(!target || todayTotal < target) return;
  const key = driver + '_' + new Date().toLocaleDateString('en-GB');
  if(targetAlertShown[key]) return;
  targetAlertShown[key] = true;
  document.getElementById('targetName').textContent = driver.split(' ')[0] + ' ' + (driver.split(' ')[1]||'');
  document.getElementById('targetAmount').textContent = 'KES ' + todayTotal.toLocaleString();
  // Trophy varies by how much they exceeded target
  const pct = Math.round((todayTotal / target) * 100);
  document.getElementById('targetTrophy').textContent = pct >= 150 ? '' : pct >= 120 ? '' : '';
  document.getElementById('targetOverlay').classList.add('open');
  // Vibrate if supported
  if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 400]);
}

function closeTargetAlert(){
  document.getElementById('targetOverlay').classList.remove('open');
}

// 
// TRIP FLOW
// 
// 
// TRIP STATE PERSISTENCE
// 
const FS_TRIPSTATE_KEY = 'fs_active_trip';
const ACTIVE_PHASES    = ['active','arrived','confirm'];

function saveTripState(){
  if(ACTIVE_PHASES.includes(tripState.phase)){
    // Save a snapshot  exclude GPS watch ID (not serialisable)
    const snap = {...tripState, gpsWatchId:null};
    save(FS_TRIPSTATE_KEY, snap);
  } else {
    localStorage.removeItem(FS_TRIPSTATE_KEY);
  }
}

function clearSavedTripState(){
  localStorage.removeItem(FS_TRIPSTATE_KEY);
}

// 
// ODOMETER HELPERS
// 
function odomStartHtml(){
  const working = tripState.odomWorking;
  const hasReading = working ? !!tripState.odomStart : !!tripState.odomSkipReason;
  return `
  <div class="odom-wrap" id="odomStartWrap"
    style="border-color:${hasReading?'var(--accent)':'var(--red)'}">
    <div class="odom-title">
      <span> ODOMETER READING  TRIP START
        <span style="font-family:var(--font-b);font-size:.44rem;color:var(--red);letter-spacing:1px;margin-left:5px"> REQUIRED</span>
      </span>
      <span class="odom-notwork ${!working?'on':''}" onclick="toggleOdomWorking()">
        <span class="odom-check">${!working?'':''}</span>
        NOT WORKING
      </span>
    </div>
    ${working ? `
      <div class="odom-input-row" style="position:relative">
        <div style="position:relative">
          <span class="odom-pfx">KM</span>
          <input class="odom-input" type="number" id="odomStartIn"
            placeholder="e.g. 24500  REQUIRED TO START"
            min="0" max="999999" value="${tripState.odomStart||''}"
            style="border-color:${tripState.odomStart?'var(--accent)':'var(--red)'}"
            oninput="updateOdomStartUI(this.value)">
        </div>
        <span class="odom-unit">KM</span>
      </div>
      <div id="odomStartStatus" style="font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;margin-top:6px;color:${tripState.odomStart?'#22c55e':'var(--red)'}">${tripState.odomStart?' READING CAPTURED':' ENTER READING TO ENABLE TRIP START'}</div>
    ` : `
      <div class="odom-skip-badge"> ODOMETER NOT WORKING<br>PLEASE PROVIDE A REASON BELOW</div>
      <div class="odom-reason-label">REASON FOR NOT CAPTURING <span style="color:var(--red)"> REQUIRED</span></div>
      <textarea class="odom-reason" id="odomSkipReasonIn" rows="2"
        style="border-color:${tripState.odomSkipReason?'var(--accent)':'var(--red)'}"
        placeholder="e.g. Odometer cable broken, digital display failed, odometer tampered..."
        oninput="updateOdomReasonUI(this.value)">${tripState.odomSkipReason||''}</textarea>
      <div id="odomReasonStatus" style="font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;margin-top:4px;color:${tripState.odomSkipReason?'#22c55e':'var(--red)'}">${tripState.odomSkipReason?' REASON CAPTURED':' REASON REQUIRED TO ENABLE TRIP START'}</div>`}
  </div>`;
}

// Update odometer start UI without re-rendering the whole page
function updateOdomStartUI(val){
  tripState.odomStart = val ? parseInt(val) : null;
  const has = !!tripState.odomStart;
  // Border on input
  const inp = document.getElementById('odomStartIn');
  if(inp) inp.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  // Border on wrap
  const wrap = document.getElementById('odomStartWrap');
  if(wrap) wrap.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  // Status message
  const status = document.getElementById('odomStartStatus');
  if(status){ status.textContent = has ? ' READING CAPTURED' : ' ENTER READING TO ENABLE TRIP START'; status.style.color = has ? '#22c55e' : 'var(--red)'; }
  // Update START TRIP button without full re-render
  updateStartTripBtn();
}

// Update reason textarea UI without re-rendering
function updateOdomReasonUI(val){
  tripState.odomSkipReason = val;
  const has = !!val.trim();
  const ta = document.getElementById('odomSkipReasonIn');
  if(ta) ta.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  const wrap = document.getElementById('odomStartWrap');
  if(wrap) wrap.style.borderColor = has ? 'var(--accent)' : 'var(--red)';
  const status = document.getElementById('odomReasonStatus');
  if(status){ status.textContent = has ? ' REASON CAPTURED' : ' REASON REQUIRED TO ENABLE TRIP START'; status.style.color = has ? '#22c55e' : 'var(--red)'; }
  updateStartTripBtn();
}

// Update only the START TRIP button state  no re-render
function updateStartTripBtn(){
  const btn = document.getElementById('startTripBtn');
  if(!btn) return;
  const odomReady = tripState.odomWorking ? !!tripState.odomStart : !!tripState.odomSkipReason;
  const canStart  = !!tripState.fromStation && odomReady;
  const why = !tripState.fromStation ? 'SELECT STATION' : !odomReady ? (tripState.odomWorking?'ENTER ODOMETER':'ENTER REASON') : '';
  btn.disabled = !canStart;
  btn.style.opacity = canStart ? '1' : '0.45';
  btn.style.cursor = canStart ? 'pointer' : 'not-allowed';
  btn.textContent = canStart ? ' START TRIP' : ` BLOCKED  ${why}`;
}

function odomEndHtml(){
  const working = tripState.odomWorking;
  const dist = (working && tripState.odomStart && tripState.odomEnd && tripState.odomEnd > tripState.odomStart)
    ? tripState.odomEnd - tripState.odomStart : null;
  return `
  <div class="odom-wrap ${working&&tripState.odomEnd?'active':''}" id="odomEndWrap">
    <div class="odom-title">
      <span> ODOMETER READING  TRIP END</span>
    </div>
    ${!working ? `
      <div class="odom-skip-badge"> ODOMETER NOT WORKING<br>REASON: ${tripState.odomSkipReason||'Not specified'}</div>` : `
      ${tripState.odomStart?`<div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);margin-bottom:7px;letter-spacing:1px">START READING: <strong style="color:var(--accent)">${Number(tripState.odomStart).toLocaleString()} KM</strong></div>`:''}
      <div class="odom-input-row" style="position:relative">
        <div style="position:relative">
          <span class="odom-pfx">KM</span>
          <input class="odom-input" type="number" id="odomEndIn" placeholder="e.g. 24547"
            min="${tripState.odomStart||0}" max="999999" value="${tripState.odomEnd||''}"
            oninput="tripState.odomEnd=this.value?parseInt(this.value):null;updateOdomDist()">
        </div>
        <span class="odom-unit">KM</span>
      </div>
      <div id="odomDistBadge">
        ${dist!==null?`<div class="odom-dist-badge"> DISTANCE THIS TRIP: <strong>${dist} KM</strong></div>`:''}
        ${tripState.odomEnd&&tripState.odomStart&&tripState.odomEnd<=tripState.odomStart?
          `<div class="fuel-warn" style="margin-top:6px"> END READING MUST BE GREATER THAN START READING (${Number(tripState.odomStart).toLocaleString()} KM)</div>`:''}
      </div>`}
  </div>`;
}

function updateOdomDist(){
  const badge = document.getElementById('odomDistBadge');
  if(!badge) return;
  const start = tripState.odomStart;
  const end   = tripState.odomEnd;
  if(start && end && end > start){
    badge.innerHTML = `<div class="odom-dist-badge"> DISTANCE THIS TRIP: <strong>${end-start} KM</strong></div>`;
  } else if(end && start && end <= start){
    badge.innerHTML = `<div class="fuel-warn" style="margin-top:6px"> END READING MUST BE GREATER THAN START READING (${Number(start).toLocaleString()} KM)</div>`;
  } else {
    badge.innerHTML = '';
  }
}

function toggleOdomWorking(){
  tripState.odomWorking = !tripState.odomWorking;
  if(tripState.odomWorking){ tripState.odomSkipReason=''; }
  renderLog();
}

function saveOdomStart(){
  const v = document.getElementById('odomStartIn')?.value;
  tripState.odomStart = v ? parseInt(v) : null;
}

function saveOdomEnd(){
  const v = document.getElementById('odomEndIn')?.value;
  tripState.odomEnd = v ? parseInt(v) : null;
}

function startTrip(){
  stationSearch='';
  if(!tripState.fromStation){toast('SELECT YOUR STARTING STATION');return;}
  if(!isShiftOpen(tripState.carPlate)){toast(' SHIFT IS CLOSED FOR '+tripState.carPlate);return;}
  // Validate odometer  hard block
  const odomVal = document.getElementById('odomStartIn')?.value;
  if(odomVal) tripState.odomStart = parseInt(odomVal);
  const reasonVal = document.getElementById('odomSkipReasonIn')?.value?.trim();
  if(reasonVal) tripState.odomSkipReason = reasonVal;
  if(tripState.odomWorking && !tripState.odomStart){
    toast(' ODOMETER READING REQUIRED  ENTER START KM TO PROCEED');
    // Shake the odom input visually
    const inp = document.getElementById('odomStartIn');
    if(inp){ inp.style.borderColor='var(--red)'; inp.focus(); setTimeout(()=>inp.style.borderColor='var(--red)',600); }
    return;
  }
  if(!tripState.odomWorking && !tripState.odomSkipReason){
    toast(' REASON REQUIRED  EXPLAIN WHY ODOMETER IS NOT WORKING');
    const ta = document.getElementById('odomSkipReasonIn');
    if(ta){ ta.style.borderColor='var(--red)'; ta.focus(); }
    return;
  }
  tripState.phase='active';
  tripState.tripStart=Date.now();
  tripState.toStation=null;
  tripState.notes='';
  saveTripState();
  // Tell admin: this car is now driving
  writeSession('driving', {
    from: tripState.fromStation?.name || '',
    to: '',
    tripStartMs: tripState.tripStart
  });
  renderLog();
  startTripTimer();
  toast('TRIP STARTED  SAFE JOURNEY! ');
}

function arrive(){
  stationSearch='';
  tripState.phase='arrived';
  tripState.tripEnd=Date.now();
  clearInterval(timerInterval);
  tripState.toStation=null;
  saveTripState();
  // Tell admin: vehicle has arrived, logging details
  writeSession('arrived', {
    from: tripState.fromStation?.name || '',
    to: '',
    arrivedMs: tripState.tripEnd
  });
  renderLog();
  toast('ARRIVED  SELECT YOUR DESTINATION');
}



// 
// FUEL SECTION HELPERS
// 
function fuelSectionHtml(){
  const dist = (tripState.odomWorking && tripState.odomStart && tripState.odomEnd && tripState.odomEnd > tripState.odomStart)
    ? tripState.odomEnd - tripState.odomStart : null;
  const eff  = (dist && tripState.fuelLiters && tripState.fuelLiters > 0)
    ? (dist / tripState.fuelLiters).toFixed(2) : null;
  const costPerKm = (dist && tripState.fuelCost && tripState.fuelCost > 0)
    ? (tripState.fuelCost / dist).toFixed(1) : null;

  return `
  <div style="margin-bottom:${tripState.refueled?'0':'10px'}">
    <div class="fuel-entry-toggle ${tripState.refueled?'on':''}" onclick="toggleRefuel()">
      <div>
        <div class="fuel-toggle-label ${tripState.refueled?'on':''}"> DID YOU REFUEL THIS TRIP?</div>
        <div style="font-family:var(--font-b);font-size:.62rem;color:var(--muted);margin-top:2px">${tripState.refueled?'TAP TO REMOVE':'TAP TO RECORD FUEL ADDED'}</div>
      </div>
      <div class="fuel-toggle-pill ${tripState.refueled?'on':''}"></div>
    </div>
  </div>
  ${tripState.refueled ? `
  <div class="fuel-fields">
    <div class="fuel-grid">
      <div>
        <div class="fuel-field-label">LITRES ADDED *</div>
        <input class="fuel-input" type="number" id="fuelLitresIn" placeholder="e.g. 40"
          min="0.1" max="300" step="0.1" value="${tripState.fuelLiters||''}"
          oninput="tripState.fuelLiters=parseFloat(this.value)||null;updateFuelEfficiency()">
      </div>
      <div>
        <div class="fuel-field-label">TOTAL COST (KES) *</div>
        <input class="fuel-input" type="number" id="fuelCostIn" placeholder="e.g. 6500"
          min="1" max="999999" value="${tripState.fuelCost||''}"
          oninput="tripState.fuelCost=parseFloat(this.value)||null;updateFuelEfficiency()">
      </div>
    </div>
    <div>
      <div class="fuel-field-label">PETROL STATION (optional)</div>
      <input class="fuel-input full" type="text" id="fuelStationIn"
        placeholder="e.g. Total Rongai, Shell Ngong Rd..."
        value="${tripState.fuelStation||''}"
        oninput="tripState.fuelStation=this.value">
    </div>
    ${tripState.fuelLiters?`
    <div style="margin-top:7px;font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px">
      COST PER LITRE: <strong style="color:#f59e0b">KES ${tripState.fuelCost&&tripState.fuelLiters?(tripState.fuelCost/tripState.fuelLiters).toFixed(0):''}</strong>
    </div>`:''  }
    <div id="fuelEffBadge">
      ${eff?`
      <div class="fuel-efficiency-badge">
        <div class="fuel-eff-ico"></div>
        <div style="flex:1">
          <div style="display:flex;align-items:baseline;gap:5px">
            <span class="fuel-eff-val ${parseFloat(eff)>=10?'feff-good':parseFloat(eff)>=7?'feff-avg':'feff-poor'}">${eff}</span>
            <span class="fuel-eff-unit">KM / LITRE</span>
          </div>
          <div class="fuel-eff-sub">
            ${dist} km  ${tripState.fuelLiters}L
            ${costPerKm?` KES ${costPerKm}/km`:''}
             ${parseFloat(eff)>=10?' GOOD EFFICIENCY':parseFloat(eff)>=7?' AVERAGE':' POOR  CHECK ENGINE'}
          </div>
        </div>
      </div>`:''}
    </div>
  </div>`:``}`;
}

function toggleRefuel(){
  tripState.refueled = !tripState.refueled;
  if(!tripState.refueled){ tripState.fuelLiters=null; tripState.fuelCost=null; tripState.fuelStation=''; }
  renderLog();
}

function updateFuelEfficiency(){
  const badge = document.getElementById('fuelEffBadge');
  if(!badge) return;
  const dist = (tripState.odomWorking && tripState.odomStart && tripState.odomEnd && tripState.odomEnd > tripState.odomStart)
    ? tripState.odomEnd - tripState.odomStart : null;
  const liters = parseFloat(document.getElementById('fuelLitresIn')?.value) || null;
  const cost   = parseFloat(document.getElementById('fuelCostIn')?.value) || null;
  if(liters) tripState.fuelLiters = liters;
  if(cost)   tripState.fuelCost   = cost;
  const eff = (dist && liters && liters > 0) ? (dist / liters).toFixed(2) : null;
  const costPerKm = (dist && cost && cost > 0) ? (cost / dist).toFixed(1) : null;
  if(eff){
    const cls = parseFloat(eff)>=10?'feff-good':parseFloat(eff)>=7?'feff-avg':'feff-poor';
    const tag = parseFloat(eff)>=10?' GOOD EFFICIENCY':parseFloat(eff)>=7?' AVERAGE':' POOR  CHECK ENGINE';
    badge.innerHTML = `
      <div class="fuel-efficiency-badge">
        <div class="fuel-eff-ico"></div>
        <div style="flex:1">
          <div style="display:flex;align-items:baseline;gap:5px">
            <span class="fuel-eff-val ${cls}">${eff}</span>
            <span class="fuel-eff-unit">KM / LITRE</span>
          </div>
          <div class="fuel-eff-sub">
            ${dist} km  ${liters}L${costPerKm?`  KES ${costPerKm}/km`:''}  ${tag}
          </div>
        </div>
      </div>`;
  } else {
    badge.innerHTML = '';
  }
  // Also update cost-per-litre display
  const cplEl = badge.previousElementSibling;
}

function reviewTrip(){
  const amt=parseFloat(document.getElementById('amtIn')?.value||'0');
  const notes=(document.getElementById('notesIn')?.value||'').trim();
  if(!tripState.toStation){toast('SELECT DESTINATION STATION');return;}
  if(!amt||amt<=0){toast('ENTER AMOUNT COLLECTED');return;}
  if(amt<AMOUNT_MIN){toast(`AMOUNT TOO LOW  MINIMUM KES ${AMOUNT_MIN}`);return;}
  if(amt>AMOUNT_MAX){toast(`AMOUNT TOO HIGH  MAXIMUM KES ${AMOUNT_MAX.toLocaleString()}`);return;}
  if(tripState.toStation.name===tripState.fromStation.name){toast('TO STATION MUST BE DIFFERENT');return;}
  // Capture odometer end reading
  const odomEndVal = document.getElementById('odomEndIn')?.value;
  if(odomEndVal) tripState.odomEnd = parseInt(odomEndVal);
  if(tripState.odomWorking && tripState.odomStart && tripState.odomEnd){
    if(tripState.odomEnd <= tripState.odomStart){
      toast(' END ODOMETER MUST BE GREATER THAN START READING'); return;
    }
  }
  // Capture fuel inputs
  const fuelL = parseFloat(document.getElementById('fuelLitresIn')?.value)||null;
  const fuelC = parseFloat(document.getElementById('fuelCostIn')?.value)||null;
  const fuelS = (document.getElementById('fuelStationIn')?.value||'').trim();
  if(tripState.refueled){
    if(!fuelL||fuelL<=0){toast(' ENTER LITRES ADDED'); return;}
    if(!fuelC||fuelC<=0){toast(' ENTER FUEL COST (KES)'); return;}
    tripState.fuelLiters = fuelL;
    tripState.fuelCost   = fuelC;
    tripState.fuelStation = fuelS;
  }
  tripState.amount=amt; tripState.notes=notes;
  tripState.phase='confirm';
  saveTripState();
  renderLog();
}

function confirmAndSubmit(){
  const tenMin=10*60*1000;
  const dup=localTrips.find(t=>
    t.driver===tripState.driver&&t.carPlate===tripState.carPlate&&
    t.fromStation===tripState.fromStation.name&&t.toStation===tripState.toStation.name&&
    (Date.now()-new Date(t.timestamp).getTime())<tenMin
  );
  if(dup&&!confirm(' SIMILAR TRIP LOGGED WITHIN 10 MINUTES  SUBMIT ANYWAY?'))return;
  const _now=new Date();
  const _odomDist=(tripState.odomWorking&&tripState.odomStart&&tripState.odomEnd&&tripState.odomEnd>tripState.odomStart)
    ? tripState.odomEnd-tripState.odomStart : null;
  const trip={
    id:Date.now(),driver:tripState.driver,carPlate:tripState.carPlate,
    fromStation:tripState.fromStation.name,toStation:tripState.toStation.name,
    amount:tripState.amount,duration:Math.floor((tripState.tripEnd-tripState.tripStart)/60000),
    notes:tripState.notes,date:_now.toLocaleDateString('en-GB'),
    time:_now.toLocaleTimeString(),timestamp:_now.toISOString(),
    dateMs:_now.getTime(),  // used for Firestore range queries
    // Odometer
    odomStart:tripState.odomStart||null,
    odomEnd:tripState.odomEnd||null,
    odomWorking:tripState.odomWorking,
    odomSkipReason:tripState.odomSkipReason||null,
    distance:_odomDist,  // km covered this trip
    // Fuel
    refueled:tripState.refueled,
    fuelLiters:tripState.refueled?tripState.fuelLiters:null,
    fuelCost:tripState.refueled?tripState.fuelCost:null,
    fuelStation:tripState.refueled?(tripState.fuelStation||null):null,
    fuelEfficiency:(_odomDist&&tripState.refueled&&tripState.fuelLiters)
      ? parseFloat((_odomDist/tripState.fuelLiters).toFixed(2)) : null,  // km/L
    fuelCostPerKm:(_odomDist&&tripState.refueled&&tripState.fuelCost)
      ? parseFloat((tripState.fuelCost/_odomDist).toFixed(2)) : null,   // KES/km
  };
  localTrips.unshift(trip); save('fs_trips',localTrips.slice(0,200));
  tripState.phase='done';
  clearSavedTripState();
  submitToFirebase(trip);
  // Tell admin: trip complete, car is idle again
  writeSession('idle', {
    from: '',
    to: '',
    lastTrip: tripState.fromStation?.name + '  ' + tripState.toStation?.name,
    lastTripMs: Date.now()
  });
  playSuccessSound();
  renderLog();
  // Check driver target after render
  const _today=_now.toLocaleDateString('en-GB');
  const _todayTotal=localTrips.filter(t=>t.date===_today&&t.driver===tripState.driver).reduce((s,t)=>s+t.amount,0);
  setTimeout(()=>checkTargetAlert(tripState.driver, _todayTotal), 600);
}

function backToEdit(){tripState.phase='arrived';renderLog();}

function newTrip(){
  const prev=tripState.toStation;
  tripState.phase='idle';
  tripState.fromStation=prev;
  tripState.toStation=null; tripState.amount=''; tripState.notes='';
  tripState.tripStart=null; tripState.tripEnd=null;
  // For next trip: start odometer = previous end reading (auto-fill convenience)
  tripState.odomStart = tripState.odomEnd || null;
  tripState.odomEnd = null;
  // Keep odomWorking and odomSkipReason  driver's car doesn't change between trips
  // Reset fuel  each trip captures its own fuel event
  tripState.refueled=false; tripState.fuelLiters=null; tripState.fuelCost=null; tripState.fuelStation='';
  resetSessionTimer();
  renderLog();
  toast('READY FOR NEXT TRIP');
}

// 
// CONFIRMATION SOUND
// 
function playSuccessSound(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    // Three-note ascending chime: C5  E5  G5
    const notes=[523.25, 659.25, 783.99];
    notes.forEach((freq,i)=>{
      const osc=ctx.createOscillator();
      const gain=ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type='sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime+i*0.13);
      gain.gain.setValueAtTime(0, ctx.currentTime+i*0.13);
      gain.gain.linearRampToValueAtTime(0.28, ctx.currentTime+i*0.13+0.04);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+i*0.13+0.32);
      osc.start(ctx.currentTime+i*0.13);
      osc.stop(ctx.currentTime+i*0.13+0.35);
    });
  }catch(e){ /* AudioContext not supported  silent fail */ }
}

// 
// SUBMIT
// 
async function submitToFirebase(trip){
  if(!initFirebase()){
    if(!isOnline()){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast(' SAVED TO OFFLINE QUEUE');}
    else toast(' SAVED LOCALLY  CONFIGURE FIREBASE IN ADMIN');
    return;
  }
  if(!isOnline()){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast(' OFFLINE  QUEUED');return;}
  try{
    await db.collection('trips').add(trip);
    toast(' SYNCED TO FIREBASE');
  }catch(e){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast(' QUEUED FOR RETRY');}
}

// 
// WHATSAPP DAILY SUMMARY
// 
function generateWhatsAppSummary(){
  const all=allData();
  const today=new Date().toLocaleDateString('en-GB');
  const todayT=all.filter(t=>t.date===today);
  if(!todayT.length){toast('NO TRIPS TODAY TO SUMMARIZE');return;}
  const total=todayT.reduce((s,t)=>s+t.amount,0);
  const avg=Math.round(total/todayT.length);
  const cars=[...new Set(todayT.map(t=>t.carPlate).filter(Boolean))];
  const carLines=cars.map(car=>{
    const ct=todayT.filter(t=>t.carPlate===car);
    const cr=ct.reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car];
    const pct=target?` (${Math.round((cr/target)*100)}% of target)`:'';
    return`   ${car}: ${ct.length} trips  KES ${cr.toLocaleString()}${pct}`;
  }).join('\n');
  const drivers=[...new Set(todayT.map(t=>t.driver).filter(Boolean))];
  const driverLines=drivers.map(d=>{
    const dt=todayT.filter(t=>t.driver===d);
    const dr=dt.reduce((s,t)=>s+t.amount,0);
    return`   ${d}: ${dt.length} trips  KES ${dr.toLocaleString()}`;
  }).join('\n');
  const msg=` *FESTUS SACCO  DAILY REPORT*\n ${today}\n\n *SUMMARY*\n Total Trips: ${todayT.length}\n Total Revenue: KES ${total.toLocaleString()}\n Average/Trip: KES ${avg.toLocaleString()}\n\n *BY CAR*\n${carLines}\n\n *BY DRIVER*\n${driverLines}\n\n_Generated by FESTUS SACCO App_`;
  const encoded=encodeURIComponent(msg);
  if(navigator.clipboard){navigator.clipboard.writeText(msg).then(()=>toast(' COPIED! OPENING WHATSAPP...')).catch(()=>{});}
  setTimeout(()=>window.open(`https://wa.me/?text=${encoded}`,'_blank'),500);
}

// 
// 
// FIREBASE  init + data layer
// 
function initFirebase(){
  // Always ensure Firebase credentials are from hardcoded defaults
  const cfg = Object.assign({}, FIREBASE_DEFAULTS, {
    saccoName: appConfig.saccoName || '',
    appUrl:    appConfig.appUrl    || ''
  });
  if(!cfg.projectId){ console.error('Firebase: no projectId'); return false; }
  if(db && auth) return true;  // already fully initialised
  try{
    if(!firebase.apps.length){
      firebase.initializeApp({
        apiKey:     cfg.apiKey,
        authDomain: cfg.authDomain,
        projectId:  cfg.projectId,
        appId:      cfg.appId
      });
    } else {
      // App already initialized (e.g. hot reload)  just get instances
    }
    db   = db   || firebase.firestore();
    auth = auth || firebase.auth();
    // Offline persistence
    db.enablePersistence({synchronizeTabs:true}).catch(()=>{});
    return !!(db && auth);
  }catch(e){
    console.error('Firebase init error:', e);
    return false;
  }
}

async function loadFirebaseData(silent=false){
  if(!initFirebase()){if(!silent)toast(' CONFIGURE FIREBASE IN ADMIN');return;}
  if(!isOnline()&&!silent){toast('OFFLINE  SHOWING CACHED DATA');return;}
  try{
    // Build date range based on current filter
    const now=new Date(); now.setHours(23,59,59,999);
    let startMs=0;
    if(reportFilter==='today'){const s=new Date();s.setHours(0,0,0,0);startMs=s.getTime();}
    else if(reportFilter==='week'){const s=new Date();s.setDate(s.getDate()-s.getDay());s.setHours(0,0,0,0);startMs=s.getTime();}
    else if(reportFilter==='month'){const s=new Date(now.getFullYear(),now.getMonth(),1);startMs=s.getTime();}
    else{// 'all'  load last 90 days to keep query fast
      const s=new Date();s.setDate(s.getDate()-90);s.setHours(0,0,0,0);startMs=s.getTime();}

    let q=db.collection('trips').where('dateMs','>=',startMs).orderBy('dateMs','desc');
    // Extra car/driver filters pushed to Firestore where possible
    if(filterCar)q=q.where('carPlate','==',filterCar);
    const snap=await q.get();
    firestoreTrips=snap.docs.map(d=>({...d.data(),_fbId:d.id}));
    if(!silent)toast(' '+firestoreTrips.length+' RECORDS LOADED');
    if(currentPage==='reports')renderReports();
  }catch(e){
    if(!silent)toast(' LOAD ERROR: '+e.message);
    if(currentPage==='reports')renderReports();
  }
}

function allData(){
  // Merge Firebase trips with local trips (local takes priority for dedup)
  const fbFiltered=firestoreTrips.filter(ft=>!localTrips.find(lt=>lt.timestamp===ft.timestamp&&lt.driver===ft.driver));
  return[...localTrips,...fbFiltered];
}

function parseDate(str){
  if(!str)return null;let d=new Date(str);if(!isNaN(d))return d;
  const m=str.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
  if(m){const yr=m[3].length===2?'20'+m[3]:m[3];return new Date(`${yr}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`);}
  return null;
}


function filterTrips(trips){
  const now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return trips.filter(t=>{
    if(reportFilter!=='all'){
      const d=parseDate(t.date);if(!d)return false;
      if(reportFilter==='today'&&d<today)return false;
      if(reportFilter==='week'){const ws=new Date(today);ws.setDate(today.getDate()-today.getDay());if(d<ws)return false;}
      if(reportFilter==='month'&&(d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear()))return false;
    }
    if(filterCar&&(t.carPlate||'').trim()!==filterCar)return false;
    if(filterDriver&&(t.driver||'').trim()!==filterDriver)return false;
    if(filterFrom&&(t.fromStation||'').trim()!==filterFrom)return false;
    if(filterTo&&(t.toStation||'').trim()!==filterTo)return false;
    return true;
  });
}
function clearFilters(){filterCar='';filterDriver='';filterFrom='';filterTo='';reportFilter='all';renderReports();}

// 
// EXPORTS
// 
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const filtered=filterTrips(allData());
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=18;let y=M;
  doc.setFillColor(26,122,60);doc.rect(0,0,W,38,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('FESTUS SACCO',M,16);
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.text('TRIP REPORT  '+reportFilter.toUpperCase(),M,24);doc.text('Generated: '+new Date().toLocaleString(),M,31);
  y=46;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:String(filtered.length)},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():''},{l:'UNIQUE CARS',v:String([...new Set(filtered.map(t=>t.carPlate))].length)}].forEach((b,i)=>{
    const bx=M+i*(bw+3);doc.setFillColor(245,250,245);doc.rect(bx,y,bw,20,'F');doc.setFillColor(26,122,60);doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(6);doc.setFont('helvetica','normal');doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26);doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0);doc.setFontSize(6.5);doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5);doc.text('DATE',M+10,y+5);doc.text('ROUTE',M+36,y+5);doc.text('DRIVER',M+90,y+5);doc.text('CAR',M+130,y+5);doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244]));doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80);doc.setFontSize(6.5);doc.setFont('helvetica','normal');doc.text(String(i+1),M+2,y+5);doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60);doc.setFont('helvetica','bold');doc.text((t.fromStation||'').slice(0,9)+''+(t.toStation||'').slice(0,9),M+36,y+5);
    doc.setTextColor(60,60,60);doc.setFont('helvetica','normal');doc.text((t.driver||'').slice(0,18),M+90,y+5);doc.text(t.carPlate||'',M+130,y+5);
    doc.setTextColor(20,100,60);doc.setFont('helvetica','bold');doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FESTUS SACCO  CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  doc.save('FESTUS-report-'+new Date().toISOString().slice(0,10)+'.pdf');
}

function exportExcel(){
  const filtered=filterTrips(allData());
  const data=filtered.map(t=>({'DATE':t.date,'TIME':t.time,'FROM':t.fromStation,'TO':t.toStation,'DRIVER':t.driver,'CAR':t.carPlate,'AMOUNT':t.amount,'DURATION(MIN)':t.duration,'NOTES':t.notes||''}));
  const ws=XLSX.utils.json_to_sheet(data);
  ws['!cols']=[{wch:12},{wch:10},{wch:14},{wch:14},{wch:20},{wch:10},{wch:10},{wch:12},{wch:20}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Trips');
  const carRevs=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))].map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car);
    return{'CAR':car,'TRIPS':ct.length,'REVENUE':ct.reduce((s,t)=>s+t.amount,0),'AVG':ct.length?Math.round(ct.reduce((s,t)=>s+t.amount,0)/ct.length):0};
  });
  if(carRevs.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(carRevs),'By Car');
  XLSX.writeFile(wb,'FESTUS-'+new Date().toISOString().slice(0,10)+'.xlsx');
}

// 
// CHARTS
// 
function renderCharts(){
  const all=allData(),isDark=darkMode;
  const tc=isDark?'#5a8a6a':'#6a8a6a',gc=isDark?'#2a3e2e':'#dde8dd';
  Chart.defaults.color=tc;Chart.defaults.borderColor=gc;
  Chart.defaults.font.family="'Space Mono',monospace";Chart.defaults.font.size=10;

  const PALETTE=['#1a7a3c','#f0a500','#2196a8','#e53935','#6d4fc2','#22c55e','#fb923c','#ec4899','#0ea5e9','#84cc16'];

  function mk(id,type,labels,datasets,legend=false,height=200){
    if(charts[id])charts[id].destroy();
    const canvas=document.getElementById(id);if(!canvas)return;
    const wrap=canvas.parentElement;if(wrap)wrap.style.height=height+'px';
    charts[id]=new Chart(canvas.getContext('2d'),{
      type,data:{labels,datasets},
      options:{
        responsive:true,maintainAspectRatio:false,
        interaction:{mode:'index',intersect:false},
        plugins:{
          legend:{display:legend,labels:{color:tc,font:{size:9},boxWidth:12,padding:10}},
          tooltip:{backgroundColor:isDark?'#1a2820':'#fff',titleColor:isDark?'#e0f0e4':'#1a2e1a',bodyColor:isDark?'#5a8a6a':'#6a8a6a',borderColor:gc,borderWidth:1}
        },
        scales:type!=='doughnut'?{
          x:{grid:{color:gc},ticks:{color:tc,maxRotation:45,font:{size:9}}},
          y:{grid:{color:gc},ticks:{color:tc,beginAtZero:true,callback:v=>v>=1000?(v/1000).toFixed(0)+'K':v}}
        }:undefined
      }
    });
  }

  //  Build date labels 
  function buildDayLabels(n){
    const arr=[];
    for(let i=n-1;i>=0;i--){
      const d=new Date();d.setDate(d.getDate()-i);d.setHours(0,0,0,0);arr.push(d);
    }
    return arr;
  }
  function buildWeekLabels(n){
    const arr=[];
    for(let i=n-1;i>=0;i--){
      const ws=new Date();ws.setDate(ws.getDate()-ws.getDay()-i*7);ws.setHours(0,0,0,0);
      const we=new Date(ws);we.setDate(ws.getDate()+7);arr.push({ws,we,label:'W'+(n-i)});
    }
    return arr;
  }
  function revForDay(trips,dayStart){
    const dayEnd=new Date(dayStart);dayEnd.setDate(dayStart.getDate()+1);
    return trips.filter(t=>{const d=parseDate(t.date);return d&&d>=dayStart&&d<dayEnd;}).reduce((s,t)=>s+(t.amount||0),0);
  }
  function revForWeek(trips,ws,we){
    return trips.filter(t=>{const d=parseDate(t.date);return d&&d>=ws&&d<we;}).reduce((s,t)=>s+(t.amount||0),0);
  }

  //  CHART 1: Daily revenue bar  30 days 
  const days30=buildDayLabels(30);
  mk('chartDaily','bar',
    days30.map(d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})),
    [{label:'Revenue',data:days30.map(d=>revForDay(all,d)),backgroundColor:'rgba(26,122,60,0.7)',borderColor:'#1a7a3c',borderWidth:1,borderRadius:3}]
  );

  //  CHART 2: Weekly comparison bar 
  const weeks=buildWeekLabels(8);
  mk('chartWeekly','bar',
    weeks.map(w=>w.label),
    [{label:'Revenue',data:weeks.map(w=>revForWeek(all,w.ws,w.we)),
      backgroundColor:weeks.map((_,i)=>i===weeks.length-1?'rgba(240,165,0,0.8)':'rgba(26,122,60,0.5)'),
      borderColor:weeks.map((_,i)=>i===weeks.length-1?'#f0a500':'#1a7a3c'),borderWidth:1,borderRadius:3}]
  );

  //  CHART 3: Revenue by car doughnut 
  const cars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))];
  mk('chartCars','doughnut',cars,
    [{data:cars.map(car=>all.filter(t=>t.carPlate===car).reduce((s,t)=>s+(t.amount||0),0)),
      backgroundColor:PALETTE,borderColor:isDark?'#141f18':'#fff',borderWidth:2}],true
  );

  //  CHART 4: Daily trips count  14 days 
  const days14=buildDayLabels(14);
  mk('chartTrips','line',
    days14.map(d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})),
    [{label:'Trips',data:days14.map(d=>{
        const de=new Date(d);de.setDate(d.getDate()+1);
        return all.filter(t=>{const rd=parseDate(t.date);return rd&&rd>=d&&rd<de;}).length;
      }),
      borderColor:'#f0a500',backgroundColor:'rgba(240,165,0,0.08)',borderWidth:2,fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#f0a500'}]
  );

  //  CHARTS 5 & 6: Revenue trends per driver / per car 
  renderTrendCharts(all,isDark,tc,gc,PALETTE,mk,buildDayLabels,buildWeekLabels,revForDay,revForWeek);
}

function hexRgba(hex,a){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;}

function renderTrendCharts(all,isDark,tc,gc,PALETTE,mk,buildDayLabels,buildWeekLabels,revForDay,revForWeek){
  const n   = chartTrendPeriod==='weekly' ? null : parseInt(chartTrendPeriod);
  const isWeekly = chartTrendPeriod==='weekly';

  // Build labels
  const labels = isWeekly
    ? buildWeekLabels(12).map(w=>w.label)
    : buildDayLabels(n).map(d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'}));
  const periods = isWeekly ? buildWeekLabels(12) : buildDayLabels(n);

  function revForPeriod(trips,p){
    return isWeekly ? revForWeek(trips,p.ws,p.we) : revForDay(trips,p);
  }

  //  Chart 5: DRIVER trend 
  const allDrivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  let driverDatasets=[];
  if(chartTrendType==='driver'){
    const selected = chartTrendEntity
      ? allDrivers.filter(d=>d===chartTrendEntity)
      : allDrivers.slice(0,6); // cap at 6 for readability
    selected.forEach((driver,i)=>{
      const dTrips=all.filter(t=>t.driver===driver);
      const color=PALETTE[i%PALETTE.length];
      driverDatasets.push({
        label:driver.split(' ')[0]+(driver.split(' ')[1]?' '+driver.split(' ')[1].charAt(0)+'.':''),
        data:periods.map(p=>revForPeriod(dTrips,p)),
        borderColor:color,
        backgroundColor:hexRgba(color,.08),
        borderWidth:chartTrendEntity?2.5:1.8,
        fill:!!chartTrendEntity,tension:0.4,
        pointRadius:chartTrendEntity?4:2,pointHoverRadius:6,
        pointBackgroundColor:color
      });
    });
  }
  mk('chartDriverTrend','line',labels,driverDatasets,true,220);

  //  Chart 6: CAR trend 
  const allCars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  let carDatasets=[];
  if(chartTrendType==='car'){
    const selected = chartTrendEntity
      ? allCars.filter(c=>c===chartTrendEntity)
      : allCars.slice(0,6);
    selected.forEach((car,i)=>{
      const cTrips=all.filter(t=>t.carPlate===car);
      const color=PALETTE[i%PALETTE.length];
      carDatasets.push({
        label:car,
        data:periods.map(p=>revForPeriod(cTrips,p)),
        borderColor:color,
        backgroundColor:hexRgba(color,.08),
        borderWidth:chartTrendEntity?2.5:1.8,
        fill:!!chartTrendEntity,tension:0.4,
        pointRadius:chartTrendEntity?4:2,pointHoverRadius:6,
        pointBackgroundColor:color
      });
    });
  }
  mk('chartCarTrend','line',labels,carDatasets,true,220);
}

// 
// RENDER LOG PAGE
// 
function renderLog(){
  const el=document.getElementById('page-log');
  if(currentPage!=='log')return;
  if(tripState.driver)document.getElementById('driverBadge').textContent=tripState.driver.split(' ')[0]+'  '+tripState.carPlate;
  else document.getElementById('driverBadge').textContent=' LOGIN ';

  // SETUP
  if(tripState.phase==='setup'){
    el.innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2);text-align:center;padding:32px 20px">
        <div style="font-size:2.5rem;margin-bottom:10px"></div>
        <div class="ctitle" style="margin-bottom:6px">FESTUS SACCO</div>
        <div style="font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:1.8">
          PLEASE WAIT  VERIFYING YOUR ACCOUNT...<br>
          <span style="font-size:.48rem">IF LOGIN SCREEN DOESN'T APPEAR, REFRESH THE PAGE</span>
        </div>
        ${appConfig.projectId?'':`<div style="margin-top:16px;padding:12px;background:var(--rlight);border:1px solid var(--red);font-family:var(--font-m);font-size:.52rem;color:var(--red);letter-spacing:1px"> FIREBASE NOT CONFIGURED<br>CONTACT SYSTEM ADMIN</div>`}
      </div>`;
    // Trigger auth overlay if Firebase is configured
    return; // auth overlay is managed solely by onAuthStateChanged
  }

  // IDLE
  if(tripState.phase==='idle'){
    if(!isShiftOpen(tripState.carPlate)){
      el.innerHTML=`
        <div class="shift-block">
          <div class="shift-block-title"> SHIFT CLOSED</div>
          <div class="shift-block-sub">THE SHIFT FOR <strong>${tripState.carPlate}</strong> IS CURRENTLY CLOSED<br>CONTACT YOUR SUPERVISOR TO OPEN THE SHIFT</div>
        </div>
        <button class="bout" onclick="goSetup()">CHANGE CAR / DRIVER</button>`;
      return;
    }
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">START TRIP</div>
        <div class="csub">// SELECT YOUR STARTING STATION</div>
        ${gpsBarHtml()}
        ${speedBadgeHtml()}
        <div class="field"><label>FROM STATION</label></div>
        ${stationGridHtml(tripState.fromStation?.name||null, null, 'from')}
        ${odomStartHtml()}
        ${(()=>{
          const odomReady = tripState.odomWorking ? !!tripState.odomStart : !!tripState.odomSkipReason;
          const canStart  = !!tripState.fromStation && odomReady;
          const why = !tripState.fromStation ? 'SELECT STATION' : !odomReady ? (tripState.odomWorking?'ENTER ODOMETER':'ENTER REASON') : '';
          return `<button id="startTripBtn" class="bb bstart" onclick="startTrip()" ${!canStart?'disabled':''}
            style="opacity:${canStart?'1':'0.45'};cursor:${canStart?'pointer':'not-allowed'}">
             ${canStart?'START TRIP':`BLOCKED  ${why}`}
          </button>`;
        })()}
        <button class="bout" onclick="authLogout()"> LOG OUT</button>
        <button class="bout" style="margin-top:4px;font-size:.52rem" onclick="switchPage('performance')"> MY STATS</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  // ACTIVE
  if(tripState.phase==='active'){
    const secs=tripState.tripStart?Math.floor((Date.now()-tripState.tripStart)/1000):0;
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">TRIP IN PROGRESS</div>
        <div class="csub">// DRIVE TO DESTINATION  TAP ARRIVE WHEN THERE</div>
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr"></div>
          <div class="rs"><div class="rl">TO</div><div class="rn" style="color:var(--muted)">DESTINATION</div></div>
        </div>
        ${speedBadgeHtml()}
        <div class="tdisp">
          <div class="tl">TRIP DURATION</div>
          <div class="tv" id="timerVal">${String(Math.floor(secs/3600)).padStart(2,'0')}:${String(Math.floor((secs%3600)/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}</div>
        </div>
        <div class="lock"><div class="lico"></div><div class="ltxt">DESTINATION LOCKED<br>ARRIVE AT STATION FIRST</div></div>
        <button class="bb barrive" onclick="arrive()"> I HAVE ARRIVED</button>
        <button class="bout" onclick="if(confirm('Cancel this trip?')){tripState.phase='idle';clearInterval(timerInterval);renderLog();}">CANCEL TRIP</button>
      </div>`;
    startTripTimer();
    return;
  }

  // ARRIVED
  if(tripState.phase==='arrived'){
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">END TRIP</div>
        <div class="csub">// CONFIRM DESTINATION & ENTER AMOUNT</div>
        ${gpsBarHtml()}
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr"></div>
          <div class="rs"><div class="rl">TO</div><div class="rn">${tripState.toStation?tripState.toStation.name:'???'}</div></div>
        </div>
        <div class="field"><label>TO STATION</label></div>
        ${stationGridHtml(tripState.toStation?.name||null, tripState.fromStation.name, 'to')}
        <div class="field"><label>AMOUNT COLLECTED IN KES</label></div>
        <div class="awrap">
          <span class="apfx">KES</span>
          <input type="number" class="ainput" id="amtIn" placeholder="0" min="${AMOUNT_MIN}" max="${AMOUNT_MAX}" value="${tripState.amount||''}">
        </div>
        ${odomEndHtml()}
        ${fuelSectionHtml()}
        <div class="field"><label>TRIP NOTES (optional)</label>
          <textarea id="notesIn" placeholder="e.g. Road closed, vehicle issue, extra passengers...">${tripState.notes||''}</textarea>
        </div>
        <button class="bb bend" onclick="reviewTrip()" ${!tripState.toStation?'disabled':''}>REVIEW & CONFIRM </button>
      </div>`;
    return;
  }

  // CONFIRM
  if(tripState.phase==='confirm'){
    const dur=Math.floor((tripState.tripEnd-tripState.tripStart)/60000);
    const isHighAmount=tripState.amount>20000;
    el.innerHTML=`
      <div class="card" style="border-top:4px solid #22c55e">
        <div class="confirm-title">CONFIRM TRIP</div>
        ${isHighAmount?`<div class="confirm-warn"> AMOUNT IS HIGHER THAN USUAL  PLEASE VERIFY</div>`:''}
        <div class="confirm-card">
          <div class="confirm-row"><span class="confirm-label">DRIVER</span><span class="confirm-val">${tripState.driver}</span></div>
          <div class="confirm-row"><span class="confirm-label">CAR</span><span class="confirm-val">${tripState.carPlate}</span></div>
          <div class="confirm-row"><span class="confirm-label">FROM</span><span class="confirm-val">${tripState.fromStation.name}</span></div>
          <div class="confirm-row"><span class="confirm-label">TO</span><span class="confirm-val">${tripState.toStation.name}</span></div>
          <div class="confirm-row"><span class="confirm-label">DURATION</span><span class="confirm-val">${dur} MIN</span></div>
          <div class="confirm-row"><span class="confirm-label">TIME</span><span class="confirm-val">${new Date().toLocaleTimeString()}</span></div>
          ${tripState.notes?`<div class="confirm-row"><span class="confirm-label">NOTES</span><span class="confirm-val">${tripState.notes}</span></div>`:''}
          ${tripState.odomWorking&&tripState.odomStart?`<div class="confirm-row"><span class="confirm-label">ODOM START</span><span class="confirm-val">${Number(tripState.odomStart).toLocaleString()} KM</span></div>`:''}
          ${tripState.odomWorking&&tripState.odomEnd?`<div class="confirm-row"><span class="confirm-label">ODOM END</span><span class="confirm-val">${Number(tripState.odomEnd).toLocaleString()} KM</span></div>`:''}
          ${tripState.odomWorking&&tripState.odomStart&&tripState.odomEnd&&tripState.odomEnd>tripState.odomStart?
            `<div class="confirm-row"><span class="confirm-label">DISTANCE</span><span class="confirm-val" style="color:var(--accent)"> ${tripState.odomEnd-tripState.odomStart} KM</span></div>`:
            !tripState.odomWorking?`<div class="confirm-row"><span class="confirm-label">ODOMETER</span><span class="confirm-val" style="color:var(--red)"> NOT WORKING</span></div>`:''}
          ${tripState.refueled?`
          <div class="confirm-row" style="border-top:1px dashed #f59e0b;padding-top:10px;margin-top:6px;border-bottom:none">
            <span class="confirm-label" style="color:#f59e0b"> FUEL ADDED</span>
            <span class="confirm-val" style="color:#f59e0b">${tripState.fuelLiters} L</span>
          </div>
          <div class="confirm-row"><span class="confirm-label">FUEL COST</span><span class="confirm-val">KES ${Number(tripState.fuelCost).toLocaleString()}</span></div>
          ${tripState.fuelStation?`<div class="confirm-row"><span class="confirm-label">STATION</span><span class="confirm-val">${tripState.fuelStation}</span></div>`:''}
          ${tripState.fuelEfficiency?`<div class="confirm-row"><span class="confirm-label">EFFICIENCY</span><span class="confirm-val" style="color:${tripState.fuelEfficiency>=10?'#22c55e':tripState.fuelEfficiency>=7?'#f59e0b':'var(--red)'}"> ${(tripState.distance/tripState.fuelLiters).toFixed(2)} KM/L</span></div>`:''}
          `:''}
          <div class="confirm-row" style="padding-top:14px;margin-top:4px;border-top:2px solid var(--accent);border-bottom:none">
            <span class="confirm-label">AMOUNT COLLECTED</span>
            <span class="confirm-amount">KES ${Number(tripState.amount).toLocaleString()}</span>
          </div>
        </div>
        <button class="bb bconfirm" onclick="confirmAndSubmit()"> CONFIRM &amp; SUBMIT</button>
        <button class="bout" onclick="backToEdit()"> GO BACK &amp; EDIT</button>
      </div>`;
    return;
  }

  // DONE
  if(tripState.phase==='done'){
    const last=localTrips[0];
    const today=new Date().toLocaleDateString('en-GB');
    const todayTrips=localTrips.filter(t=>t.date===today&&t.driver===tripState.driver);
    const todayTotal=todayTrips.reduce((s,t)=>s+t.amount,0);
    const carTarget=carTargets[tripState.carPlate];
    const driverTarget=driverTargets[tripState.driver];
    const target=driverTarget||carTarget;  // driver target takes priority
    const tpct=target?Math.min(100,Math.round((todayTotal/target)*100)):null;
    el.innerHTML=`
      <div class="scard">
        <div class="sico"></div>
        <div class="stitle">TRIP LOGGED!</div>
        <div class="sdetails">
          <div class="drow"><span>ROUTE</span><span>${last.fromStation}  ${last.toStation}</span></div>
          <div class="drow"><span>DURATION</span><span>${last.duration} MIN</span></div>
          <div class="drow"><span>AMOUNT</span><span>KES ${Number(last.amount).toLocaleString()}</span></div>
          ${last.notes?`<div class="drow"><span>NOTES</span><span style="max-width:60%;text-align:right">${last.notes}</span></div>`:''}
          ${last.distance?`<div class="drow"><span>DISTANCE</span><span style="color:var(--accent)"> ${last.distance} KM</span></div>`:''}
          ${last.odomWorking===false?`<div class="drow"><span>ODOMETER</span><span style="color:var(--red)"> NOT WORKING</span></div>`:''}
          ${last.refueled?`<div class="drow" style="border-top:1px dashed #f59e0b;padding-top:8px;margin-top:4px"><span style="color:#f59e0b"> FUEL ADDED</span><span style="color:#f59e0b">${last.fuelLiters} L  KES ${Number(last.fuelCost).toLocaleString()}</span></div>`:''}
          ${last.fuelEfficiency?`<div class="drow"><span>EFFICIENCY</span><span style="color:${last.fuelEfficiency>=10?'#22c55e':last.fuelEfficiency>=7?'#f59e0b':'var(--red)'}"> ${last.fuelEfficiency} KM/L</span></div>`:''}
          ${last.fuelStation?`<div class="drow"><span>FUEL STATION</span><span>${last.fuelStation}</span></div>`:''}
        </div>
        <div class="ssub">${db&&isOnline()?' SYNCED TO FIREBASE':offlineQ.length?' QUEUED FOR SYNC':' SAVED LOCALLY  CONFIGURE FIREBASE IN ADMIN'}</div>
      </div>
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle" style="margin-bottom:12px">MY SHIFT TODAY</div>
        <div class="sumcard" style="margin-bottom:0">
          <div class="sumrow"><span class="sumlbl">TRIPS TODAY</span><span class="sumval">${todayTrips.length}</span></div>
          <div class="sumrow"><span class="sumlbl">REVENUE TODAY</span><span class="sumval">KES ${todayTotal.toLocaleString()}</span></div>
          <div class="sumrow"><span class="sumlbl">AVG PER TRIP</span><span class="sumval">KES ${todayTrips.length?Math.round(todayTotal/todayTrips.length).toLocaleString():''}</span></div>
          ${target?`<div class="sumrow"><span class="sumlbl">TARGET PROGRESS</span><span class="sumval" style="color:${tpct>=100?'#22c55e':'var(--red)'}">${tpct}%</span></div>
          <div style="margin-top:8px"><div class="target-bar"><div class="target-fill ${tpct>=100?'high':tpct>=50?'mid':'low'}" style="width:${tpct}%"></div></div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);margin-top:4px">KES ${todayTotal.toLocaleString()} of KES ${Number(target).toLocaleString()} ${driverTarget?'PERSONAL':'CAR'} TARGET</div></div>`:''}
        </div>
      </div>
      <button class="bb bstart" onclick="newTrip()"> START NEXT TRIP</button>
      <button class="bout" onclick="authLogout()"> END SHIFT &amp; LOG OUT</button>
      ${renderTodayHistory()}`;
    return;
  }
}

function renderTodayHistory(){
  const today=new Date().toLocaleDateString('en-GB');
  const tt=localTrips.filter(t=>t.date===today&&t.driver===tripState.driver);
  if(!tt.length)return'';
  const tot=tt.reduce((s,t)=>s+t.amount,0);
  return`<div class="hsect"><div class="stitle2">MY TRIPS TODAY (${tt.length})  KES ${tot.toLocaleString()}</div>
  ${tt.slice(0,8).map(t=>`<div class="hitem">
    <div class="htop"><span class="hroute">${t.fromStation}  ${t.toStation}</span><span class="hamt">KES ${Number(t.amount).toLocaleString()}</span></div>
    <div class="hbot"><span>${t.carPlate}${t.distance?`   ${t.distance}km`:''}${t.notes?`   ${t.notes.slice(0,22)}`:''}</span><span class="htime">${t.time}</span></div>
  </div>`).join('')}</div>`;
}

// 
// RENDER REPORTS
// 
function renderReports(){
  const el=document.getElementById('page-reports');
  const all=allData();
  const filtered=filterTrips(all);
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const avg=filtered.length?Math.round(total/filtered.length):0;
  const now=new Date();now.setHours(0,0,0,0);
  const todayT=all.filter(t=>{const d=parseDate(t.date);return d&&d>=now;});
  const allCars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const allDrivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  const allStations=[...new Set([...all.map(t=>t.fromStation),...all.map(t=>t.toStation)].filter(Boolean))].sort();
  const activeTags=[];
  if(filterCar)activeTags.push({l:'CAR: '+filterCar,c:"filterCar='';renderReports()"});
  if(filterDriver)activeTags.push({l:'DRV: '+filterDriver.split(' ')[0],c:"filterDriver='';renderReports()"});
  if(filterFrom)activeTags.push({l:'FROM: '+filterFrom,c:"filterFrom='';renderReports()"});
  if(filterTo)activeTags.push({l:'TO: '+filterTo,c:"filterTo='';renderReports()"});
  if(reportFilter!=='all')activeTags.push({l:reportFilter.toUpperCase(),c:"reportFilter='all';renderReports()"});

  el.innerHTML=`
    <div class="exprow">
      <button class="bsm bg" onclick="loadFirebaseData()"></button>
      <button class="bsm by" style="flex:3;letter-spacing:2px" onclick="openReportModal()"> GENERATE REPORT</button>
      <button class="bsm bgray" onclick="clearFilters()"></button>
    </div>
    <div class="sgrid2">
      <div class="sbox"><div class="sl">TOTAL TRIPS</div><div class="sv green">${filtered.length}</div></div>
      <div class="sbox"><div class="sl">TOTAL REVENUE</div><div class="sv green" style="font-size:1.1rem">KES ${total.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">AVG / TRIP</div><div class="sv yellow" style="font-size:1.1rem">KES ${avg.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">TODAY'S TRIPS</div><div class="sv">${todayT.length}</div></div>
    </div>
    <div class="rtabs">
      <button class="rtab ${reportTab==='overview'?'active':''}" onclick="reportTab='overview';renderReports()">OVERVIEW</button>
      <button class="rtab ${reportTab==='charts'?'active':''}" onclick="reportTab='charts';renderReports();setTimeout(renderCharts,80)">CHARTS</button>
      <button class="rtab ${reportTab==='leaderboard'?'active':''}" onclick="reportTab='leaderboard';renderReports()">LEADERBOARD</button>
      <button class="rtab ${reportTab==='performance'?'active':''}" onclick="reportTab='performance';renderReports()">PERFORMANCE</button>
      <button class="rtab ${reportTab==='live'?'active':''}" onclick="reportTab='live';renderReports();if(!liveSessionSub&&db)startSessionListener();"><span class="live-dot" style="display:${liveUnsubscribe?'inline-block':'none'}"></span>LIVE</button>
      <button class="rtab ${reportTab==='fuel'?'active':''}" onclick="reportTab='fuel';renderReports()"> FUEL</button>
    </div>
    <div id="rsect-overview" class="rsect ${reportTab==='overview'?'active':''}">
      <div class="card" style="padding:13px;margin-bottom:11px">
        <div class="stitle2" style="margin-bottom:9px"> FILTER REPORTS</div>
        <div class="fchips">${['all','today','week','month'].map(f=>`<div class="fchip ${reportFilter===f?'active':''}" onclick="reportFilter='${f}';renderReports()">${f==='all'?'ALL TIME':f.toUpperCase()}</div>`).join('')}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px">
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">BY CAR</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterCar=this.value;renderReports()">
              <option value="">All Cars</option>${allCars.map(c=>`<option value="${c}" ${filterCar===c?'selected':''}>${c}</option>`).join('')}</select></div>
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">BY DRIVER</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterDriver=this.value;renderReports()">
              <option value="">All Drivers</option>${allDrivers.map(d=>`<option value="${d}" ${filterDriver===d?'selected':''}>${d.split(' ')[0]}</option>`).join('')}</select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">FROM</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterFrom=this.value;renderReports()">
              <option value="">Any</option>${allStations.map(s=>`<option value="${s}" ${filterFrom===s?'selected':''}>${s}</option>`).join('')}</select></div>
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">TO</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterTo=this.value;renderReports()">
              <option value="">Any</option>${allStations.map(s=>`<option value="${s}" ${filterTo===s?'selected':''}>${s}</option>`).join('')}</select></div>
        </div>
        ${activeTags.length?`<div style="margin-top:9px;display:flex;flex-wrap:wrap;gap:4px">${activeTags.map(t=>`<div class="tag-active">${t.l} <span onclick="${t.c}"></span></div>`).join('')}</div>`:''}
        <div style="margin-top:10px;padding:10px 12px;background:var(--accent);display:flex;justify-content:space-between;align-items:center">
          <div style="font-family:var(--font-m);font-size:.48rem;color:rgba(255,255,255,.7);letter-spacing:1px">MATCHING TRIPS</div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <span style="font-family:var(--font-d);font-size:1.5rem;color:#fff;letter-spacing:2px">${filtered.length}</span>
            <span style="font-family:var(--font-m);font-size:.52rem;color:rgba(255,255,255,.7)"> KES ${total.toLocaleString()}</span>
          </div>
        </div>
      </div>
      ${filtered.length===0?'<div class="empty">NO RESULTS<br>TRY DIFFERENT FILTERS OR SYNC</div>':`
      <div class="rtable">
        <div class="rth"><span>ROUTE</span><span>DRIVER</span><span>DATE</span><span>AMOUNT</span></div>
        ${filtered.slice(0,80).map(t=>`<div class="rtr">
          <div><div class="trroute">${(t.fromStation||'').slice(0,7)}${(t.toStation||'').slice(0,7)}</div><div style="font-family:var(--font-m);font-size:.43rem;color:var(--muted)">${t.carPlate||''}</div></div>
          <div style="font-size:.64rem;color:var(--muted)">${(t.driver||'').split(' ')[0]}</div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted)">${(t.date||'').slice(0,10)}</div>
          <div class="tramt">KES ${Number(t.amount||0).toLocaleString()}</div>
        </div>`).join('')}
      </div>
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-align:center;padding:6px">SHOWING ${Math.min(80,filtered.length)} OF ${filtered.length}</div>`}
      ${renderCarBars(filtered,total)}
    </div>
    <div class="rsect ${reportTab==='charts'?'active':''}">
      <!-- Standard charts -->
      <div class="chart-wrap"><div class="chart-title">DAILY REVENUE  30 DAYS</div><div class="chart-canvas"><canvas id="chartDaily"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">WEEKLY COMPARISON</div><div class="chart-canvas"><canvas id="chartWeekly"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">REVENUE BY CAR  TOTAL SHARE</div><div class="chart-canvas"><canvas id="chartCars"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">DAILY TRIPS  14 DAYS</div><div class="chart-canvas"><canvas id="chartTrips"></canvas></div></div>

      <!-- Trend charts with filter -->
      <div class="card" style="padding:13px;margin-bottom:11px">
        <div class="chart-title" style="margin-bottom:10px"> REVENUE TREND FILTER</div>

        <!-- Type toggle -->
        <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px">VIEW BY</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
          <div class="fchip ${chartTrendType==='driver'?'active':''}"
            onclick="chartTrendType='driver';chartTrendEntity='';renderReports();setTimeout(renderCharts,60)"> DRIVER</div>
          <div class="fchip ${chartTrendType==='car'?'active':''}"
            onclick="chartTrendType='car';chartTrendEntity='';renderReports();setTimeout(renderCharts,60)"> CAR</div>
        </div>

        <!-- Entity selector -->
        <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px">
          ${chartTrendType==='driver'?'SELECT DRIVER (BLANK = ALL)':'SELECT CAR (BLANK = ALL)'}
        </div>
        <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.82rem;outline:none;appearance:none;margin-bottom:10px"
          onchange="chartTrendEntity=this.value;renderCharts()">
          <option value=""> ${chartTrendType==='driver'?'All Drivers (compare top 6)':'All Cars (compare top 6)'} </option>
          ${chartTrendType==='driver'
            ? [...new Set(allData().map(t=>t.driver).filter(Boolean))].sort().map(d=>`<option value="${d}" ${chartTrendEntity===d?'selected':''}>${d}</option>`).join('')
            : [...new Set(allData().map(t=>t.carPlate).filter(Boolean))].sort().map(car=>`<option value="${car}" ${chartTrendEntity===car?'selected':''}>${car}</option>`).join('')
          }
        </select>

        <!-- Period toggle -->
        <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:5px">PERIOD</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
          <div class="fchip ${chartTrendPeriod==='14'?'active':''}"
            onclick="chartTrendPeriod='14';renderCharts()">14 DAYS</div>
          <div class="fchip ${chartTrendPeriod==='30'?'active':''}"
            onclick="chartTrendPeriod='30';renderCharts()">30 DAYS</div>
          <div class="fchip ${chartTrendPeriod==='weekly'?'active':''}"
            onclick="chartTrendPeriod='weekly';renderCharts()">WEEKLY</div>
        </div>
      </div>

      <!-- Driver trend chart -->
      <div class="chart-wrap" style="${chartTrendType==='driver'?'':'display:none'}">
        <div class="chart-title">
          REVENUE TREND  ${chartTrendEntity?chartTrendEntity:'TOP DRIVERS'}
          <span style="font-size:.44rem;color:var(--muted);font-family:var(--font-b);letter-spacing:0;font-weight:400;margin-left:6px">
            ${chartTrendPeriod==='weekly'?'WEEKLY  12 WEEKS':chartTrendPeriod+' DAYS'}
          </span>
        </div>
        <div class="chart-canvas" style="height:220px"><canvas id="chartDriverTrend"></canvas></div>
      </div>

      <!-- Car trend chart -->
      <div class="chart-wrap" style="${chartTrendType==='car'?'':'display:none'}">
        <div class="chart-title">
          REVENUE TREND  ${chartTrendEntity?chartTrendEntity:'ALL CARS'}
          <span style="font-size:.44rem;color:var(--muted);font-family:var(--font-b);letter-spacing:0;font-weight:400;margin-left:6px">
            ${chartTrendPeriod==='weekly'?'WEEKLY  12 WEEKS':chartTrendPeriod+' DAYS'}
          </span>
        </div>
        <div class="chart-canvas" style="height:220px"><canvas id="chartCarTrend"></canvas></div>
      </div>
    </div>
    <div class="rsect ${reportTab==='leaderboard'?'active':''}">${renderLeaderboard(filtered)}</div>
    <div class="rsect ${reportTab==='performance'?'active':''}">${renderPerformance(all)}</div>
    <div id="rsect-live" class="rsect ${reportTab==='live'?'active':''}" ></div>
  <div id="rsect-fuel" class="rsect ${reportTab==='fuel'?'active':''}" ></div>`;
  if(reportTab==='live')setTimeout(renderLiveTab,0);
  if(reportTab==='fuel')setTimeout(renderFuelTab,0);
}

// 
// RENDER FUEL / ODOMETER TAB
// 
function renderFuelTab(){
  const el = document.getElementById('rsect-fuel');
  if(!el) return;
  const all = allData();

  // Trips with valid odometer distance
  const odomTrips   = all.filter(t => t.distance && t.distance > 0);
  // Trips where fuel was added
  const fuelTrips   = all.filter(t => t.refueled && t.fuelLiters > 0 && t.fuelCost > 0);
  // Trips with both distance AND fuel (efficiency computable)
  const effTrips    = all.filter(t => t.fuelEfficiency && t.fuelEfficiency > 0);
  // Trips where odometer broken
  const noOdomTrips = all.filter(t => t.odomWorking === false);

  const allCars    = [...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const allDrivers = [...new Set(all.map(t=>t.driver).filter(Boolean))].sort();

  // Fleet totals
  const totalLitres   = fuelTrips.reduce((s,t)=>s+(t.fuelLiters||0),0);
  const totalFuelCost = fuelTrips.reduce((s,t)=>s+(t.fuelCost||0),0);
  const totalKm       = odomTrips.reduce((s,t)=>s+(t.distance||0),0);
  const fleetEff      = effTrips.length
    ? (effTrips.reduce((s,t)=>s+t.fuelEfficiency,0)/effTrips.length).toFixed(2) : null;
  const capRate       = all.length ? Math.round((odomTrips.length/all.length)*100) : 0;

  // Per-car stats
  const carStats = allCars.map(car=>{
    const cFuel = fuelTrips.filter(t=>t.carPlate===car);
    const cOdom = odomTrips.filter(t=>t.carPlate===car);
    const cEff  = effTrips.filter(t=>t.carPlate===car);
    const litres    = cFuel.reduce((s,t)=>s+(t.fuelLiters||0),0);
    const fuelCost  = cFuel.reduce((s,t)=>s+(t.fuelCost||0),0);
    const km        = cOdom.reduce((s,t)=>s+(t.distance||0),0);
    const avgEff    = cEff.length?(cEff.reduce((s,t)=>s+t.fuelEfficiency,0)/cEff.length).toFixed(2):null;
    const costPerKm = (fuelCost&&km)?(fuelCost/km).toFixed(1):null;
    const lastOdom  = [...cOdom].sort((a,b)=>b.dateMs-a.dateMs)[0]?.odomEnd;
    const noOdom    = noOdomTrips.filter(t=>t.carPlate===car).length;
    const allCarT   = all.filter(t=>t.carPlate===car).length;
    const capR      = allCarT?Math.round((cOdom.length/allCarT)*100):0;
    const fuelEvents= cFuel.length;
    return{car,litres,fuelCost,km,avgEff,costPerKm,lastOdom,noOdom,capR,fuelEvents,effCount:cEff.length};
  }).filter(s=>s.km>0||s.litres>0||s.noOdom>0);

  // Per-driver stats
  const driverStats = allDrivers.map(driver=>{
    const dFuel = fuelTrips.filter(t=>t.driver===driver);
    const dOdom = odomTrips.filter(t=>t.driver===driver);
    const dEff  = effTrips.filter(t=>t.driver===driver);
    const litres   = dFuel.reduce((s,t)=>s+(t.fuelLiters||0),0);
    const fuelCost = dFuel.reduce((s,t)=>s+(t.fuelCost||0),0);
    const km       = dOdom.reduce((s,t)=>s+(t.distance||0),0);
    const avgEff   = dEff.length?(dEff.reduce((s,t)=>s+t.fuelEfficiency,0)/dEff.length).toFixed(2):null;
    return{driver,litres,fuelCost,km,avgEff,fuelEvents:dFuel.length};
  }).filter(s=>s.km>0||s.litres>0);

  // Recent fuel log (last 20 fuel events)
  const recentFuel = fuelTrips.sort((a,b)=>b.dateMs-a.dateMs).slice(0,20);
  // Skip log
  const skipLog    = all.filter(t=>t.odomWorking===false&&t.odomSkipReason)
    .sort((a,b)=>b.dateMs-a.dateMs).slice(0,15);

  function effColor(v){ return v>=10?'#22c55e':v>=7?'#f59e0b':'var(--red)'; }
  function effLabel(v){ return v>=10?'GOOD':v>=7?'AVG':'POOR'; }

  el.innerHTML = `
    <!--  FLEET SUMMARY  -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px">
      <div class="live-stat" style="grid-column:1/-1">
        <div class="lsl">FLEET FUEL COST (ALL TIME)</div>
        <div class="lsv" style="font-size:1.1rem;color:#f59e0b">KES ${totalFuelCost.toLocaleString()}</div>
      </div>
      <div class="live-stat"><div class="lsl">TOTAL LITRES</div><div class="lsv" style="color:#f59e0b">${totalLitres.toFixed(1)}L</div></div>
      <div class="live-stat"><div class="lsl">TOTAL KM TRACKED</div><div class="lsv">${(totalKm/1000).toFixed(1)}K</div></div>
      <div class="live-stat"><div class="lsl">FLEET AVG EFFICIENCY</div>
        <div class="lsv" style="color:${fleetEff?effColor(parseFloat(fleetEff)):'var(--muted)'}">${fleetEff||''}<span style="font-size:.7rem;font-family:var(--font-b);color:var(--muted)"> KM/L</span></div>
      </div>
      <div class="live-stat"><div class="lsl">ODOM CAPTURE RATE</div>
        <div class="lsv" style="color:${capRate>=80?'#22c55e':capRate>=50?'#f59e0b':'var(--red)'}">${capRate}%</div>
      </div>
    </div>

    <!--  BY CAR  -->
    <div class="stitle2" style="margin-bottom:8px"> FUEL EFFICIENCY BY CAR</div>
    ${carStats.length ? carStats.sort((a,b)=>parseFloat(b.avgEff||0)-parseFloat(a.avgEff||0)).map(s=>`
      <div class="fuel-stat">
        <div class="fuel-stat-top">
          <span class="fuel-stat-car">${s.car}</span>
          <div style="text-align:right">
            ${s.avgEff?`<span class="fuel-stat-km" style="color:${effColor(parseFloat(s.avgEff))}">${s.avgEff}<span style="font-size:.65rem;font-family:var(--font-b);color:var(--muted)"> KM/L</span></span>`
            :`<span style="font-family:var(--font-m);font-size:.52rem;color:var(--muted)">NO EFF DATA</span>`}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:7px">
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">TOTAL KM</div><div style="font-size:.72rem;font-family:var(--font-m)">${s.km.toLocaleString()}</div></div>
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">LITRES</div><div style="font-size:.72rem;font-family:var(--font-m)">${s.litres.toFixed(1)}</div></div>
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">FUEL COST</div><div style="font-size:.72rem;font-family:var(--font-m)">KES ${(s.fuelCost/1000).toFixed(1)}K</div></div>
          <div><div style="font-size:.42rem;color:var(--muted);font-family:var(--font-m);letter-spacing:1px">KES/KM</div><div style="font-size:.72rem;font-family:var(--font-m)">${s.costPerKm||''}</div></div>
        </div>
        ${s.lastOdom?`<div style="font-size:.5rem;color:var(--muted);font-family:var(--font-m);margin-bottom:4px">LAST READING: <strong style="color:var(--text)">${Number(s.lastOdom).toLocaleString()} KM</strong>  CAPTURE RATE: <strong style="color:${s.capR>=80?'#22c55e':'#f59e0b'}">${s.capR}%</strong></div>`:''}
        ${s.avgEff?`<div style="height:5px;background:var(--border);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(100,(parseFloat(s.avgEff)/15)*100)}%;background:${effColor(parseFloat(s.avgEff))};border-radius:3px;transition:width 1s"></div></div>`:''}
        ${s.noOdom>0?`<div class="fuel-warn" style="margin-top:6px;margin-bottom:0"> ${s.noOdom} TRIP${s.noOdom>1?'S':''} WITH ODOMETER NOT WORKING</div>`:''}
      </div>`).join('')
    : `<div style="text-align:center;padding:24px;color:var(--muted);font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;line-height:2">NO FUEL DATA YET<br>DRIVERS MUST TOGGLE "REFUEL" WHEN ADDING FUEL</div>`}

    <!--  BY DRIVER  -->
    ${driverStats.length?`
    <div class="stitle2" style="margin:12px 0 8px"> EFFICIENCY BY DRIVER</div>
    ${driverStats.filter(s=>s.avgEff).sort((a,b)=>parseFloat(b.avgEff)-parseFloat(a.avgEff)).map((s,i)=>`
      <div style="background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:6px;display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center">
        <div style="font-family:var(--font-d);font-size:1.3rem;color:${i===0?'#f0a500':i===1?'var(--muted)':i===2?'#cd7f32':'var(--border)'}">${i+1}</div>
        <div>
          <div style="font-family:var(--font-m);font-size:.62rem;font-weight:600">${s.driver}</div>
          <div style="font-size:.5rem;color:var(--muted)">${s.km.toLocaleString()} km  ${s.litres.toFixed(1)}L  ${s.fuelEvents} fill-up${s.fuelEvents!==1?'s':''}</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:var(--font-d);font-size:1.25rem;color:${effColor(parseFloat(s.avgEff))}">${s.avgEff}</div>
          <div style="font-family:var(--font-m);font-size:.42rem;color:var(--muted)">KM/L</div>
        </div>
      </div>`).join('')}`:''}

    <!--  RECENT FUEL LOG  -->
    ${recentFuel.length?`
    <div class="stitle2" style="margin:12px 0 8px"> RECENT FUEL EVENTS</div>
    ${recentFuel.map(t=>`
      <div style="background:var(--card);border:1px solid var(--border);border-left:3px solid #f59e0b;padding:9px 12px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-family:var(--font-m);font-size:.6rem;font-weight:700;color:#f59e0b"> ${t.fuelLiters}L  KES ${Number(t.fuelCost).toLocaleString()}</span>
          <span style="font-size:.5rem;color:var(--muted)">${t.date||''} ${t.time||''}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.58rem">
          <span><strong style="color:var(--text)">${t.driver?t.driver.split(' ')[0]:''}</strong>  <span style="color:var(--accent)">${t.carPlate||''}</span>${t.fuelStation?`  ${t.fuelStation}`:''}</span>
          ${t.fuelEfficiency?`<span style="font-family:var(--font-m);font-size:.56rem;font-weight:700;color:${effColor(t.fuelEfficiency)}"> ${t.fuelEfficiency} KM/L</span>`:''}
        </div>
        ${t.distance?`<div style="font-size:.5rem;color:var(--muted);margin-top:2px">${t.fromStation||'?'}  ${t.toStation||'?'}  ${t.distance} km${t.fuelCostPerKm?`  KES ${t.fuelCostPerKm}/km`:''}</div>`:''}
      </div>`).join('')}`:''}

    <!--  ODOMETER SKIP LOG  -->
    ${skipLog.length?`
    <div class="stitle2" style="margin:12px 0 8px"> ODOMETER SKIP LOG</div>
    ${skipLog.map(t=>`
      <div style="background:var(--card);border:1px solid var(--border);border-left:3px solid var(--red);padding:9px 12px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
          <span style="font-family:var(--font-m);font-size:.58rem;font-weight:600">${t.driver?t.driver.split(' ')[0]:''}  <span style="color:var(--accent)">${t.carPlate||''}</span></span>
          <span style="font-size:.5rem;color:var(--muted)">${t.date||''}</span>
        </div>
        <div style="font-size:.64rem;color:var(--text)">${t.odomSkipReason}</div>
        <div style="font-size:.5rem;color:var(--muted);margin-top:2px">${t.fromStation||'?'}  ${t.toStation||'?'}</div>
      </div>`).join('')}`:''}
  `;
}

function renderCarBars(filtered,total){
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  if(!cars.length)return'';
  const today=new Date().toLocaleDateString('en-GB');
  return`<div class="stitle2" style="margin-bottom:9px;margin-top:4px">REVENUE BY CAR</div>
  ${cars.map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car),cr=ct.reduce((s,t)=>s+t.amount,0),pct=total?Math.round((cr/total)*100):0;
    const todayRev=localTrips.filter(t=>t.carPlate===car&&t.date===today).reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car],tpct=target?Math.min(100,Math.round((todayRev/target)*100)):null;
    return`<div class="hitem" style="margin-bottom:7px;cursor:pointer" onclick="filterCar=filterCar==='${car}'?'':'${car}';renderReports()">
      <div class="htop"><span class="hroute">${car}${shifts[car]?.open===false?' <span style=\\"background:var(--red);color:#fff;font-size:.42rem;padding:1px 5px\\">CLOSED</span>':''}</span><span class="hamt">KES ${cr.toLocaleString()}</span></div>
      <div class="bar-mini"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="hbot" style="margin-top:4px"><span>${ct.length} trips  ${pct}% of total</span>${target?`<span style="color:${tpct>=100?'#22c55e':tpct>=50?'var(--accent2)':'var(--red)'}">TODAY ${tpct}%</span>`:''}</div>
    </div>`;
  }).join('')}`;
}

function renderLeaderboard(filtered){
  if(!filtered.length)return'<div class="empty">NO DATA<br>SYNC FROM FIREBASE OR LOG TRIPS</div>';
  const dm={};filtered.forEach(t=>{const d=t.driver||'?';if(!dm[d])dm[d]={trips:0,revenue:0};dm[d].trips++;dm[d].revenue+=t.amount||0;});
  const dr=Object.entries(dm).sort((a,b)=>b[1].revenue-a[1].revenue);
  const mr=dr[0]?.[1].revenue||1;
  const cm={};filtered.forEach(t=>{const c=t.carPlate||'?';if(!cm[c])cm[c]={trips:0,revenue:0};cm[c].trips++;cm[c].revenue+=t.amount||0;});
  const cr=Object.entries(cm).sort((a,b)=>b[1].revenue-a[1].revenue);
  return`
    <div class="stitle2" style="margin-bottom:9px"> TOP DRIVERS BY REVENUE</div>
    ${dr.slice(0,7).map(([name,data],i)=>{
      const dt=driverTargets[name];
      const today=new Date().toLocaleDateString('en-GB');
      const todayRev=filtered.filter(t=>t.driver===name&&t.date===today).reduce((s,t)=>s+t.amount,0);
      const tpct=dt?Math.min(100,Math.round((todayRev/dt)*100)):null;
      return`<div class="lb-item">
        <div class="lb-rank ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
        <div style="flex:1;min-width:0">
          <div class="lb-name">${name.split(' ')[0]} ${name.split(' ')[1]||''}</div>
          <div class="lb-sub">${data.trips} trips${dt?'   KES '+Number(dt).toLocaleString():''}</div>
          <div class="bar-mini" style="width:90%"><div class="bar-fill" style="width:${Math.round((data.revenue/mr)*100)}%"></div></div>
          ${dt?`<div class="target-bar" style="margin-top:3px;width:90%"><div class="target-fill ${tpct>=100?'high':tpct>=50?'mid':'low'}" style="width:${tpct}%"></div></div>
          <div style="font-family:var(--font-m);font-size:.42rem;color:var(--muted);margin-top:2px">TODAY ${tpct}% OF DAILY TARGET</div>`:''}
        </div>
        <div><div class="lb-val">KES ${(data.revenue/1000).toFixed(1)}K</div><div class="lb-vsub">KES ${data.trips?Math.round(data.revenue/data.trips).toLocaleString():''}/trip</div></div>
      </div>`;
    }).join('')}
    <div class="stitle2" style="margin-bottom:9px;margin-top:14px"> TOP CARS BY REVENUE</div>
    ${cr.map(([plate,data],i)=>`<div class="lb-item">
      <div class="lb-rank ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
      <div><div class="lb-name">${plate}</div><div class="lb-sub">${data.trips} trips</div>
      <div class="bar-mini" style="width:80%"><div class="bar-fill" style="width:${Math.round((data.revenue/(cr[0][1].revenue||1))*100)}%"></div></div></div>
      <div><div class="lb-val">KES ${(data.revenue/1000).toFixed(1)}K</div><div class="lb-vsub">${data.trips?Math.round(data.revenue/data.trips).toLocaleString():''}/trip</div></div>
    </div>`).join('')}`;
}

function renderPerformance(all){
  if(!all.length)return'<div class="empty">NO DATA<br>SYNC FROM FIREBASE OR LOG TRIPS</div>';
  const drivers=[...new Set(all.map(t=>t.driver).filter(Boolean))];
  const allAvgs=drivers.map(d=>{const dt=all.filter(t=>t.driver===d);return dt.length?dt.reduce((s,t)=>s+t.amount,0)/dt.length:0;});
  const maxAvg=Math.max(...allAvgs)||1;
  const allDays=drivers.map(d=>[...new Set(all.filter(t=>t.driver===d).map(t=>t.date))].length);
  const maxDays=Math.max(...allDays)||1;
  const allTrips=drivers.map(d=>all.filter(t=>t.driver===d).length);
  const maxTrips=Math.max(...allTrips)||1;
  return drivers.map((driver,di)=>{
    const dtrips=all.filter(t=>t.driver===driver);
    const rev=dtrips.reduce((s,t)=>s+t.amount,0);
    const avg=dtrips.length?Math.round(rev/dtrips.length):0;
    const days=[...new Set(dtrips.map(t=>t.date))].length;
    const bestDay=dtrips.reduce((best,t)=>{const dr=dtrips.filter(x=>x.date===t.date).reduce((s,x)=>s+x.amount,0);return dr>best?dr:best;},0);
    const score=Math.round((allAvgs[di]/maxAvg)*50+(allDays[di]/maxDays)*30+(allTrips[di]/maxTrips)*20);
    const grade=score>=80?'A':score>=60?'B':'C';
    return`<div class="perf-card">
      <div class="perf-name">${driver.split(' ')[0]} ${driver.split(' ')[1]||''} <span class="score-badge score-${grade.toLowerCase()}">${grade}</span></div>
      <div class="perf-grid">
        <div class="pstat"><div class="pl">TOTAL TRIPS</div><div class="pv">${dtrips.length}</div></div>
        <div class="pstat"><div class="pl">REVENUE</div><div class="pv" style="font-size:.85rem">KES ${(rev/1000).toFixed(1)}K</div></div>
        <div class="pstat"><div class="pl">AVG/TRIP</div><div class="pv" style="font-size:.85rem">KES ${avg.toLocaleString()}</div></div>
        <div class="pstat"><div class="pl">DAYS ACTIVE</div><div class="pv">${days}</div></div>
        <div class="pstat"><div class="pl">BEST DAY</div><div class="pv" style="font-size:.85rem">KES ${bestDay.toLocaleString()}</div></div>
        <div class="pstat"><div class="pl">SCORE</div><div class="pv">${score}/100</div></div>
      </div>
      <div style="margin-top:9px"><div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);margin-bottom:4px">PERFORMANCE SCORE</div>
      <div class="target-bar"><div class="target-fill ${score>=80?'high':score>=60?'mid':'low'}" style="width:${score}%"></div></div></div>
    </div>`;
  }).join('');
}

// 
// RENDER ADMIN
// 
function renderAdmin(){
  const el=document.getElementById('page-admin');
  if(!adminUnlocked){
    const locked=isAdminLocked();
    el.innerHTML=`
      <div class="apinbox">
        <div class="apintitle">ADMIN ACCESS</div>
        <div class="apinsub">ENTER PIN TO MANAGE SHIFTS,<br>STATIONS, DRIVERS & SETTINGS</div>
        ${locked?`<div class="pin-locked"> TOO MANY ATTEMPTS<br>TRY AGAIN IN ${adminLockSecsLeft()}s</div>`:''}
        <input type="password" class="pininput" id="pinIn" maxlength="6" placeholder=""
          ${locked?'disabled':''} onkeydown="if(event.key==='Enter')checkPin()">
        <button class="bb bstart" style="max-width:200px;margin:0 auto;display:block"
          onclick="checkPin()" ${locked?'disabled':''}>UNLOCK</button>
        <div style="margin-top:14px">
          <button class="bghost" style="font-size:.48rem;letter-spacing:1px;padding:5px 12px;border:none;color:var(--muted)"
            onclick="openResetOverlay()"> FORGOT PIN?</button>
        </div>
      </div>`;
    return;
  }
  const adminName = (currentDriverDoc?.name||'ADMIN').split(' ')[0];
  const saccoLabel = currentDriverDoc?.saccoName || appConfig.saccoName || 'SACCO';
  el.innerHTML=`
    <div class="card" style="border-left:4px solid var(--accent2);margin-bottom:10px;padding:12px 14px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="ctitle" style="margin:0;font-size:1rem">${saccoLabel}</div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;margin-top:2px"> ${adminName}  ADMIN PANEL</div>
        </div>
        <button class="bghost" style="color:var(--red);border-color:var(--red);font-size:.52rem;padding:7px 10px" onclick="authLogout()"> LOG OUT</button>
      </div>
    </div>
    <div class="atabs">
      <button class="atab ${adminTab==='shifts'?'active':''}" onclick="adminTab='shifts';renderAdmin()">SHIFTS</button>
      <button class="atab ${adminTab==='drivers'?'active':''}" onclick="adminTab='drivers';renderAdmin();setTimeout(loadRegisteredDrivers,100)">DRIVERS</button>
      <button class="atab ${adminTab==='cars'?'active':''}" onclick="adminTab='cars';renderAdmin()">CARS</button>
      <button class="atab ${adminTab==='stations'?'active':''}" onclick="adminTab='stations';renderAdmin()">STATIONS</button>
      <button class="atab ${adminTab==='trips'?'active':''}" onclick="adminTab='trips';renderAdmin()">TRIPS</button>
      <button class="atab ${adminTab==='config'?'active':''}" onclick="openDevTab('config')"
        style="${adminTab==='config'?'':''}">
        CONFIG <span style="font-size:.38rem;opacity:.6"></span>
      </button>
      <button class="atab ${adminTab==='settings'?'active':''}" onclick="openDevTab('settings')"
        style="${adminTab==='settings'?'color:var(--red);border-bottom-color:var(--red)':'color:var(--red);opacity:.7'}">
         DEV <span style="font-size:.38rem;opacity:.6"></span>
      </button>
    </div>

    <!-- SHIFTS -->
    <div class="asect ${adminTab==='shifts'?'active':''}">
      <div class="card">
        <div class="ctitle">SHIFT MANAGEMENT</div>
        <div class="csub">// OPEN OR CLOSE SHIFTS PER CAR  CLOSED CARS CANNOT LOG TRIPS</div>
        ${CARS.map(car=>{
          const s=shifts[car];
          const isOpen=s?.open===true;
          const isClosed=s?.open===false;
          const openTime=s?.openedAt?new Date(s.openedAt).toLocaleTimeString():'';
          return`<div class="aitem" style="margin-bottom:8px">
            <div style="flex:1">
              <div class="aitem-name">${car}</div>
              <div class="aitem-sub">
                ${isOpen?`<span class="shift-open"> OPEN</span> since ${openTime} by ${s.openedBy||'?'}`
                :isClosed?`<span class="shift-closed"> CLOSED</span> at ${s?.closedAt?new Date(s.closedAt).toLocaleTimeString():''}`
                :'<span style="font-family:var(--font-m);font-size:.52rem;color:var(--muted)">NO SHIFT SET</span>'}
              </div>
            </div>
            <div class="abtn-row">
              ${!isOpen?`<button class="bsm bg" onclick="openShift('${car}')">OPEN</button>`:''}
              ${isOpen?`<button class="bsm br" onclick="showCloseShiftSummary('${car}')">CLOSE</button>`:''}
            </div>
          </div>`;
        }).join('')}
        <div class="divline"></div>
        <div style="display:flex;gap:7px">
          <button class="bsm bg" style="flex:1;padding:10px" onclick="openAllShifts()">OPEN ALL</button>
          <button class="bsm br" style="flex:1;padding:10px" onclick="closeAllShifts()">CLOSE ALL</button>
        </div>
      </div>
    </div>

    <!-- DRIVERS -->
    <div class="asect ${adminTab==='drivers'?'active':''}">

      <!-- ONBOARDING BANNER  shown only on first login when no drivers yet -->
      ${isFirstAdminLogin ? `
      <div class="onboard-banner">
        <div class="onboard-banner-ico"></div>
        <div class="onboard-banner-text">
          <div class="onboard-banner-title">YOUR SACCO IS SET UP!</div>
          <div class="onboard-banner-sub">
            Now invite your drivers. They'll receive an email with a link to join.<br>
            Once registered, each driver logs in with their own account.
          </div>
        </div>
      </div>` : ''}

      <!-- REGISTER NEW DRIVER -->
      <div class="card" style="border-top:4px solid var(--accent2);margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
          <div class="ctitle" style="color:var(--accent2);margin:0"> INVITE A DRIVER</div>
        </div>
        <div class="csub" style="margin-bottom:14px">// DRIVER RECEIVES AN EMAIL WITH A LOGIN LINK  NO PASSWORD NEEDED FROM YOU</div>
        <div id="regDriverError" style="display:none;background:var(--rlight);border:1px solid var(--red);color:var(--red);font-family:var(--font-m);font-size:.52rem;padding:9px 11px;letter-spacing:1px;margin-bottom:10px;line-height:1.6"></div>
        <div id="regDriverSuccess" style="display:none;margin-bottom:10px"></div>
        <div class="field"><label>Driver's Full Name</label>
          <input type="text" id="regDName" placeholder="e.g. JOHN KAMAU" style="text-transform:uppercase"
            onkeydown="if(event.key==='Enter')document.getElementById('regDEmail').focus()">
        </div>
        <div class="field"><label>Driver's Email Address</label>
          <input type="email" id="regDEmail" placeholder="driver@gmail.com"
            onkeydown="if(event.key==='Enter')document.getElementById('regDPhone').focus()">
        </div>
        <div class="field"><label>Phone Number <span style="color:var(--muted);font-size:.44rem">(optional)</span></label>
          <input type="tel" id="regDPhone" placeholder="e.g. 0712 345678"
            onkeydown="if(event.key==='Enter')document.getElementById('regDCar').focus()">
        </div>
        <div class="field"><label>Assign Car Plate <span style="color:var(--muted);font-size:.44rem">(optional)</span></label>
          <select id="regDCar">
            <option value=""> Assign Car (optional) </option>
            ${CARS.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>
        </div>
        <button class="bb bstart" style="margin:0;background:var(--accent2);border-color:var(--accent2)" id="regDBtn" onclick="adminRegisterDriver()">
           SEND INVITATION
        </button>
        <div style="font-family:var(--font-m);font-size:.44rem;color:var(--muted);text-align:center;margin-top:8px;letter-spacing:1px;line-height:1.8">
          THE DRIVER CLICKS THE LINK IN THEIR EMAIL<br>SETS THEIR OWN PASSWORD AND LOGS IN
        </div>
      </div>

      <!-- REGISTERED DRIVERS LIST -->
      <div class="card">
        <div class="ctitle">REGISTERED DRIVERS <span class="pill" id="regDriverCount"></span></div>
        <div class="csub">// RESET PASSWORDS  DISABLE ACCOUNTS  VIEW ASSIGNMENTS</div>
        <div id="regDriverList">
          <div style="text-align:center;padding:20px;font-family:var(--font-m);font-size:.54rem;color:var(--muted)">
            CLICK REFRESH TO LOAD DRIVERS
          </div>
        </div>
        <div style="margin-top:10px">
          <button class="bsm bg" style="width:100%;padding:10px" onclick="loadRegisteredDrivers()"> LOAD / REFRESH DRIVERS</button>
        </div>
      </div>

      <!-- DAILY TARGETS -->
      <div class="card" style="margin-top:12px">
        <div class="ctitle">DAILY REVENUE TARGETS</div>
        <div class="csub">// SET KES TARGETS PER DRIVER</div>
        ${DRIVERS.map((d,i)=>{
          const esc=d.replace(/'/g,"\'");
          const target=driverTargets[d];
          return`<div class="aitem" style="flex-direction:column;align-items:stretch;gap:8px;padding:12px">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div><div class="aitem-name">${d}</div></div>
              <div class="abtn-row"><button class="adel" onclick="removeDriver(${i})"></button></div>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);white-space:nowrap;letter-spacing:1px">DAILY TARGET KES</div>
              <input type="number" id="dt_${i}" placeholder="e.g. 5000" value="${target||''}"
                style="flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:7px 9px;font-family:var(--font-m);font-size:.78rem;outline:none;min-width:0"
                onkeydown="if(event.key==='Enter')saveDriverTarget('${esc}',${i})">
              <button class="bsm bg" onclick="saveDriverTarget('${esc}',${i})">SET</button>
              ${target?`<button class="bsm br" onclick="removeDriverTarget('${esc}')"></button>`:''}
            </div>
          </div>`;
        }).join('')}
      </div>

    </div>

    <!-- CARS -->
    <div class="asect ${adminTab==='cars'?'active':''}">
      <div class="card">
        <div class="ctitle">CARS <span class="pill">${CARS.length}</span></div>
        ${CARS.map((c,i)=>`<div class="aitem">
          <div><div class="aitem-name">${c}</div><div class="aitem-sub">Target: ${carTargets[c]?'KES '+Number(carTargets[c]).toLocaleString():'Not set'}</div></div>
          <div class="abtn-row">
            <button class="aedit" onclick="adminSetTarget('${c}')"></button>
            <button class="adel" onclick="removeCar(${i})"></button>
          </div>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Car Plate</label><input type="text" id="newCar" placeholder="e.g. KCA 123A"></div>
          <button class="bsm bg" onclick="addCar()">ADD</button>
        </div>
      </div>
    </div>

    <!-- STATIONS -->
    <div class="asect ${adminTab==='stations'?'active':''}">
      <div class="card">
        <div class="ctitle">STATIONS <span class="pill">${STATIONS.length}</span></div>
        ${STATIONS.map((s,i)=>`<div class="aitem">
          <div>
            <div class="aitem-name">${s.name}</div>
            <div class="aitem-sub">${s.lat?`${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}`:'No GPS'}</div>
          </div>
          <button class="adel" onclick="removeStation(${i})"></button>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="field"><label>Station Name</label><input type="text" id="newStn" placeholder="STATION NAME IN CAPS"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:8px">
          <div class="field" style="margin:0"><label>Latitude</label><input type="number" id="newLat" placeholder="-1.2833" step="any"></div>
          <div class="field" style="margin:0"><label>Longitude</label><input type="number" id="newLng" placeholder="36.8167" step="any"></div>
        </div>
        <button class="bsm bg" style="width:100%;padding:10px" onclick="addStation()">ADD STATION</button>
      </div>
    </div>

    <!-- TRIPS -->
    <div class="asect ${adminTab==='trips'?'active':''}">
      <div class="card">
        <div class="ctitle">LOCAL TRIPS <span class="pill">${localTrips.length}</span></div>
        <div class="csub">// EDIT OR DELETE LOCAL TRIP RECORDS</div>
        ${localTrips.length===0?'<div class="empty">NO LOCAL TRIPS</div>':localTrips.slice(0,30).map(t=>`
          <div class="aitem" style="margin-bottom:7px">
            <div style="flex:1">
              <div class="aitem-name" style="font-size:.6rem">${t.fromStation}  ${t.toStation}</div>
              <div class="aitem-sub">${t.driver}  ${t.carPlate}  KES ${t.amount}  ${t.date}</div>
              ${t.notes?`<div class="aitem-sub"> ${t.notes}</div>`:''}
            </div>
            <div class="abtn-row">
              <button class="aedit" onclick="openEditTrip(${t.id})"></button>
              <button class="adel" onclick="deleteTrip(${t.id})"></button>
            </div>
          </div>`).join('')}
      </div>
    </div>

    <!-- CONFIG -->
    <div class="asect ${adminTab==='config'?'active':''}">

      <!-- FIREBASE SETUP CHECKLIST -->
      <div class="card" style="border-left:4px solid var(--accent2);margin-bottom:12px">
        <div class="ctitle" style="color:var(--accent2);margin-bottom:6px"> FIREBASE SETUP CHECKLIST</div>
        <div class="csub" style="margin-bottom:12px">// ONE-TIME SETUP IN FIREBASE CONSOLE</div>
        <div style="font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;line-height:2.2">
          <div> <strong style="color:var(--text)">Firestore Database</strong>  Already enabled</div>
          <div style="margin-left:16px;font-size:.46rem;color:var(--muted)">Rules: allow read, write to trips, sessions, drivers, pendingInvites, driverNotes</div>
          <div style="margin-top:8px"> <strong style="color:var(--accent2)">Email/Password Sign-In</strong>  Must enable:</div>
          <div style="margin-left:16px;font-size:.46rem;color:var(--muted)">Firebase Console  Authentication  Sign-in method  Email/Password  Enable</div>
          <div style="margin-top:8px"> <strong style="color:var(--accent2)">Email Link Sign-In</strong>  Must enable (for driver invites):</div>
          <div style="margin-left:16px;font-size:.46rem;color:var(--muted)">Firebase Console  Authentication  Sign-in method  Email/Password  Enable "Email link (passwordless sign-in)"</div>
          <div style="margin-top:8px"> <strong style="color:var(--accent2)">Authorized Domain</strong>  Must add your app URL:</div>
          <div style="margin-left:16px;font-size:.46rem;color:var(--muted)">Firebase Console  Authentication  Settings  Authorized domains  Add domain</div>
          <div style="margin-left:16px;font-size:.46rem;color:var(--accent)">Your URL: ${window.location.hostname}</div>
        </div>
        <div style="margin-top:12px;padding:10px;background:var(--bg);border:1px solid var(--border)">
          <div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px;margin-bottom:6px">REQUIRED FIRESTORE RULES (paste in Firebase Console  Firestore  Rules):</div>
          <pre style="font-family:monospace;font-size:.48rem;color:var(--text);line-height:1.6;white-space:pre-wrap;margin:0">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</pre>
        </div>
        <button class="bb bconfirm" style="margin-top:10px;margin-bottom:0;font-size:.7rem"
          onclick="window.open('https://console.firebase.google.com/project/${appConfig.projectId}/authentication/providers','_blank')">
          OPEN FIREBASE CONSOLE 
        </button>
      </div>

      ${!devUnlocked?devLockedHtml('CONFIG'):`
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="ctitle" style="margin:0">SYSTEM CONFIG</div>
          <button class="bghost" style="color:var(--red);border-color:var(--red)" onclick="lockDev()"> LOCK DEV</button>
        </div>
        <div class="csub">// CHANGE ADMIN PIN</div>
        <div class="irow">
          <div class="field"><label>New Admin PIN (4-6 digits)</label><input type="password" id="newPin" placeholder="New PIN" maxlength="6"></div>
          <button class="bsm bg" onclick="changePin()">SAVE</button>
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// CHANGE DEV PIN</div>
        <div class="irow">
          <div class="field"><label>New Developer PIN (4-6 digits)</label><input type="password" id="newDevPin" placeholder="New Dev PIN" maxlength="6"></div>
          <button class="bsm br" onclick="changeDevPin()">SAVE</button>
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// SECURITY SETTINGS</div>
        <div style="font-size:.74rem;color:var(--muted);margin-bottom:9px;line-height:1.8">
           Session timeout: <strong>30 minutes</strong> of inactivity<br>
           Countdown bar shows only in final <strong>5 minutes</strong><br>
           Warning overlay at <strong>60 seconds</strong> remaining<br>
           PIN lockout: <strong>3 failed attempts</strong> = 5 min lock
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// LOCAL DATA</div>
        <p style="font-size:.74rem;color:var(--muted);margin-bottom:9px">${localTrips.length} trips stored locally  ${offlineQ.length} queued for Firebase sync</p>
        ${offlineQ.length?`<button class="bsm by" style="width:100%;padding:10px;margin-bottom:8px" onclick="flushQueue()">SYNC ${offlineQ.length} QUEUED TRIPS TO FIREBASE</button>`:''}
        <button class="bout" onclick="if(confirm('Reset all lists to defaults?')){resetToDefaults();}">RESET LISTS TO DEFAULTS</button>
        <button class="bout" onclick="if(confirm('Clear all local trips? This cannot be undone.')){localTrips=[];save('fs_trips',[]);toast('CLEARED');renderAdmin();}">CLEAR LOCAL TRIP DATA</button>
      </div>`}
    </div>

    <!-- FIREBASE CONFIG -->
    <div class="asect ${adminTab==='settings'?'active':''}">
      ${!devUnlocked?devLockedHtml('DEV'):`
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div class="ctitle" style="margin:0;color:var(--red)">FIREBASE CONFIG</div>
          <button class="bghost" style="color:var(--red);border-color:var(--red)" onclick="lockDev()"> LOCK DEV</button>
        </div>
        <div class="csub">// CONNECT TO FIREBASE FIRESTORE</div>
        ${db?'<div class="conn-badge"><div class="dg"></div>FIREBASE CONNECTED</div>':''}
        <div class="field"><label>API KEY</label>
          <input type="text" id="fbApiKey" value="${appConfig.apiKey||''}" placeholder="AIzaSy..."></div>
        <div class="field"><label>AUTH DOMAIN</label>
          <input type="text" id="fbAuthDomain" value="${appConfig.authDomain||''}" placeholder="your-app.firebaseapp.com"></div>
        <div class="field"><label>PROJECT ID</label>
          <input type="text" id="fbProjectId" value="${appConfig.projectId||''}" placeholder="your-project-id"></div>
        <div class="field"><label>APP ID</label>
          <input type="text" id="fbAppId" value="${appConfig.appId||''}" placeholder="1:123456:web:abc..."></div>
        <button class="bb bstart" style="margin-top:4px" onclick="saveFirebaseConfig()">SAVE & CONNECT</button>
        <button class="bout" onclick="testFirebaseConnection()">TEST CONNECTION</button>
      </div>
      <div class="card">
        <div class="ctitle">SETUP GUIDE</div>
        <div class="steps">
          <div class="step">Go to <code>console.firebase.google.com</code>  Create project  Disable Google Analytics</div>
          <div class="step">Click <code>Firestore Database</code>  <code>Create database</code>  Start in <strong>test mode</strong>  Choose region</div>
          <div class="step">Click <code>Project settings</code> ()  <code>Your apps</code>  <code>&lt;/&gt; Web</code>  Register app  Copy the config values above</div>
          <div class="step">In Firestore  <code>Rules</code> tab  Paste:<br><code>allow read, write: if true;</code>  Publish</div>
          <div class="step">Paste all 4 config values above  <strong>SAVE & CONNECT</strong></div>
          <div class="step">Done! All trips from all 50 cars now sync instantly to Firebase. No limits.</div>
        </div>
      </div>`}
    </div>`;
}


// 
// ADMIN ACTIONS
// 
function checkPin(){
  if(isAdminLocked()){toast(` LOCKED  TRY IN ${adminLockSecsLeft()}s`);return;}
  const pin=document.getElementById('pinIn')?.value;
  if(pin===(localStorage.getItem(ADMIN_PIN_KEY)||DEFAULT_ADMIN_PIN)){
    adminPinFailures=0;
    adminUnlocked=true;
    renderAdmin();
  } else {
    recordAdminFailure();
    renderAdmin();
  }
}

// SHIFT CLOSE WITH SUMMARY
function showCloseShiftSummary(plate){
  const today=new Date().toLocaleDateString('en-GB');
  const shiftStart=shifts[plate]?.openedAt;
  const tripsInShift=localTrips.filter(t=>
    t.carPlate===plate&&t.date===today&&
    (!shiftStart||new Date(t.timestamp).getTime()>=shiftStart)
  );
  const revenue=tripsInShift.reduce((s,t)=>s+t.amount,0);
  const drivers=[...new Set(tripsInShift.map(t=>t.driver).filter(Boolean))];

  document.getElementById('shiftSummaryBody').innerHTML=`
    <div style="font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;margin-bottom:12px">
      SHIFT SUMMARY FOR <strong style="color:var(--text)">${plate}</strong>
    </div>
    <div class="shift-sum-row"><span>TOTAL TRIPS</span><strong>${tripsInShift.length}</strong></div>
    <div class="shift-sum-row"><span>DRIVERS ON SHIFT</span><strong>${drivers.length?drivers.map(d=>d.split(' ')[0]).join(', '):'None'}</strong></div>
    <div class="shift-sum-row"><span>OPENED AT</span><strong>${shifts[plate]?.openedAt?new Date(shifts[plate].openedAt).toLocaleTimeString():''}</strong></div>
    <div class="shift-sum-row"><span>CLOSING AT</span><strong>${new Date().toLocaleTimeString()}</strong></div>
    <div class="shift-sum-total">KES ${revenue.toLocaleString()}</div>
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-align:center;margin-top:4px">TOTAL REVENUE THIS SHIFT</div>`;

  document.getElementById('shiftCloseConfirmBtn').onclick=()=>closeShift(plate);
  document.getElementById('shiftSummaryModal').classList.add('open');
}

function openShift(plate){
  const by=prompt('Who is opening this shift?')||'ADMIN';
  shifts[plate]={open:true,openedAt:Date.now(),openedBy:by.toUpperCase(),closedAt:null};
  save('fs_shifts',shifts);toast(` SHIFT OPENED FOR ${plate}`);renderAdmin();
}
function closeShift(plate){
  shifts[plate]={...shifts[plate],open:false,closedAt:Date.now()};
  save('fs_shifts',shifts);
  document.getElementById('shiftSummaryModal').classList.remove('open');
  toast(` SHIFT CLOSED FOR ${plate}`);
  renderAdmin();
}
function openAllShifts(){
  const by=prompt('Who is opening all shifts?')||'ADMIN';
  CARS.forEach(c=>{shifts[c]={open:true,openedAt:Date.now(),openedBy:by.toUpperCase(),closedAt:null};});
  save('fs_shifts',shifts);toast(' ALL SHIFTS OPENED');renderAdmin();
}
function closeAllShifts(){
  if(!confirm('Close ALL shifts?'))return;
  CARS.forEach(c=>{shifts[c]={...shifts[c],open:false,closedAt:Date.now()};});
  save('fs_shifts',shifts);toast(' ALL SHIFTS CLOSED');renderAdmin();
}

// DRIVERS & CARS
function saveDriverTarget(driver, idx){
  const input=document.getElementById('dt_'+idx);
  const val=(input?.value||'').trim();
  if(val===''){delete driverTargets[driver];save('fs_dtargets',driverTargets);toast('TARGET REMOVED');renderAdmin();return;}
  const n=parseFloat(val);
  if(isNaN(n)||n<=0){toast('ENTER A VALID AMOUNT');return;}
  driverTargets[driver]=n;
  save('fs_dtargets',driverTargets);
  toast(' TARGET SET  KES '+n.toLocaleString()+' FOR '+driver.split(' ')[0]);
  renderAdmin();
}
function removeDriverTarget(driver){
  delete driverTargets[driver];
  save('fs_dtargets',driverTargets);
  toast('TARGET REMOVED');
  renderAdmin();
}
function adminSetDriverPin(driver){
  const pin=prompt(`Set PIN for ${driver.split(' ')[0]} (blank to remove):`);
  if(pin===null)return;
  if(pin===''){delete driverPins[driver];}
  else if(pin.length>=4){driverPins[driver]=pin;}
  else{toast('PIN MUST BE AT LEAST 4 DIGITS');return;}
  save('fs_dpins',driverPins);toast(pin?'PIN SET ':'PIN REMOVED');renderAdmin();
}
function adminSetTarget(plate){
  const t=prompt(`Daily revenue target for ${plate} (KES, blank to remove):`);
  if(t===null)return;
  if(t===''){delete carTargets[plate];}
  else{const n=parseFloat(t);if(isNaN(n)||n<=0){toast('INVALID AMOUNT');return;}carTargets[plate]=n;}
  save('fs_targets',carTargets);toast(t?'TARGET SET ':'TARGET REMOVED');renderAdmin();
}
function addDriver(){const n=(document.getElementById('newDriver')?.value||'').trim().toUpperCase();if(!n){toast('ENTER NAME');return;}if(DRIVERS.includes(n)){toast('ALREADY EXISTS');return;}DRIVERS.push(n);save('fs_drivers',DRIVERS);toast('DRIVER ADDED ');renderAdmin();}
function removeDriver(i){if(!confirm('Remove '+DRIVERS[i]+'?'))return;const d=DRIVERS[i];delete driverPins[d];save('fs_dpins',driverPins);DRIVERS.splice(i,1);save('fs_drivers',DRIVERS);renderAdmin();}
function addCar(){const n=(document.getElementById('newCar')?.value||'').trim().toUpperCase();if(!n){toast('ENTER PLATE');return;}if(CARS.includes(n)){toast('ALREADY EXISTS');return;}CARS.push(n);save('fs_cars',CARS);toast('CAR ADDED ');renderAdmin();}
function removeCar(i){if(!confirm('Remove '+CARS[i]+'?'))return;CARS.splice(i,1);save('fs_cars',CARS);renderAdmin();}
function addStation(){
  const n=(document.getElementById('newStn')?.value||'').trim().toUpperCase();
  const lat=parseFloat(document.getElementById('newLat')?.value||'');
  const lng=parseFloat(document.getElementById('newLng')?.value||'');
  if(!n){toast('ENTER NAME');return;}
  STATIONS.push({name:n,lat:isNaN(lat)?0:lat,lng:isNaN(lng)?0:lng});
  save('fs_stations',STATIONS);toast('STATION ADDED ');renderAdmin();
}
function removeStation(i){if(!confirm('Remove '+STATIONS[i].name+'?'))return;STATIONS.splice(i,1);save('fs_stations',STATIONS);renderAdmin();}
function changePin(){const p=document.getElementById('newPin')?.value||'';if(p.length<4){toast('MIN 4 DIGITS');return;}localStorage.setItem(ADMIN_PIN_KEY,p);toast('PIN UPDATED ');}
function resetToDefaults(){DRIVERS=[...DEFAULT_DRIVERS];CARS=[...DEFAULT_CARS];STATIONS=DEFAULT_STATIONS.map(s=>({...s}));save('fs_drivers',DRIVERS);save('fs_cars',CARS);save('fs_stations',STATIONS);toast('RESET ');renderAdmin();}

// TRIPS
function openEditTrip(id){
  const trip=localTrips.find(t=>t.id===id);if(!trip)return;
  editingTripId=id;
  document.getElementById('editDriver').value=trip.driver||'';
  document.getElementById('editCar').value=trip.carPlate||'';
  document.getElementById('editFrom').value=trip.fromStation||'';
  document.getElementById('editTo').value=trip.toStation||'';
  document.getElementById('editAmount').value=trip.amount||'';
  document.getElementById('editDate').value=trip.date||'';
  document.getElementById('editModal').classList.add('open');
}
function closeEditModal(){document.getElementById('editModal').classList.remove('open');editingTripId=null;}
function saveEditTrip(){
  const idx=localTrips.findIndex(t=>t.id===editingTripId);if(idx<0)return;
  localTrips[idx]={...localTrips[idx],driver:document.getElementById('editDriver').value,carPlate:document.getElementById('editCar').value,fromStation:document.getElementById('editFrom').value,toStation:document.getElementById('editTo').value,amount:parseFloat(document.getElementById('editAmount').value)||0,date:document.getElementById('editDate').value};
  save('fs_trips',localTrips);closeEditModal();toast('TRIP UPDATED ');renderAdmin();
}
function deleteTrip(id){if(!confirm('Delete this trip?'))return;localTrips=localTrips.filter(t=>t.id!==id);save('fs_trips',localTrips);toast('DELETED');renderAdmin();}

function saveFirebaseConfig(){
  appConfig.apiKey      =(document.getElementById('fbApiKey')?.value||'').trim();
  appConfig.authDomain  =(document.getElementById('fbAuthDomain')?.value||'').trim();
  appConfig.projectId   =(document.getElementById('fbProjectId')?.value||'').trim();
  appConfig.appId       =(document.getElementById('fbAppId')?.value||'').trim();
  save('fs_config',appConfig);
  db=null; // force re-init with new config
  if(appConfig.projectId&&initFirebase()){
    toast(' FIREBASE CONNECTED!');
    startLiveListener();
  }
  else{toast(appConfig.projectId?' CHECK CONFIG VALUES':'CONFIG SAVED  ENTER ALL 4 VALUES');}
  renderAdmin();
}
async function testFirebaseConnection(){
  if(!initFirebase()){toast(' SAVE CONFIG FIRST');return;}
  try{
    await db.collection('_test').limit(1).get();
    toast(' FIREBASE CONNECTION OK!');
  }catch(e){toast(' CONNECTION FAILED: '+e.message);}
}

// 
// ADMIN  DRIVER REGISTRATION & MANAGEMENT
// 

async function adminRegisterDriver(){
  const name  = (document.getElementById('regDName')?.value||'').trim().toUpperCase();
  const email = (document.getElementById('regDEmail')?.value||'').trim().toLowerCase();
  const car   = (document.getElementById('regDCar')?.value||'').trim();
  const phone = (document.getElementById('regDPhone')?.value||'').trim();

  const errEl  = document.getElementById('regDriverError');
  const succEl = document.getElementById('regDriverSuccess');
  if(errEl)  { errEl.style.display='none'; errEl.textContent=''; }
  if(succEl) { succEl.style.display='none'; succEl.innerHTML=''; }

  if(!name)  { if(errEl){errEl.textContent=' ENTER DRIVER FULL NAME';errEl.style.display='block';} return; }
  if(!email) { if(errEl){errEl.textContent=' ENTER DRIVER EMAIL ADDRESS';errEl.style.display='block';} return; }
  if(!db)    { if(errEl){errEl.textContent=' FIREBASE NOT CONNECTED  CHECK CONFIG';errEl.style.display='block';} return; }
  if(!auth)  { if(errEl){errEl.textContent=' AUTH NOT READY  REFRESH PAGE';errEl.style.display='block';} return; }

  const btn = document.getElementById('regDBtn');
  btn.disabled=true; btn.innerHTML='<span style="display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:6px"></span>SENDING INVITATION...';

  try{
    const saccoName = currentDriverDoc?.saccoName || appConfig.saccoName || 'FESTUS SACCO';
    const appUrl    = appConfig.appUrl || (window.location.origin + window.location.pathname);

    // STEP 1: Store pending invite in Firestore BEFORE sending email
    // Key: normalised email (no dots before @, per Firebase rules)
    const inviteKey = email.replace(/\./g,'_');
    const inviteData = {
      name, email, carPlate: car||null, phone: phone||null,
      saccoName, invitedBy: currentDriverDoc?.name||'ADMIN',
      invitedByUid: currentAuthUser?.uid||'',
      invitedAt: Date.now(),
      status: 'pending'
    };
    await db.collection('pendingInvites').doc(inviteKey).set(inviteData);

    // STEP 2: Also add to local DRIVERS list for legacy support
    if(!DRIVERS.includes(name)){ DRIVERS.push(name); save('fs_drivers', DRIVERS); }

    // STEP 3: Send Firebase Email Link invitation
    // The driver clicks the link  lands on the app  auto-signs in  creates account
    const actionCodeSettings = {
      url: appUrl + (appUrl.includes('?') ? '&' : '?') + 'invite=1&email='+encodeURIComponent(email),
      handleCodeInApp: true,
    };

    await auth.sendSignInLinkToEmail(email, actionCodeSettings);

    // Save sent email for this invite for easier tracking
    await db.collection('pendingInvites').doc(inviteKey).update({ inviteLinkSentAt: Date.now() });

    btn.disabled=false; btn.innerHTML=' SEND INVITATION';

    // Show success block with details
    if(succEl){
      succEl.innerHTML = `
        <div class="invite-success-box">
          <div class="invite-success-ico"></div>
          <div class="invite-success-title">INVITATION SENT!</div>
          <div class="invite-success-email">${email}</div>
          <div class="invite-success-note">
            <strong>${name.split(' ')[0]}</strong> will receive an email with a login link.<br>
            They click it  set their password  they're in.<br><br>
            If the email doesn't arrive, share this link manually:
          </div>
          <div class="invite-link-box" title="Click to copy" onclick="copyInviteLink(this)">
            ${appUrl}?invite=1&email=${encodeURIComponent(email)}
          </div>
        </div>`;
      succEl.style.display='block';
    }
    // Clear form
    document.getElementById('regDName').value='';
    document.getElementById('regDEmail').value='';
    if(document.getElementById('regDCar')) document.getElementById('regDCar').value='';
    if(document.getElementById('regDPhone')) document.getElementById('regDPhone').value='';
    // Reload list
    loadRegisteredDrivers();

  } catch(e){
    btn.disabled=false; btn.innerHTML=' SEND INVITATION';
    const msgs={
      'auth/email-already-in-use': ' THIS DRIVER IS ALREADY REGISTERED  USE RESEND INVITE BELOW',
      'auth/invalid-email':        ' INVALID EMAIL ADDRESS',
      'auth/missing-continue-uri': ' APP URL NOT CONFIGURED  CHECK CONFIG TAB',
      'auth/unauthorized-continue-uri': ' APP URL NOT AUTHORISED IN FIREBASE  ADD IT TO AUTHORISED DOMAINS',
    };
    const msg = msgs[e.code]||(' FAILED: '+e.message);
    if(errEl){ errEl.textContent=msg; errEl.style.display='block'; }
    console.error('adminRegisterDriver error:', e);
  }
}

function copyInviteLink(el){
  const url = el.textContent.trim();
  navigator.clipboard?.writeText(url).then(()=>toast(' INVITE LINK COPIED!')).catch(()=>{
    // Fallback: select all
    const r=document.createRange(); r.selectNode(el);
    window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
    toast('SELECT AND COPY THE LINK MANUALLY');
  });
}

async function adminResendInvite(email){
  if(!confirm('RESEND INVITATION TO '+email.toUpperCase()+'?')) return;
  const appUrl = appConfig.appUrl || (window.location.origin + window.location.pathname);
  const actionCodeSettings = {
    url: appUrl + (appUrl.includes('?') ? '&' : '?') + 'invite=1&email='+encodeURIComponent(email),
    handleCodeInApp: true,
  };
  try{
    await auth.sendSignInLinkToEmail(email, actionCodeSettings);
    toast(' INVITATION RESENT TO '+email.toUpperCase());
  } catch(e){ toast(' RESEND FAILED: '+e.message); }
}


async function loadRegisteredDrivers(){
  const listEl  = document.getElementById('regDriverList');
  const countEl = document.getElementById('regDriverCount');
  if(!listEl||!db) return;
  listEl.innerHTML='<div style="text-align:center;padding:16px;font-family:var(--font-m);font-size:.54rem;color:var(--muted)">LOADING...</div>';
  try{
    // Load active drivers
    const dSnap = await db.collection('drivers').where('role','==','driver').orderBy('registeredAt','desc').get();
    const drivers = dSnap.docs.map(d=>({id:d.id,...d.data(),_type:'active'}));

    // Load pending invites (not yet accepted)
    const iSnap = await db.collection('pendingInvites').orderBy('invitedAt','desc').get();
    const pending = iSnap.docs.map(d=>({id:d.id,...d.data(),_type:'pending'}));

    // Filter out pending entries where driver already accepted (email match)
    const activeEmails = new Set(drivers.map(d=>d.email));
    const pendingFiltered = pending.filter(p=>!activeEmails.has(p.email));

    const all = [...drivers, ...pendingFiltered];
    if(countEl) countEl.textContent = drivers.length + (pendingFiltered.length ? ' (+'+pendingFiltered.length+' pending)' : '');

    // Show first-time onboarding cue if no drivers at all
    isFirstAdminLogin = (all.length === 0);

    if(!all.length){
      listEl.innerHTML=`
        <div style="text-align:center;padding:24px 16px;border:2px dashed var(--border)">
          <div style="font-size:2rem;margin-bottom:8px"></div>
          <div style="font-family:var(--font-d);font-size:1rem;letter-spacing:2px;color:var(--muted);margin-bottom:6px">NO DRIVERS YET</div>
          <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1px;line-height:1.8">
            USE THE FORM ABOVE TO REGISTER<br>YOUR FIRST DRIVER
          </div>
        </div>`;
      return;
    }

    listEl.innerHTML = all.map(d=>{
      const isPending = d._type==='pending';
      const esc = (d.email||'').replace(/'/g,"\'");
      const nameEsc = (d.name||'').replace(/'/g,"\'");
      return `
        <div class="driver-reg-card" style="${isPending?'border-left-color:var(--accent2);opacity:.9':''}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
            <div style="flex:1;min-width:0">
              <div class="driver-reg-name">${d.name||''}</div>
              <div class="driver-reg-email" style="word-break:break-all">${d.email||''}</div>
              <div style="font-size:.5rem;color:var(--muted);margin-top:3px">${d.carPlate?' '+d.carPlate:'No car assigned'}</div>
              <span class="driver-reg-status ${isPending?'pending':d.active!==false?'active':'pending'}">
                ${isPending?' INVITE PENDING':d.active!==false?' ACTIVE':' DISABLED'}
              </span>
            </div>
            <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">
              ${isPending
                ? `<button style="background:none;border:1px solid var(--accent2);color:var(--accent2);font-family:var(--font-m);font-size:.42rem;padding:5px 7px;cursor:pointer;letter-spacing:1px;white-space:nowrap"
                    onclick="adminResendInvite('${esc}')"> RESEND</button>`
                : `<button style="background:none;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.42rem;padding:5px 7px;cursor:pointer;letter-spacing:1px;white-space:nowrap"
                    onclick="adminResetDriverPassword('${esc}','${nameEsc}')"> RESET PW</button>
                   <button style="background:none;border:1px solid ${d.active!==false?'var(--red)':'var(--accent)'};color:${d.active!==false?'var(--red)':'var(--accent)'};font-family:var(--font-m);font-size:.42rem;padding:5px 7px;cursor:pointer;letter-spacing:1px;white-space:nowrap"
                    onclick="adminToggleDriver('${d.id}',${d.active!==false})">
                    ${d.active!==false?'DISABLE':'ENABLE'}
                   </button>`
              }
            </div>
          </div>
          <div style="font-size:.44rem;color:var(--muted);margin-top:5px">
            ${isPending
              ? `INVITED ${new Date(d.invitedAt).toLocaleDateString('en-GB')} BY ${d.invitedBy||'ADMIN'}`
              : d.registeredAt?`REGISTERED ${new Date(d.registeredAt).toLocaleDateString('en-GB')}`:''
            }
          </div>
        </div>`;
    }).join('');
  } catch(e){
    listEl.innerHTML='<div style="color:var(--red);font-family:var(--font-m);font-size:.54rem;padding:12px"> ERROR: '+e.message+'</div>';
    console.error('loadRegisteredDrivers error:',e);
  }
}

async function adminResetDriverPassword(email, name){
  if(!email){ toast(' NO EMAIL FOR THIS DRIVER'); return; }
  if(!confirm('SEND PASSWORD RESET EMAIL TO '+email.toUpperCase()+'?')) return;
  try{
    await auth.sendPasswordResetEmail(email);
    toast(' RESET EMAIL SENT TO '+name.split(' ')[0]);
  } catch(e){ toast(' FAILED: '+e.message); }
}

async function adminToggleDriver(uid, currentlyActive){
  const action = currentlyActive ? 'DISABLE' : 'ENABLE';
  if(!confirm(action+' THIS DRIVER ACCOUNT?')) return;
  try{
    await db.collection('drivers').doc(uid).update({active: !currentlyActive});
    toast(' DRIVER '+action+'D');
    loadRegisteredDrivers();
  } catch(e){ toast(' FAILED: '+e.message); }
}

// Auto-load driver list when admin opens drivers tab
// (called from renderAdmin)

// 
// REPORT MODAL
// 
let rModalPeriod = 'today';
let rModalScope  = 'all';

function openReportModal(){
  rModalPeriod='today'; rModalScope='all';
  // Populate driver/car selects from current data
  const all=allData();
  const drivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  const cars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const dSel=document.getElementById('rModalDriverSel');
  const cSel=document.getElementById('rModalCarSel');
  dSel.innerHTML='<option value=""> All Drivers </option>'+drivers.map(d=>`<option value="${d}">${d}</option>`).join('');
  cSel.innerHTML='<option value=""> All Cars </option>'+cars.map(c=>`<option value="${c}">${c}</option>`).join('');
  // Reset chips
  document.querySelectorAll('#rModalPeriodBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.period==='today'));
  document.querySelectorAll('#rModalScopeBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.scope==='all'));
  document.getElementById('rModalDriverPick').style.display='none';
  document.getElementById('rModalCarPick').style.display='none';
  updateReportPreview();
  document.getElementById('reportModal').classList.add('open');
}

function closeReportModal(){
  document.getElementById('reportModal').classList.remove('open');
}

function setReportPeriod(p){
  rModalPeriod=p;
  document.querySelectorAll('#rModalPeriodBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.period===p));
  updateReportPreview();
}

function setReportScope(s){
  rModalScope=s;
  document.querySelectorAll('#rModalScopeBtns .fchip').forEach(el=>el.classList.toggle('active',el.dataset.scope===s));
  document.getElementById('rModalDriverPick').style.display=s==='driver'?'block':'none';
  document.getElementById('rModalCarPick').style.display=s==='car'?'block':'none';
  updateReportPreview();
}

function getReportTrips(){
  const all=allData();
  const now=new Date();
  const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  const filtered=all.filter(t=>{
    const d=parseDate(t.date); if(!d)return false;
    if(rModalPeriod==='today'&&d<todayStart)return false;
    if(rModalPeriod==='week'){const ws=new Date(todayStart);ws.setDate(todayStart.getDate()-todayStart.getDay());if(d<ws)return false;}
    if(rModalPeriod==='month'&&(d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear()))return false;
    if(rModalScope==='driver'){const sel=document.getElementById('rModalDriverSel')?.value;if(sel&&t.driver!==sel)return false;}
    if(rModalScope==='car'){const sel=document.getElementById('rModalCarSel')?.value;if(sel&&t.carPlate!==sel)return false;}
    return true;
  });
  return filtered;
}

function getReportLabel(){
  const period=rModalPeriod==='all'?'ALL TIME':rModalPeriod.toUpperCase();
  if(rModalScope==='driver'){
    const sel=document.getElementById('rModalDriverSel')?.value;
    return sel?`${sel}  ${period}`:`ALL DRIVERS  ${period}`;
  }
  if(rModalScope==='car'){
    const sel=document.getElementById('rModalCarSel')?.value;
    return sel?`${sel}  ${period}`:`ALL CARS  ${period}`;
  }
  return `FULL REPORT  ${period}`;
}

function updateReportPreview(){
  const trips=getReportTrips();
  const total=trips.reduce((s,t)=>s+(t.amount||0),0);
  const el=document.getElementById('rModalPreview');
  if(!el)return;
  if(!trips.length){el.textContent='NO TRIPS MATCH THIS SELECTION';el.style.color='var(--red)';return;}
  el.style.color='var(--accent)';
  el.innerHTML=`<strong style="font-size:.9rem">${trips.length}</strong> TRIPS &nbsp;&nbsp; KES <strong>${total.toLocaleString()}</strong>`;
}

// Live preview when driver/car select changes
document.addEventListener('change',e=>{
  if(e.target.id==='rModalDriverSel'||e.target.id==='rModalCarSel')updateReportPreview();
});

function runReport(format){
  const trips=getReportTrips();
  if(!trips.length){toast('NO TRIPS FOR THIS SELECTION');return;}
  const label=getReportLabel();
  if(format==='view'){
    closeReportModal();
    openReportViewer(trips,label);
    return;
  }
  if(format==='pdf') runReportPDF(trips,label);
  else if(format==='xls') runReportExcel(trips,label);
  else if(format==='wa') runReportWA(trips,label);
  closeReportModal();
}

// 
// REPORT VIEWER
// 
let rviewTrips = [];
let rviewLabel = '';

function openReportViewer(trips, label){
  rviewTrips = trips;
  rviewLabel = label;
  document.getElementById('rviewTitle').textContent = label;
  renderReportViewer(trips, label);
  document.getElementById('rviewOverlay').classList.add('open');
}

function closeReportViewer(){
  document.getElementById('rviewOverlay').classList.remove('open');
}

function openExportMenuFromViewer(){
  // Show a mini export picker sheet
  const sheet = document.getElementById('rviewExportSheet');
  if(sheet){ sheet.style.display = sheet.style.display==='none'?'block':'none'; return; }
  // Inject it into viewer body
  const body = document.getElementById('rviewBody');
  const div = document.createElement('div');
  div.id = 'rviewExportSheet';
  div.style.cssText = 'position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:2px solid var(--border);padding:16px;z-index:400;animation:fadeUp .2s ease';
  div.innerHTML = `
    <div style="font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1.5px;margin-bottom:10px">EXPORT THIS REPORT AS</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px">
      <button class="rview-btn-pdf" onclick="runReportPDF(rviewTrips,rviewLabel);closeExportSheet()"> PDF</button>
      <button class="rview-btn-xls" onclick="runReportExcel(rviewTrips,rviewLabel);closeExportSheet()"> XLS</button>
      <button class="rview-btn-wa" onclick="runReportWA(rviewTrips,rviewLabel);closeExportSheet()"> WHATSAPP</button>
    </div>
    <button class="bout" style="margin:0;width:100%" onclick="closeExportSheet()">CANCEL</button>`;
  document.body.appendChild(div);
}

function closeExportSheet(){
  const s = document.getElementById('rviewExportSheet');
  if(s) s.remove();
}

function renderReportViewer(trips, label){
  const body = document.getElementById('rviewBody');
  if(!body) return;

  const total     = trips.reduce((s,t)=>s+(t.amount||0),0);
  const avg       = trips.length ? Math.round(total/trips.length) : 0;
  const totalKm   = trips.reduce((s,t)=>s+(t.distance||0),0);
  const fuelTrips = trips.filter(t=>t.refueled&&t.fuelLiters>0);
  const totalL    = fuelTrips.reduce((s,t)=>s+(t.fuelLiters||0),0);
  const totalFuel = fuelTrips.reduce((s,t)=>s+(t.fuelCost||0),0);
  const fleetEff  = fuelTrips.length&&totalKm
    ? (totalKm/totalL).toFixed(2) : null;

  // Group by car
  const carMap = {};
  trips.forEach(t=>{
    const k = t.carPlate||'Unknown';
    if(!carMap[k]) carMap[k]={trips:0,revenue:0,km:0};
    carMap[k].trips++; carMap[k].revenue+=t.amount||0; carMap[k].km+=t.distance||0;
  });
  const cars = Object.entries(carMap).sort((a,b)=>b[1].revenue-a[1].revenue);
  const maxRev = cars[0]?.[1].revenue||1;

  // Group by driver
  const drvMap = {};
  trips.forEach(t=>{
    const k = t.driver||'Unknown';
    if(!drvMap[k]) drvMap[k]={trips:0,revenue:0};
    drvMap[k].trips++; drvMap[k].revenue+=t.amount||0;
  });
  const drivers = Object.entries(drvMap).sort((a,b)=>b[1].revenue-a[1].revenue);

  // Date range
  const dates = trips.map(t=>t.date).filter(Boolean);
  const dateRange = dates.length ? (dates[dates.length-1]===dates[0]?dates[0]:`${dates[dates.length-1]}  ${dates[0]}`) : '';

  body.innerHTML = `
    <!-- Export row at top of viewer -->
    <div class="rview-export-row" style="margin-bottom:14px">
      <button class="rview-btn-pdf" onclick="runReportPDF(rviewTrips,rviewLabel)"> PDF</button>
      <button class="rview-btn-xls" onclick="runReportExcel(rviewTrips,rviewLabel)"> XLS</button>
      <button class="rview-btn-wa" onclick="runReportWA(rviewTrips,rviewLabel)"> WHATSAPP</button>
    </div>

    <!-- Label + date range -->
    <div style="background:var(--accent);padding:12px 14px;margin-bottom:12px">
      <div style="font-family:var(--font-d);font-size:1.3rem;color:#fff;letter-spacing:2px">${label}</div>
      ${dateRange?`<div style="font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.7);letter-spacing:1px;margin-top:3px">${dateRange}</div>`:''}
    </div>

    <!-- Summary stats -->
    <div class="rview-summary">
      <div class="rview-stat wide">
        <div class="rs-label">TOTAL REVENUE</div>
        <div class="rs-val" style="font-size:2rem">KES ${total.toLocaleString()}</div>
      </div>
      <div class="rview-stat"><div class="rs-label">TOTAL TRIPS</div><div class="rs-val">${trips.length}</div></div>
      <div class="rview-stat"><div class="rs-label">AVG / TRIP</div><div class="rs-val" style="font-size:1.1rem">KES ${avg.toLocaleString()}</div></div>
      ${totalKm?`<div class="rview-stat"><div class="rs-label">TOTAL KM</div><div class="rs-val">${totalKm.toLocaleString()}</div></div>`:''}
      ${fleetEff?`<div class="rview-stat"><div class="rs-label">AVG EFFICIENCY</div><div class="rs-val" style="color:#f59e0b">${fleetEff}<span style="font-size:.7rem;font-family:var(--font-b)"> KM/L</span></div></div>`:''}
      ${totalFuel?`<div class="rview-stat wide"><div class="rs-label">TOTAL FUEL COST</div><div class="rs-val" style="color:#f59e0b;font-size:1.2rem">KES ${totalFuel.toLocaleString()}</div></div>`:''}
    </div>

    <!-- By Car breakdown -->
    ${cars.length>1?`
    <div class="rview-section-title">BREAKDOWN BY CAR</div>
    ${cars.map(([car,s])=>`
      <div class="rview-car-row">
        <span class="rview-car-badge">${car}</span>
        <div>
          <div style="font-size:.6rem;color:var(--muted)">${s.trips} trip${s.trips!==1?'s':''}${s.km?`  ${s.km.toLocaleString()} km`:''}</div>
          <div class="rview-bar-wrap"><div class="rview-bar" style="width:${Math.round((s.revenue/maxRev)*100)}%"></div></div>
        </div>
        <div style="font-family:var(--font-m);font-size:.72rem;font-weight:700;color:var(--accent)">KES ${(s.revenue/1000).toFixed(1)}K</div>
      </div>`).join('')}`:''}

    <!-- By Driver breakdown -->
    ${drivers.length>1?`
    <div class="rview-section-title">BREAKDOWN BY DRIVER</div>
    ${drivers.map(([drv,s],i)=>`
      <div class="rview-car-row">
        <div style="font-family:var(--font-d);font-size:1.1rem;color:${i===0?'#f0a500':i===1?'#aaa':i===2?'#cd7f32':'var(--border)'}">${i+1}</div>
        <div>
          <div style="font-family:var(--font-m);font-size:.62rem;font-weight:600">${drv}</div>
          <div style="font-size:.54rem;color:var(--muted)">${s.trips} trip${s.trips!==1?'s':''}  avg KES ${Math.round(s.revenue/s.trips).toLocaleString()}</div>
        </div>
        <div style="font-family:var(--font-m);font-size:.72rem;font-weight:700;color:var(--accent)">KES ${(s.revenue/1000).toFixed(1)}K</div>
      </div>`).join('')}`:''}

    <!-- Trip list -->
    <div class="rview-section-title">ALL TRIPS (${trips.length})</div>
    ${trips.slice(0,100).map((t,i)=>`
      <div class="rview-trip">
        <div class="rview-trip-top">
          <span class="rview-route">${t.fromStation||'?'}  ${t.toStation||'?'}</span>
          <span class="rview-amt">KES ${Number(t.amount||0).toLocaleString()}</span>
        </div>
        <div class="rview-trip-bot">
          <span>${t.driver?t.driver.split(' ')[0]:''}  ${t.carPlate||''}${t.distance?`   ${t.distance}km`:''}${t.fuelEfficiency?`  ${t.fuelEfficiency}km/L`:''}</span>
          <span>${t.date||''} ${t.time||''}</span>
        </div>
        ${t.notes?`<div style="font-size:.52rem;color:var(--muted);margin-top:3px;font-style:italic"> ${t.notes}</div>`:''}
      </div>`).join('')}
    ${trips.length>100?`<div style="text-align:center;font-family:var(--font-m);font-size:.52rem;color:var(--muted);padding:12px">SHOWING 100 OF ${trips.length}  EXPORT TO SEE ALL</div>`:''}
  `;
}

function runReportPDF(filtered,label){
  const {jsPDF}=window.jspdf;
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=18;let y=M;
  doc.setFillColor(26,122,60);doc.rect(0,0,W,42,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('FESTUS SACCO',M,16);
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.text(label,M,24);doc.text('Generated: '+new Date().toLocaleString(),M,31);
  y=50;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:String(filtered.length)},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():''},{l:'UNIQUE CARS',v:String([...new Set(filtered.map(t=>t.carPlate))].length)}].forEach((b,i)=>{
    const bx=M+i*(bw+3);doc.setFillColor(245,250,245);doc.rect(bx,y,bw,20,'F');doc.setFillColor(26,122,60);doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(6);doc.setFont('helvetica','normal');doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26);doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0);doc.setFontSize(6.5);doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5);doc.text('DATE',M+10,y+5);doc.text('ROUTE',M+36,y+5);doc.text('DRIVER',M+90,y+5);doc.text('CAR',M+130,y+5);doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244]));doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80);doc.setFontSize(6.5);doc.setFont('helvetica','normal');doc.text(String(i+1),M+2,y+5);doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60);doc.setFont('helvetica','bold');doc.text((t.fromStation||'').slice(0,9)+''+(t.toStation||'').slice(0,9),M+36,y+5);
    doc.setTextColor(60,60,60);doc.setFont('helvetica','normal');doc.text((t.driver||'').slice(0,18),M+90,y+5);doc.text(t.carPlate||'',M+130,y+5);
    doc.setTextColor(20,100,60);doc.setFont('helvetica','bold');doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FESTUS SACCO  CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  const fname='FESTUS-'+label.replace(/[^a-zA-Z0-9]/g,'-').replace(/-+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.pdf';
  doc.save(fname);
  toast(' PDF SAVED');
}

function runReportExcel(filtered,label){
  const data=filtered.map(t=>({'DATE':t.date,'TIME':t.time,'FROM':t.fromStation,'TO':t.toStation,'DRIVER':t.driver,'CAR':t.carPlate,'AMOUNT':t.amount,'DURATION(MIN)':t.duration,'NOTES':t.notes||''}));
  const ws=XLSX.utils.json_to_sheet(data);
  ws['!cols']=[{wch:12},{wch:10},{wch:14},{wch:14},{wch:20},{wch:10},{wch:10},{wch:12},{wch:20}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Trips');
  // Summary sheet
  const total=filtered.reduce((s,t)=>s+t.amount,0);
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  const carRows=cars.map(car=>{const ct=filtered.filter(t=>t.carPlate===car);return{'CAR':car,'TRIPS':ct.length,'REVENUE':ct.reduce((s,t)=>s+t.amount,0),'AVG/TRIP':ct.length?Math.round(ct.reduce((s,t)=>s+t.amount,0)/ct.length):0};});
  if(carRows.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(carRows),'By Car');
  const drivers=[...new Set(filtered.map(t=>t.driver).filter(Boolean))];
  const drvRows=drivers.map(d=>{const dt=filtered.filter(t=>t.driver===d);return{'DRIVER':d,'TRIPS':dt.length,'REVENUE':dt.reduce((s,t)=>s+t.amount,0),'AVG/TRIP':dt.length?Math.round(dt.reduce((s,t)=>s+t.amount,0)/dt.length):0};});
  if(drvRows.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(drvRows),'By Driver');
  const fname='FESTUS-'+label.replace(/[^a-zA-Z0-9]/g,'-').replace(/-+/g,'-')+'-'+new Date().toISOString().slice(0,10)+'.xlsx';
  XLSX.writeFile(wb,fname);
  toast(' EXCEL SAVED');
}

function runReportWA(filtered,label){
  const total=filtered.reduce((s,t)=>s+t.amount,0);
  const avg=filtered.length?Math.round(total/filtered.length):0;
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  const carLines=cars.map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car);
    const cr=ct.reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car];
    const pct=target?` (${Math.round((cr/target)*100)}% of target)`:'';
    return`   ${car}: ${ct.length} trips  KES ${cr.toLocaleString()}${pct}`;
  }).join('\n');
  const drivers=[...new Set(filtered.map(t=>t.driver).filter(Boolean))];
  const drvLines=drivers.map(d=>{
    const dt=filtered.filter(t=>t.driver===d);
    return`   ${d}: ${dt.length} trips  KES ${dt.reduce((s,t)=>s+t.amount,0).toLocaleString()}`;
  }).join('\n');
  const msg=` *FESTUS SACCO  ${label}*\n ${new Date().toLocaleDateString('en-GB')}\n\n *SUMMARY*\n Total Trips: ${filtered.length}\n Total Revenue: KES ${total.toLocaleString()}\n Average/Trip: KES ${avg.toLocaleString()}\n${cars.length>1?`\n *BY CAR*\n${carLines}\n`:''}${drivers.length>1?`\n *BY DRIVER*\n${drvLines}\n`:''}\n_Generated by FESTUS SACCO App_`;
  const encoded=encodeURIComponent(msg);
  if(navigator.clipboard){navigator.clipboard.writeText(msg).then(()=>toast(' COPIED! OPENING WHATSAPP...')).catch(()=>{});}
  setTimeout(()=>window.open(`https://wa.me/?text=${encoded}`,'_blank'),500);
}

// 
// ADMIN PIN RESET (via Dev PIN verification)
// 
let resetDevVerifyFailures = 0;

function openResetOverlay(){
  resetDevVerifyFailures = 0;
  // Reset both steps
  document.getElementById('resetStepVerify').style.display = 'block';
  document.getElementById('resetStepNew').style.display = 'none';
  const vm = document.getElementById('resetVerifyMsg');
  if(vm) vm.innerHTML = '';
  const di = document.getElementById('resetDevPinIn');
  if(di){ di.value = ''; di.style.borderColor = 'var(--accent2)'; }
  const ni = document.getElementById('resetNewPinIn');
  if(ni){ ni.value = ''; }
  document.getElementById('resetPinOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('resetDevPinIn')?.focus(), 120);
}

function closeResetOverlay(){
  document.getElementById('resetPinOverlay').classList.remove('open');
}

function verifyDevForReset(){
  const pin = (document.getElementById('resetDevPinIn')?.value || '').trim();
  const correct = localStorage.getItem(DEV_PIN_KEY) || DEFAULT_DEV_PIN;
  if(pin === correct){
    // Identity confirmed  show new PIN step
    document.getElementById('resetStepVerify').style.display = 'none';
    document.getElementById('resetStepNew').style.display = 'block';
    setTimeout(()=>document.getElementById('resetNewPinIn')?.focus(), 80);
  } else {
    resetDevVerifyFailures++;
    const vm = document.getElementById('resetVerifyMsg');
    const di = document.getElementById('resetDevPinIn');
    if(di){ di.value = ''; di.style.borderColor = 'var(--red)'; setTimeout(()=>{if(di)di.style.borderColor='var(--accent2)';},600); }
    if(resetDevVerifyFailures >= 3){
      // Lock out and close
      adminLockedUntil = Date.now() + PIN_LOCKOUT_SECS * 1000;
      closeResetOverlay();
      renderAdmin();
      toast(' TOO MANY FAILED ATTEMPTS  LOCKED FOR 5 MINUTES');
    } else {
      const left = 3 - resetDevVerifyFailures;
      if(vm) vm.innerHTML = `<div class="pin-locked" style="margin-bottom:10px;font-size:.52rem">WRONG DEV PIN  ${left} ATTEMPT${left===1?'':'S'} LEFT</div>`;
      di?.focus();
    }
  }
}

function commitResetPin(){
  const newPin = (document.getElementById('resetNewPinIn')?.value || '').trim();
  if(newPin.length < 4){
    const ni = document.getElementById('resetNewPinIn');
    if(ni){ ni.style.borderColor = 'var(--red)'; setTimeout(()=>{if(ni)ni.style.borderColor='var(--accent)';},600); }
    toast('PIN MUST BE AT LEAST 4 DIGITS');
    return;
  }
  localStorage.setItem(ADMIN_PIN_KEY, newPin);
  // Clear any lockout
  adminLockedUntil = 0;
  adminPinFailures = 0;
  closeResetOverlay();
  renderAdmin();
  toast(' ADMIN PIN RESET SUCCESSFULLY  USE YOUR NEW PIN TO LOGIN');
}

// 
// DEV PIN SYSTEM
// 
let devPinFailures = 0;
let devLockedUntil = 0;

function isDevLocked(){ return devLockedUntil > Date.now(); }
function devLockSecsLeft(){ return Math.ceil((devLockedUntil - Date.now()) / 1000); }

function recordDevFailure(){
  devPinFailures++;
  if(devPinFailures >= MAX_PIN_ATTEMPTS){
    devLockedUntil = Date.now() + PIN_LOCKOUT_SECS * 1000;
    devPinFailures = 0;
    toast(' TOO MANY ATTEMPTS  DEV ACCESS LOCKED FOR 5 MINUTES');
    closeDevPinOverlay();
    renderAdmin();
  } else {
    const left = MAX_PIN_ATTEMPTS - devPinFailures;
    const lockEl = document.getElementById('devPinLockMsg');
    if(lockEl) lockEl.innerHTML = `<div class="pin-locked" style="margin-bottom:10px">WRONG PIN  ${left} ATTEMPT${left===1?'':'S'} LEFT</div>`;
    const inp = document.getElementById('devPinIn');
    if(inp){ inp.value=''; inp.focus(); inp.style.borderColor='var(--red)'; setTimeout(()=>inp.style.borderColor='',600); }
  }
}

function checkDevPin(){
  if(isDevLocked()){
    toast(` DEV ACCESS LOCKED  TRY IN ${devLockSecsLeft()}s`);
    return;
  }
  const pin = (document.getElementById('devPinIn')?.value || '').trim();
  const correct = localStorage.getItem(DEV_PIN_KEY) || DEFAULT_DEV_PIN;
  if(pin === correct){
    devPinFailures = 0;
    devUnlocked = true;
    adminTab = pendingDevTab || 'settings';
    closeDevPinOverlay();
    renderAdmin();
    toast(' DEV ACCESS GRANTED');
  } else {
    recordDevFailure();
  }
}

function openDevTab(tab){
  if(devUnlocked){
    adminTab = tab;
    renderAdmin();
    return;
  }
  // Show the dev PIN overlay, remember which tab was requested
  pendingDevTab = tab;
  const lockEl = document.getElementById('devPinLockMsg');
  if(lockEl) lockEl.innerHTML = '';
  const inp = document.getElementById('devPinIn');
  if(inp){ inp.value=''; inp.style.borderColor=''; }
  if(isDevLocked()){
    // Show lock message directly without opening overlay
    toast(` DEV ACCESS LOCKED  TRY IN ${devLockSecsLeft()}s`);
    return;
  }
  document.getElementById('devPinOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('devPinIn')?.focus(), 100);
}

// Store which tab was requested when overlay was opened
let pendingDevTab = 'settings';

function closeDevPinOverlay(){
  document.getElementById('devPinOverlay').classList.remove('open');
}

function lockDev(){
  devUnlocked = false;
  adminTab = 'shifts';
  renderAdmin();
  toast(' DEV ACCESS LOCKED');
}

function devLockedHtml(area){
  if(isDevLocked()){
    return `<div class="card" style="border:2px solid var(--red);text-align:center;padding:30px 20px">
      <div style="font-size:2rem;margin-bottom:8px"></div>
      <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--red);letter-spacing:2px;margin-bottom:6px">DEV ACCESS LOCKED</div>
      <div style="font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:1.8">TOO MANY FAILED ATTEMPTS<br>TRY AGAIN IN ${devLockSecsLeft()}s</div>
    </div>`;
  }
  return `<div class="card" style="border:2px solid var(--red);text-align:center;padding:30px 20px">
    <div style="font-size:2rem;margin-bottom:8px"></div>
    <div style="font-family:var(--font-d);font-size:1.2rem;color:var(--red);letter-spacing:2px;margin-bottom:6px">${area}  DEV ONLY</div>
    <div style="font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:16px">THIS SECTION IS RESTRICTED<br>TO AUTHORISED DEVELOPERS ONLY</div>
    <button class="bb bend" style="margin:0;max-width:220px" onclick="openDevTab('${area.toLowerCase()==='dev'?'settings':'config'}')"> ENTER DEV PIN</button>
  </div>`;
}

function changeDevPin(){
  const p = (document.getElementById('newDevPin')?.value || '').trim();
  if(p.length < 4){ toast('DEV PIN MUST BE AT LEAST 4 DIGITS'); return; }
  localStorage.setItem(DEV_PIN_KEY, p);
  toast(' DEV PIN UPDATED ');
  document.getElementById('newDevPin').value = '';
}

// 
// FIREBASE AUTH  Full Login System
// Admin + Driver roles, first-time setup
// 

//  Panel & role helpers 
function showAuthOverlay(){
  document.getElementById('authOverlay').classList.remove('hidden');
}
function hideAuthOverlay(){
  document.getElementById('authOverlay').classList.add('hidden');
}

function showAuthPanel(panel){ switchToPanel(panel); }

// Better panel switcher that uses exact panel names
function switchToPanel(panel){
  // panel: 'landing' | 'create' | 'login' | 'forgot' | 'invite'
  const map={
    landing: 'authPanelLanding',
    create:  'authPanelCreate',
    setup:   'authPanelCreate',
    login:   'authPanelLogin',
    forgot:  'authPanelForgot',
    invite:  'authPanelInvite'
  };
  const targetId = map[panel];
  if(!targetId){ console.warn('switchToPanel: unknown panel', panel); return; }
  // Hide all auth panels, show the target
  Object.values(map).filter((v,i,a)=>a.indexOf(v)===i).forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display = (id===targetId) ? 'block' : 'none';
  });
  clearAuthErrors();
  setTimeout(()=>{
    if(panel==='login')  document.getElementById('authEmail')?.focus();
    if(panel==='create'||panel==='setup') document.getElementById('setupName')?.focus();
    if(panel==='forgot') document.getElementById('authForgotEmail')?.focus();
    if(panel==='invite') document.getElementById('inviteEmail')?.focus();
  }, 150);
}

function switchAuthRole(role){
  // Role is now auto-detected from Firestore  this is a no-op stub
  currentAuthRole = role;
}

function clearAuthErrors(){
  ['authLoginError','authForgotError','authForgotSuccess','authSetupError'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.classList.remove('show');el.textContent='';el.style.display='none';}
  });
}

function showAuthError(id, msg){
  const el=document.getElementById(id);
  if(el){el.textContent=msg;el.classList.add('show');el.style.display='block';}
}

function toggleAuthEye(){
  const inp=document.getElementById('authPass');
  const btn=document.getElementById('authEyeBtn');
  if(!inp)return;
  inp.type = inp.type==='password'?'text':'password';
  btn.textContent = inp.type==='password'?'':'';
}

function toggleSetupEye(){
  const inp=document.getElementById('setupPass');
  const btn=document.getElementById('setupEyeBtn');
  if(!inp)return;
  inp.type = inp.type==='password'?'text':'password';
  btn.textContent = inp.type==='password'?'':'';
}

//  FIRST-TIME ADMIN SETUP 
async function authSetupAdmin(){
  const name      = (document.getElementById('setupName')?.value||'').trim().toUpperCase();
  const saccoName = (document.getElementById('setupSaccoName')?.value||'').trim().toUpperCase();
  const email     = (document.getElementById('setupEmail')?.value||'').trim().toLowerCase();
  const pass      = document.getElementById('setupPass')?.value||'';

  clearAuthErrors();
  if(!name)     { showAuthError('authSetupError',' ENTER YOUR FULL NAME'); return; }
  if(!saccoName){ showAuthError('authSetupError',' ENTER YOUR SACCO NAME'); return; }
  if(!email)    { showAuthError('authSetupError',' ENTER YOUR EMAIL ADDRESS'); return; }
  if(pass.length<6){ showAuthError('authSetupError',' PASSWORD MUST BE AT LEAST 6 CHARACTERS'); return; }

  const btn=document.getElementById('setupBtn');
  btn.disabled=true; btn.innerHTML='<span class="auth-spinner"></span>CREATING ACCOUNT...';

  try{
    if(!auth) initFirebase();

    // STEP 1: Create the Firebase Auth account
    btn.innerHTML='<span class="auth-spinner"></span>STEP 1/3  CREATING AUTH...';
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const uid  = cred.user.uid;

    // STEP 2: Immediately write profile to Firestore BEFORE anything else
    // Set a flag so onAuthStateChanged knows the profile is being written
    window._pendingProfileWrite = true;
    btn.innerHTML='<span class="auth-spinner"></span>STEP 2/3  SAVING PROFILE...';
    const profile = { uid, name, email, role:'admin', saccoName, active:true, createdAt:Date.now() };
    await db.collection('drivers').doc(uid).set(profile);
    window._pendingProfileWrite = false;

    // STEP 3: Save config + mark setup done
    btn.innerHTML='<span class="auth-spinner"></span>STEP 3/3  FINISHING...';
    appConfig.saccoName = saccoName;
    appConfig.appUrl    = window.location.origin + window.location.pathname;
    save('fs_config', appConfig);
    updateSaccoName(saccoName);
    localStorage.setItem('fs_setup_done','1');
    localStorage.setItem('fs_last_email', email);
    localStorage.setItem('fs_last_role', 'admin');
    window._adminAuthCred = {email, password:pass};

    btn.disabled=false; btn.innerHTML=' ACCOUNT CREATED!';

    // Route directly  tell the observer to skip
    window._pendingProfileWrite = false;
    window._loginHandled = true;
    onDriverAuthenticated(cred.user, profile);
    setTimeout(()=>{ window._loginHandled = false; }, 3000);

  } catch(e){
    window._pendingProfileWrite = false;
    btn.disabled=false; btn.innerHTML=' CREATE ADMIN ACCOUNT';
    const msgs={
      'auth/email-already-in-use': ' THAT EMAIL IS ALREADY REGISTERED  USE ADMIN LOGIN TAB',
      'auth/invalid-email':        ' INVALID EMAIL ADDRESS',
      'auth/weak-password':        ' PASSWORD TOO WEAK  USE AT LEAST 6 CHARACTERS',
    };
    showAuthError('authSetupError', msgs[e.code]||(' '+e.message));
  }
}

function updateSaccoName(name){
  if(!name) return;
  // Auth overlay logo
  const el=document.getElementById('authLogoName');
  if(el) el.textContent=name;
  // Main header logo  split on first space for styling
  const logo=document.getElementById('headerLogo');
  if(logo){
    const parts = name.split(' ');
    const first = parts[0];
    const rest  = parts.slice(1).join(' ');
    logo.innerHTML = first + (rest ? '<span> '+rest+'</span>' : '');
  }
  // Page title
  document.title = name + '  Fleet Tracker';
  // Store in config
  if(appConfig.saccoName !== name){
    appConfig.saccoName = name;
    save('fs_config', appConfig);
  }
}

//  MAIN LOGIN 
// Routes directly  does NOT wait for onAuthStateChanged
async function authLogin(){
  const email = (document.getElementById('authEmail')?.value||'').trim().toLowerCase();
  const pass  = document.getElementById('authPass')?.value||'';
  clearAuthErrors();
  if(!email){ showAuthError('authLoginError',' ENTER YOUR EMAIL ADDRESS'); return; }
  if(!pass){  showAuthError('authLoginError',' ENTER YOUR PASSWORD'); return; }

  const btn = document.getElementById('authLoginBtn');
  const resetBtn = ()=>{
    if(btn){ btn.disabled=false; btn.textContent='LOG IN'; btn.style.background=''; }
  };

  btn.disabled=true;
  btn.innerHTML='<span class="auth-spinner"></span>LOGGING IN...';

  try{
    //  Make sure Firebase is ready 
    if(!auth || !db){
      for(let t=0; t<3; t++){
        if(initFirebase() && auth && db) break;
        await new Promise(r=>setTimeout(r,400));
      }
    }
    if(!auth || !db){
      resetBtn();
      showAuthError('authLoginError',' FIREBASE FAILED TO LOAD  PLEASE REFRESH THE PAGE');
      return;
    }

    //  STEP 1: Firebase Auth 
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    const user  = cred.user;
    currentAuthUser = user;
    localStorage.setItem('fs_last_email', email);
    window._adminAuthCred = {email, password: pass};

    //  STEP 2: Try loading Firestore profile 
    btn.innerHTML='<span class="auth-spinner"></span>LOADING YOUR PROFILE...';
    let profile    = null;
    let profileErr = null;

    for(let i=0; i<4; i++){
      try{
        profile = await loadDriverProfile(user.uid);
      } catch(e){
        profileErr = e;
        break; // Hard error  don't retry
      }
      if(profile) break;
      if(i<3) await new Promise(r=>setTimeout(r,700));
    }

    //  STEP 3: Route  never leave the user stuck 
    if(profile){
      //  Normal path  profile found
      window._loginHandled = true;
      onDriverAuthenticated(user, profile);
      setTimeout(()=>{ window._loginHandled = false; }, 3000);

    } else if(profileErr && profileErr.code === 'unavailable'){
      //  No internet / Firestore offline
      resetBtn();
      showAuthError('authLoginError',
        ' CANNOT REACH DATABASE\n' +
        'Check your internet connection and try again.');

    } else if(profileErr && profileErr.code === 'permission-denied'){
      //  Firestore rules are blocking reads  but Firebase Auth worked fine.
      // Build a profile from the Auth user object and let them in.
      // The admin can fix Firestore rules once inside.
      btn.innerHTML='<span class="auth-spinner"></span>BYPASSING FIRESTORE...';
      const bypassProfile = {
        uid:           user.uid,
        name:          user.displayName || email.split('@')[0].replace(/[^a-z]/gi,' ').toUpperCase().trim(),
        email:         user.email,
        role:          'admin',
        saccoName:     appConfig.saccoName || 'FESTUS SACCO',
        active:        true,
        createdAt:     Date.now(),
        _rulesBlocked: true  // flag so UI can show a warning
      };
      window._loginHandled = true;
      onDriverAuthenticated(user, bypassProfile);
      setTimeout(()=>{ window._loginHandled = false; }, 3000);
      setTimeout(()=>{
        toast(' FIRESTORE RULES NEED UPDATING  GO TO CONFIG TAB');
      }, 1500);

    } else {
      //  Auth worked but no Firestore profile exists  create it now
      btn.innerHTML='<span class="auth-spinner"></span>CREATING YOUR PROFILE...';
      try{
        const newProfile = {
          uid:       user.uid,
          name:      user.displayName || email.split('@')[0].replace(/[^a-z]/gi,' ').toUpperCase().trim(),
          email:     user.email,
          role:      'admin',
          saccoName: appConfig.saccoName || 'FESTUS SACCO',
          active:    true,
          createdAt: Date.now(),
        };
        await db.collection('drivers').doc(user.uid).set(newProfile);
        window._loginHandled = true;
        onDriverAuthenticated(user, newProfile);
        setTimeout(()=>{ window._loginHandled = false; }, 3000);

      } catch(createErr){
        // Creating profile also failed (likely permission-denied on write)
        // Still let them in using Auth data only
        const fallbackProfile = {
          uid:           user.uid,
          name:          user.displayName || email.split('@')[0].replace(/[^a-z]/gi,' ').toUpperCase().trim(),
          email:         user.email,
          role:          'admin',
          saccoName:     appConfig.saccoName || 'FESTUS SACCO',
          active:        true,
          _rulesBlocked: true
        };
        window._loginHandled = true;
        onDriverAuthenticated(user, fallbackProfile);
        setTimeout(()=>{ window._loginHandled = false; }, 3000);
        setTimeout(()=>{
          toast(' FIRESTORE RULES NEED UPDATING  GO TO CONFIG TAB');
        }, 1500);
      }
    }

  } catch(e){
    resetBtn();
    const msgs={
      'auth/user-not-found':         ' NO ACCOUNT FOUND  CHECK YOUR EMAIL',
      'auth/wrong-password':         ' INCORRECT PASSWORD  TRY AGAIN',
      'auth/invalid-email':          ' INVALID EMAIL ADDRESS',
      'auth/user-disabled':          ' ACCOUNT DISABLED  CONTACT YOUR ADMIN',
      'auth/too-many-requests':      ' TOO MANY ATTEMPTS  WAIT A FEW MINUTES',
      'auth/invalid-credential':     ' INCORRECT EMAIL OR PASSWORD',
      'auth/network-request-failed': ' NO INTERNET  CHECK YOUR CONNECTION',
    };
    showAuthError('authLoginError', msgs[e.code]||(' '+e.message));
  }
}


//  FORGOT PASSWORD 
async function authForgotPassword(){
  const email=(document.getElementById('authForgotEmail')?.value||'').trim().toLowerCase();
  clearAuthErrors();
  if(!email){ showAuthError('authForgotError',' ENTER YOUR EMAIL ADDRESS'); return; }

  const btn=document.getElementById('authForgotBtn');
  btn.disabled=true; btn.innerHTML='<span class="auth-spinner"></span>SENDING...';

  try{
    if(!auth) initFirebase();
    await auth.sendPasswordResetEmail(email);
    btn.disabled=false; btn.innerHTML='SEND RESET LINK';
    const succ=document.getElementById('authForgotSuccess');
    if(succ){
      succ.textContent=' RESET LINK SENT TO '+email.toUpperCase()+'  CHECK YOUR INBOX';
      succ.classList.add('show'); succ.style.display='block';
    }
  } catch(e){
    btn.disabled=false; btn.innerHTML='SEND RESET LINK';
    const msgs={
      'auth/user-not-found': ' NO ACCOUNT WITH THAT EMAIL',
      'auth/invalid-email':  ' INVALID EMAIL ADDRESS',
    };
    showAuthError('authForgotError', msgs[e.code]||(' '+e.message));
  }
}

//  LOGOUT 
async function authLogout(){
  const msg = isAdminUser ? 'LOG OUT OF ADMIN PANEL?' : 'LOG OUT OF YOUR ACCOUNT?';
  if(!confirm(msg)) return;
  try{
    if(!isAdminUser){
      clearInterval(timerInterval);
      stopGpsWatch();
      clearSavedTripState();
      endSession();
      mySessionId     = null;
      tripState.phase = 'setup';
      tripState.driver = ''; tripState.carPlate = '';
      save('fs_driver', null);
    }
    isAdminUser           = false;
    adminUnlocked         = false;
    window._adminAuthCred = null;
    driverNotes           = [];
    showNavFor(null);  // hide navs immediately
    window._intentionalSignOut = true; // show landing after sign-out
    if(auth) await auth.signOut();
  } catch(e){ console.error('Logout error:', e); }
}

//  LOAD USER PROFILE 
async function loadDriverProfile(uid){
  // Returns profile object or null (not found).
  // THROWS with {code, message} on permission/network errors so caller can react.
  if(!db || !uid) return null;
  try{
    const snap = await db.collection('drivers').doc(uid).get();
    if(snap.exists){
      currentDriverDoc = {...snap.data(), _docId: snap.id};
      return currentDriverDoc;
    }
    // Fallback: query by uid field (handles legacy docs keyed differently)
    const q = await db.collection('drivers').where('uid','==',uid).limit(1).get();
    if(!q.empty){
      currentDriverDoc = {...q.docs[0].data(), _docId: q.docs[0].id};
      return currentDriverDoc;
    }
    return null; // Authenticated but no profile document exists
  } catch(e){
    const code = e.code || '';
    console.warn('loadDriverProfile error:', code, e.message);
    if(code.includes('permission-denied') || code === 'permission-denied'){
      throw { code:'permission-denied', message:'FIRESTORE RULES BLOCKING ACCESS' };
    }
    if(code.includes('unavailable') || code === 'unavailable'){
      throw { code:'unavailable', message:'NO DATABASE CONNECTION' };
    }
    // Any other Firestore error  surface it
    throw { code: code||'unknown', message: e.message||'Unknown error' };
  }
}


//  ROUTE USER AFTER LOGIN 
function onDriverAuthenticated(user, profile){
  if(!profile){
    // Don't sign out  just show error on login panel so they can retry
    showAuthOverlay();
    switchToPanel('login');
    showAuthError('authLoginError',' NO PROFILE FOUND  PLEASE TRY AGAIN OR CONTACT YOUR ADMIN');
    return;
  }

  if(profile.role==='admin'){
    //  ADMIN 
    isAdminUser   = true;
    adminUnlocked = true;
    if(profile.saccoName) updateSaccoName(profile.saccoName);
    const firstName = (profile.name||'ADMIN').split(' ')[0];
    document.getElementById('driverBadge').textContent = ' '+firstName;
    const hSub=document.getElementById('headerSubText');
    if(hSub) hSub.textContent='// ADMIN PANEL  '+profile.saccoName||'SACCO';
    hideAuthOverlay();
    showNavFor('admin');
    // Always open on DRIVERS tab  that's where admin manages the fleet
    adminTab = 'drivers';
    switchPage('admin');
    // Load driver list after render
    setTimeout(()=>{
      loadRegisteredDrivers();
    }, 300);
    toast(' WELCOME, '+firstName+'!');

  } else {
    //  DRIVER 
    isAdminUser        = false;
    tripState.driver   = profile.name || user.email;
    tripState.carPlate = profile.carPlate || '';
    tripState.phase    = 'idle';
    save('fs_driver',{driver:tripState.driver, carPlate:tripState.carPlate});
    const firstName = tripState.driver.split(' ')[0];
    document.getElementById('driverBadge').textContent =
      firstName + (tripState.carPlate?'  '+tripState.carPlate:'');
    const hSub2=document.getElementById('headerSubText');
    if(hSub2) hSub2.textContent='// DRIVER  '+firstName;
    startSessionTimer();
    startGpsWatch();
    writeSession('online',{loginTime:Date.now()});
    hideAuthOverlay();
    showNavFor('driver');
    switchPage('log');
    toast(' WELCOME, '+firstName+'!');
  }
}

//  INVITATION LINK HANDLER 
async function handleInviteLink(){
  // Called on page load when URL contains ?invite=1
  // Shows the invite acceptance panel
  if(!auth){ initFirebase(); }
  if(!auth){ return; }

  showAuthOverlay();
  switchToPanel('invite');
  // Show loading state
  document.getElementById('inviteLoadingState').style.display = 'block';
  document.getElementById('inviteFormState').style.display    = 'none';
  document.getElementById('inviteErrorState').style.display   = 'none';

  // Pre-fill email from URL param
  const urlParams  = new URLSearchParams(window.location.search);
  const emailHint  = decodeURIComponent(urlParams.get('email')||'');
  if(emailHint && document.getElementById('inviteEmail')){
    document.getElementById('inviteEmail').value = emailHint;
  }

  // Check if this is a valid sign-in link
  const isSignInLink = auth.isSignInWithEmailLink(window.location.href);
  if(!isSignInLink){
    document.getElementById('inviteLoadingState').style.display = 'none';
    document.getElementById('inviteErrorState').style.display   = 'block';
    return;
  }

  // Load sacco name from pending invite if we have the email
  if(emailHint && db){
    try{
      const inviteKey = emailHint.replace(/\./g,'_').replace(/@/g,'_AT_');
      // Try both key formats
      let inviteSnap = await db.collection('pendingInvites').doc(emailHint.replace(/\./g,'_')).get();
      if(!inviteSnap.exists){
        const q = await db.collection('pendingInvites').where('email','==',emailHint).limit(1).get();
        if(!q.empty) inviteSnap = q.docs[0];
      }
      if(inviteSnap && inviteSnap.exists){
        pendingInviteData = inviteSnap.data ? inviteSnap.data() : inviteSnap;
        // Update the invite panel with sacco + driver name
        const saccoEl  = document.getElementById('inviteSaccoName');
        const nameEl   = document.getElementById('inviteDriverNameBadge');
        if(saccoEl && pendingInviteData.saccoName) saccoEl.textContent = pendingInviteData.saccoName;
        if(nameEl  && pendingInviteData.name)      nameEl.textContent  = ' HELLO, '+pendingInviteData.name.split(' ')[0]+'!';
        if(pendingInviteData.saccoName)             updateSaccoName(pendingInviteData.saccoName);
      }
    } catch(e){ console.warn('Could not load invite data:', e.message); }
  }

  // Show the form
  document.getElementById('inviteLoadingState').style.display = 'none';
  document.getElementById('inviteFormState').style.display    = 'block';
  setTimeout(()=>{
    const emailEl = document.getElementById('inviteEmail');
    if(emailEl && !emailEl.value) emailEl.focus();
    else document.getElementById('inviteNewPass')?.focus();
  }, 200);
}

async function acceptInvitation(){
  const email   = (document.getElementById('inviteEmail')?.value||'').trim().toLowerCase();
  const pass    = document.getElementById('inviteNewPass')?.value||'';

  const errEl = document.getElementById('authInviteError');
  if(errEl){ errEl.style.display='none'; errEl.textContent=''; }

  if(!email){ if(errEl){errEl.textContent=' ENTER YOUR EMAIL ADDRESS';errEl.style.display='block';} return; }
  if(pass.length < 6){ if(errEl){errEl.textContent=' PASSWORD MUST BE AT LEAST 6 CHARACTERS';errEl.style.display='block';} return; }

  const btn = document.getElementById('inviteAcceptBtn');
  btn.disabled=true; btn.innerHTML='<span class="auth-spinner"></span>SETTING UP YOUR ACCOUNT...';

  try{
    if(!auth){ initFirebase(); }

    // Sign in with the email link
    window._pendingProfileWrite = true;
    const cred = await auth.signInWithEmailLink(email, window.location.href);
    const user = cred.user;

    // Check if they already have a profile (re-clicking invite link)
    const existingProfile = await loadDriverProfile(user.uid);
    if(existingProfile){
      window._pendingProfileWrite = false;
      // Just update password and route them in
      try{ await user.updatePassword(pass); } catch(e){ /* may already be set */ }
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      onDriverAuthenticated(user, existingProfile);
      return;
    }

    // Update their password to what they chose
    await user.updatePassword(pass);

    // Load the pending invite data if not already loaded
    let inviteData = pendingInviteData;
    if(!inviteData && db){
      const inviteKey = email.replace(/\./g,'_');
      const snap = await db.collection('pendingInvites').doc(inviteKey).get();
      if(snap.exists) inviteData = snap.data();
      if(!inviteData){
        const q = await db.collection('pendingInvites').where('email','==',email).limit(1).get();
        if(!q.empty) inviteData = q.docs[0].data();
      }
    }

    // Build driver profile
    const profile = {
      uid:          user.uid,
      name:         inviteData?.name || email.split('@')[0].toUpperCase(),
      email:        email,
      carPlate:     inviteData?.carPlate || null,
      phone:        inviteData?.phone    || null,
      role:         'driver',
      active:       true,
      saccoName:    inviteData?.saccoName || appConfig.saccoName || '',
      invitedBy:    inviteData?.invitedBy || '',
      registeredAt: Date.now(),
      acceptedAt:   Date.now()
    };

    // Save to Firestore drivers collection
    await db.collection('drivers').doc(user.uid).set(profile);

    // Remove from pendingInvites
    try{
      const inviteKey = email.replace(/\./g,'_');
      await db.collection('pendingInvites').doc(inviteKey).delete();
    } catch(e){ /* non-critical */ }

    window._pendingProfileWrite = false;
    window._loginHandled = true;

    // Clean URL
    const cleanUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, document.title, cleanUrl);

    btn.disabled=false; btn.innerHTML=' ACCEPT INVITATION & LOG IN';

    onDriverAuthenticated(user, profile);
    setTimeout(()=>{ window._loginHandled = false; }, 3000);

  } catch(e){
    window._pendingProfileWrite = false;
    btn.disabled=false; btn.innerHTML=' ACCEPT INVITATION & LOG IN';
    const msgs={
      'auth/invalid-action-code':  ' INVITATION LINK HAS EXPIRED  ASK YOUR ADMIN FOR A NEW ONE',
      'auth/invalid-email':        ' EMAIL DOES NOT MATCH THE INVITATION',
      'auth/user-disabled':        ' YOUR ACCOUNT HAS BEEN DISABLED',
      'auth/email-already-in-use': ' THIS EMAIL IS ALREADY REGISTERED  USE THE LOGIN PAGE',
      'auth/weak-password':        ' PASSWORD IS TOO WEAK  USE AT LEAST 6 CHARACTERS',
    };
    const msg = msgs[e.code]||(' '+e.message);
    if(errEl){ errEl.textContent=msg; errEl.style.display='block'; }
    console.error('acceptInvitation error:', e);
  }
}

function toggleInviteEye(){
  const inp=document.getElementById('inviteNewPass');
  const btn=document.getElementById('inviteEyeBtn');
  if(!inp)return;
  inp.type = inp.type==='password'?'text':'password';
  btn.textContent = inp.type==='password'?'':'';
}

//  AUTH STATE LISTENER 
// Flags that control listener behavior
window._pendingProfileWrite = window._pendingProfileWrite || false;
window._intentionalSignOut  = false; // set true before manual auth.signOut()
window._loginHandled        = false; // set true when authLogin/setup routes directly

function startAuthListener(){
  if(!auth) return;
  auth.onAuthStateChanged(async (user)=>{

    if(user){
      // Skip if authLogin / setup / invite already handled routing
      if(window._loginHandled || window._pendingProfileWrite) return;

      // PAGE RELOAD with an existing Firebase session
      currentAuthUser = user;

      let profile = null;
      try{
        for(let i=0; i<3; i++){
          try{ profile = await loadDriverProfile(user.uid); } catch(e){ break; }
          if(profile) break;
          if(i<2) await new Promise(r=>setTimeout(r,600));
        }
      } catch(e){ profile = null; }

      if(profile){
        onDriverAuthenticated(user, profile);
      } else {
        // Profile missing or blocked  show login panel so user can re-authenticate
        showAuthOverlay();
        switchToPanel('login');
        setTimeout(()=>{
          const el = document.getElementById('authEmail');
          if(el) el.value = user.email || localStorage.getItem('fs_last_email')||'';
          showAuthError('authLoginError','SESSION RESTORED  PLEASE CLICK LOG IN TO CONTINUE');
        }, 100);
      }

    } else {
      // No user  only act if we were previously logged in
      if(!currentAuthUser && !window._intentionalSignOut) return;

      currentAuthUser  = null;
      currentDriverDoc = null;
      isAdminUser      = false;
      adminUnlocked    = false;
      driverNotes      = [];
      tripState.phase  = 'setup';
      tripState.driver = ''; tripState.carPlate = '';
      save('fs_driver', null);
      document.getElementById('driverBadge').textContent = ' LOGIN ';
      const btn = document.getElementById('authLoginBtn');
      if(btn){ btn.disabled=false; btn.textContent='LOG IN'; btn.style.background=''; }
      showNavFor(null);

      if(window._intentionalSignOut){
        window._intentionalSignOut = false;
        showAuthOverlay();
        switchToPanel('landing');
      } else {
        showAuthOverlay();
        switchToPanel('login');
        const saved = localStorage.getItem('fs_last_email');
        if(saved) setTimeout(()=>{
          const el = document.getElementById('authEmail');
          if(el) el.value = saved;
        }, 80);
      }
    }
  });
}


// 
// SESSION TRACKING  writes driver login/phase to Firestore
// So the admin can see who is logged in and what they're doing
// 

async function writeSession(status, extra){
  // status: 'online' | 'driving' | 'arrived' | 'idle' | 'offline'
  if(!db || !tripState.driver || !tripState.carPlate) return;
  try{
    const doc = {
      driver:    tripState.driver,
      carPlate:  tripState.carPlate,
      status:    status,
      updatedAt: Date.now(),
      date:      new Date().toLocaleDateString('en-GB'),
      ...extra
    };
    if(mySessionId){
      // Update existing session document
      await db.collection('sessions').doc(mySessionId).set(doc, {merge:true});
    } else {
      // Create new session document
      const ref = await db.collection('sessions').add(doc);
      mySessionId = ref.id;
    }
  } catch(e){ console.warn('Session write failed:', e); }
}

async function endSession(){
  if(!db || !mySessionId) return;
  try{
    await db.collection('sessions').doc(mySessionId).set({
      status:'offline',
      updatedAt: Date.now(),
      driver: tripState.driver,
      carPlate: tripState.carPlate
    }, {merge:true});
    mySessionId = null;
  } catch(e){}
}

//  Listener for ALL sessions (admin side) 
function startSessionListener(){
  if(!db) return;
  if(liveSessionSub){ liveSessionSub(); liveSessionSub=null; }
  try{
    // Only sessions updated in last 14 hours (today's shift)
    const since = Date.now() - (14*60*60*1000);
    liveSessionSub = db.collection('sessions')
      .where('updatedAt','>=',since)
      .onSnapshot(snap=>{
        snap.forEach(doc=>{
          const s = {...doc.data(), _id: doc.id};
          liveSessions[s.carPlate] = s; // latest doc per plate
        });
        if(currentPage==='reports' && reportTab==='live') renderLiveTab();
      }, err=>{ console.warn('Session listener error:', err); });
  } catch(e){}
}

function stopSessionListener(){
  if(liveSessionSub){ liveSessionSub(); liveSessionSub=null; }
  liveSessions = {};
}

// 
// LIVE LISTENER  Firebase onSnapshot
// 
function startLiveListener(){
  if(liveUnsubscribe){liveUnsubscribe();liveUnsubscribe=null;}
  if(!initFirebase()){updateListenerStatus(false);return;}
  updateListenerStatus('connecting');
  startSessionListener(); // Also listen for driver sessions
  // Listen to trips from last 12 hours so manager sees today's activity
  const since=Date.now()-(12*60*60*1000);
  try{
    liveUnsubscribe=db.collection('trips')
      .where('dateMs','>=',since)
      .orderBy('dateMs','desc')
      .onSnapshot(snap=>{
        snap.docChanges().forEach(change=>{
          if(change.type==='added'){
            const trip={...change.doc.data(),_fbId:change.doc.id};
            // Avoid duplicates
            if(!liveTrips.find(t=>t._fbId===trip._fbId)){
              liveTrips.unshift(trip);
              liveNewIds.add(trip._fbId);
              setTimeout(()=>{liveNewIds.delete(trip._fbId);renderLiveTab();},4000);
            }
          }
        });
        // Sort newest first
        liveTrips.sort((a,b)=>(b.dateMs||0)-(a.dateMs||0));
        // Keep last 200
        if(liveTrips.length>200)liveTrips=liveTrips.slice(0,200);
        updateListenerStatus(true);
        if(currentPage==='reports'&&reportTab==='live')renderLiveTab();
      }, err=>{
        console.error('Live listener error:',err);
        updateListenerStatus(false);
      });
  }catch(e){updateListenerStatus(false);}
}

function stopLiveListener(){
  if(liveUnsubscribe){liveUnsubscribe();liveUnsubscribe=null;}
  liveTrips=[];
  stopSessionListener();
  updateListenerStatus(false);
  if(currentPage==='reports'&&reportTab==='live')renderLiveTab();
}

function updateListenerStatus(state){
  const el=document.getElementById('listenerStatusBar');
  if(!el)return;
  if(state===true){
    el.className='listener-status on';
    el.innerHTML=`<span class="live-dot"></span>LIVE  LISTENING FOR NEW TRIPS`;
  }else if(state==='connecting'){
    el.className='listener-status on';
    el.innerHTML=`<span class="live-dot"></span>CONNECTING...`;
  }else{
    el.className='listener-status off';
    el.innerHTML=` LISTENER OFF  ${appConfig.projectId?'TAP START':'CONFIGURE FIREBASE IN ADMIN'}`;
  }
}

function renderLiveTab(){
  const el=document.getElementById('rsect-live');
  if(!el)return;
  const today=new Date().toLocaleDateString('en-GB');
  const now=Date.now();
  const todayLive=liveTrips.filter(t=>t.date===today);
  const totalRev=todayLive.reduce((s,t)=>s+(t.amount||0),0);
  const isOn=!!liveUnsubscribe;

  //  Build per-car data combining sessions + trips 
  // Get all known cars from sessions + today's trips
  const knownPlates = new Set([
    ...Object.keys(liveSessions),
    ...todayLive.map(t=>t.carPlate).filter(Boolean)
  ]);

  // For each plate, merge session info with trip stats
  const STALE_MS = 14 * 60 * 60 * 1000; // 14h  same as listener window
  const fleetData = [...knownPlates].map(plate=>{
    const sess   = liveSessions[plate] || null;
    const cTrips = todayLive.filter(t=>t.carPlate===plate);
    const lastTrip = cTrips.length ? cTrips.reduce((a,b)=>((a.dateMs||0)>(b.dateMs||0)?a:b)) : null;
    const cRev   = cTrips.reduce((s,t)=>s+(t.amount||0),0);

    // Determine status: session doc wins, fallback to trips
    let status = 'offline';
    if(sess){
      const age = now - (sess.updatedAt||0);
      if(age < STALE_MS) status = sess.status || 'online';
      if(age > 3*60*60*1000) status = 'offline'; // 3h no update = offline
    } else if(lastTrip && (now-(lastTrip.dateMs||0)) < 90*60*1000){
      status = 'idle'; // had a trip <90min ago, no session = older app version
    }

    return {
      plate,
      driver:   sess?.driver || lastTrip?.driver || '',
      status,
      from:     sess?.from   || lastTrip?.fromStation || '',
      to:       sess?.to     || lastTrip?.toStation   || '',
      updatedAt: sess?.updatedAt || lastTrip?.dateMs || 0,
      loginTime: sess?.loginTime || null,
      lastTrip,
      trips:    cTrips.length,
      revenue:  cRev
    };
  }).filter(v=>v.status!=='offline' || v.trips>0 ) // hide truly offline + no trips today
    .sort((a,b)=>{
      const order={driving:0,arrived:1,idle:2,online:3,offline:4};
      return (order[a.status]??5)-(order[b.status]??5) || b.updatedAt-a.updatedAt;
    });

  const onlineCount   = fleetData.filter(v=>v.status==='driving'||v.status==='arrived'||v.status==='online').length;
  const drivingCount  = fleetData.filter(v=>v.status==='driving').length;
  const idleCount     = fleetData.filter(v=>v.status==='idle').length;

  function minsAgo(ms){ const m=Math.floor((now-(ms||0))/60000); return m<1?'JUST NOW':m<60?m+'M AGO':Math.floor(m/60)+'H '+m%60+'M AGO'; }
  function statusLabel(s){return{driving:' ON THE ROAD',arrived:' ARRIVED',idle:' IDLE',online:' LOGGED IN',offline:' OFFLINE'}[s]||s.toUpperCase();}
  function statusColor(s){return{driving:'#22c55e',arrived:'#f59e0b',idle:'var(--muted)',online:'var(--accent)',offline:'var(--border)'}[s]||'var(--muted)';}
  function statusBorder(s){return{driving:'#22c55e',arrived:'#f59e0b',idle:'var(--border)',online:'var(--accent)',offline:'var(--border)'}[s]||'var(--border)';}

  el.innerHTML=`
    <!-- Listener bar -->
    <div class="listener-status ${isOn?'on':'off'}" id="listenerStatusBar">
      ${isOn?`<span class="live-dot"></span>LIVE  FLEET MONITORING ACTIVE`:` LISTENER OFF  ${appConfig.projectId?'TAP START':'CONFIGURE FIREBASE IN ADMIN'}`}
    </div>
    <div style="display:flex;gap:7px;margin-bottom:12px">
      ${isOn
        ?`<button class="bsm br" style="flex:1;padding:10px" onclick="stopLiveListener()"> STOP</button>`
        :`<button class="bsm bg" style="flex:1;padding:10px" onclick="startLiveListener()"> START LIVE MONITORING</button>`}
    </div>

    <!-- Fleet summary strip -->
    <div class="live-stats" style="margin-bottom:14px">
      <div class="live-stat"><div class="lsl">ON THE ROAD</div><div class="lsv" style="color:#22c55e">${drivingCount}</div></div>
      <div class="live-stat"><div class="lsl">ONLINE TODAY</div><div class="lsv" style="color:var(--accent)">${onlineCount}</div></div>
      <div class="live-stat"><div class="lsl">TODAY TRIPS</div><div class="lsv">${todayLive.length}</div></div>
      <div class="live-stat"><div class="lsl">TODAY REVENUE</div><div class="lsv" style="font-size:.8rem">KES ${(totalRev/1000).toFixed(1)}K</div></div>
    </div>

    ${fleetData.length?`
    <!--  FLEET STATUS BOARD  -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
      <div class="stitle2" style="margin:0"> FLEET STATUS</div>
      <div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px">${new Date().toLocaleTimeString()}</div>
    </div>

    ${fleetData.map(v=>`
    <div style="background:var(--card);border:2px solid ${statusBorder(v.status)};margin-bottom:9px;overflow:hidden;transition:border-color .4s">

      <!-- TOP ROW: plate + driver + status badge -->
      <div style="display:grid;grid-template-columns:auto 1fr auto;gap:0;align-items:stretch">

        <!-- Plate -->
        <div style="background:${statusBorder(v.status)};padding:10px 14px;display:flex;align-items:center;justify-content:center;min-width:88px;transition:background .4s">
          <div style="text-align:center">
            <div style="font-family:var(--font-d);font-size:1.05rem;letter-spacing:3px;color:${v.status==='offline'?'var(--muted)':'#fff'};line-height:1">${v.plate}</div>
            ${v.status==='driving'?`<div style="font-family:var(--font-m);font-size:.38rem;color:rgba(255,255,255,.8);letter-spacing:1px;margin-top:3px">IN MOTION</div>`:''}
          </div>
        </div>

        <!-- Driver + route -->
        <div style="padding:9px 11px">
          <div style="font-family:var(--font-m);font-size:.66rem;font-weight:700;color:var(--text);letter-spacing:1px;margin-bottom:3px">${v.driver}</div>

          ${v.status==='driving'?`
          <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px">
            <span style="font-family:var(--font-m);font-size:.54rem;color:var(--muted)">${v.from||'?'}</span>
            <span style="color:#22c55e;font-size:.6rem"></span>
            <span style="font-family:var(--font-m);font-size:.54rem;color:#22c55e;font-weight:700">DESTINATION</span>
          </div>
          <div style="font-size:.46rem;color:#22c55e;font-family:var(--font-m)"> DEPARTED ${minsAgo(v.updatedAt)}</div>
          `:v.status==='arrived'?`
          <div style="display:flex;align-items:center;gap:5px;margin-bottom:3px">
            <span style="font-family:var(--font-m);font-size:.54rem;color:var(--muted)">${v.from||'?'}</span>
            <span style="color:#f59e0b;font-size:.6rem"></span>
            <span style="font-family:var(--font-m);font-size:.54rem;color:#f59e0b;font-weight:700">${v.to||'LOGGING...'}</span>
          </div>
          <div style="font-size:.46rem;color:#f59e0b;font-family:var(--font-m)"> ARRIVED ${minsAgo(v.updatedAt)}</div>
          `:v.status==='idle'?`
          <div style="font-size:.52rem;color:var(--muted);margin-bottom:2px">LAST: ${v.from||'?'}  ${v.to||'?'}</div>
          <div style="font-size:.46rem;color:var(--muted)">${minsAgo(v.updatedAt)}</div>
          `:v.status==='online'?`
          <div style="font-size:.52rem;color:var(--accent);margin-bottom:2px"> LOGGED IN  READY</div>
          <div style="font-size:.46rem;color:var(--muted)">${v.loginTime?'SINCE '+minsAgo(v.loginTime):minsAgo(v.updatedAt)}</div>
          `:`
          <div style="font-size:.52rem;color:var(--muted)">LAST SEEN ${minsAgo(v.updatedAt)}</div>
          `}
        </div>

        <!-- Right: trips + revenue -->
        <div style="padding:9px 11px;text-align:right;display:flex;flex-direction:column;justify-content:center;border-left:1px solid var(--border)">
          <div style="font-family:var(--font-d);font-size:1.3rem;color:var(--accent);line-height:1">${v.trips}</div>
          <div style="font-family:var(--font-m);font-size:.42rem;color:var(--muted);letter-spacing:1px">TRIPS</div>
          ${v.revenue?`<div style="font-family:var(--font-m);font-size:.52rem;color:var(--accent);margin-top:4px;font-weight:700">KES ${(v.revenue/1000).toFixed(1)}K</div>`:''}
        </div>
      </div>

      <!-- PROGRESS BAR for driving/arrived -->
      ${v.status==='driving'?`<div style="height:3px;background:rgba(34,197,94,.15)"><div style="height:100%;background:#22c55e;width:60%;animation:none"></div></div>`:
        v.status==='arrived'?`<div style="height:3px;background:rgba(245,158,11,.15)"><div style="height:100%;background:#f59e0b;width:85%"></div></div>`:''}
    </div>`).join('')}

    <!--  TRIP FEED  -->
    ${todayLive.length?`
    <div class="stitle2" style="margin:14px 0 8px"> TODAY'S TRIP FEED</div>
    ${liveTrips.slice(0,50).map(t=>`
      <div class="live-item ${liveNewIds.has(t._fbId)?'new':''}">
        <div class="live-top">
          <span style="display:flex;align-items:center;gap:6px">
            <span style="font-family:var(--font-m);font-size:.52rem;background:var(--accent);color:#fff;padding:2px 8px;letter-spacing:1px">${t.carPlate||''}</span>
            <span class="live-route">${t.fromStation||'?'}  ${t.toStation||'?'}</span>
          </span>
          <span class="live-amt">KES ${Number(t.amount||0).toLocaleString()}</span>
        </div>
        <div class="live-bot">
          <span>${t.driver||''}${t.distance?`   ${t.distance}km`:''}</span>
          <span class="live-time">${t.time||t.date||''}</span>
        </div>
      </div>`).join('')}`:''}
    `:`<div class="live-empty">${isOn?' WAITING FOR DRIVERS TO LOG IN...<br><br>EACH VEHICLE WILL APPEAR HERE<br>WHEN THE DRIVER STARTS THE APP':' START THE LISTENER ABOVE<br>TO MONITOR ALL VEHICLES IN REAL TIME<br><br>REQUIRES FIREBASE CONNECTION'}</div>`}`;
}
// 
// DRIVER: PERFORMANCE PAGE
// 
function renderPerformancePage(){
  const el = document.getElementById('page-performance');
  if(!el) return;
  const driver = tripState.driver;
  const all    = allData().filter(t=>t.driver===driver);
  const today  = new Date().toLocaleDateString('en-GB');
  const todayT = all.filter(t=>t.date===today);
  const todayRev = todayT.reduce((s,t)=>s+(t.amount||0),0);
  const target   = driverTargets[driver] || carTargets[tripState.carPlate];
  const tpct     = target ? Math.min(150,Math.round((todayRev/target)*100)) : null;

  // This week
  const weekStart = new Date(); weekStart.setDate(weekStart.getDate()-weekStart.getDay()); weekStart.setHours(0,0,0,0);
  const weekT  = all.filter(t=>{ const d=parseDate(t.date); return d&&d>=weekStart; });
  const weekRev = weekT.reduce((s,t)=>s+(t.amount||0),0);

  // Last 7 days bar chart data
  const days7=[]; for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days7.push(d);}
  const days7rev=days7.map(d=>{
    const lbl=d.toLocaleDateString('en-GB');
    return{lbl:d.toLocaleDateString('en-GB',{weekday:'short'}).toUpperCase(),rev:all.filter(t=>t.date===lbl).reduce((s,t)=>s+(t.amount||0),0)};
  });
  const maxRev = Math.max(...days7rev.map(d=>d.rev),1);

  // All-time stats
  const totalRev  = all.reduce((s,t)=>s+(t.amount||0),0);
  const bestDay   = days7rev.reduce((a,b)=>b.rev>a.rev?b:a,{lbl:'',rev:0});
  const avgPerTrip= all.length ? Math.round(totalRev/all.length) : 0;

  // Emoji for target pct
  const targetEmoji = !tpct?'':tpct>=150?'':tpct>=120?'':tpct>=100?'':tpct>=50?'':'';

  el.innerHTML=`
    <div style="padding:12px 0 80px">
      <div class="ctitle" style="margin-bottom:2px">MY PERFORMANCE</div>
      <div class="csub" style="margin-bottom:14px">// ${driver}</div>

      ${target?`
      <!-- TARGET RING -->
      <div class="card" style="border-left:4px solid ${tpct>=100?'#22c55e':tpct>=50?'#f59e0b':'var(--red)'}; margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="text-align:center;min-width:72px">
            <div style="font-size:2.2rem">${targetEmoji}</div>
            <div style="font-family:var(--font-d);font-size:1.6rem;color:${tpct>=100?'#22c55e':tpct>=50?'#f59e0b':'var(--red)'};">${tpct}%</div>
            <div style="font-family:var(--font-m);font-size:.44rem;color:var(--muted)">OF TARGET</div>
          </div>
          <div style="flex:1">
            <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);margin-bottom:4px">TODAY'S TARGET</div>
            <div class="target-bar" style="margin-bottom:5px"><div class="target-fill ${tpct>=100?'high':tpct>=50?'mid':'low'}" style="width:${Math.min(100,tpct||0)}%"></div></div>
            <div style="display:flex;justify-content:space-between;font-family:var(--font-m);font-size:.5rem">
              <span style="color:${tpct>=100?'#22c55e':'var(--text)'}">KES ${todayRev.toLocaleString()}</span>
              <span style="color:var(--muted)">/ KES ${Number(target).toLocaleString()}</span>
            </div>
          </div>
        </div>
      </div>`:''}

      <!-- STAT GRID -->
      <div class="perf-stat-grid">
        <div class="perf-stat">
          <div class="perf-stat-lbl">TRIPS TODAY</div>
          <div class="perf-stat-val">${todayT.length}</div>
          <div class="perf-stat-sub">KES ${todayRev.toLocaleString()}</div>
        </div>
        <div class="perf-stat">
          <div class="perf-stat-lbl">THIS WEEK</div>
          <div class="perf-stat-val">${weekT.length}</div>
          <div class="perf-stat-sub">KES ${weekRev.toLocaleString()}</div>
        </div>
        <div class="perf-stat">
          <div class="perf-stat-lbl">AVG PER TRIP</div>
          <div class="perf-stat-val" style="font-size:1.2rem">KES ${avgPerTrip.toLocaleString()}</div>
          <div class="perf-stat-sub">ALL TIME</div>
        </div>
        <div class="perf-stat">
          <div class="perf-stat-lbl">TOTAL TRIPS</div>
          <div class="perf-stat-val">${all.length}</div>
          <div class="perf-stat-sub">KES ${(totalRev/1000).toFixed(1)}K TOTAL</div>
        </div>
      </div>

      <!-- 7-DAY BAR CHART -->
      <div class="card" style="margin-bottom:10px">
        <div class="stitle2" style="margin-bottom:10px">LAST 7 DAYS</div>
        <div class="week-bar">
          ${days7rev.map(d=>`
          <div class="week-bar-col">
            <div style="font-family:var(--font-m);font-size:.4rem;color:var(--muted)">${d.rev?'KES '+(d.rev/1000).toFixed(1)+'K':''}</div>
            <div class="week-bar-fill" style="height:${Math.round((d.rev/maxRev)*54)+2}px;background:${d.lbl===new Date().toLocaleDateString('en-GB',{weekday:'short'}).toUpperCase()?'#22c55e':'var(--accent)'}"></div>
            <div class="week-bar-lbl">${d.lbl}</div>
          </div>`).join('')}
        </div>
        ${target?`<div style="border-top:1px solid var(--border);margin-top:8px;padding-top:7px;font-family:var(--font-m);font-size:.48rem;color:var(--muted);text-align:center">Daily target: KES ${Number(target).toLocaleString()}</div>`:''}
      </div>

      <!-- RECENT TRIPS -->
      <div class="stitle2" style="margin-bottom:8px">RECENT TRIPS</div>
      ${all.slice(0,15).map(t=>`
      <div class="hitem">
        <div class="htop"><span class="hroute">${t.fromStation||'?'}  ${t.toStation||'?'}</span><span class="hamt">KES ${Number(t.amount||0).toLocaleString()}</span></div>
        <div class="hbot"><span>${t.date}  ${t.time||''}</span><span>${t.distance?' '+t.distance+'km':''}</span></div>
      </div>`).join('')}
      ${!all.length?'<div class="empty">NO TRIPS YET<br>COMPLETE YOUR FIRST TRIP TO SEE STATS</div>':''}
    </div>`;
}

// 
// DRIVER: NOTES PAGE (Strategies + Reasons)
// 
function renderNotesPage(){
  const el = document.getElementById('page-notes');
  if(!el) return;
  el.innerHTML=`
    <div style="padding:12px 0 80px">
      <div class="ctitle" style="margin-bottom:2px">MY NOTES</div>
      <div class="csub" style="margin-bottom:16px">// STRATEGIES &amp; REFLECTIONS</div>

      <!-- ADD NOTE FORM -->
      <div class="card" style="margin-bottom:14px">
        <div class="stitle2" style="margin-bottom:10px">ADD NEW NOTE</div>

        <!-- Type selector -->
        <div class="note-type-btns">
          <button class="note-type-btn strategy ${driverNoteType==='strategy'?'selected':''}"
            onclick="driverNoteType='strategy';renderNotesPage()">
             STRATEGY<br><span style="font-size:.42rem;letter-spacing:0">How I'll hit my target</span>
          </button>
          <button class="note-type-btn reason ${driverNoteType==='reason'?'selected':''}"
            onclick="driverNoteType='reason';renderNotesPage()">
             REASON<br><span style="font-size:.42rem;letter-spacing:0">Why I didn't hit target</span>
          </button>
        </div>

        <!-- Text input -->
        <div class="auth-field" style="margin-bottom:8px">
          <label style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;display:block;margin-bottom:5px">
            ${driverNoteType==='strategy'?'MY STRATEGY / PLAN':'REASON / EXPLANATION'}
          </label>
          <textarea id="noteTextIn" rows="4"
            placeholder="${driverNoteType==='strategy'?'e.g. I will focus on peak hours (7-9am and 5-7pm), take shorter breaks, and be more friendly to passengers...':'e.g. Low passenger demand today due to rain. Will plan better for weather conditions next time...'}"
            style="width:100%;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:11px 12px;font-family:var(--font-b);font-size:.72rem;outline:none;resize:vertical;line-height:1.5;transition:border-color .2s"
            onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></textarea>
        </div>

        <button class="bb bstart" style="margin:0;font-size:.8rem" onclick="saveDriverNote()">
           SAVE NOTE
        </button>
      </div>

      <!-- NOTES LIST -->
      <div class="stitle2" style="margin-bottom:8px">MY PREVIOUS NOTES</div>
      <div id="driverNotesList">
        <div style="text-align:center;padding:20px;font-family:var(--font-m);font-size:.54rem;color:var(--muted)">
          LOADING NOTES...
        </div>
      </div>
    </div>`;

  // Load notes from Firestore
  loadDriverNotes();
}

async function saveDriverNote(){
  const text = (document.getElementById('noteTextIn')?.value||'').trim();
  if(!text){ toast(' PLEASE WRITE SOMETHING BEFORE SAVING'); return; }
  if(!db){ toast(' NOT CONNECTED  TRY AGAIN'); return; }

  const btn = document.querySelector('#page-notes .bb.bstart');
  if(btn){ btn.disabled=true; btn.textContent='SAVING...'; }

  const note = {
    uid:       currentAuthUser?.uid||'',
    driver:    tripState.driver,
    carPlate:  tripState.carPlate,
    type:      driverNoteType,     // 'strategy' | 'reason'
    text,
    date:      new Date().toLocaleDateString('en-GB'),
    timestamp: new Date().toISOString(),
    createdAt: Date.now()
  };

  try{
    await db.collection('driverNotes').add(note);
    driverNotes.unshift(note);
    if(btn){ btn.disabled=false; btn.textContent=' SAVE NOTE'; }
    toast(' NOTE SAVED!');
    document.getElementById('noteTextIn').value='';
    renderNotesList();
  } catch(e){
    if(btn){ btn.disabled=false; btn.textContent=' SAVE NOTE'; }
    toast(' SAVE FAILED: '+e.message);
  }
}

async function loadDriverNotes(){
  if(!db || !currentAuthUser) return;
  try{
    const snap = await db.collection('driverNotes')
      .where('uid','==',currentAuthUser.uid)
      .orderBy('createdAt','desc')
      .limit(50)
      .get();
    driverNotes = snap.docs.map(d=>({...d.data(),_id:d.id}));
    renderNotesList();
  } catch(e){
    // Fallback: query by driver name
    try{
      const snap = await db.collection('driverNotes')
        .where('driver','==',tripState.driver)
        .orderBy('createdAt','desc').limit(50).get();
      driverNotes = snap.docs.map(d=>({...d.data(),_id:d.id}));
      renderNotesList();
    } catch(e2){
      const el=document.getElementById('driverNotesList');
      if(el) el.innerHTML='<div style="color:var(--muted);font-family:var(--font-m);font-size:.52rem;padding:12px;text-align:center">NO NOTES YET  ADD YOUR FIRST NOTE ABOVE</div>';
    }
  }
}

function renderNotesList(){
  const el = document.getElementById('driverNotesList');
  if(!el) return;
  if(!driverNotes.length){
    el.innerHTML='<div style="text-align:center;padding:20px;font-family:var(--font-m);font-size:.54rem;color:var(--muted)">NO NOTES YET<br><br>ADD YOUR FIRST STRATEGY OR REFLECTION ABOVE </div>';
    return;
  }
  el.innerHTML = driverNotes.map(n=>`
    <div class="note-card ${n.type}">
      <div class="note-card-type ${n.type}">${n.type==='strategy'?' STRATEGY':' REASON FOR MISS'}</div>
      <div class="note-card-text">${n.text}</div>
      <div class="note-card-meta">${n.date} ${n.timestamp?' '+new Date(n.timestamp).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}):''}</div>
    </div>`).join('');
}



// 
// INIT  with trip recovery + login reset on refresh
// 
(function initApp(){
  const savedTrip = load(FS_TRIPSTATE_KEY, null);

  if(savedTrip && ACTIVE_PHASES.includes(savedTrip.phase)){
    //  Restore the active trip 
    Object.assign(tripState, savedTrip);
    // tripStart/tripEnd were saved as timestamps (numbers)  ensure they stay numbers
    if(tripState.tripStart) tripState.tripStart = Number(tripState.tripStart);
    if(tripState.tripEnd)   tripState.tripEnd   = Number(tripState.tripEnd);
    tripState.gpsWatchId = null; // will be re-acquired below

    // Show driver badge
    document.getElementById('driverBadge').textContent =
      tripState.driver.split(' ')[0] + '  ' + tripState.carPlate;

    // Show recovery overlay
    showTripRecoveryOverlay(savedTrip);

    // Start background services  trip is still going
    startSessionTimer();
    startGpsWatch();
    if(tripState.phase === 'active') startTripTimer();

  } else {
    //  No active trip  go back to Driver Login 
    clearSavedTripState();
    // Reset tripState to setup regardless of what was saved
    tripState.phase   = 'setup';
    tripState.driver  = '';
    tripState.carPlate= '';
    tripState.fromStation = null;
    tripState.toStation   = null;
    tripState.amount  = '';
    tripState.notes   = '';
    tripState.tripStart = null;
    tripState.tripEnd   = null;
    // Clear persisted login so badge shows "LOGIN"
    save('fs_driver', null);
    document.getElementById('driverBadge').textContent = ' LOGIN ';
  }

  updateOfflineBadge();
  startAutoSync();
  // Apply saved sacco name to UI
  if(appConfig.saccoName) updateSaccoName(appConfig.saccoName);

  if(initFirebase()){
    // Invite link? Handle before anything else
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('invite') === '1' || auth.isSignInWithEmailLink(window.location.href)){
      handleInviteLink();
    } else {
      // Register the observer for page-reload session restores
      startAuthListener();

      // Immediately show the right panel for fresh (no-session) loads
      // Firebase will override this if a session exists (observer fires)
      const hasEmail = !!localStorage.getItem('fs_last_email');
      showAuthOverlay();
      if(hasEmail){
        // Returning user  drop straight to login form, pre-fill email
        switchToPanel('login');
        setTimeout(()=>{
          const el = document.getElementById('authEmail');
          if(el) el.value = localStorage.getItem('fs_last_email');
        }, 80);
      } else {
        // Brand new user  show landing so they can choose create/login
        switchToPanel('landing');
      }
    }
    if(isOnline()){
      loadFirebaseData(true);
      startLiveListener();
    }
  } else {
    renderLog();
    showAuthOverlay();
    switchToPanel('landing');
  }
})();

function showTripRecoveryOverlay(snap){
  const info = document.getElementById('tripRecoveryInfo');
  if(!info) return;

  const elapsed = snap.tripStart
    ? Math.floor((Date.now() - Number(snap.tripStart)) / 60000) : null;

  const phaseLabel = snap.phase==='active'
    ? ' IN PROGRESS'
    : snap.phase==='arrived'
    ? ' ARRIVED  AWAITING END DETAILS'
    : snap.phase==='confirm'
    ? ' READY TO SUBMIT'
    : snap.phase.toUpperCase();

  info.innerHTML = `
    <div class="trip-recovery-row"><span>DRIVER</span><span>${snap.driver||''}</span></div>
    <div class="trip-recovery-row"><span>CAR</span><span>${snap.carPlate||''}</span></div>
    <div class="trip-recovery-row"><span>FROM</span><span>${snap.fromStation?.name||snap.fromStation||''}</span></div>
    ${snap.toStation?`<div class="trip-recovery-row"><span>TO</span><span>${snap.toStation?.name||snap.toStation}</span></div>`:''}
    <div class="trip-recovery-row"><span>STATUS</span><span style="color:#f59e0b">${phaseLabel}</span></div>
    ${elapsed!==null?`<div class="trip-recovery-row"><span>TRIP TIME</span><span>${elapsed} MIN AGO</span></div>`:''}
    ${snap.amount?`<div class="trip-recovery-row"><span>AMOUNT</span><span>KES ${Number(snap.amount).toLocaleString()}</span></div>`:''}`;

  document.getElementById('tripRecoveryOverlay').classList.add('show');
}

function resumeActiveTrip(){
  document.getElementById('tripRecoveryOverlay').classList.remove('show');
  renderLog();
  toast(' TRIP RESTORED  PLEASE COMPLETE AND SUBMIT');
}

function abandonTripAndReset(){
  if(!confirm(' ARE YOU SURE? THIS WILL DISCARD YOUR CURRENT TRIP AND LOG YOU OUT.')){return;}
  clearSavedTripState();
  save('fs_driver', null);
  tripState.phase='setup';
  tripState.driver=''; tripState.carPlate='';
  tripState.fromStation=null; tripState.toStation=null;
  tripState.amount=''; tripState.notes='';
  tripState.tripStart=null; tripState.tripEnd=null;
  clearInterval(timerInterval);
  document.getElementById('driverBadge').textContent=' LOGIN ';
  document.getElementById('tripRecoveryOverlay').classList.remove('show');
  renderLog();
  toast('LOGGED OUT  PLEASE LOG IN AGAIN');
}

// 
// BEFOREUNLOAD  warn on active trip + save state
// 
window.addEventListener('beforeunload', e => {
  if(ACTIVE_PHASES.includes(tripState.phase)){
    // Always save latest state before the page unloads
    saveTripState();
    // Show browser-native warning dialog
    const msg = 'YOU HAVE AN ACTIVE TRIP IN PROGRESS! Refresh now and your trip details will be restored, but please end it first.';
    e.preventDefault();
    e.returnValue = msg;
    return msg;
  }
});

// 
// PWA  Service Worker + Install Prompt
// 
let pwaInstallEvent = null;

// Register service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('sw.js')
      .then(reg=>{
        console.log('[PWA] Service worker registered:', reg.scope);
        // Check for updates every time the app loads
        reg.addEventListener('updatefound', ()=>{
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', ()=>{
            if(newWorker.state==='installed' && navigator.serviceWorker.controller){
              toast(' APP UPDATE AVAILABLE  REFRESH TO UPDATE');
            }
          });
        });
      })
      .catch(err => console.log('[PWA] Service worker registration failed:', err));
  });
}

// Capture the install prompt (Android Chrome)
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  pwaInstallEvent = e;
  // Show banner only if not already installed and not dismissed recently
  const dismissed = localStorage.getItem('pwa_dismissed');
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches;
  if(!isInstalled && (!dismissed || Date.now() - parseInt(dismissed) > 7*24*60*60*1000)){
    setTimeout(()=>document.getElementById('pwaBanner')?.classList.add('show'), 3000);
  }
});

// Handle install button tap
document.getElementById('pwaInstallBtn')?.addEventListener('click', async ()=>{
  if(!pwaInstallEvent){ toast('TO INSTALL: TAP BROWSER MENU  ADD TO HOME SCREEN'); return; }
  pwaInstallEvent.prompt();
  const { outcome } = await pwaInstallEvent.userChoice;
  if(outcome === 'accepted'){
    toast(' FESTUS SACCO INSTALLED!');
    document.getElementById('pwaBanner')?.classList.remove('show');
  }
  pwaInstallEvent = null;
});

function dismissPwaBanner(){
  document.getElementById('pwaBanner')?.classList.remove('show');
  localStorage.setItem('pwa_dismissed', Date.now().toString());
}

// If already running as installed PWA, update theme color for dark mode
function updatePwaTheme(){
  const meta = document.getElementById('themeColorMeta');
  if(meta) meta.setAttribute('content', darkMode ? '#0d1410' : '#1a7a3c');
}
updatePwaTheme();

// Show iOS install instructions if Safari and not installed
(function(){
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /safari/i.test(navigator.userAgent) && !/chrome/i.test(navigator.userAgent);
  const isStandalone = window.navigator.standalone === true;
  const dismissed = localStorage.getItem('pwa_ios_dismissed');
  if(isIos && isSafari && !isStandalone && (!dismissed || Date.now()-parseInt(dismissed)>7*24*60*60*1000)){
    setTimeout(()=>{
      const banner = document.getElementById('pwaBanner');
      const btn    = document.getElementById('pwaInstallBtn');
      if(banner && btn){
        banner.querySelector('.pwa-banner-text').innerHTML =
          '<strong>INSTALL ON IPHONE</strong>TAP <strong>Share </strong> THEN <strong>"ADD TO HOME SCREEN"</strong>';
        btn.style.display='none';
        banner.classList.add('show');
        // Auto dismiss after 8 seconds
        setTimeout(()=>{
          banner.classList.remove('show');
          localStorage.setItem('pwa_ios_dismissed', Date.now().toString());
        }, 8000);
      }
    }, 3000);
  }
})();
</script>
</body>
</html>
