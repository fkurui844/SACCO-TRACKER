<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>FESTUS SACCO v7</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Firebase v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f7f5;--card:#fff;--surface:#eef2ee;--border:#dde8dd;
  --accent:#1a7a3c;--alight:#e8f5ed;--accent2:#f0a500;
  --red:#e53935;--rlight:#fdecea;--text:#1a2e1a;--muted:#6a8a6a;
  --shadow:0 2px 16px rgba(26,122,60,.10);--shlg:0 8px 32px rgba(26,122,60,.15);
  --font-d:'Bebas Neue',sans-serif;--font-m:'Space Mono',monospace;--font-b:'DM Sans',sans-serif;
}
[data-theme="dark"]{
  --bg:#0d1410;--card:#141f18;--surface:#1a2820;--border:#2a3e2e;
  --accent:#22c55e;--alight:#0d2a1a;--accent2:#f0a500;
  --red:#ef4444;--rlight:#2a0f0f;--text:#e0f0e4;--muted:#5a8a6a;
  --shadow:0 2px 16px rgba(0,0,0,.4);--shlg:0 8px 32px rgba(0,0,0,.5);
}
body{background:var(--bg);color:var(--text);font-family:var(--font-b);min-height:100vh;max-width:480px;margin:0 auto;transition:background .3s,color .3s}

/* HEADER */
header{background:var(--accent);padding:13px 16px 10px;position:sticky;top:0;z-index:100}
.hrow{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
.logo{font-family:var(--font-d);font-size:1.6rem;letter-spacing:3px;color:#fff}
.logo span{color:var(--accent2)}
.hright{display:flex;align-items:center;gap:7px}
.hsub{font-family:var(--font-m);font-size:.5rem;color:rgba(255,255,255,.6);letter-spacing:2px;display:flex;align-items:center;gap:10px}
.dbadge{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);padding:4px 9px;font-family:var(--font-m);font-size:.52rem;color:#fff;letter-spacing:1px;cursor:pointer;transition:background .2s;white-space:nowrap}
.dbadge:hover{background:rgba(255,255,255,.25)}
.hico{background:rgba(255,255,255,.15);border:none;color:#fff;width:28px;height:28px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;transition:background .2s;flex-shrink:0}
.hico:hover{background:rgba(255,255,255,.3)}
.offline-badge{background:#ef4444;color:#fff;font-family:var(--font-m);font-size:.46rem;padding:2px 6px;letter-spacing:1px;display:none}
.offline-badge.show{display:inline-block}
.sync-timer{font-family:var(--font-m);font-size:.46rem;color:rgba(255,255,255,.55);letter-spacing:1px;white-space:nowrap}
/* Session bar: hidden by default, only shown in last 5 minutes */
.session-bar{font-family:var(--font-m);font-size:.46rem;color:rgba(255,220,100,.9);letter-spacing:1px;white-space:nowrap;display:none}
.session-bar.show{display:inline}
.session-bar.warn{color:#ff6b6b;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

/* NAV */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--card);border-top:2px solid var(--border);display:grid;grid-template-columns:1fr 1fr 1fr;z-index:100;transition:background .3s}
.nbtn{padding:9px 4px;text-align:center;cursor:pointer;border:none;background:transparent;transition:background .15s}
.nbtn.active{background:var(--alight)}
.nbtn .ni{font-size:1.15rem;display:block;margin-bottom:1px}
.nbtn .nl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.nbtn.active .nl{color:var(--accent)}

main{padding:13px 13px 74px}
.page{display:none}.page.active{display:block}

/* CARD */
.card{background:var(--card);border:1px solid var(--border);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);animation:fadeUp .3s ease;transition:background .3s,border-color .3s}
.ctitle{font-family:var(--font-d);font-size:1.2rem;color:var(--accent);letter-spacing:2px;margin-bottom:4px}
.csub{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1px;margin-bottom:13px}

/* FIELD */
.field{margin-bottom:10px}
.field label{display:block;font-family:var(--font-m);font-size:.5rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:4px}
.field select,.field input,.field textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 11px;font-family:var(--font-b);font-size:.86rem;outline:none;transition:border-color .2s;appearance:none}
.field textarea{resize:vertical;min-height:66px;font-size:.82rem}
.field select:focus,.field input:focus,.field textarea:focus{border-color:var(--accent)}

/* STATION GRID */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px}
.sbtn{background:var(--bg);border:2px solid var(--border);padding:10px 7px;text-align:center;cursor:pointer;transition:all .2s;font-family:var(--font-b);font-size:.72rem;color:var(--text);font-weight:500;position:relative}
.sbtn:hover{border-color:var(--accent);color:var(--accent);background:var(--alight)}
.sbtn.sel{border-color:var(--accent);background:var(--accent);color:#fff}
.sbtn.dis{opacity:.22;cursor:not-allowed;pointer-events:none}
.sbtn.nearest{border-color:var(--accent2)}
.sbtn .dist{display:block;font-family:var(--font-m);font-size:.44rem;opacity:.7;margin-top:2px}
.sbtn.sel .dist{opacity:.8}

/* GPS BAR */
.gbar{display:flex;align-items:center;gap:7px;padding:8px 10px;background:var(--alight);border:1px solid var(--border);margin-bottom:11px;font-family:var(--font-m);font-size:.52rem;color:var(--accent);letter-spacing:1px}
.gbar.err{background:var(--rlight);border-color:var(--red);color:var(--red)}
.gbar.detecting{background:var(--surface);border-color:var(--border);color:var(--muted)}

/* ROUTE DISPLAY */
.rdisp{display:flex;align-items:center;gap:10px;padding:12px;background:var(--alight);border:1px solid var(--border);margin-bottom:12px}
.rs{flex:1;text-align:center}
.rs .rn{font-family:var(--font-m);font-size:.66rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.rs .rl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:2px}
.rarr{font-size:1.3rem;color:var(--accent)}

/* TIMER */
.tdisp{text-align:center;padding:13px;background:var(--text);color:var(--bg);margin-bottom:12px;transition:background .3s}
.tl{font-family:var(--font-m);font-size:.48rem;letter-spacing:2px;color:rgba(128,200,128,.7);text-transform:uppercase;margin-bottom:3px}
.tv{font-family:var(--font-d);font-size:2.5rem;letter-spacing:3px;color:#22c55e}

/* SPEED BADGE */
.speed-badge{display:inline-flex;align-items:center;gap:6px;background:var(--alight);border:1px solid var(--border);padding:6px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent);letter-spacing:1px;margin-bottom:10px}
.speed-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0}
.speed-dot.moving{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.25)}

/* AMOUNT */
.awrap{position:relative;margin-bottom:12px}
.apfx{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-family:var(--font-m);font-size:.72rem;color:var(--muted);font-weight:700}
.ainput{width:100%;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:12px 12px 12px 48px;font-family:var(--font-m);font-size:1.1rem;font-weight:700;outline:none;transition:border-color .2s;letter-spacing:1px}
.ainput:focus{border-color:var(--accent)}

/* LOCK */
.lock{padding:15px;background:var(--surface);border:2px dashed var(--border);text-align:center;margin-bottom:12px}
.lico{font-size:1.6rem;margin-bottom:4px;opacity:.3}
.ltxt{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;line-height:1.8;text-transform:uppercase}

/* CONFIRM */
.confirm-card{background:var(--surface);border:2px solid var(--accent);padding:18px;margin-bottom:14px;animation:fadeUp .3s ease}
.confirm-title{font-family:var(--font-d);font-size:1.6rem;color:var(--accent);letter-spacing:3px;text-align:center;margin-bottom:16px}
.confirm-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.confirm-row:last-child{border-bottom:none}
.confirm-label{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase}
.confirm-val{font-family:var(--font-m);font-size:.72rem;color:var(--text);font-weight:700;text-align:right;max-width:60%}
.confirm-amount{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:2px}
.confirm-warn{background:rgba(240,165,0,.12);border:1px solid var(--accent2);padding:9px 12px;font-family:var(--font-m);font-size:.56rem;color:var(--accent2);letter-spacing:1px;margin-bottom:12px;text-align:center}

/* SHIFT */
.shift-open{background:#22c55e;color:#fff;font-family:var(--font-m);font-size:.5rem;padding:2px 8px;letter-spacing:1px;display:inline-block}
.shift-closed{background:var(--red);color:#fff;font-family:var(--font-m);font-size:.5rem;padding:2px 8px;letter-spacing:1px;display:inline-block}
.shift-block{background:var(--rlight);border:2px solid var(--red);padding:20px;text-align:center;margin-bottom:12px}
.shift-block-title{font-family:var(--font-d);font-size:1.4rem;color:var(--red);letter-spacing:2px;margin-bottom:6px}
.shift-block-sub{font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:1.8}

/* PIN LOCKOUT */
.pin-locked{background:var(--rlight);border:1px solid var(--red);padding:10px 13px;font-family:var(--font-m);font-size:.58rem;color:var(--red);letter-spacing:1px;text-align:center;margin-bottom:10px}

/* BUTTONS */
.bb{width:100%;padding:13px;font-family:var(--font-d);font-size:1.1rem;letter-spacing:3px;cursor:pointer;border:none;transition:all .2s;margin-bottom:7px}
.bstart{background:var(--accent);color:#fff}.bstart:hover{background:#156632}.bstart:disabled{background:var(--muted);cursor:not-allowed}
.barrive{background:var(--accent2);color:#fff}.barrive:hover{background:#d4920a}
.bend{background:var(--red);color:#fff}.bend:hover{background:#c0392b}.bend:disabled{background:var(--muted);cursor:not-allowed}
.bconfirm{background:#22c55e;color:#fff}.bconfirm:hover{background:#16a34a}
.bout{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.6rem;letter-spacing:1px;padding:9px;width:100%;cursor:pointer;margin-bottom:7px;transition:all .2s}
.bout:hover{border-color:var(--red);color:var(--red)}
.bsm{padding:7px 12px;font-family:var(--font-m);font-size:.54rem;letter-spacing:1px;cursor:pointer;border:none;transition:all .2s}
.bg{background:var(--accent);color:#fff}.by{background:var(--accent2);color:#fff}.br{background:var(--red);color:#fff}.bgray{background:var(--muted);color:#fff}
.bwa{background:#25D366;color:#fff}
.bghost{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:var(--font-m);font-size:.54rem;padding:7px 12px;cursor:pointer;transition:all .2s}
.bghost:hover{border-color:var(--accent);color:var(--accent)}

/* SUCCESS */
.scard{background:var(--accent);color:#fff;padding:20px 16px;text-align:center;margin-bottom:12px;box-shadow:var(--shlg);animation:fadeUp .4s ease}
.sico{font-size:2.2rem;margin-bottom:8px}
.stitle{font-family:var(--font-d);font-size:1.7rem;letter-spacing:3px;margin-bottom:5px}
.ssub{font-family:var(--font-m);font-size:.54rem;opacity:.8;letter-spacing:1px;line-height:1.8}
.sdetails{background:rgba(255,255,255,.15);padding:11px;margin:12px 0}
.drow{display:flex;justify-content:space-between;font-family:var(--font-m);font-size:.56rem;margin-bottom:4px}
.drow:last-child{margin-bottom:0}

/* HISTORY */
.hsect{margin-top:6px}
.stitle2{font-family:var(--font-m);font-size:.52rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.hitem{background:var(--card);border:1px solid var(--border);padding:10px 12px;margin-bottom:7px;box-shadow:0 1px 4px rgba(0,0,0,.04);transition:background .3s}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.hroute{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--accent);letter-spacing:1px}
.hamt{font-family:var(--font-m);font-size:.61rem;color:#22c55e;font-weight:700}
.hbot{display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted)}
.htime{font-family:var(--font-m);font-size:.5rem}

/* SHIFT SUMMARY */
.sumcard{background:var(--surface);border:1px solid var(--border);padding:14px;margin-bottom:12px}
.sumrow{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border)}
.sumrow:last-child{border-bottom:none}
.sumlbl{font-family:var(--font-m);font-size:.54rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.sumval{font-family:var(--font-d);font-size:1.3rem;color:var(--accent)}

/* REPORTS */
.sgrid2{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
.sbox{background:var(--card);border:1px solid var(--border);padding:13px;box-shadow:var(--shadow);transition:background .3s}
.sbox .sl{font-family:var(--font-m);font-size:.46rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
.sbox .sv{font-family:var(--font-d);font-size:1.6rem;color:var(--text);line-height:1}
.sv.green{color:var(--accent)}.sv.yellow{color:var(--accent2)}
.fchips{display:flex;gap:5px;margin-bottom:10px;flex-wrap:wrap}
.fchip{background:var(--bg);border:1px solid var(--border);padding:4px 9px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;cursor:pointer;color:var(--muted);transition:all .15s;text-transform:uppercase}
.fchip.active{background:var(--accent);border-color:var(--accent);color:#fff}
.rtable{background:var(--card);border:1px solid var(--border);overflow:hidden;margin-bottom:10px;transition:background .3s}
.rth{display:grid;grid-template-columns:1fr 1fr 55px 72px;padding:7px 10px;background:var(--accent);font-family:var(--font-m);font-size:.44rem;color:#fff;letter-spacing:1px;text-transform:uppercase;gap:4px}
.rtr{display:grid;grid-template-columns:1fr 1fr 55px 72px;padding:9px 10px;border-bottom:1px solid var(--border);font-size:.66rem;gap:4px;align-items:center;transition:background .1s}
.rtr:hover{background:var(--alight)}.rtr:last-child{border-bottom:none}
.trroute{font-family:var(--font-m);font-size:.53rem;color:var(--accent);font-weight:700}
.tramt{font-family:var(--font-m);font-size:.58rem;color:#22c55e;font-weight:700;text-align:right}
.exprow{display:flex;gap:6px;margin-bottom:11px;flex-wrap:wrap}
.exprow button{flex:1;min-width:55px}

/* REPORT TABS */
.rtabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--border);overflow-x:auto}
.rtab{font-family:var(--font-m);font-size:.5rem;letter-spacing:1px;padding:8px 12px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase;white-space:nowrap;margin-bottom:-2px}
.rtab.active{color:var(--accent);border-bottom-color:var(--accent)}
.rsect{display:none}.rsect.active{display:block}

/* CHARTS */
.chart-wrap{background:var(--card);border:1px solid var(--border);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.chart-title{font-family:var(--font-m);font-size:.52rem;color:var(--accent);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px}
.chart-canvas{height:200px;position:relative}

/* LEADERBOARD */
.lb-item{display:grid;grid-template-columns:30px 1fr auto;gap:10px;align-items:center;padding:11px 12px;background:var(--card);border:1px solid var(--border);margin-bottom:7px;box-shadow:var(--shadow)}
.lb-rank{font-family:var(--font-d);font-size:1.4rem;color:var(--muted);text-align:center}
.lb-rank.g{color:#f0a500}.lb-rank.s{color:#9ca3af}.lb-rank.b{color:#b87333}
.lb-name{font-family:var(--font-m);font-size:.64rem;font-weight:700;color:var(--text);letter-spacing:1px}
.lb-sub{font-size:.6rem;color:var(--muted);margin-top:2px}
.lb-val{font-family:var(--font-d);font-size:1.3rem;color:var(--accent);text-align:right}
.lb-vsub{font-family:var(--font-m);font-size:.46rem;color:var(--muted);text-align:right;margin-top:2px}
.bar-mini{height:4px;background:var(--border);border-radius:2px;margin-top:5px;overflow:hidden}
.bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width 1s}
.target-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:5px}
.target-fill{height:100%;border-radius:3px;transition:width 1s}
.target-fill.low{background:var(--red)}.target-fill.mid{background:var(--accent2)}.target-fill.high{background:#22c55e}

/* PERFORMANCE */
.perf-card{background:var(--card);border:1px solid var(--border);padding:14px;margin-bottom:10px;box-shadow:var(--shadow)}
.perf-name{font-family:var(--font-d);font-size:1.05rem;color:var(--text);letter-spacing:2px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.score-badge{font-family:var(--font-d);font-size:1rem;padding:2px 9px;letter-spacing:2px}
.score-a{background:#22c55e;color:#fff}.score-b{background:var(--accent2);color:#fff}.score-c{background:var(--red);color:#fff}
.perf-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.pstat{text-align:center;padding:9px 6px;background:var(--surface);border:1px solid var(--border)}
.pstat .pl{font-family:var(--font-m);font-size:.44rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.pstat .pv{font-family:var(--font-d);font-size:1.15rem;color:var(--accent)}

/* ADMIN */
.apinbox{text-align:center;padding:40px 16px}
.apintitle{font-family:var(--font-d);font-size:2rem;color:var(--accent);letter-spacing:3px;margin-bottom:7px}
.apinsub{font-family:var(--font-m);font-size:.56rem;color:var(--muted);letter-spacing:1px;margin-bottom:18px;line-height:1.8}
.pininput{width:180px;text-align:center;font-family:var(--font-m);font-size:1.5rem;letter-spacing:8px;background:var(--bg);border:2px solid var(--border);color:var(--text);padding:13px;outline:none;margin:0 auto 14px;display:block}
.pininput:focus{border-color:var(--accent)}
.atabs{display:flex;gap:0;margin-bottom:12px;border-bottom:2px solid var(--border);overflow-x:auto}
.atab{font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;padding:8px 10px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;background:transparent;border-top:none;border-left:none;border-right:none;transition:all .2s;text-transform:uppercase;white-space:nowrap;margin-bottom:-2px}
.atab.active{color:var(--accent);border-bottom-color:var(--accent)}
.asect{display:none}.asect.active{display:block}
.aitem{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--card);border:1px solid var(--border);margin-bottom:6px;transition:background .3s}
.aitem-name{font-family:var(--font-m);font-size:.68rem;color:var(--text);font-weight:700;letter-spacing:1px}
.aitem-sub{font-size:.62rem;color:var(--muted);margin-top:2px}
.abtn-row{display:flex;gap:5px;flex-shrink:0}
.adel{background:none;border:1px solid var(--border);cursor:pointer;font-size:.72rem;color:var(--muted);padding:4px 8px;transition:all .2s}
.adel:hover{color:var(--red);border-color:var(--red)}
.aedit{background:none;border:1px solid var(--border);cursor:pointer;font-size:.72rem;color:var(--muted);padding:4px 8px;transition:all .2s}
.aedit:hover{color:var(--accent);border-color:var(--accent)}
.addrow{display:flex;gap:7px;align-items:end;margin-top:10px}
.addrow .field{flex:1;margin:0}
.irow{display:flex;gap:7px;align-items:end}
.irow .field{flex:1;margin:0}
.conn-badge{display:inline-flex;align-items:center;gap:5px;background:var(--alight);border:1px solid var(--accent);padding:4px 10px;font-family:var(--font-m);font-size:.5rem;color:var(--accent);letter-spacing:1px;margin-bottom:8px}
.dg{width:7px;height:7px;border-radius:50%;background:#22c55e}
.urlbox{background:var(--bg);border:1px solid var(--border);padding:8px 10px;font-family:var(--font-m);font-size:.5rem;color:var(--muted);word-break:break-all;line-height:1.6;margin-bottom:7px}
.steps{counter-reset:s}
.step{counter-increment:s;padding:8px 10px 8px 32px;border-left:2px solid var(--border);margin-bottom:7px;position:relative;font-size:.74rem;color:var(--text);line-height:1.6}
.step::before{content:counter(s);position:absolute;left:-12px;top:6px;width:22px;height:22px;background:var(--accent);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-m);font-size:.56rem;font-weight:700}
.step code{background:var(--alight);padding:1px 5px;font-family:var(--font-m);font-size:.64rem;color:var(--accent)}

/* SESSION TIMEOUT OVERLAY */
.timeout-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;padding:20px}
.timeout-overlay.open{display:flex}
.timeout-box{background:var(--card);border:3px solid var(--accent2);padding:30px 24px;text-align:center;max-width:320px;width:100%;animation:fadeUp .3s ease}
.timeout-title{font-family:var(--font-d);font-size:2rem;color:var(--accent2);letter-spacing:3px;margin-bottom:8px}
.timeout-sub{font-family:var(--font-m);font-size:.6rem;color:var(--muted);letter-spacing:1px;line-height:1.8;margin-bottom:18px}
.timeout-count{font-family:var(--font-d);font-size:3rem;color:var(--red);letter-spacing:3px;margin-bottom:16px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-top:3px solid var(--accent);padding:22px;width:100%;max-width:380px;animation:fadeUp .3s ease;max-height:90vh;overflow-y:auto}
.modal-title{font-family:var(--font-d);font-size:1.4rem;color:var(--accent);letter-spacing:2px;margin-bottom:14px}
.modal-actions{display:flex;gap:8px;margin-top:14px}
.modal-actions button{flex:1}

/* SHIFT CLOSE SUMMARY MODAL */
.shift-summary-modal .modal{border-top-color:var(--red)}
.shift-sum-row{display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);font-family:var(--font-m);font-size:.62rem}
.shift-sum-row:last-child{border-bottom:none}
.shift-sum-total{font-family:var(--font-d);font-size:1.6rem;color:var(--accent);margin-top:10px;text-align:center}

/* MISC */
.toast{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:9px 16px;font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;z-index:999;opacity:0;transition:opacity .3s;max-width:90vw;text-align:center}
.toast.show{opacity:1}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin:30px auto}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.empty{text-align:center;padding:30px 14px;font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;line-height:2}
.divline{height:1px;background:var(--border);margin:12px 0}
.pill{display:inline-block;background:var(--alight);color:var(--accent);font-family:var(--font-m);font-size:.44rem;padding:2px 6px;letter-spacing:1px;margin-left:5px;vertical-align:middle}
.tag-active{display:inline-flex;align-items:center;gap:4px;background:var(--accent);color:#fff;padding:3px 8px;font-family:var(--font-m);font-size:.48rem;letter-spacing:1px;margin:0 3px 3px 0}
.tag-active span{cursor:pointer;opacity:.8}.tag-active span:hover{opacity:1}
.queue-banner{background:var(--accent2);color:#fff;padding:7px 13px;font-family:var(--font-m);font-size:.56rem;letter-spacing:1px;display:none;align-items:center;justify-content:space-between;cursor:pointer}
.queue-banner.show{display:flex}

@media print{
  .bnav,.hico,header .hright,.exprow,.fchips,.rtabs,.queue-banner,.timeout-overlay,.modal-overlay{display:none!important}
  body{background:#fff!important;color:#000!important;max-width:100%!important}
  main{padding:0!important}
  .page{display:block!important}
  #page-reports .rsect:not(#rsect-overview){display:none!important}
}
</style>
</head>
<body>

<header>
  <div class="hrow">
    <div class="logo">FESTUS<span> SACCO</span></div>
    <div class="hright">
      <span class="session-bar" id="sessionBar"></span>
      <span class="offline-badge" id="offlineBadge">OFFLINE</span>
      <button class="hico" onclick="toggleDark()" id="darkBtn" title="Toggle dark mode">ğŸŒ™</button>
      <div class="dbadge" id="driverBadge" onclick="goSetup()">â€” LOGIN â€”</div>
    </div>
  </div>
  <div class="hsub">
    <span>// TRIP LOGGER</span>
    <span class="sync-timer" id="syncTimer"></span>
  </div>
</header>

<div class="queue-banner" id="queueBanner" onclick="flushQueue()">
  <span id="queueMsg">ğŸ“¦ TRIPS QUEUED OFFLINE â€” TAP TO SYNC</span>
  <span>â†’</span>
</div>

<main>
  <div id="page-log" class="page active"></div>
  <div id="page-reports" class="page"></div>
  <div id="page-admin" class="page"></div>
</main>

<nav class="bnav">
  <button class="nbtn active" id="nav-log" onclick="switchPage('log')">
    <span class="ni">ğŸšŒ</span><span class="nl">LOG TRIP</span>
  </button>
  <button class="nbtn" id="nav-reports" onclick="switchPage('reports')">
    <span class="ni">ğŸ“Š</span><span class="nl">REPORTS</span>
  </button>
  <button class="nbtn" id="nav-admin" onclick="switchPage('admin')">
    <span class="ni">ğŸ‘‘</span><span class="nl">ADMIN</span>
  </button>
</nav>

<!-- SESSION TIMEOUT OVERLAY -->
<div class="timeout-overlay" id="timeoutOverlay">
  <div class="timeout-box">
    <div class="timeout-title">â± STILL THERE?</div>
    <div class="timeout-sub">YOU'LL BE LOGGED OUT IN</div>
    <div class="timeout-count" id="timeoutCount">60</div>
    <div class="timeout-sub" style="margin-bottom:16px">SECONDS DUE TO INACTIVITY</div>
    <button class="bb bstart" style="margin:0" onclick="resetSessionTimer()">âœ‹ I'M STILL HERE</button>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">EDIT TRIP</div>
    <div class="field"><label>Driver</label><input type="text" id="editDriver"></div>
    <div class="field"><label>Car Plate</label><input type="text" id="editCar"></div>
    <div class="field"><label>From Station</label><input type="text" id="editFrom"></div>
    <div class="field"><label>To Station</label><input type="text" id="editTo"></div>
    <div class="field"><label>Amount (KES)</label><input type="number" id="editAmount"></div>
    <div class="field"><label>Date</label><input type="text" id="editDate"></div>
    <div class="modal-actions">
      <button class="bb bstart" style="margin:0" onclick="saveEditTrip()">SAVE</button>
      <button class="bb" style="margin:0;background:var(--border);color:var(--text)" onclick="closeEditModal()">CANCEL</button>
    </div>
  </div>
</div>

<!-- SHIFT CLOSE SUMMARY MODAL -->
<div class="modal-overlay shift-summary-modal" id="shiftSummaryModal">
  <div class="modal">
    <div class="modal-title" style="color:var(--red)">CLOSE SHIFT</div>
    <div id="shiftSummaryBody"></div>
    <div class="modal-actions">
      <button class="bb br" style="margin:0" id="shiftCloseConfirmBtn">CLOSE SHIFT</button>
      <button class="bb" style="margin:0;background:var(--border);color:var(--text)" onclick="document.getElementById('shiftSummaryModal').classList.remove('open')">CANCEL</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEFAULT DATA â€” stations now include GPS coords
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_DRIVERS  = ['FESTUS KIPKURUI','TOM WASIKE','FELIX OTIENO','MUTUA KIRUI','JANETH TIONY','ABIGAEL CHEPKORIR','GRACE WANGECHI'];
const DEFAULT_CARS     = ['KBZ 300','KBY 400','KBU 500','KCA 200','KDY 260W','KYA 520X','KAF 2601'];
const DEFAULT_STATIONS = [
  {name:'NAIROBI CBD', lat:-1.2833, lng:36.8167},
  {name:'WESTLANDS',   lat:-1.2676, lng:36.8112},
  {name:'KAREN',       lat:-1.3197, lng:36.7073},
  {name:'NGONG',       lat:-1.3583, lng:36.6583},
  {name:'RONGAI',      lat:-1.3944, lng:36.7452},
  {name:"LANG'ATA",    lat:-1.3204, lng:36.7571},
  {name:'KIKUYU',      lat:-1.2463, lng:36.6637},
  {name:'LIMURU',      lat:-1.1095, lng:36.6431},
];
const ADMIN_PIN_KEY     = 'fs_pin';
const DEFAULT_ADMIN_PIN = '1234';
const SESSION_TIMEOUT   = 30 * 60;  // 30 min
const SESSION_WARN_SHOW = 5 * 60;   // show bar at 5 min remaining
const SESSION_WARN_OVL  = 60;       // overlay at 60s
const AMOUNT_MIN        = 10;
const AMOUNT_MAX        = 50000;
const MAX_PIN_ATTEMPTS  = 3;
const PIN_LOCKOUT_SECS  = 5 * 60;   // 5-minute lockout

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function load(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch(e){return d;}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}

let DRIVERS    = load('fs_drivers', DEFAULT_DRIVERS);
let CARS       = load('fs_cars', DEFAULT_CARS);
let STATIONS   = load('fs_stations', DEFAULT_STATIONS);
let localTrips = load('fs_trips', []);
let offlineQ      = load('fs_queue', []);
let driverPins    = load('fs_dpins', {});
let carTargets    = load('fs_targets', {});
let shifts        = load('fs_shifts', {});
let firestoreTrips = [];   // trips fetched from Firebase
let appConfig     = load('fs_config', {
  apiKey:'', authDomain:'', projectId:'', appId:''
});

// PIN lockout state (in-memory only â€” resets on page reload, intentional)
let adminPinFailures   = 0;
let adminLockedUntil   = 0;
let driverPinFailures  = {};  // {driverName: {count, until}}

let tripState = {
  phase:'setup', driver:'', carPlate:'',
  fromStation:null, toStation:null,
  amount:'', notes:'',
  tripStart:null, tripEnd:null,
  // GPS / motion
  gpsLat:null, gpsLng:null, gpsStatus:'unknown',
  nearestStation:null,
  gpsWatchId:null,
  speed:null,         // m/s from GPS, null = unknown
};

const sd = load('fs_driver', null);
if(sd){tripState.driver=sd.driver; tripState.carPlate=sd.carPlate; tripState.phase='idle';}

let currentPage        = 'log';
let reportFilter       = 'all';
let filterCar='', filterDriver='', filterFrom='', filterTo='';
let adminTab           = 'shifts';
let reportTab          = 'overview';
let adminUnlocked      = false;
let timerInterval      = null;
let syncInterval       = null;
let syncCountdown      = 300;
let db                 = null;   // Firestore instance
let sessionSecondsLeft = SESSION_TIMEOUT;
let sessionInterval    = null;
let showingTimeout     = false;
let darkMode           = load('fs_dark', false);
let charts             = {};
let editingTripId      = null;

if(darkMode){document.documentElement.setAttribute('data-theme','dark'); document.getElementById('darkBtn').textContent='â˜€ï¸';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DARK MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDark(){
  darkMode=!darkMode; save('fs_dark',darkMode);
  document.documentElement.setAttribute('data-theme',darkMode?'dark':'light');
  document.getElementById('darkBtn').textContent=darkMode?'â˜€ï¸':'ğŸŒ™';
  if(currentPage==='reports'&&reportTab==='charts')setTimeout(renderCharts,100);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION TIMEOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSessionTimer(){
  clearInterval(sessionInterval);
  sessionSecondsLeft=SESSION_TIMEOUT;
  showingTimeout=false;
  sessionInterval=setInterval(tickSession,1000);
  updateSessionBar();
}

function tickSession(){
  if(tripState.phase==='setup'||tripState.phase==='done'){
    clearInterval(sessionInterval);
    hideTimeoutOverlay();
    updateSessionBar();
    return;
  }
  sessionSecondsLeft--;
  updateSessionBar();
  if(sessionSecondsLeft<=0){
    clearInterval(sessionInterval);
    hideTimeoutOverlay();
    toast('SESSION EXPIRED â€” PLEASE LOG IN AGAIN');
    autoLogout();
    return;
  }
  if(sessionSecondsLeft<=SESSION_WARN_OVL && !showingTimeout){
    showingTimeout=true;
    document.getElementById('timeoutOverlay').classList.add('open');
  }
  if(showingTimeout){
    document.getElementById('timeoutCount').textContent=sessionSecondsLeft;
    document.getElementById('sessionBar').textContent='â± '+sessionSecondsLeft+'s';
    document.getElementById('sessionBar').className='session-bar show warn';
  }
}

function updateSessionBar(){
  const bar=document.getElementById('sessionBar');
  if(tripState.phase==='setup'||tripState.phase==='done'){bar.textContent='';bar.className='session-bar';return;}
  if(showingTimeout)return;
  // Only show when â‰¤ 5 minutes left
  if(sessionSecondsLeft <= SESSION_WARN_SHOW){
    const m=Math.floor(sessionSecondsLeft/60);
    const s=sessionSecondsLeft%60;
    bar.textContent=`â± ${m}:${String(s).padStart(2,'0')}`;
    bar.className='session-bar show';
  } else {
    bar.textContent='';
    bar.className='session-bar';
  }
}

function resetSessionTimer(){
  sessionSecondsLeft=SESSION_TIMEOUT;
  showingTimeout=false;
  hideTimeoutOverlay();
  updateSessionBar();
  if(!sessionInterval||sessionSecondsLeft<=0)startSessionTimer();
}

function hideTimeoutOverlay(){
  document.getElementById('timeoutOverlay').classList.remove('open');
  showingTimeout=false;
}

function autoLogout(){
  clearInterval(timerInterval);
  stopGpsWatch();
  tripState={...tripState,phase:'setup',driver:'',carPlate:'',fromStation:null,toStation:null,amount:'',notes:'',tripStart:null,tripEnd:null,gpsLat:null,gpsLng:null,gpsStatus:'unknown',nearestStation:null,speed:null};
  save('fs_driver',null);
  document.getElementById('driverBadge').textContent='â€” LOGIN â€”';
  document.getElementById('sessionBar').textContent='';
  document.getElementById('sessionBar').className='session-bar';
  switchPage('log');
}

['click','touchstart','keypress'].forEach(ev=>{
  document.addEventListener(ev,()=>{
    if(tripState.phase!=='setup'&&tripState.phase!=='done'&&!showingTimeout)resetSessionTimer();
  },{passive:true});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchPage(p){
  currentPage=p;
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nbtn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  document.getElementById('nav-'+p).classList.add('active');
  if(p==='log')renderLog();
  if(p==='reports')renderReports();
  if(p==='admin')renderAdmin();
}
function goSetup(){
  clearInterval(timerInterval);
  stopGpsWatch();
  tripState.phase='setup';
  switchPage('log');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN LOCKOUT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isAdminLocked(){return adminLockedUntil>Date.now();}
function adminLockSecsLeft(){return Math.ceil((adminLockedUntil-Date.now())/1000);}

function recordAdminFailure(){
  adminPinFailures++;
  if(adminPinFailures>=MAX_PIN_ATTEMPTS){
    adminLockedUntil=Date.now()+PIN_LOCKOUT_SECS*1000;
    adminPinFailures=0;
    toast(`ğŸ”’ TOO MANY ATTEMPTS â€” LOCKED FOR ${PIN_LOCKOUT_SECS/60} MINUTES`);
  } else {
    toast(`WRONG PIN â€” ${MAX_PIN_ATTEMPTS-adminPinFailures} ATTEMPT${MAX_PIN_ATTEMPTS-adminPinFailures===1?'':'S'} LEFT`);
  }
}

function isDriverLocked(driver){
  const d=driverPinFailures[driver];
  return d&&d.until>Date.now();
}
function driverLockSecsLeft(driver){
  return Math.ceil((driverPinFailures[driver].until-Date.now())/1000);
}
function recordDriverFailure(driver){
  if(!driverPinFailures[driver])driverPinFailures[driver]={count:0,until:0};
  driverPinFailures[driver].count++;
  if(driverPinFailures[driver].count>=MAX_PIN_ATTEMPTS){
    driverPinFailures[driver].until=Date.now()+PIN_LOCKOUT_SECS*1000;
    driverPinFailures[driver].count=0;
    toast(`ğŸ”’ TOO MANY ATTEMPTS â€” LOCKED FOR ${PIN_LOCKOUT_SECS/60} MINUTES`);
  } else {
    const left=MAX_PIN_ATTEMPTS-driverPinFailures[driver].count;
    toast(`WRONG PIN â€” ${left} ATTEMPT${left===1?'':'S'} LEFT`);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OFFLINE / QUEUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isOnline(){return navigator.onLine;}
function updateOfflineBadge(){
  document.getElementById('offlineBadge').className='offline-badge'+(isOnline()?'':' show');
  const banner=document.getElementById('queueBanner');
  if(offlineQ.length>0){banner.className='queue-banner show';document.getElementById('queueMsg').textContent=`ğŸ“¦ ${offlineQ.length} TRIP${offlineQ.length>1?'S':''} QUEUED â€” TAP TO SYNC`;}
  else{banner.className='queue-banner';}
}
window.addEventListener('online',()=>{updateOfflineBadge();if(offlineQ.length)flushQueue();});
window.addEventListener('offline',()=>updateOfflineBadge());

async function flushQueue(){
  if(!offlineQ.length)return;
  if(!initFirebase()){toast('âš  CONFIGURE FIREBASE IN ADMIN FIRST');return;}
  if(!isOnline()){toast('STILL OFFLINE â€” WILL SYNC WHEN CONNECTED');return;}
  toast('SYNCING '+offlineQ.length+' QUEUED TRIPS...');
  const remaining=[];
  for(const trip of offlineQ){
    try{await db.collection('trips').add(trip);}
    catch(e){remaining.push(trip);}
  }
  offlineQ=remaining; save('fs_queue',offlineQ);
  toast(remaining.length===0?'âœ… ALL TRIPS SYNCED':'âš  '+remaining.length+' STILL QUEUED');
  updateOfflineBadge();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-SYNC â€” refresh Firebase every 5 min
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startAutoSync(){
  clearInterval(syncInterval);
  syncCountdown=300;
  syncInterval=setInterval(()=>{
    syncCountdown--;
    const el=document.getElementById('syncTimer');
    if(el)el.textContent='SYNC '+Math.floor(syncCountdown/60)+':'+String(syncCountdown%60).padStart(2,'0');
    if(syncCountdown<=0){
      syncCountdown=300;
      if(isOnline())flushQueue();
      if(currentPage==='reports'&&isOnline())loadFirebaseData(true);
    }
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS â€” passive watch (doesn't block flow)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hav(a,b,c,d){const R=6371,dL=(c-a)*Math.PI/180,dO=(d-b)*Math.PI/180,x=Math.sin(dL/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dO/2)**2;return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));}

function findNearest(lat,lng){
  let best=null,bd=Infinity;
  STATIONS.forEach(s=>{
    if(!s.lat||!s.lng)return;
    const d=hav(lat,lng,s.lat,s.lng);
    if(d<bd){bd=d;best={...s,dist:d};}
  });
  return best;
}

function startGpsWatch(){
  stopGpsWatch();
  if(!navigator.geolocation){tripState.gpsStatus='unsupported';return;}
  tripState.gpsStatus='detecting';
  tripState.gpsWatchId=navigator.geolocation.watchPosition(
    pos=>{
      const prevNearest=tripState.nearestStation?.name;
      tripState.gpsLat=pos.coords.latitude;
      tripState.gpsLng=pos.coords.longitude;
      tripState.gpsStatus='ok';
      tripState.speed=(pos.coords.speed!=null&&pos.coords.speed>=0)?pos.coords.speed:null;
      tripState.nearestStation=findNearest(tripState.gpsLat,tripState.gpsLng);

      // Driver picks stations manually â€” GPS is reference only
      updateGpsElements();
    },
    err=>{tripState.gpsStatus='error';tripState.speed=null;updateGpsElements();},
    {enableHighAccuracy:true,maximumAge:5000,timeout:15000}
  );
}

// Patch only the GPS bar and speed badge without touching the rest of the page
function updateGpsElements(){
  const gbarEl=document.getElementById('gpsBar');
  if(gbarEl)gbarEl.outerHTML=gpsBarHtml().replace('<div','<div id="gpsBar"');
  // Re-insert with id so we can find it next time
  const gbarNew=document.querySelector('.gbar');
  if(gbarNew&&!gbarNew.id)gbarNew.id='gpsBar';

  const speedEl=document.getElementById('speedBadge');
  if(speedEl){
    const html=speedBadgeHtml();
    speedEl.outerHTML=html?html.replace('<div','<div id="speedBadge"'):'<div id="speedBadge" style="display:none"></div>';
  }
}

function stopGpsWatch(){
  if(tripState.gpsWatchId!=null){
    navigator.geolocation.clearWatch(tripState.gpsWatchId);
    tripState.gpsWatchId=null;
  }
  tripState.speed=null;
}

function gpsBarHtml(){
  if(tripState.gpsStatus==='detecting')
    return`<div id="gpsBar" class="gbar detecting"><span>ğŸ“¡</span>DETECTING LOCATION...</div>`;
  if(tripState.gpsStatus==='ok'&&tripState.nearestStation)
    return`<div id="gpsBar" class="gbar"><span>ğŸ“</span>NEAREST: ${tripState.nearestStation.name} (${tripState.nearestStation.dist.toFixed(1)} KM)</div>`;
  if(tripState.gpsStatus==='error')
    return`<div id="gpsBar" class="gbar err"><span>âš </span>GPS UNAVAILABLE</div>`;
  return`<div id="gpsBar" class="gbar detecting"><span>ğŸ“¡</span>WAITING FOR GPS...</div>`;
}

function speedBadgeHtml(){
  if(tripState.speed===null)return'<div id="speedBadge" style="display:none"></div>';
  const kmh=(tripState.speed*3.6).toFixed(0);
  const moving=tripState.speed>2;
  return`<div id="speedBadge" class="speed-badge">
    <div class="speed-dot ${moving?'moving':''}"></div>
    ${moving?`MOVING â€” ${kmh} KM/H`:`STATIONARY â€” ${kmh} KM/H`}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX #1: TRIP TIMER â€” was missing entirely
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTripTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    const el=document.getElementById('timerVal');
    if(el&&tripState.tripStart){
      const s=Math.floor((Date.now()-tripState.tripStart)/1000);
      el.textContent=`${String(Math.floor(s/3600)).padStart(2,'0')}:${String(Math.floor((s%3600)/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHIFT CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isShiftOpen(plate){
  const hasAnyShift=Object.keys(shifts).length>0;
  if(!hasAnyShift)return true;
  return shifts[plate]?.open===true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRIVER LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveDriver(){
  const d=document.getElementById('selD')?.value, p=document.getElementById('selP')?.value;
  if(!d||!p){toast('SELECT DRIVER AND CAR PLATE');return;}
  if(driverPins[d]){
    // Check lockout
    if(isDriverLocked(d)){
      toast(`ğŸ”’ LOCKED â€” TRY AGAIN IN ${driverLockSecsLeft(d)}s`);
      return;
    }
    const n=d.replace(/'/g,"\\'"), q=p.replace(/'/g,"\\'");
    const lockMsg=isDriverLocked(d)?`<div class="pin-locked">ğŸ”’ LOCKED â€” TRY IN ${driverLockSecsLeft(d)}s</div>`:'';
    document.getElementById('page-log').innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle">DRIVER PIN</div>
        <div class="csub">// ENTER YOUR PIN TO CONTINUE</div>
        ${lockMsg}
        <div style="text-align:center;margin-bottom:14px">
          <div style="font-family:var(--font-m);font-size:.58rem;color:var(--muted);margin-bottom:10px">${d} Â· ${p}</div>
          <input type="password" id="driverPinIn" maxlength="6" placeholder="â€¢â€¢â€¢â€¢" class="pininput"
            onkeydown="if(event.key==='Enter')confirmDriverPin('${n}','${q}')">
        </div>
        <button class="bb bstart" onclick="confirmDriverPin('${n}','${q}')">CONFIRM</button>
        <button class="bout" onclick="renderLog()">BACK</button>
      </div>`;
    return;
  }
  finishLogin(d,p);
}

function confirmDriverPin(d,p){
  if(isDriverLocked(d)){toast(`ğŸ”’ LOCKED â€” TRY IN ${driverLockSecsLeft(d)}s`);return;}
  const pin=document.getElementById('driverPinIn')?.value;
  if(pin!==driverPins[d]){recordDriverFailure(d);if(!isDriverLocked(d))saveDriver();else renderLog();return;}
  // Success â€” clear failures
  driverPinFailures[d]={count:0,until:0};
  finishLogin(d,p);
}

function finishLogin(d,p){
  tripState.driver=d; tripState.carPlate=p; tripState.phase='idle';
  save('fs_driver',{driver:d,carPlate:p});
  document.getElementById('driverBadge').textContent=d.split(' ')[0]+' Â· '+p;
  startSessionTimer();
  startGpsWatch();
  renderLog();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATION SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selFrom(n){
  tripState.fromStation=STATIONS.find(s=>s.name===n)||{name:n,lat:0,lng:0};
  renderLog();
}
function selTo(n){
  if(tripState.phase!=='arrived')return;
  tripState.toStation=STATIONS.find(s=>s.name===n)||{name:n,lat:0,lng:0};
  renderLog();
}

function stationGridHtml(selected, disabledName=null, mode='from'){
  return STATIONS.map(s=>{
    const d=tripState.gpsLat?hav(tripState.gpsLat,tripState.gpsLng,s.lat,s.lng):null;
    const nearest=tripState.nearestStation?.name===s.name;
    const isSel=selected===s.name;
    const isDis=s.name===disabledName;
    return`<div class="sbtn ${isSel?'sel':''} ${isDis?'dis':''} ${nearest&&!isSel?'nearest':''}"
      onclick="${isDis?'':`sel${mode==='from'?'From':'To'}('${s.name.replace(/'/g,"\\'")}')` }"
      title="${nearest?'Nearest to you':''}">
      ${s.name}${nearest&&!isSel?' ğŸ“':''}
      ${d!==null?`<span class="dist">${d.toFixed(1)} km</span>`:''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIP FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTrip(){
  if(!tripState.fromStation){toast('SELECT YOUR STARTING STATION');return;}
  if(!isShiftOpen(tripState.carPlate)){toast('â›” SHIFT IS CLOSED FOR '+tripState.carPlate);return;}
  tripState.phase='active';
  tripState.tripStart=Date.now();
  tripState.toStation=null;
  tripState.notes='';
  renderLog();
  startTripTimer();
  toast('TRIP STARTED â€” SAFE JOURNEY! ğŸšŒ');
}

function arrive(){
  tripState.phase='arrived';
  tripState.tripEnd=Date.now();
  clearInterval(timerInterval);
  tripState.toStation=null;
  renderLog();
  toast('ARRIVED â€” SELECT YOUR DESTINATION');
}



function reviewTrip(){
  const amt=parseFloat(document.getElementById('amtIn')?.value||'0');
  const notes=(document.getElementById('notesIn')?.value||'').trim();
  if(!tripState.toStation){toast('SELECT DESTINATION STATION');return;}
  if(!amt||amt<=0){toast('ENTER AMOUNT COLLECTED');return;}
  if(amt<AMOUNT_MIN){toast(`AMOUNT TOO LOW â€” MINIMUM KES ${AMOUNT_MIN}`);return;}
  if(amt>AMOUNT_MAX){toast(`AMOUNT TOO HIGH â€” MAXIMUM KES ${AMOUNT_MAX.toLocaleString()}`);return;}
  if(tripState.toStation.name===tripState.fromStation.name){toast('TO STATION MUST BE DIFFERENT');return;}
  tripState.amount=amt; tripState.notes=notes;
  tripState.phase='confirm';
  renderLog();
}

function confirmAndSubmit(){
  const tenMin=10*60*1000;
  const dup=localTrips.find(t=>
    t.driver===tripState.driver&&t.carPlate===tripState.carPlate&&
    t.fromStation===tripState.fromStation.name&&t.toStation===tripState.toStation.name&&
    (Date.now()-new Date(t.timestamp).getTime())<tenMin
  );
  if(dup&&!confirm('âš  SIMILAR TRIP LOGGED WITHIN 10 MINUTES â€” SUBMIT ANYWAY?'))return;
  const _now=new Date();
  const trip={
    id:Date.now(),driver:tripState.driver,carPlate:tripState.carPlate,
    fromStation:tripState.fromStation.name,toStation:tripState.toStation.name,
    amount:tripState.amount,duration:Math.floor((tripState.tripEnd-tripState.tripStart)/60000),
    notes:tripState.notes,date:_now.toLocaleDateString('en-GB'),
    time:_now.toLocaleTimeString(),timestamp:_now.toISOString(),
    dateMs:_now.getTime(),  // used for Firestore range queries
  };
  localTrips.unshift(trip); save('fs_trips',localTrips.slice(0,200));
  tripState.phase='done';
  submitToFirebase(trip);
  renderLog();
}

function backToEdit(){tripState.phase='arrived';renderLog();}

function newTrip(){
  const prev=tripState.toStation;
  tripState.phase='idle';
  tripState.fromStation=prev;
  tripState.toStation=null; tripState.amount=''; tripState.notes='';
  tripState.tripStart=null; tripState.tripEnd=null;
  resetSessionTimer();
  renderLog();
  toast('READY FOR NEXT TRIP');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitToFirebase(trip){
  if(!initFirebase()){
    if(!isOnline()){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast('ğŸ“¦ SAVED TO OFFLINE QUEUE');}
    else toast('ğŸ’¾ SAVED LOCALLY â€” CONFIGURE FIREBASE IN ADMIN');
    return;
  }
  if(!isOnline()){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast('ğŸ“¦ OFFLINE â€” QUEUED');return;}
  try{
    await db.collection('trips').add(trip);
    toast('âœ… SYNCED TO FIREBASE');
  }catch(e){offlineQ.push(trip);save('fs_queue',offlineQ);updateOfflineBadge();toast('âš  QUEUED FOR RETRY');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP DAILY SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateWhatsAppSummary(){
  const all=allData();
  const today=new Date().toLocaleDateString('en-GB');
  const todayT=all.filter(t=>t.date===today);
  if(!todayT.length){toast('NO TRIPS TODAY TO SUMMARIZE');return;}
  const total=todayT.reduce((s,t)=>s+t.amount,0);
  const avg=Math.round(total/todayT.length);
  const cars=[...new Set(todayT.map(t=>t.carPlate).filter(Boolean))];
  const carLines=cars.map(car=>{
    const ct=todayT.filter(t=>t.carPlate===car);
    const cr=ct.reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car];
    const pct=target?` (${Math.round((cr/target)*100)}% of target)`:'';
    return`  ğŸš— ${car}: ${ct.length} trips Â· KES ${cr.toLocaleString()}${pct}`;
  }).join('\n');
  const drivers=[...new Set(todayT.map(t=>t.driver).filter(Boolean))];
  const driverLines=drivers.map(d=>{
    const dt=todayT.filter(t=>t.driver===d);
    const dr=dt.reduce((s,t)=>s+t.amount,0);
    return`  ğŸ‘¤ ${d}: ${dt.length} trips Â· KES ${dr.toLocaleString()}`;
  }).join('\n');
  const msg=`ğŸšŒ *FESTUS SACCO â€” DAILY REPORT*\nğŸ“… ${today}\n\nğŸ“Š *SUMMARY*\nâ€¢ Total Trips: ${todayT.length}\nâ€¢ Total Revenue: KES ${total.toLocaleString()}\nâ€¢ Average/Trip: KES ${avg.toLocaleString()}\n\nğŸš— *BY CAR*\n${carLines}\n\nğŸ‘¤ *BY DRIVER*\n${driverLines}\n\n_Generated by FESTUS SACCO App_`;
  const encoded=encodeURIComponent(msg);
  if(navigator.clipboard){navigator.clipboard.writeText(msg).then(()=>toast('ğŸ“‹ COPIED! OPENING WHATSAPP...')).catch(()=>{});}
  setTimeout(()=>window.open(`https://wa.me/?text=${encoded}`,'_blank'),500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE â€” init + data layer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFirebase(){
  if(!appConfig.projectId){return false;}
  if(db)return true;  // already initialised
  try{
    if(!firebase.apps.length){
      firebase.initializeApp({
        apiKey:appConfig.apiKey,
        authDomain:appConfig.authDomain,
        projectId:appConfig.projectId,
        appId:appConfig.appId
      });
    }
    db=firebase.firestore();
    // Offline persistence â€” survives network drops
    db.enablePersistence({synchronizeTabs:true}).catch(()=>{});
    return true;
  }catch(e){console.error('Firebase init error:',e);return false;}
}

async function loadFirebaseData(silent=false){
  if(!initFirebase()){if(!silent)toast('âš  CONFIGURE FIREBASE IN ADMIN');return;}
  if(!isOnline()&&!silent){toast('OFFLINE â€” SHOWING CACHED DATA');return;}
  try{
    // Build date range based on current filter
    const now=new Date(); now.setHours(23,59,59,999);
    let startMs=0;
    if(reportFilter==='today'){const s=new Date();s.setHours(0,0,0,0);startMs=s.getTime();}
    else if(reportFilter==='week'){const s=new Date();s.setDate(s.getDate()-s.getDay());s.setHours(0,0,0,0);startMs=s.getTime();}
    else if(reportFilter==='month'){const s=new Date(now.getFullYear(),now.getMonth(),1);startMs=s.getTime();}
    else{// 'all' â€” load last 90 days to keep query fast
      const s=new Date();s.setDate(s.getDate()-90);s.setHours(0,0,0,0);startMs=s.getTime();}

    let q=db.collection('trips').where('dateMs','>=',startMs).orderBy('dateMs','desc');
    // Extra car/driver filters pushed to Firestore where possible
    if(filterCar)q=q.where('carPlate','==',filterCar);
    const snap=await q.get();
    firestoreTrips=snap.docs.map(d=>({...d.data(),_fbId:d.id}));
    if(!silent)toast('âœ… '+firestoreTrips.length+' RECORDS LOADED');
    if(currentPage==='reports')renderReports();
  }catch(e){
    if(!silent)toast('âš  LOAD ERROR: '+e.message);
    if(currentPage==='reports')renderReports();
  }
}

function allData(){
  // Merge Firebase trips with local trips (local takes priority for dedup)
  const fbFiltered=firestoreTrips.filter(ft=>!localTrips.find(lt=>lt.timestamp===ft.timestamp&&lt.driver===ft.driver));
  return[...localTrips,...fbFiltered];
}

function parseDate(str){
  if(!str)return null;let d=new Date(str);if(!isNaN(d))return d;
  const m=str.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
  if(m){const yr=m[3].length===2?'20'+m[3]:m[3];return new Date(`${yr}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`);}
  return null;
}


function filterTrips(trips){
  const now=new Date(),today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  return trips.filter(t=>{
    if(reportFilter!=='all'){
      const d=parseDate(t.date);if(!d)return false;
      if(reportFilter==='today'&&d<today)return false;
      if(reportFilter==='week'){const ws=new Date(today);ws.setDate(today.getDate()-today.getDay());if(d<ws)return false;}
      if(reportFilter==='month'&&(d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear()))return false;
    }
    if(filterCar&&(t.carPlate||'').trim()!==filterCar)return false;
    if(filterDriver&&(t.driver||'').trim()!==filterDriver)return false;
    if(filterFrom&&(t.fromStation||'').trim()!==filterFrom)return false;
    if(filterTo&&(t.toStation||'').trim()!==filterTo)return false;
    return true;
  });
}
function clearFilters(){filterCar='';filterDriver='';filterFrom='';filterTo='';reportFilter='all';renderReports();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const filtered=filterTrips(allData());
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=18;let y=M;
  doc.setFillColor(26,122,60);doc.rect(0,0,W,38,'F');
  doc.setTextColor(255,255,255);doc.setFontSize(20);doc.setFont('helvetica','bold');doc.text('FESTUS SACCO',M,16);
  doc.setFontSize(8);doc.setFont('helvetica','normal');doc.text('TRIP REPORT â€” '+reportFilter.toUpperCase(),M,24);doc.text('Generated: '+new Date().toLocaleString(),M,31);
  y=46;
  const bw=(W-M*2-9)/4;
  [{l:'TOTAL TRIPS',v:String(filtered.length)},{l:'TOTAL REVENUE',v:'KES '+total.toLocaleString()},{l:'AVG/TRIP',v:filtered.length?'KES '+Math.round(total/filtered.length).toLocaleString():'â€”'},{l:'UNIQUE CARS',v:String([...new Set(filtered.map(t=>t.carPlate))].length)}].forEach((b,i)=>{
    const bx=M+i*(bw+3);doc.setFillColor(245,250,245);doc.rect(bx,y,bw,20,'F');doc.setFillColor(26,122,60);doc.rect(bx,y,bw,1.5,'F');
    doc.setTextColor(130,130,130);doc.setFontSize(6);doc.setFont('helvetica','normal');doc.text(b.l,bx+3,y+8);
    doc.setTextColor(20,20,20);doc.setFontSize(10);doc.setFont('helvetica','bold');doc.text(b.v,bx+3,y+17);
  });
  y+=28;
  doc.setFillColor(26,46,26);doc.rect(M,y,W-M*2,7,'F');
  doc.setTextColor(240,165,0);doc.setFontSize(6.5);doc.setFont('helvetica','bold');
  doc.text('#',M+2,y+5);doc.text('DATE',M+10,y+5);doc.text('ROUTE',M+36,y+5);doc.text('DRIVER',M+90,y+5);doc.text('CAR',M+130,y+5);doc.text('KES',W-M-2,y+5,{align:'right'});
  y+=7;
  filtered.forEach((t,i)=>{
    if(y>272){doc.addPage();y=M;}
    doc.setFillColor(...(i%2===0?[250,253,250]:[244,248,244]));doc.rect(M,y,W-M*2,7,'F');
    doc.setTextColor(80,80,80);doc.setFontSize(6.5);doc.setFont('helvetica','normal');doc.text(String(i+1),M+2,y+5);doc.text((t.date||'').slice(0,10),M+10,y+5);
    doc.setTextColor(26,122,60);doc.setFont('helvetica','bold');doc.text((t.fromStation||'').slice(0,9)+'â†’'+(t.toStation||'').slice(0,9),M+36,y+5);
    doc.setTextColor(60,60,60);doc.setFont('helvetica','normal');doc.text((t.driver||'').slice(0,18),M+90,y+5);doc.text(t.carPlate||'',M+130,y+5);
    doc.setTextColor(20,100,60);doc.setFont('helvetica','bold');doc.text(Number(t.amount||0).toLocaleString(),W-M-2,y+5,{align:'right'});
    y+=7;
  });
  const pg=doc.internal.getNumberOfPages();
  for(let i=1;i<=pg;i++){doc.setPage(i);doc.setFontSize(6);doc.setTextColor(150,150,150);doc.setFont('helvetica','normal');doc.text('FESTUS SACCO â€” CONFIDENTIAL',M,292);doc.text('Page '+i+' of '+pg,W-M,292,{align:'right'});}
  doc.save('FESTUS-report-'+new Date().toISOString().slice(0,10)+'.pdf');
}

function exportExcel(){
  const filtered=filterTrips(allData());
  const data=filtered.map(t=>({'DATE':t.date,'TIME':t.time,'FROM':t.fromStation,'TO':t.toStation,'DRIVER':t.driver,'CAR':t.carPlate,'AMOUNT':t.amount,'DURATION(MIN)':t.duration,'NOTES':t.notes||''}));
  const ws=XLSX.utils.json_to_sheet(data);
  ws['!cols']=[{wch:12},{wch:10},{wch:14},{wch:14},{wch:20},{wch:10},{wch:10},{wch:12},{wch:20}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Trips');
  const carRevs=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))].map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car);
    return{'CAR':car,'TRIPS':ct.length,'REVENUE':ct.reduce((s,t)=>s+t.amount,0),'AVG':ct.length?Math.round(ct.reduce((s,t)=>s+t.amount,0)/ct.length):0};
  });
  if(carRevs.length)XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(carRevs),'By Car');
  XLSX.writeFile(wb,'FESTUS-'+new Date().toISOString().slice(0,10)+'.xlsx');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts(){
  const all=allData(),isDark=darkMode;
  const tc=isDark?'#5a8a6a':'#6a8a6a',gc=isDark?'#2a3e2e':'#dde8dd';
  Chart.defaults.color=tc;Chart.defaults.borderColor=gc;
  Chart.defaults.font.family="'Space Mono',monospace";Chart.defaults.font.size=10;
  function mk(id,type,labels,datasets,legend=false){
    if(charts[id])charts[id].destroy();
    const canvas=document.getElementById(id);if(!canvas)return;
    charts[id]=new Chart(canvas.getContext('2d'),{type,data:{labels,datasets},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:legend,labels:{color:tc,font:{size:9}}}},scales:type!=='doughnut'?{x:{grid:{color:gc},ticks:{color:tc,maxRotation:45}},y:{grid:{color:gc},ticks:{color:tc},beginAtZero:true}}:undefined}});
  }
  const days30=[];
  for(let i=29;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);d.setHours(0,0,0,0);const n=new Date(d);n.setDate(d.getDate()+1);const dt=all.filter(t=>{const rd=parseDate(t.date);return rd&&rd>=d&&rd<n;});days30.push({label:d.toLocaleDateString('en-GB',{day:'numeric',month:'short'}),trips:dt.length,revenue:dt.reduce((s,t)=>s+t.amount,0)});}
  const weeks=[];
  for(let i=7;i>=0;i--){const ws=new Date();ws.setDate(ws.getDate()-ws.getDay()-i*7);ws.setHours(0,0,0,0);const we=new Date(ws);we.setDate(ws.getDate()+7);const wt=all.filter(t=>{const d=parseDate(t.date);return d&&d>=ws&&d<we;});weeks.push({label:'W'+(8-i),revenue:wt.reduce((s,t)=>s+t.amount,0)});}
  mk('chartDaily','bar',days30.map(d=>d.label),[{label:'Revenue',data:days30.map(d=>d.revenue),backgroundColor:'rgba(26,122,60,0.7)',borderColor:'#1a7a3c',borderWidth:1,borderRadius:3}]);
  mk('chartWeekly','bar',weeks.map(w=>w.label),[{label:'Revenue',data:weeks.map(w=>w.revenue),backgroundColor:weeks.map((_,i)=>i===weeks.length-1?'rgba(240,165,0,0.8)':'rgba(26,122,60,0.5)'),borderColor:weeks.map((_,i)=>i===weeks.length-1?'#f0a500':'#1a7a3c'),borderWidth:1,borderRadius:3}]);
  const cars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))];
  const colors=['#1a7a3c','#f0a500','#2196a8','#e53935','#6d4fc2','#22c55e','#fb923c'];
  mk('chartCars','doughnut',cars,[{data:cars.map(c=>all.filter(t=>t.carPlate===c).reduce((s,t)=>s+t.amount,0)),backgroundColor:colors,borderColor:isDark?'#141f18':'#fff',borderWidth:2}],true);
  mk('chartTrips','line',days30.slice(-14).map(d=>d.label),[{label:'Trips',data:days30.slice(-14).map(d=>d.trips),borderColor:'#f0a500',backgroundColor:'rgba(240,165,0,0.1)',borderWidth:2,fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#f0a500'}]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LOG PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLog(){
  const el=document.getElementById('page-log');
  if(currentPage!=='log')return;
  if(tripState.driver)document.getElementById('driverBadge').textContent=tripState.driver.split(' ')[0]+' Â· '+tripState.carPlate;
  else document.getElementById('driverBadge').textContent='â€” LOGIN â€”';

  // SETUP
  if(tripState.phase==='setup'){
    el.innerHTML=`
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle">DRIVER LOGIN</div>
        <div class="field"><label>Select Driver</label>
          <select id="selD"><option value="">â€” Choose Driver â€”</option>
          ${DRIVERS.map(d=>`<option value="${d}" ${d===tripState.driver?'selected':''}>${d}</option>`).join('')}</select></div>
        <div class="field"><label>Car Plate</label>
          <select id="selP"><option value="">â€” Choose Car â€”</option>
          ${CARS.map(c=>`<option value="${c}" ${c===tripState.carPlate?'selected':''}>${c}${shifts[c]?.open===false?' ğŸ”´ CLOSED':shifts[c]?.open===true?' ğŸŸ¢':''}</option>`).join('')}</select></div>
        <button class="bb bstart" onclick="saveDriver()">BEGIN SHIFT</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  // IDLE
  if(tripState.phase==='idle'){
    if(!isShiftOpen(tripState.carPlate)){
      el.innerHTML=`
        <div class="shift-block">
          <div class="shift-block-title">â›” SHIFT CLOSED</div>
          <div class="shift-block-sub">THE SHIFT FOR <strong>${tripState.carPlate}</strong> IS CURRENTLY CLOSED<br>CONTACT YOUR SUPERVISOR TO OPEN THE SHIFT</div>
        </div>
        <button class="bout" onclick="goSetup()">CHANGE CAR / DRIVER</button>`;
      return;
    }
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">START TRIP</div>
        <div class="csub">// SELECT YOUR STARTING STATION</div>
        ${gpsBarHtml()}
        ${speedBadgeHtml()}
        <div class="field"><label>FROM STATION</label></div>
        <div class="sgrid">${stationGridHtml(tripState.fromStation?.name||null, null, 'from')}</div>
        <button class="bb bstart" onclick="startTrip()" ${!tripState.fromStation?'disabled':''}>ğŸšŒ START TRIP</button>
        <button class="bout" onclick="goSetup()">CHANGE DRIVER / CAR</button>
      </div>
      ${renderTodayHistory()}`;
    return;
  }

  // ACTIVE
  if(tripState.phase==='active'){
    const secs=tripState.tripStart?Math.floor((Date.now()-tripState.tripStart)/1000):0;
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">TRIP IN PROGRESS</div>
        <div class="csub">// DRIVE TO DESTINATION â€” TAP ARRIVE WHEN THERE</div>
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr">â†’</div>
          <div class="rs"><div class="rl">TO</div><div class="rn" style="color:var(--muted)">DESTINATION</div></div>
        </div>
        ${speedBadgeHtml()}
        <div class="tdisp">
          <div class="tl">TRIP DURATION</div>
          <div class="tv" id="timerVal">${String(Math.floor(secs/3600)).padStart(2,'0')}:${String(Math.floor((secs%3600)/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}</div>
        </div>
        <div class="lock"><div class="lico">ğŸ”’</div><div class="ltxt">DESTINATION LOCKED<br>ARRIVE AT STATION FIRST</div></div>
        <button class="bb barrive" onclick="arrive()">ğŸ“ I HAVE ARRIVED</button>
        <button class="bout" onclick="if(confirm('Cancel this trip?')){tripState.phase='idle';clearInterval(timerInterval);renderLog();}">CANCEL TRIP</button>
      </div>`;
    startTripTimer();
    return;
  }

  // ARRIVED
  if(tripState.phase==='arrived'){
    el.innerHTML=`
      <div class="card">
        <div class="ctitle">END TRIP</div>
        <div class="csub">// CONFIRM DESTINATION & ENTER AMOUNT</div>
        ${gpsBarHtml()}
        <div class="rdisp">
          <div class="rs"><div class="rl">FROM</div><div class="rn">${tripState.fromStation.name}</div></div>
          <div class="rarr">â†’</div>
          <div class="rs"><div class="rl">TO</div><div class="rn">${tripState.toStation?tripState.toStation.name:'???'}</div></div>
        </div>
        <div class="field"><label>TO STATION</label></div>
        <div class="sgrid">${stationGridHtml(tripState.toStation?.name||null, tripState.fromStation.name, 'to')}</div>
        <div class="field"><label>AMOUNT COLLECTED IN KES</label></div>
        <div class="awrap">
          <span class="apfx">KES</span>
          <input type="number" class="ainput" id="amtIn" placeholder="0" min="${AMOUNT_MIN}" max="${AMOUNT_MAX}" value="${tripState.amount||''}">
        </div>
        <div class="field"><label>TRIP NOTES (optional)</label>
          <textarea id="notesIn" placeholder="e.g. Road closed, vehicle issue, extra passengers...">${tripState.notes||''}</textarea>
        </div>
        <button class="bb bend" onclick="reviewTrip()" ${!tripState.toStation?'disabled':''}>REVIEW & CONFIRM â†’</button>
      </div>`;
    return;
  }

  // CONFIRM
  if(tripState.phase==='confirm'){
    const dur=Math.floor((tripState.tripEnd-tripState.tripStart)/60000);
    const isHighAmount=tripState.amount>20000;
    el.innerHTML=`
      <div class="card" style="border-top:4px solid #22c55e">
        <div class="confirm-title">CONFIRM TRIP</div>
        ${isHighAmount?`<div class="confirm-warn">âš  AMOUNT IS HIGHER THAN USUAL â€” PLEASE VERIFY</div>`:''}
        <div class="confirm-card">
          <div class="confirm-row"><span class="confirm-label">DRIVER</span><span class="confirm-val">${tripState.driver}</span></div>
          <div class="confirm-row"><span class="confirm-label">CAR</span><span class="confirm-val">${tripState.carPlate}</span></div>
          <div class="confirm-row"><span class="confirm-label">FROM</span><span class="confirm-val">${tripState.fromStation.name}</span></div>
          <div class="confirm-row"><span class="confirm-label">TO</span><span class="confirm-val">${tripState.toStation.name}</span></div>
          <div class="confirm-row"><span class="confirm-label">DURATION</span><span class="confirm-val">${dur} MIN</span></div>
          <div class="confirm-row"><span class="confirm-label">TIME</span><span class="confirm-val">${new Date().toLocaleTimeString()}</span></div>
          ${tripState.notes?`<div class="confirm-row"><span class="confirm-label">NOTES</span><span class="confirm-val">${tripState.notes}</span></div>`:''}
          <div class="confirm-row" style="padding-top:14px;margin-top:4px;border-top:2px solid var(--accent);border-bottom:none">
            <span class="confirm-label">AMOUNT COLLECTED</span>
            <span class="confirm-amount">KES ${Number(tripState.amount).toLocaleString()}</span>
          </div>
        </div>
        <button class="bb bconfirm" onclick="confirmAndSubmit()">âœ… CONFIRM &amp; SUBMIT</button>
        <button class="bout" onclick="backToEdit()">â† GO BACK &amp; EDIT</button>
      </div>`;
    return;
  }

  // DONE
  if(tripState.phase==='done'){
    const last=localTrips[0];
    const today=new Date().toLocaleDateString('en-GB');
    const todayTrips=localTrips.filter(t=>t.date===today&&t.driver===tripState.driver);
    const todayTotal=todayTrips.reduce((s,t)=>s+t.amount,0);
    const target=carTargets[tripState.carPlate];
    const tpct=target?Math.min(100,Math.round((todayTotal/target)*100)):null;
    el.innerHTML=`
      <div class="scard">
        <div class="sico">âœ…</div>
        <div class="stitle">TRIP LOGGED!</div>
        <div class="sdetails">
          <div class="drow"><span>ROUTE</span><span>${last.fromStation} â†’ ${last.toStation}</span></div>
          <div class="drow"><span>DURATION</span><span>${last.duration} MIN</span></div>
          <div class="drow"><span>AMOUNT</span><span>KES ${Number(last.amount).toLocaleString()}</span></div>
          ${last.notes?`<div class="drow"><span>NOTES</span><span style="max-width:60%;text-align:right">${last.notes}</span></div>`:''}
        </div>
        <div class="ssub">${db&&isOnline()?'âœ… SYNCED TO FIREBASE':offlineQ.length?'ğŸ“¦ QUEUED FOR SYNC':'ğŸ’¾ SAVED LOCALLY â€” CONFIGURE FIREBASE IN ADMIN'}</div>
      </div>
      <div class="card" style="border-left:4px solid var(--accent2)">
        <div class="ctitle" style="margin-bottom:12px">MY SHIFT TODAY</div>
        <div class="sumcard" style="margin-bottom:0">
          <div class="sumrow"><span class="sumlbl">TRIPS TODAY</span><span class="sumval">${todayTrips.length}</span></div>
          <div class="sumrow"><span class="sumlbl">REVENUE TODAY</span><span class="sumval">KES ${todayTotal.toLocaleString()}</span></div>
          <div class="sumrow"><span class="sumlbl">AVG PER TRIP</span><span class="sumval">KES ${todayTrips.length?Math.round(todayTotal/todayTrips.length).toLocaleString():'â€”'}</span></div>
          ${target?`<div class="sumrow"><span class="sumlbl">TARGET PROGRESS</span><span class="sumval" style="color:${tpct>=100?'#22c55e':'var(--red)'}">${tpct}%</span></div>
          <div style="margin-top:8px"><div class="target-bar"><div class="target-fill ${tpct>=100?'high':tpct>=50?'mid':'low'}" style="width:${tpct}%"></div></div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);margin-top:4px">KES ${todayTotal.toLocaleString()} of KES ${Number(target).toLocaleString()} TARGET</div></div>`:''}
        </div>
      </div>
      <button class="bb bstart" onclick="newTrip()">ğŸšŒ START NEXT TRIP</button>
      <button class="bout" onclick="goSetup()">END SHIFT</button>
      ${renderTodayHistory()}`;
    return;
  }
}

function renderTodayHistory(){
  const today=new Date().toLocaleDateString('en-GB');
  const tt=localTrips.filter(t=>t.date===today&&t.driver===tripState.driver);
  if(!tt.length)return'';
  const tot=tt.reduce((s,t)=>s+t.amount,0);
  return`<div class="hsect"><div class="stitle2">MY TRIPS TODAY (${tt.length}) Â· KES ${tot.toLocaleString()}</div>
  ${tt.slice(0,8).map(t=>`<div class="hitem">
    <div class="htop"><span class="hroute">${t.fromStation} â†’ ${t.toStation}</span><span class="hamt">KES ${Number(t.amount).toLocaleString()}</span></div>
    <div class="hbot"><span>${t.carPlate}${t.notes?` Â· ğŸ“ ${t.notes.slice(0,28)}`:''}</span><span class="htime">${t.time}</span></div>
  </div>`).join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReports(){
  const el=document.getElementById('page-reports');
  const all=allData();
  const filtered=filterTrips(all);
  const total=filtered.reduce((s,t)=>s+(t.amount||0),0);
  const avg=filtered.length?Math.round(total/filtered.length):0;
  const now=new Date();now.setHours(0,0,0,0);
  const todayT=all.filter(t=>{const d=parseDate(t.date);return d&&d>=now;});
  const allCars=[...new Set(all.map(t=>t.carPlate).filter(Boolean))].sort();
  const allDrivers=[...new Set(all.map(t=>t.driver).filter(Boolean))].sort();
  const allStations=[...new Set([...all.map(t=>t.fromStation),...all.map(t=>t.toStation)].filter(Boolean))].sort();
  const activeTags=[];
  if(filterCar)activeTags.push({l:'CAR: '+filterCar,c:"filterCar='';renderReports()"});
  if(filterDriver)activeTags.push({l:'DRV: '+filterDriver.split(' ')[0],c:"filterDriver='';renderReports()"});
  if(filterFrom)activeTags.push({l:'FROM: '+filterFrom,c:"filterFrom='';renderReports()"});
  if(filterTo)activeTags.push({l:'TO: '+filterTo,c:"filterTo='';renderReports()"});
  if(reportFilter!=='all')activeTags.push({l:reportFilter.toUpperCase(),c:"reportFilter='all';renderReports()"});

  el.innerHTML=`
    <div class="exprow">
      <button class="bsm bg" onclick="loadFirebaseData()">âŸ³</button>
      <button class="bsm by" onclick="exportPDF()">PDF</button>
      <button class="bsm" style="background:#217346;color:#fff" onclick="exportExcel()">XLS</button>
      <button class="bsm bwa" onclick="generateWhatsAppSummary()">ğŸ“± WA</button>
      <button class="bsm bgray" onclick="clearFilters()">âœ•</button>
    </div>
    <div class="sgrid2">
      <div class="sbox"><div class="sl">TOTAL TRIPS</div><div class="sv green">${filtered.length}</div></div>
      <div class="sbox"><div class="sl">TOTAL REVENUE</div><div class="sv green" style="font-size:1.1rem">KES ${total.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">AVG / TRIP</div><div class="sv yellow" style="font-size:1.1rem">KES ${avg.toLocaleString()}</div></div>
      <div class="sbox"><div class="sl">TODAY'S TRIPS</div><div class="sv">${todayT.length}</div></div>
    </div>
    <div class="rtabs">
      <button class="rtab ${reportTab==='overview'?'active':''}" onclick="reportTab='overview';renderReports()">OVERVIEW</button>
      <button class="rtab ${reportTab==='charts'?'active':''}" onclick="reportTab='charts';renderReports();setTimeout(renderCharts,80)">CHARTS</button>
      <button class="rtab ${reportTab==='leaderboard'?'active':''}" onclick="reportTab='leaderboard';renderReports()">LEADERBOARD</button>
      <button class="rtab ${reportTab==='performance'?'active':''}" onclick="reportTab='performance';renderReports()">PERFORMANCE</button>
    </div>
    <div id="rsect-overview" class="rsect ${reportTab==='overview'?'active':''}">
      <div class="card" style="padding:13px;margin-bottom:11px">
        <div class="stitle2" style="margin-bottom:9px">ğŸ” FILTER REPORTS</div>
        <div class="fchips">${['all','today','week','month'].map(f=>`<div class="fchip ${reportFilter===f?'active':''}" onclick="reportFilter='${f}';renderReports()">${f==='all'?'ALL TIME':f.toUpperCase()}</div>`).join('')}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:7px">
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">BY CAR</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterCar=this.value;renderReports()">
              <option value="">All Cars</option>${allCars.map(c=>`<option value="${c}" ${filterCar===c?'selected':''}>${c}</option>`).join('')}</select></div>
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">BY DRIVER</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterDriver=this.value;renderReports()">
              <option value="">All Drivers</option>${allDrivers.map(d=>`<option value="${d}" ${filterDriver===d?'selected':''}>${d.split(' ')[0]}</option>`).join('')}</select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">FROM</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterFrom=this.value;renderReports()">
              <option value="">Any</option>${allStations.map(s=>`<option value="${s}" ${filterFrom===s?'selected':''}>${s}</option>`).join('')}</select></div>
          <div><div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px">TO</div>
            <select style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 9px;font-family:var(--font-b);font-size:.8rem;outline:none;appearance:none" onchange="filterTo=this.value;renderReports()">
              <option value="">Any</option>${allStations.map(s=>`<option value="${s}" ${filterTo===s?'selected':''}>${s}</option>`).join('')}</select></div>
        </div>
        ${activeTags.length?`<div style="margin-top:9px;display:flex;flex-wrap:wrap;gap:4px">${activeTags.map(t=>`<div class="tag-active">${t.l} <span onclick="${t.c}">âœ•</span></div>`).join('')}</div>`:''}
      </div>
      ${filtered.length===0?'<div class="empty">NO RESULTS<br>TRY DIFFERENT FILTERS OR SYNC</div>':`
      <div class="rtable">
        <div class="rth"><span>ROUTE</span><span>DRIVER</span><span>DATE</span><span>AMOUNT</span></div>
        ${filtered.slice(0,80).map(t=>`<div class="rtr">
          <div><div class="trroute">${(t.fromStation||'').slice(0,7)}â†’${(t.toStation||'').slice(0,7)}</div><div style="font-family:var(--font-m);font-size:.43rem;color:var(--muted)">${t.carPlate||''}</div></div>
          <div style="font-size:.64rem;color:var(--muted)">${(t.driver||'').split(' ')[0]}</div>
          <div style="font-family:var(--font-m);font-size:.48rem;color:var(--muted)">${(t.date||'').slice(0,10)}</div>
          <div class="tramt">KES ${Number(t.amount||0).toLocaleString()}</div>
        </div>`).join('')}
      </div>
      <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-align:center;padding:6px">SHOWING ${Math.min(80,filtered.length)} OF ${filtered.length}</div>`}
      ${renderCarBars(filtered,total)}
    </div>
    <div class="rsect ${reportTab==='charts'?'active':''}">
      <div class="chart-wrap"><div class="chart-title">DAILY REVENUE â€” 30 DAYS</div><div class="chart-canvas"><canvas id="chartDaily"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">WEEKLY COMPARISON</div><div class="chart-canvas"><canvas id="chartWeekly"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">REVENUE BY CAR</div><div class="chart-canvas"><canvas id="chartCars"></canvas></div></div>
      <div class="chart-wrap"><div class="chart-title">DAILY TRIPS â€” 14 DAYS</div><div class="chart-canvas"><canvas id="chartTrips"></canvas></div></div>
    </div>
    <div class="rsect ${reportTab==='leaderboard'?'active':''}">${renderLeaderboard(filtered)}</div>
    <div class="rsect ${reportTab==='performance'?'active':''}">${renderPerformance(all)}</div>`;
}

function renderCarBars(filtered,total){
  const cars=[...new Set(filtered.map(t=>t.carPlate).filter(Boolean))];
  if(!cars.length)return'';
  const today=new Date().toLocaleDateString('en-GB');
  return`<div class="stitle2" style="margin-bottom:9px;margin-top:4px">REVENUE BY CAR</div>
  ${cars.map(car=>{
    const ct=filtered.filter(t=>t.carPlate===car),cr=ct.reduce((s,t)=>s+t.amount,0),pct=total?Math.round((cr/total)*100):0;
    const todayRev=localTrips.filter(t=>t.carPlate===car&&t.date===today).reduce((s,t)=>s+t.amount,0);
    const target=carTargets[car],tpct=target?Math.min(100,Math.round((todayRev/target)*100)):null;
    return`<div class="hitem" style="margin-bottom:7px;cursor:pointer" onclick="filterCar=filterCar==='${car}'?'':'${car}';renderReports()">
      <div class="htop"><span class="hroute">${car}${shifts[car]?.open===false?' <span style=\\"background:var(--red);color:#fff;font-size:.42rem;padding:1px 5px\\">CLOSED</span>':''}</span><span class="hamt">KES ${cr.toLocaleString()}</span></div>
      <div class="bar-mini"><div class="bar-fill" style="width:${pct}%"></div></div>
      <div class="hbot" style="margin-top:4px"><span>${ct.length} trips Â· ${pct}% of total</span>${target?`<span style="color:${tpct>=100?'#22c55e':tpct>=50?'var(--accent2)':'var(--red)'}">TODAY ${tpct}%</span>`:''}</div>
    </div>`;
  }).join('')}`;
}

function renderLeaderboard(filtered){
  if(!filtered.length)return'<div class="empty">NO DATA<br>SYNC FROM FIREBASE OR LOG TRIPS</div>';
  const dm={};filtered.forEach(t=>{const d=t.driver||'?';if(!dm[d])dm[d]={trips:0,revenue:0};dm[d].trips++;dm[d].revenue+=t.amount||0;});
  const dr=Object.entries(dm).sort((a,b)=>b[1].revenue-a[1].revenue);
  const mr=dr[0]?.[1].revenue||1;
  const cm={};filtered.forEach(t=>{const c=t.carPlate||'?';if(!cm[c])cm[c]={trips:0,revenue:0};cm[c].trips++;cm[c].revenue+=t.amount||0;});
  const cr=Object.entries(cm).sort((a,b)=>b[1].revenue-a[1].revenue);
  return`
    <div class="stitle2" style="margin-bottom:9px">ğŸ† TOP DRIVERS BY REVENUE</div>
    ${dr.slice(0,7).map(([name,data],i)=>`<div class="lb-item">
      <div class="lb-rank ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
      <div><div class="lb-name">${name.split(' ')[0]} ${name.split(' ')[1]||''}</div><div class="lb-sub">${data.trips} trips</div>
      <div class="bar-mini" style="width:80%"><div class="bar-fill" style="width:${Math.round((data.revenue/mr)*100)}%"></div></div></div>
      <div><div class="lb-val">KES ${(data.revenue/1000).toFixed(1)}K</div><div class="lb-vsub">KES ${data.trips?Math.round(data.revenue/data.trips).toLocaleString():'â€”'}/trip</div></div>
    </div>`).join('')}
    <div class="stitle2" style="margin-bottom:9px;margin-top:14px">ğŸš— TOP CARS BY REVENUE</div>
    ${cr.map(([plate,data],i)=>`<div class="lb-item">
      <div class="lb-rank ${i===0?'g':i===1?'s':i===2?'b':''}">${i+1}</div>
      <div><div class="lb-name">${plate}</div><div class="lb-sub">${data.trips} trips</div>
      <div class="bar-mini" style="width:80%"><div class="bar-fill" style="width:${Math.round((data.revenue/(cr[0][1].revenue||1))*100)}%"></div></div></div>
      <div><div class="lb-val">KES ${(data.revenue/1000).toFixed(1)}K</div><div class="lb-vsub">${data.trips?Math.round(data.revenue/data.trips).toLocaleString():''}/trip</div></div>
    </div>`).join('')}`;
}

function renderPerformance(all){
  if(!all.length)return'<div class="empty">NO DATA<br>SYNC FROM FIREBASE OR LOG TRIPS</div>';
  const drivers=[...new Set(all.map(t=>t.driver).filter(Boolean))];
  const allAvgs=drivers.map(d=>{const dt=all.filter(t=>t.driver===d);return dt.length?dt.reduce((s,t)=>s+t.amount,0)/dt.length:0;});
  const maxAvg=Math.max(...allAvgs)||1;
  const allDays=drivers.map(d=>[...new Set(all.filter(t=>t.driver===d).map(t=>t.date))].length);
  const maxDays=Math.max(...allDays)||1;
  const allTrips=drivers.map(d=>all.filter(t=>t.driver===d).length);
  const maxTrips=Math.max(...allTrips)||1;
  return drivers.map((driver,di)=>{
    const dtrips=all.filter(t=>t.driver===driver);
    const rev=dtrips.reduce((s,t)=>s+t.amount,0);
    const avg=dtrips.length?Math.round(rev/dtrips.length):0;
    const days=[...new Set(dtrips.map(t=>t.date))].length;
    const bestDay=dtrips.reduce((best,t)=>{const dr=dtrips.filter(x=>x.date===t.date).reduce((s,x)=>s+x.amount,0);return dr>best?dr:best;},0);
    const score=Math.round((allAvgs[di]/maxAvg)*50+(allDays[di]/maxDays)*30+(allTrips[di]/maxTrips)*20);
    const grade=score>=80?'A':score>=60?'B':'C';
    return`<div class="perf-card">
      <div class="perf-name">${driver.split(' ')[0]} ${driver.split(' ')[1]||''} <span class="score-badge score-${grade.toLowerCase()}">${grade}</span></div>
      <div class="perf-grid">
        <div class="pstat"><div class="pl">TOTAL TRIPS</div><div class="pv">${dtrips.length}</div></div>
        <div class="pstat"><div class="pl">REVENUE</div><div class="pv" style="font-size:.85rem">KES ${(rev/1000).toFixed(1)}K</div></div>
        <div class="pstat"><div class="pl">AVG/TRIP</div><div class="pv" style="font-size:.85rem">KES ${avg.toLocaleString()}</div></div>
        <div class="pstat"><div class="pl">DAYS ACTIVE</div><div class="pv">${days}</div></div>
        <div class="pstat"><div class="pl">BEST DAY</div><div class="pv" style="font-size:.85rem">KES ${bestDay.toLocaleString()}</div></div>
        <div class="pstat"><div class="pl">SCORE</div><div class="pv">${score}/100</div></div>
      </div>
      <div style="margin-top:9px"><div style="font-family:var(--font-m);font-size:.46rem;color:var(--muted);margin-bottom:4px">PERFORMANCE SCORE</div>
      <div class="target-bar"><div class="target-fill ${score>=80?'high':score>=60?'mid':'low'}" style="width:${score}%"></div></div></div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin(){
  const el=document.getElementById('page-admin');
  if(!adminUnlocked){
    const locked=isAdminLocked();
    el.innerHTML=`
      <div class="apinbox">
        <div class="apintitle">ADMIN ACCESS</div>
        <div class="apinsub">ENTER PIN TO MANAGE SHIFTS,<br>STATIONS, DRIVERS & SETTINGS</div>
        ${locked?`<div class="pin-locked">ğŸ”’ TOO MANY ATTEMPTS<br>TRY AGAIN IN ${adminLockSecsLeft()}s</div>`:''}
        <input type="password" class="pininput" id="pinIn" maxlength="6" placeholder="â€¢â€¢â€¢â€¢"
          ${locked?'disabled':''} onkeydown="if(event.key==='Enter')checkPin()">
        <button class="bb bstart" style="max-width:200px;margin:0 auto;display:block"
          onclick="checkPin()" ${locked?'disabled':''}>UNLOCK</button>
      </div>`;
    return;
  }
  el.innerHTML=`
    <div class="card" style="border-left:4px solid var(--accent2);margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="ctitle" style="margin:0">ADMIN PANEL</div>
        <button class="bghost" onclick="adminUnlocked=false;renderAdmin()">ğŸ”’ LOCK</button>
      </div>
    </div>
    <div class="atabs">
      <button class="atab ${adminTab==='shifts'?'active':''}" onclick="adminTab='shifts';renderAdmin()">SHIFTS</button>
      <button class="atab ${adminTab==='drivers'?'active':''}" onclick="adminTab='drivers';renderAdmin()">DRIVERS</button>
      <button class="atab ${adminTab==='cars'?'active':''}" onclick="adminTab='cars';renderAdmin()">CARS</button>
      <button class="atab ${adminTab==='stations'?'active':''}" onclick="adminTab='stations';renderAdmin()">STATIONS</button>
      <button class="atab ${adminTab==='trips'?'active':''}" onclick="adminTab='trips';renderAdmin()">TRIPS</button>
      <button class="atab ${adminTab==='config'?'active':''}" onclick="adminTab='config';renderAdmin()">CONFIG</button>
      <button class="atab ${adminTab==='settings'?'active':''}" onclick="adminTab='settings';renderAdmin()">âš™ DEV</button>
    </div>

    <!-- SHIFTS -->
    <div class="asect ${adminTab==='shifts'?'active':''}">
      <div class="card">
        <div class="ctitle">SHIFT MANAGEMENT</div>
        <div class="csub">// OPEN OR CLOSE SHIFTS PER CAR â€” CLOSED CARS CANNOT LOG TRIPS</div>
        ${CARS.map(car=>{
          const s=shifts[car];
          const isOpen=s?.open===true;
          const isClosed=s?.open===false;
          const openTime=s?.openedAt?new Date(s.openedAt).toLocaleTimeString():'';
          return`<div class="aitem" style="margin-bottom:8px">
            <div style="flex:1">
              <div class="aitem-name">${car}</div>
              <div class="aitem-sub">
                ${isOpen?`<span class="shift-open">ğŸŸ¢ OPEN</span> since ${openTime} by ${s.openedBy||'?'}`
                :isClosed?`<span class="shift-closed">ğŸ”´ CLOSED</span> at ${s?.closedAt?new Date(s.closedAt).toLocaleTimeString():''}`
                :'<span style="font-family:var(--font-m);font-size:.52rem;color:var(--muted)">NO SHIFT SET</span>'}
              </div>
            </div>
            <div class="abtn-row">
              ${!isOpen?`<button class="bsm bg" onclick="openShift('${car}')">OPEN</button>`:''}
              ${isOpen?`<button class="bsm br" onclick="showCloseShiftSummary('${car}')">CLOSE</button>`:''}
            </div>
          </div>`;
        }).join('')}
        <div class="divline"></div>
        <div style="display:flex;gap:7px">
          <button class="bsm bg" style="flex:1;padding:10px" onclick="openAllShifts()">OPEN ALL</button>
          <button class="bsm br" style="flex:1;padding:10px" onclick="closeAllShifts()">CLOSE ALL</button>
        </div>
      </div>
    </div>

    <!-- DRIVERS -->
    <div class="asect ${adminTab==='drivers'?'active':''}">
      <div class="card">
        <div class="ctitle">DRIVERS <span class="pill">${DRIVERS.length}</span></div>
        ${DRIVERS.map((d,i)=>`<div class="aitem">
          <div><div class="aitem-name">${d}</div><div class="aitem-sub">PIN: ${driverPins[d]?'SET âœ“':'NOT SET'}</div></div>
          <div class="abtn-row">
            <button class="aedit" onclick="adminSetDriverPin('${d.replace(/'/g,"\\'")}')">ğŸ”‘ PIN</button>
            <button class="adel" onclick="removeDriver(${i})">âœ•</button>
          </div>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Driver Name</label><input type="text" id="newDriver" placeholder="FULL NAME IN CAPS"></div>
          <button class="bsm bg" onclick="addDriver()">ADD</button>
        </div>
      </div>
    </div>

    <!-- CARS -->
    <div class="asect ${adminTab==='cars'?'active':''}">
      <div class="card">
        <div class="ctitle">CARS <span class="pill">${CARS.length}</span></div>
        ${CARS.map((c,i)=>`<div class="aitem">
          <div><div class="aitem-name">${c}</div><div class="aitem-sub">Target: ${carTargets[c]?'KES '+Number(carTargets[c]).toLocaleString():'Not set'}</div></div>
          <div class="abtn-row">
            <button class="aedit" onclick="adminSetTarget('${c}')">ğŸ¯</button>
            <button class="adel" onclick="removeCar(${i})">âœ•</button>
          </div>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="addrow">
          <div class="field"><label>New Car Plate</label><input type="text" id="newCar" placeholder="e.g. KCA 123A"></div>
          <button class="bsm bg" onclick="addCar()">ADD</button>
        </div>
      </div>
    </div>

    <!-- STATIONS -->
    <div class="asect ${adminTab==='stations'?'active':''}">
      <div class="card">
        <div class="ctitle">STATIONS <span class="pill">${STATIONS.length}</span></div>
        ${STATIONS.map((s,i)=>`<div class="aitem">
          <div>
            <div class="aitem-name">${s.name}</div>
            <div class="aitem-sub">${s.lat?`${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}`:'No GPS'}</div>
          </div>
          <button class="adel" onclick="removeStation(${i})">âœ•</button>
        </div>`).join('')}
        <div class="divline"></div>
        <div class="field"><label>Station Name</label><input type="text" id="newStn" placeholder="STATION NAME IN CAPS"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:8px">
          <div class="field" style="margin:0"><label>Latitude</label><input type="number" id="newLat" placeholder="-1.2833" step="any"></div>
          <div class="field" style="margin:0"><label>Longitude</label><input type="number" id="newLng" placeholder="36.8167" step="any"></div>
        </div>
        <button class="bsm bg" style="width:100%;padding:10px" onclick="addStation()">ADD STATION</button>
      </div>
    </div>

    <!-- TRIPS -->
    <div class="asect ${adminTab==='trips'?'active':''}">
      <div class="card">
        <div class="ctitle">LOCAL TRIPS <span class="pill">${localTrips.length}</span></div>
        <div class="csub">// EDIT OR DELETE LOCAL TRIP RECORDS</div>
        ${localTrips.length===0?'<div class="empty">NO LOCAL TRIPS</div>':localTrips.slice(0,30).map(t=>`
          <div class="aitem" style="margin-bottom:7px">
            <div style="flex:1">
              <div class="aitem-name" style="font-size:.6rem">${t.fromStation} â†’ ${t.toStation}</div>
              <div class="aitem-sub">${t.driver} Â· ${t.carPlate} Â· KES ${t.amount} Â· ${t.date}</div>
              ${t.notes?`<div class="aitem-sub">ğŸ“ ${t.notes}</div>`:''}
            </div>
            <div class="abtn-row">
              <button class="aedit" onclick="openEditTrip(${t.id})">âœ</button>
              <button class="adel" onclick="deleteTrip(${t.id})">âœ•</button>
            </div>
          </div>`).join('')}
      </div>
    </div>

    <!-- CONFIG -->
    <div class="asect ${adminTab==='config'?'active':''}">
      <div class="card">
        <div class="ctitle">SYSTEM CONFIG</div>
        <div class="csub">// CHANGE ADMIN PIN</div>
        <div class="irow">
          <div class="field"><label>New Admin PIN (4-6 digits)</label><input type="password" id="newPin" placeholder="New PIN" maxlength="6"></div>
          <button class="bsm bg" onclick="changePin()">SAVE</button>
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// SECURITY SETTINGS</div>
        <div style="font-size:.74rem;color:var(--muted);margin-bottom:9px;line-height:1.8">
          â€¢ Session timeout: <strong>30 minutes</strong> of inactivity<br>
          â€¢ Countdown bar shows only in final <strong>5 minutes</strong><br>
          â€¢ Warning overlay at <strong>60 seconds</strong> remaining<br>
          â€¢ PIN lockout: <strong>3 failed attempts</strong> = 5 min lock
        </div>
        <div class="divline"></div>
        <div class="csub" style="margin-top:0">// LOCAL DATA</div>
        <p style="font-size:.74rem;color:var(--muted);margin-bottom:9px">${localTrips.length} trips stored locally Â· ${offlineQ.length} queued for Firebase sync</p>
        ${offlineQ.length?`<button class="bsm by" style="width:100%;padding:10px;margin-bottom:8px" onclick="flushQueue()">SYNC ${offlineQ.length} QUEUED TRIPS TO FIREBASE</button>`:''}
        <button class="bout" onclick="if(confirm('Reset all lists to defaults?')){resetToDefaults();}">RESET LISTS TO DEFAULTS</button>
        <button class="bout" onclick="if(confirm('Clear all local trips? This cannot be undone.')){localTrips=[];save('fs_trips',[]);toast('CLEARED');renderAdmin();}">CLEAR LOCAL TRIP DATA</button>
      </div>
    </div>

    <!-- FIREBASE CONFIG -->
    <div class="asect ${adminTab==='settings'?'active':''}">
      <div class="card">
        <div class="ctitle">FIREBASE CONFIG</div>
        <div class="csub">// CONNECT TO FIREBASE FIRESTORE</div>
        ${db?'<div class="conn-badge"><div class="dg"></div>FIREBASE CONNECTED</div>':''}
        <div class="field"><label>API KEY</label>
          <input type="text" id="fbApiKey" value="${appConfig.apiKey||''}" placeholder="AIzaSy..."></div>
        <div class="field"><label>AUTH DOMAIN</label>
          <input type="text" id="fbAuthDomain" value="${appConfig.authDomain||''}" placeholder="your-app.firebaseapp.com"></div>
        <div class="field"><label>PROJECT ID</label>
          <input type="text" id="fbProjectId" value="${appConfig.projectId||''}" placeholder="your-project-id"></div>
        <div class="field"><label>APP ID</label>
          <input type="text" id="fbAppId" value="${appConfig.appId||''}" placeholder="1:123456:web:abc..."></div>
        <button class="bb bstart" style="margin-top:4px" onclick="saveFirebaseConfig()">SAVE & CONNECT</button>
        <button class="bout" onclick="testFirebaseConnection()">TEST CONNECTION</button>
      </div>
      <div class="card">
        <div class="ctitle">SETUP GUIDE</div>
        <div class="steps">
          <div class="step">Go to <code>console.firebase.google.com</code> â†’ Create project â†’ Disable Google Analytics</div>
          <div class="step">Click <code>Firestore Database</code> â†’ <code>Create database</code> â†’ Start in <strong>test mode</strong> â†’ Choose region</div>
          <div class="step">Click <code>Project settings</code> (âš™) â†’ <code>Your apps</code> â†’ <code>&lt;/&gt; Web</code> â†’ Register app â†’ Copy the config values above</div>
          <div class="step">In Firestore â†’ <code>Rules</code> tab â†’ Paste:<br><code>allow read, write: if true;</code> â†’ Publish</div>
          <div class="step">Paste all 4 config values above â†’ <strong>SAVE & CONNECT</strong></div>
          <div class="step">Done! All trips from all 50 cars now sync instantly to Firebase. No limits.</div>
        </div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkPin(){
  if(isAdminLocked()){toast(`ğŸ”’ LOCKED â€” TRY IN ${adminLockSecsLeft()}s`);return;}
  const pin=document.getElementById('pinIn')?.value;
  if(pin===(localStorage.getItem(ADMIN_PIN_KEY)||DEFAULT_ADMIN_PIN)){
    adminPinFailures=0;
    adminUnlocked=true;
    renderAdmin();
  } else {
    recordAdminFailure();
    renderAdmin();
  }
}

// SHIFT CLOSE WITH SUMMARY
function showCloseShiftSummary(plate){
  const today=new Date().toLocaleDateString('en-GB');
  const shiftStart=shifts[plate]?.openedAt;
  const tripsInShift=localTrips.filter(t=>
    t.carPlate===plate&&t.date===today&&
    (!shiftStart||new Date(t.timestamp).getTime()>=shiftStart)
  );
  const revenue=tripsInShift.reduce((s,t)=>s+t.amount,0);
  const drivers=[...new Set(tripsInShift.map(t=>t.driver).filter(Boolean))];

  document.getElementById('shiftSummaryBody').innerHTML=`
    <div style="font-family:var(--font-m);font-size:.58rem;color:var(--muted);letter-spacing:1px;margin-bottom:12px">
      SHIFT SUMMARY FOR <strong style="color:var(--text)">${plate}</strong>
    </div>
    <div class="shift-sum-row"><span>TOTAL TRIPS</span><strong>${tripsInShift.length}</strong></div>
    <div class="shift-sum-row"><span>DRIVERS ON SHIFT</span><strong>${drivers.length?drivers.map(d=>d.split(' ')[0]).join(', '):'None'}</strong></div>
    <div class="shift-sum-row"><span>OPENED AT</span><strong>${shifts[plate]?.openedAt?new Date(shifts[plate].openedAt).toLocaleTimeString():'â€”'}</strong></div>
    <div class="shift-sum-row"><span>CLOSING AT</span><strong>${new Date().toLocaleTimeString()}</strong></div>
    <div class="shift-sum-total">KES ${revenue.toLocaleString()}</div>
    <div style="font-family:var(--font-m);font-size:.5rem;color:var(--muted);text-align:center;margin-top:4px">TOTAL REVENUE THIS SHIFT</div>`;

  document.getElementById('shiftCloseConfirmBtn').onclick=()=>closeShift(plate);
  document.getElementById('shiftSummaryModal').classList.add('open');
}

function openShift(plate){
  const by=prompt('Who is opening this shift?')||'ADMIN';
  shifts[plate]={open:true,openedAt:Date.now(),openedBy:by.toUpperCase(),closedAt:null};
  save('fs_shifts',shifts);toast(`âœ… SHIFT OPENED FOR ${plate}`);renderAdmin();
}
function closeShift(plate){
  shifts[plate]={...shifts[plate],open:false,closedAt:Date.now()};
  save('fs_shifts',shifts);
  document.getElementById('shiftSummaryModal').classList.remove('open');
  toast(`ğŸ”´ SHIFT CLOSED FOR ${plate}`);
  renderAdmin();
}
function openAllShifts(){
  const by=prompt('Who is opening all shifts?')||'ADMIN';
  CARS.forEach(c=>{shifts[c]={open:true,openedAt:Date.now(),openedBy:by.toUpperCase(),closedAt:null};});
  save('fs_shifts',shifts);toast('âœ… ALL SHIFTS OPENED');renderAdmin();
}
function closeAllShifts(){
  if(!confirm('Close ALL shifts?'))return;
  CARS.forEach(c=>{shifts[c]={...shifts[c],open:false,closedAt:Date.now()};});
  save('fs_shifts',shifts);toast('ğŸ”´ ALL SHIFTS CLOSED');renderAdmin();
}

// DRIVERS & CARS
function adminSetDriverPin(driver){
  const pin=prompt(`Set PIN for ${driver.split(' ')[0]} (blank to remove):`);
  if(pin===null)return;
  if(pin===''){delete driverPins[driver];}
  else if(pin.length>=4){driverPins[driver]=pin;}
  else{toast('PIN MUST BE AT LEAST 4 DIGITS');return;}
  save('fs_dpins',driverPins);toast(pin?'PIN SET âœ…':'PIN REMOVED');renderAdmin();
}
function adminSetTarget(plate){
  const t=prompt(`Daily revenue target for ${plate} (KES, blank to remove):`);
  if(t===null)return;
  if(t===''){delete carTargets[plate];}
  else{const n=parseFloat(t);if(isNaN(n)||n<=0){toast('INVALID AMOUNT');return;}carTargets[plate]=n;}
  save('fs_targets',carTargets);toast(t?'TARGET SET âœ…':'TARGET REMOVED');renderAdmin();
}
function addDriver(){const n=(document.getElementById('newDriver')?.value||'').trim().toUpperCase();if(!n){toast('ENTER NAME');return;}if(DRIVERS.includes(n)){toast('ALREADY EXISTS');return;}DRIVERS.push(n);save('fs_drivers',DRIVERS);toast('DRIVER ADDED âœ…');renderAdmin();}
function removeDriver(i){if(!confirm('Remove '+DRIVERS[i]+'?'))return;const d=DRIVERS[i];delete driverPins[d];save('fs_dpins',driverPins);DRIVERS.splice(i,1);save('fs_drivers',DRIVERS);renderAdmin();}
function addCar(){const n=(document.getElementById('newCar')?.value||'').trim().toUpperCase();if(!n){toast('ENTER PLATE');return;}if(CARS.includes(n)){toast('ALREADY EXISTS');return;}CARS.push(n);save('fs_cars',CARS);toast('CAR ADDED âœ…');renderAdmin();}
function removeCar(i){if(!confirm('Remove '+CARS[i]+'?'))return;CARS.splice(i,1);save('fs_cars',CARS);renderAdmin();}
function addStation(){
  const n=(document.getElementById('newStn')?.value||'').trim().toUpperCase();
  const lat=parseFloat(document.getElementById('newLat')?.value||'');
  const lng=parseFloat(document.getElementById('newLng')?.value||'');
  if(!n){toast('ENTER NAME');return;}
  STATIONS.push({name:n,lat:isNaN(lat)?0:lat,lng:isNaN(lng)?0:lng});
  save('fs_stations',STATIONS);toast('STATION ADDED âœ…');renderAdmin();
}
function removeStation(i){if(!confirm('Remove '+STATIONS[i].name+'?'))return;STATIONS.splice(i,1);save('fs_stations',STATIONS);renderAdmin();}
function changePin(){const p=document.getElementById('newPin')?.value||'';if(p.length<4){toast('MIN 4 DIGITS');return;}localStorage.setItem(ADMIN_PIN_KEY,p);toast('PIN UPDATED âœ…');}
function resetToDefaults(){DRIVERS=[...DEFAULT_DRIVERS];CARS=[...DEFAULT_CARS];STATIONS=DEFAULT_STATIONS.map(s=>({...s}));save('fs_drivers',DRIVERS);save('fs_cars',CARS);save('fs_stations',STATIONS);toast('RESET âœ…');renderAdmin();}

// TRIPS
function openEditTrip(id){
  const trip=localTrips.find(t=>t.id===id);if(!trip)return;
  editingTripId=id;
  document.getElementById('editDriver').value=trip.driver||'';
  document.getElementById('editCar').value=trip.carPlate||'';
  document.getElementById('editFrom').value=trip.fromStation||'';
  document.getElementById('editTo').value=trip.toStation||'';
  document.getElementById('editAmount').value=trip.amount||'';
  document.getElementById('editDate').value=trip.date||'';
  document.getElementById('editModal').classList.add('open');
}
function closeEditModal(){document.getElementById('editModal').classList.remove('open');editingTripId=null;}
function saveEditTrip(){
  const idx=localTrips.findIndex(t=>t.id===editingTripId);if(idx<0)return;
  localTrips[idx]={...localTrips[idx],driver:document.getElementById('editDriver').value,carPlate:document.getElementById('editCar').value,fromStation:document.getElementById('editFrom').value,toStation:document.getElementById('editTo').value,amount:parseFloat(document.getElementById('editAmount').value)||0,date:document.getElementById('editDate').value};
  save('fs_trips',localTrips);closeEditModal();toast('TRIP UPDATED âœ…');renderAdmin();
}
function deleteTrip(id){if(!confirm('Delete this trip?'))return;localTrips=localTrips.filter(t=>t.id!==id);save('fs_trips',localTrips);toast('DELETED');renderAdmin();}

function saveFirebaseConfig(){
  appConfig.apiKey      =(document.getElementById('fbApiKey')?.value||'').trim();
  appConfig.authDomain  =(document.getElementById('fbAuthDomain')?.value||'').trim();
  appConfig.projectId   =(document.getElementById('fbProjectId')?.value||'').trim();
  appConfig.appId       =(document.getElementById('fbAppId')?.value||'').trim();
  save('fs_config',appConfig);
  db=null; // force re-init with new config
  if(appConfig.projectId&&initFirebase()){toast('âœ… FIREBASE CONNECTED!');}
  else{toast(appConfig.projectId?'âš  CHECK CONFIG VALUES':'CONFIG SAVED â€” ENTER ALL 4 VALUES');}
  renderAdmin();
}
async function testFirebaseConnection(){
  if(!initFirebase()){toast('âš  SAVE CONFIG FIRST');return;}
  try{
    await db.collection('_test').limit(1).get();
    toast('âœ… FIREBASE CONNECTION OK!');
  }catch(e){toast('âš  CONNECTION FAILED: '+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(tripState.driver)document.getElementById('driverBadge').textContent=tripState.driver.split(' ')[0]+' Â· '+tripState.carPlate;
if(tripState.phase!=='setup'){startSessionTimer();startGpsWatch();}
updateOfflineBadge();
startAutoSync();
initFirebase();  // connect to Firebase on load if config exists
renderLog();
if(appConfig.projectId&&isOnline())loadFirebaseData(true);
</script>
</body>
</html>
